<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find-Flix | מצא את הסרט או הסדרה הבאה שלך</title>

    <!-- SEO Meta Tags -->
    <meta id="meta-description" name="description" content="Find-Flix עוזר לך למצוא את הסרט או הסדרה הבאה שלך, עם המלצות, חיפוש, ומידע על איפה לצפות. גלה תכנים פופולריים וקבל המלצה אישית בלחיצת כפתור.">
    <meta id="meta-keywords" name="keywords" content="סרטים, סדרות, נטפליקס, המלצות, חיפוש סרטים, דיסני פלוס, אמזון פריים, find-flix, movies, series, netflix, recommendations, search movies, קולנוע">


    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-website-url.com/">
    <meta property="og:title" content="Find-Flix | מצא את הסרט או הסדרה הבאה שלך">
    <meta property="og:description" content="Find-Flix עוזר לך למצוא את הסרט או הסדרה הבאה שלך, עם המלצות, חיפוש, ומידע על איפה לצפות.">
    <meta property="og:image" content="https://placehold.co/1200x630/e50914/ffffff?text=Find-Flix">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://your-website-url.com/">
    <meta property="twitter:title" content="Find-Flix | מצא את הסרט או הסדרה הבאה שלך">
    <meta property="twitter:description" content="Find-Flix עוזר לך למצוא את הסרט או הסדרה הבאה שלך, עם המלצות, חיפוש, ומידע על איפה לצפות.">
    <meta property="twitter:image" content="https://placehold.co/1200x630/e50914/ffffff?text=Find-Flix">

    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAYFBMVEX/AAD/////OTn/Kiropqf/2dn/8PD/9PT/MjL/ERH/WVn/5ub/ICD/ycn/vr7/fn7/XV3/s7P/goL/h4f/oqL/c3P/U1P/zMzp6en/amr/rq7/j4//YWH/wcH/dXUA4uRdAAACnklEQVR4nO3d63aqMBhAYRCSAoKioIgoiP7/v3a4A4gIqgQdwj2fcx6dG2xCa2uWAAAAAAAAAAAAAAAAAAAAgMAs9l5rK1er1Qqx915bW7f2Xl/c7v22t3O5XIPo0/a+L05eHp9ffN/39/3j5w8+3+9/fTw/e/a3h+NRvR8Qjx/H4/Hw+v1u/N17bW3dC+Lp17fXl48fj8frb7eX28vt1/eb7cftj5sffz3+eH5e/73+/v3t7c3jYy+Yl48P29ub4/F4eX16vR7lY5m//eY3x+NRL2yvx8/bH+n59eb5x+NRfX6/G6d/915bW7e2vT4eP79ej1O+N4jH49fne5Ufrz/fj/Kv4y/+L/zUv7y/v395fX27ubx8/vT7eXp5u14N/6e33u1b8i+7e8+3n24/bj5sv3x5/vi++3fvrbe2a7tL/zL+U//G7u3vfu1vL7/e3F9f/958efw15cZ7r62tW/w15/f3t7c/33r7L5zvtbe1a/y97Xp7f/814fD2vS+599rauiX/L957bW3dkn8t915bW7fkv+vea2vr1u5/8QpfeOEVvvDCS6tY/t/l/L/L+X+X8/8u5/9dyn+Z/q/f8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/whRde+CW1/xVfeOEVvvDCS6tY/zXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/wDQIAAADApz8L7o7/v7G5xgAAAABJRU5ErkJggg==" type="image/png">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAYFBMVEX/AAD/////OTn/Kiropqf/2dn/8PD/9PT/MjL/ERH/WVn/5ub/ICD/ycn/vr7/fn7/XV3/s7P/goL/h4f/oqL/c3P/U1P/zMzp6en/amr/rq7/j4//YWH/wcH/dXUA4uRdAAACnklEQVR4nO3d63aqMBhAYRCSAoKioIgoiP7/v3a4A4gIqgQdwj2fcx6dG2xCa2uWAAAAAAAAAAAAAAAAAAAAgMAs9l5rK1er1Qqx915bW7f2Xl/c7v22t3O5XIPo0/a+L05eHp9ffN/39/3j5w8+3+9/fTw/e/a3h+NRvR8Qjx/H4/Hw+v1u/N17bW3dC+Lp17fXl48fj8frb7eX28vt1/eb7cftj5sffz3+eH5e/73+/v3t7c3jYy+Yl48P29ub4/F4eX16vR7lY5m//eY3x+NRL2yvx8/bH+n59eb5x+NRfX6/G6d/915bW7e2vT4eP79ej1O+N4jH49fne5Ufrz/fj/Kv4y/+L/zUv7y/v395fX27ubx8/vT7eXp5u14N/6e33u1b8i+7e8+3n24/bj5sv3x5/vi++3fvrbe2a7tL/zL+U//G7u3vfu1vL7/e3F9f/958efw15cZ7r62tW/w15/f3t7c/33r7L5zvtbe1a/y97Xp7f/814fD2vS+599rauiX/L957bW3dkn8t915bW7fkv+vea2vr1u5/8QpfeOEVvvDCS6tY/t/l/L/L+X+X8/8u5/9dyn+Z/q/f8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/whRde+CW1/xVfeOEVvvDCS6tY/zXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/wDQIAAADApz8L7o7/v7G5xgAAAABJRU5ErkJggg==">
    <meta name="theme-color" content="#e50914"/>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Assistant Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@200..800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    
    <!-- NEW: Cast API Callback Setup (Before loading the sender script) -->
    <script>
        window.castApiAvailable = false;
        // Define the callback globally before the API loads
        window['__onGCastApiAvailable'] = function(isAvailable) {
            window.castApiAvailable = isAvailable;
            if (isAvailable && window.initializeCastApi) {
                window.initializeCastApi();
            }
        };
    </script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        html.custom-font body,
        html.custom-font button,
        html.custom-font input,
        html.custom-font select,
        html.custom-font textarea,
        html.custom-font h1,
        html.custom-font h2,
        html.custom-font h3,
        html.custom-font h4,
        html.custom-font p,
        html.custom-font a,
        html.custom-font span {
            font-family: 'user-custom-font', sans-serif !important;
        }

        /* NEW: Logo Drop Shadow */
        #detail-logo {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }
        html.theme-light #detail-logo {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        /* NEW: Header Logo Style */
        #detail-header-logo {
            max-height: 56px; /* 14 * 4 = 56px, same as h-14 */
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
        }
        html.theme-light #detail-header-logo {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }


        body {
            font-family: 'Assistant', sans-serif;
            background-color: #0d0d0d;
            color: #f5f5f5;
        }
        body.sidebar-open, body.modal-open {
            overflow: hidden;
        }
        /* --- NEW: Premium Card Design --- */
        .card {
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            aspect-ratio: 2/3;
            border: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateZ(0); /* Hardware acceleration */
        }
        .card:hover {
            transform: scale(1.05) translateZ(0);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            z-index: 20;
        }
        .card-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease, filter 0.3s ease;
        }
        .card:hover .card-poster {
            transform: scale(1.1);
            filter: brightness(0.6);
        }
        /* Base gradient for non-hover state title visibility */
        .card-base-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .card:hover .card-base-overlay {
            opacity: 0;
        }
        /* Hover overlay with full info */
        .card-hover-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 50%, rgba(0,0,0,0.2) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1.25rem;
            pointer-events: none; /* Let clicks pass through to card unless on buttons */
        }
        .card:hover .card-hover-overlay {
            opacity: 1;
            pointer-events: auto;
        }
        .card-title-base {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            transition: opacity 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }
        .card:hover .card-title-base {
            opacity: 0;
        }
        /* Elements inside hover overlay */
        .card-content {
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .card:hover .card-content {
            transform: translateY(0);
        }
        .card-title-hover {
            color: white;
            font-weight: 800;
            font-size: 1.1rem;
            line-height: 1.2;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #e5e7eb;
            margin-bottom: 0.75rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.1s;
        }
        .card:hover .card-meta {
            opacity: 1;
            transform: translateY(0);
        }
        .card-match {
            color: #4ade80; /* green-400 */
            font-weight: 700;
        }
        .card-desc {
            font-size: 0.75rem;
            color: #9ca3af;
            line-height: 1.4;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.15s;
        }
        .card:hover .card-desc {
            opacity: 1;
            transform: translateY(0);
        }
        .card-actions {
            display: none; /* הוסתר לחלוטין */
        }
        /* --- NEW: Premium Card Design (No Buttons) --- */
        .card {
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            aspect-ratio: 2/3;
            border: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateZ(0); /* Hardware acceleration */
            cursor: pointer;
        }
        .card:hover {
            transform: scale(1.05) translateZ(0);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            z-index: 20;
        }
        .card-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1), filter 0.3s ease; /* חלקה יותר */
        }
        .card:hover .card-poster {
            transform: scale(1.12);
            filter: brightness(0.5); /* כהה יותר לקריאות טקסט */
        }
        /* Base gradient for non-hover state title visibility */
        .card-base-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 60%, transparent 100%);
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .card:hover .card-base-overlay {
            opacity: 0;
        }
        /* Hover overlay with full info */
        .card-hover-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 40%, rgba(0,0,0,0.2) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1.5rem; /* מרווח פנימי מוגדל */
            pointer-events: none;
        }
        .card:hover .card-hover-overlay {
            opacity: 1;
        }
        .card-title-base {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            transition: opacity 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
            text-align: center; /* מירכוז כותרת בסיס */
        }
        .card:hover .card-title-base {
            opacity: 0;
        }
        /* Elements inside hover overlay */
        .card-content {
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            width: 100%;
        }
        .card:hover .card-content {
            transform: translateY(0);
        }
        .card-title-hover {
            color: white;
            font-weight: 800;
            font-size: 1.25rem; /* כותרת גדולה יותר */
            line-height: 1.1;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: #d1d5db;
            margin-bottom: 0.75rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.1s;
            font-weight: 500;
        }
        .card:hover .card-meta {
            opacity: 1;
            transform: translateY(0);
        }
        .card-match {
            color: #4ade80; /* green-400 */
            font-weight: 800;
            letter-spacing: 0.025em;
        }
        .card-desc {
            font-size: 0.85rem; /* טקסט מעט גדול יותר */
            color: #9ca3af;
            line-height: 1.5;
            margin-bottom: 0; /* ביטול מרווח תחתון כי אין כפתורים */
            display: -webkit-box;
            -webkit-line-clamp: 5; /* יותר שורות טקסט */
            -webkit-box-orient: vertical;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.15s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .card:hover .card-desc {
            opacity: 1;
            transform: translateY(0);
        }
        /* --- END New Card Design --- */

        /* NEW: Force original logo color across all themes */
        #logo-icon {
            color: #e50914 !important;
        }
        /* NEW: Add a more visible focus state for accessibility */
        *:focus-visible {
            outline: 3px solid #ff7b7b !important;
            outline-offset: 2px;
            border-radius: 4px; /* Optional: adds rounded corners to the outline */
        }
        /* NEW: Add text shadow for better readability on posters */
        .card .absolute.bottom-0 h3, .card .absolute.bottom-0 span {
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }
        .quote {
            transition: opacity 0.5s ease;
        }
        .lang-select {
            background-color: #2b2b2b;
            color: #f5f5f5;
            border: 1px solid #444;
            font-size: 1rem;
            padding: 0.5rem 1rem;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #e50914;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* New animations */
        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                background-color: #e50914;
            }
            50% {
                transform: scale(1.05);
                background-color: #ff3838;
            }
        }
        .animate-pulse-red {
            animation: pulse-red 1.5s infinite ease-in-out;
        }

        .fade-in-scale {
            animation: fadeInScale 0.5s ease-out forwards;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logo-button img {
            transition: transform 0.3s ease;
        }

        .logo-button:hover img {
            transform: scale(1.05);
        }
        .detail-header {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            background-color: #0d0d0d;
            z-index: 10;
            padding-top: 1.5rem;
            padding-bottom: 1rem;
        }
        .sidebar-link.active {
            background-color: #e50914;
            font-weight: bold;
        }
        /* NEW Sidebar Dropdown Styles */
        .sidebar-dropdown-toggle.active {
            background-color: #e50914;
        }
        html.theme-light .sidebar-dropdown-toggle.active,
        html.theme-light .sidebar-dropdown-toggle:hover {
             background-color: #e50914;
             color: #ffffff;
        }
         html.theme-light .sidebar-dropdown-toggle.active svg,
         html.theme-light .sidebar-dropdown-toggle:hover svg {
             color: #ffffff;
         }

        .sidebar-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding-left: 1rem; /* Indent submenu items */
        }
        .sidebar-dropdown-toggle .chevron-icon.open {
            transform: rotate(180deg);
        }
        
        /* Modals */
        .modal-overlay {
            background-color: rgba(0,0,0,0.8);
            z-index: 50;
        }
        .modal-content {
            background-color: #1a1a1a;
        }
        .aspect-video {
            aspect-ratio: 16 / 9;
        }

        /* "Now in Cinemas" Banner */
        .in-cinemas-banner {
            background: linear-gradient(45deg, #ff007f, #ffcc00);
            color: white;
            padding: 5px 15px;
            font-weight: bold;
            font-size: 0.8rem;
            border-radius: 5px;
            transform: rotate(-5deg);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: sparkle 1.5s infinite alternate;
            z-index: 10;
        }
        @keyframes sparkle {
            0% { box-shadow: 0 0 5px #fff, 0 0 10px #ff007f, 0 0 15px #ffcc00; }
            100% { box-shadow: 0 0 10px #fff, 0 0 20px #ff007f, 0 0 30px #ffcc00; }
        }

        /* "New Content" Banner */
        .new-content-banner {
            background: linear-gradient(45deg, #007bff, #00c6ff);
            color: white;
            padding: 5px 15px;
            font-weight: bold;
            font-size: 0.8rem;
            border-radius: 5px;
            transform: rotate(-5deg);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            animation: sparkle-blue 1.5s infinite alternate;
            z-index: 10;
        }
        @keyframes sparkle-blue {
            0% { box-shadow: 0 0 5px #fff, 0 0 10px #007bff, 0 0 15px #00c6ff; }
            100% { box-shadow: 0 0 10px #fff, 0 0 20px #007bff, 0 0 30px #00c6ff; }
        }

        /* New Animation for Surprise Me Again */
        @keyframes surprise-out {
            from { opacity: 1; transform: scale(1) rotate(0deg); }
            to { opacity: 0; transform: scale(0.95) rotate(-3deg); }
        }
        @keyframes surprise-in {
            from { opacity: 0; transform: scale(0.95) rotate(3deg); }
            to { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        /* More Options Dropdown */
        .more-options-container {
            position: relative;
            display: inline-block;
        }
        .more-options-dropdown {
            display: none;
            position: absolute;
            bottom: 100%; /* Position above the button */
            right: 0; /* Unified position for all languages */
            background-color: #2b2b2b;
            min-width: 220px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
            z-index: 20; /* Ensure it's above other elements */
            border-radius: 8px;
            border: 1px solid #444;
            padding: 8px 0;
            margin-bottom: 8px;
        }
        html.theme-light .more-options-dropdown {
            background-color: #ffffff;
            border-color: #e0e0e0;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1);
        }
        .more-options-dropdown a, .more-options-dropdown button {
            color: #f5f5f5;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }
        html[dir="ltr"] .more-options-dropdown a, html[dir="ltr"] .more-options-dropdown button { text-align: left; }
        html[dir="rtl"] .more-options-dropdown a, html[dir="rtl"] .more-options-dropdown button { text-align: right; }
        html.theme-light .more-options-dropdown a, html.theme-light .more-options-dropdown button {
            color: #1c1e21;
        }
        .more-options-dropdown a:hover, .more-options-dropdown button:hover {
            background-color: #444;
        }
        html.theme-light .more-options-dropdown a:hover, html.theme-light .more-options-dropdown button:hover {
            background-color: #f0f2f5;
        }
        .more-options-dropdown.show {
            display: block;
        }

        html.theme-light #tools-dropdown-menu { background-color: #ffffff; border: 1px solid #e0e0e0; }
        html.theme-light #tools-dropdown-menu button { color: #1c1e21; }
        html.theme-light #tools-dropdown-menu button:hover { background-color: #f0f2f5; }

        .roulette-result-card {
            animation: fadeInScale 0.5s ease-out forwards;
        }

        #roulette-wheel {
            perspective: 1000px;
        }
        #roulette-strip {
            transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .roulette-item {
            backface-visibility: hidden;
        }

        /* Tools Dropdown Animation */
        .animate-dropdown {
            animation: fadeInScaleUp 0.2s ease-out;
            transform-origin: top right;
        }
        html[dir="rtl"] .animate-dropdown {
            transform-origin: top left;
        }
        @keyframes fadeInScaleUp {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-dropdown-out {
            animation: fadeOutScaleDown 0.2s ease-in forwards;
            transform-origin: top right;
        }
        html[dir="rtl"] .animate-dropdown-out {
            transform-origin: top left;
        }
        @keyframes fadeOutScaleDown {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
        }

        /* More Options Dropdown Animation */
        .animate-dropdown-up {
            animation: fadeInScaleFromBottom 0.2s ease-out;
            transform-origin: bottom right;
        }
        @keyframes fadeInScaleFromBottom {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .animate-dropdown-up-out {
            animation: fadeOutScaleToBottom 0.2s ease-in forwards;
            transform-origin: bottom right;
        }
        @keyframes fadeOutScaleToBottom {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
        }

        /* Light Theme Styles */
        html.theme-light body {
            background-color: #f0f2f5;
            color: #1c1e21;
        }
        html.theme-light h1, html.theme-light h2, html.theme-light h3, html.theme-light h4, html.theme-light .text-white {
            color: #1c1e21;
        }
        html.theme-light .card {
            background-color: #ffffff;
            border-color: #e0e0e0;
        }
        html.theme-light .card .text-white {
            color: #1c1e21 !important;
        }
        /* NEW: Ensure poster text is white with a dark shadow in light mode for readability */
        html.theme-light .card .absolute.bottom-0 h3, 
        html.theme-light .card .absolute.bottom-0 span {
            color: #ffffff !important;
            /* The dark text-shadow from the base rule is inherited, so we don't need to override the shadow here. */
        }
        html.theme-light .card .text-gray-400 {
            color: #1c1e21;
        }
        html.theme-light .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        html.theme-light #sidebar {
            background-color: #f8f9fa;
        }
        html.theme-light #sidebar a, html.theme-light #sidebar h2, html.theme-light #sidebar span, html.theme-light #sidebar svg { color: #1c1e21; }
        html.theme-light #sidebar #nav-title { color: #e50914; }
        html.theme-light .sidebar-link:hover { background-color: #e50914; }
        html.theme-light .sidebar-link:hover span, html.theme-light .sidebar-link:hover svg { color: #ffffff !important; }
        html.theme-light .sidebar-link.active { color: #ffffff; background-color: #e50914; }
        html.theme-light .sidebar-link.active span, html.theme-light .sidebar-link.active svg { color: #ffffff !important; }
        html.theme-light #search-input {
            background-color: #e9ebee;
            color: #1c1e21;
            border-color: #ced0d4;
        }
        html.theme-light #search-input::placeholder { color: #606770; }
        html.theme-light .detail-header { background-color: #f0f2f5; }
        html.theme-light .text-gray-300, html.theme-light .text-gray-400 { color: #606770; }
        html.theme-light #detail-meta span, html.theme-light .bg-gray-700 { background-color: #e9ebee; color: #1c1e21; }
        html.theme-light .modal-content, html.theme-light .bg-gray-800 { background-color: #f8f9fa; color: #1c1e21; }
        html.theme-light .lang-select { background-color: #e9ebee; color: #1c1e21; border-color: #ced0d4; }
        html.theme-light .bg-gray-900 { background-color: #ffffff; }
        html.theme-light #episodes-grid .bg-gray-800,
        html.theme-light #seasons-list .bg-gray-800,
        html.theme-light #streaming-buttons-container .bg-gray-800 {
            background-color: #ffffff; border: 1px solid #e0e0e0;
        }
        html.theme-light #seasons-list .hover\:bg-gray-700:hover { background-color: #f0f2f5; }
        html.theme-light #settings-view .bg-gray-900\/50 { background-color: rgba(240, 242, 245, 0.8); }
        html.theme-light #settings-view .border-gray-600 { border-color: #e0e0e0; }
    <!-- Gemini AI Modal styles -->
    .prose {
        color: #d1d5db; /* gray-300 */
        line-height: 1.65;
    }
    .prose strong {
        color: #f9fafb; /* gray-50 */
        font-weight: 600;
    }
    .prose em {
        font-style: italic;
    }
    html.theme-light .prose {
        color: #374151; /* gray-700 */
    }
    html.theme-light .prose strong {
        color: #111827; /* gray-900 */
    }

    /* API Key Input */
    #gemini-api-key-input::placeholder {
        color: #9ca3af; /* gray-400 */
    }
    html.theme-light #gemini-api-key-input {
        background-color: #e9ebee;
        color: #1c1e21;
        border-color: #ced0d4;
    }
     html.theme-light #gemini-api-key-input::placeholder {
        color: #606770;
    }


    /* Achievement Progress Bar */
    .progress-bar-container {
        background-color: #333;
            border-radius: 9999px;
            overflow: hidden;
            height: 1.5rem; /* 24px */
            border: 2px solid #555;
        }
        .progress-bar-fill {
            background: linear-gradient(90deg, #f59e0b, #ef4444);
            height: 100%;
            transition: width 0.5s ease-in-out;
            border-radius: 9999px;
        }
        html.theme-light .progress-bar-container {
            background-color: #e0e0e0;
            border-color: #bdbdbd;
        }

        /* Achievement Card Progress Bar */
        .achievement-progress-container {
            background-color: #4a5568; /* gray-600 */
            border-radius: 9999px;
            height: 0.5rem; /* 8px */
            width: 100%;
            margin-top: 0.25rem; /* 4px */
        }
        .achievement-progress-fill {
            background-color: #f59e0b; /* amber-500 */
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        html.theme-light .achievement-progress-container {
            background-color: #e0e0e0;
        }

        /* Achievement Styles */
        .achievement-card {
            border: 2px solid #4a5568;
            transition: all 0.3s ease;
        }
        .achievement-card.unlocked {
            border-color: #f59e0b; /* amber-500 */
            background: radial-gradient(circle, rgba(245,158,11,0.2) 0%, rgba(23,23,23,0) 70%);
            box-shadow: 0 0 15px rgba(245,158,11,0.3);
        }
        .achievement-card.locked {
            filter: grayscale(80%);
            opacity: 0.6;
        }
        .achievement-card .unlocked-icon {
            color: #f59e0b;
            text-shadow: 0 0 8px #f59e0b;
        }
        html.theme-light .achievement-card.unlocked {
            background: radial-gradient(circle, rgba(245,158,11,0.1) 0%, rgba(255,255,255,0) 70%);
        }
        html.theme-light .achievement-card {
             background-color: #ffffff; border-color: #e0e0e0;
        }

        /* Gemini Icon Theming */
        .gemini-icon-color {
            color: #a855f7; /* purple-500 for default dark theme */
        }
        html.theme-light .gemini-icon-color {
            color: #9333ea; /* purple-600 for light theme */
        }
        html.high-contrast .gemini-icon-color {
            color: yellow !important;
        }

        /* Glass Theme */
        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        html.theme-glass {
            /* הרקע המונפש הוסר לבקשת המשתמש */
        }
        html.theme-glass body {
            background: #0d0d0d;
            color: #fff;
            text-shadow: 0 1px 4px rgba(0,0,0,0.6);
        }
        /* Main static glass elements */
        html.theme-glass .card, 
        html.theme-glass .modal-content, 
        html.theme-glass #sidebar,
        html.theme-glass .bg-gray-800,
        html.theme-glass #search-input,
        html.theme-glass .detail-header,
        html.theme-glass .lang-select,
        html.theme-glass .bg-gray-900,
        html.theme-glass .bg-gray-900\/50,
        html.theme-glass .progress-bar-container,
        html.theme-glass #cookie-consent-banner,
        html.theme-glass .achievement-progress-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        /* More specific style for glass theme dropdown for better readability */
        html.theme-glass .more-options-dropdown,
        html.theme-glass #tools-dropdown-menu {
            background: rgba(30, 30, 40, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        }
        /* Override solid colors for interactive elements */
        html.theme-glass .bg-red-600,
        html.theme-glass .bg-purple-600,
        html.theme-glass .bg-green-600,
        html.theme-glass .bg-blue-600,
        html.theme-glass .bg-gray-600,
        html.theme-glass .bg-gray-700,
        html.theme-glass .bg-teal-600,
        html.theme-glass .sidebar-link.active,
        html.theme-glass .sidebar-dropdown-toggle.active,
        html.theme-glass #back-to-top-btn,
        html.theme-glass .bg-white {
            background: rgba(255, 255, 255, 0.12) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }
        /* Override hover states for interactive elements */
        html.theme-glass .bg-red-700:hover,
        html.theme-glass .sidebar-link:hover,
        html.theme-glass .sidebar-dropdown-toggle:hover,
        html.theme-glass .bg-purple-700:hover,
        html.theme-glass .bg-green-700:hover,
        html.theme-glass .bg-blue-700:hover,
        html.theme-glass .bg-gray-700:hover,
        html.theme-glass .bg-teal-700:hover,
        html.theme-glass #back-to-top-btn:hover,
        html.theme-glass .hover\:bg-gray-200:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }
        html.theme-glass .more-options-dropdown a:hover,
        html.theme-glass .more-options-dropdown button:hover,
        html.theme-glass #tools-dropdown-menu button:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }
        /* Text and icon colors */
        html.theme-glass h1, html.theme-glass h2, html.theme-glass h3, html.theme-glass h4,
        html.theme-glass .text-red-600, html.theme-glass .text-red-500,
        html.theme-glass #sidebar #nav-title, html.theme-glass .text-gray-400, html.theme-glass .text-gray-300,
        html.theme-glass .text-black,
        html.theme-glass .gemini-icon-color {
             color: #fff !important;
        }
        html.theme-glass ::placeholder {
            color: #e5e7eb !important;
            opacity: 1;
        }
        html.theme-glass .loading-spinner { border-top-color: #fff; }

        /* Accessibility Styles */
        html.high-contrast body {
            background-color: black;
            color: white;
        }
        html.high-contrast .card, html.high-contrast .modal-content, html.high-contrast .bg-gray-800, html.high-contrast #sidebar, html.high-contrast .bg-gray-900, html.high-contrast #search-input, html.high-contrast .detail-header, html.high-contrast .bg-gray-700 {
            background-color: black !important;
            color: white !important;
            border: 2px solid white !important;
        }
        html.high-contrast .text-red-600, html.high-contrast .text-red-500, html.high-contrast #sidebar #nav-title {
            color: yellow !important;
        }
        html.high-contrast .bg-red-600, html.high-contrast .bg-red-700 {
            background-color: black !important;
            color: yellow !important;
            border: 2px solid yellow !important;
        }
        html.high-contrast button:hover, html.high-contrast a:hover {
            background-color: #333 !important;
        }
        html.high-contrast .text-gray-400, html.high-contrast .text-gray-300, html.high-contrast .text-white, html.high-contrast #sidebar a, html.high-contrast #sidebar span, html.high-contrast #sidebar svg {
            color: white !important;
        }
        html.high-contrast .sidebar-link.active,
        html.high-contrast .sidebar-dropdown-toggle.active,
        html.high-contrast .sidebar-link:hover,
        html.high-contrast .sidebar-dropdown-toggle:hover {
            background-color: black !important;
            border: 2px solid yellow !important;
        }
        html.high-contrast .sidebar-link.active span, 
        html.high-contrast .sidebar-link.active svg,
        html.high-contrast .sidebar-dropdown-toggle.active span, 
        html.high-contrast .sidebar-dropdown-toggle.active svg,
        html.high-contrast .sidebar-link:hover span, 
        html.high-contrast .sidebar-link:hover svg,
        html.high-contrast .sidebar-dropdown-toggle:hover span, 
        html.high-contrast .sidebar-dropdown-toggle:hover svg {
            color: yellow !important;
        }
        html.high-contrast .loading-spinner {
            border-top-color: yellow;
        }
        html.high-contrast .accent-red-600 {
            accent-color: yellow;
        }

        html.reduced-motion *,
        html.reduced-motion *::before,
        html.reduced-motion *::after {
            animation-duration: 1ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 1ms !important;
            scroll-behavior: auto !important;
        }

        html.underline-links a,
        html.underline-links button {
            text-decoration: underline !important;
            text-underline-offset: 4px;
        }

        /* Onboarding styles */
        .genre-button, .age-button {
            border: 2px solid #4a5568; /* border-gray-600 */
            transition: all 0.2s ease-in-out;
        }
        .genre-button.selected, .age-button.selected {
            border-color: #e50914; /* border-red-600 */
            background-color: rgba(229, 9, 20, 0.2);
            transform: scale(1.05);
        }
        html.theme-light .genre-button.selected, html.theme-light .age-button.selected {
            border-color: #e50914;
            background-color: rgba(229, 9, 20, 0.1);
        }

        /* Back to Top Button */
        #back-to-top-btn {
            position: fixed;
            bottom: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s ease-in-out;
            z-index: 45; /* Below sidebar overlay but above content */
            transform: translateY(20px);
            /* שינוי: תמיד בצד שמאל כדי לא להפריע לצ'אט */
            left: 20px !important;
            right: auto !important;
        }
        /* נמחק: כללי כיוון ספציפיים לכפתור חזרה למעלה כי כעת הוא קבוע בשמאל */
        
        #back-to-top-btn.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* --- NEW ANIMATIONS --- */

        /* Enhanced button and card press feedback */
        button, .sidebar-link, .card {
            /* Adding a transition for the active state */
            transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        button:active, .sidebar-link:active {
            transform: scale(0.96); /* Press down effect */
        }
        .card:active {
            transform: scale(1.02); /* Slight scale effect on click */
        }

        /* --- NEW: Cool Pop-in Animation --- */
        @keyframes popInCard {
            0% {
                opacity: 0;
                transform: scale(0.85) translateY(30px);
                filter: blur(8px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
                filter: blur(0);
            }
        }

        .scroll-animate {
            opacity: 0;
            will-change: transform, opacity, filter;
        }

        .scroll-animate.visible {
            animation: popInCard 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* Staggered delay for grid items using animation-delay */
        .grid .scroll-animate:nth-child(1) { animation-delay: 0.05s; }
        .grid .scroll-animate:nth-child(2n) { animation-delay: 0.1s; }
        .grid .scroll-animate:nth-child(3n) { animation-delay: 0.15s; }
        .grid .scroll-animate:nth-child(4n) { animation-delay: 0.2s; }
        .grid .scroll-animate:nth-child(5n) { animation-delay: 0.25s; }

        @keyframes pulse-selector {
            0%, 100% {
                box-shadow: 0 0 20px #e50914, inset 0 0 15px rgba(239, 68, 68, 0.4);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 35px #ff3838, inset 0 0 25px rgba(255, 56, 56, 0.6);
                transform: scale(1.02);
            }
        }

        /* Roulette Selector Style */
        .roulette-selector {
            border-y: 3px solid #e50914;
            position: relative;
            border-radius: 8px;
            animation: pulse-selector 2s infinite ease-in-out;
            transition: all 0.3s ease; /* Add transition for smoothness */
        }
        .roulette-selector::before, .roulette-selector::after {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border-top: 12px solid transparent;
            border-bottom: 12px solid transparent;
            filter: drop-shadow(0 0 6px #e50914);
        }
        html[dir="ltr"] .roulette-selector::before { left: -15px; border-right: 12px solid #e50914; }
        html[dir="ltr"] .roulette-selector::after { right: -15px; border-left: 12px solid #e50914; }
        html[dir="rtl"] .roulette-selector::before { right: -15px; border-left: 12px solid #e50914; }
        html[dir="rtl"] .roulette-selector::after { left: -15px; border-right: 12px solid #e50914; }

        /* Skeleton Loader Animation */
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }
        .skeleton-loader {
            position: relative;
            overflow: hidden;
            background-color: #374151; /* gray-700 */
        }
        .skeleton-loader::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.2) 20%,
                rgba(255, 255, 255, 0.5) 60%,
                rgba(255, 255, 255, 0)
            );
            animation: shimmer 1.5s infinite;
        }
        html.theme-light .skeleton-loader {
            background-color: #e5e7eb; /* gray-200 */
        }
        html.theme-light .skeleton-loader::after {
             background-image: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0) 0,
                rgba(255, 255, 255, 0.4) 20%,
                rgba(255, 255, 255, 0.8) 60%,
                rgba(255, 255, 255, 0)
            );
        }

        /* Sport 5 Logo Themed Border */
        .sport5-logo { border-color: #444; }
        html.theme-light .sport5-logo { border-color: #e0e0e0; }
        html.theme-glass .sport5-logo { border-color: rgba(255, 255, 255, 0.15); }
        html.high-contrast .sport5-logo { border-color: white !important; border-width: 2px !important; }

        .multi-channel-tag {
            background-color: #e50914;
            color: white;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
            border-radius: 9999px;
            line-height: 1;
        }
        
        /* NEW: Beta Tag Style */
        .beta-tag {
            background-color: #f59e0b; /* amber-500 */
            color: #000;
            padding: 1px 5px;
            font-size: 0.65rem; /* 10px */
            font-weight: 800; /* extrabold */
            border-radius: 4px; /* rounded-sm */
            line-height: 1;
            text-transform: uppercase;
            margin-inline-start: 8px; /* margin-left/right based on dir */
        }
        html.theme-light .beta-tag {
            background-color: #d97706; /* amber-600 */
            color: #fff;
        }

        /* NEW: Shorts (TikTok-style) Feed */
        #shorts-feed-container {
            height: calc(100vh - 250px); /* Adjust height based on header/nav */
            scroll-snap-type: y mandatory;
            overflow-y: hidden; /* שונה - בוטלה גלילה ידנית */
            border-radius: 0.5rem; /* rounded-lg */
            background-color: #000;
        }
        .short-item {
            height: 100%; /* Each item takes full container height */
            scroll-snap-align: start;
            position: relative;
            background-color: #000;
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden; /* Ensure iframe corners are rounded */
        }
        .short-item iframe {
            width: 100%;
            height: 100%;
            border: 0;
            object-fit: contain; /* Make video fit within the area */
        }
        .short-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            /* OLD: padding: 1rem; */
            /* OLD: padding-bottom: 2.5rem; */
            height: 50%; /* Cover bottom half */
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); /* Darker gradient */
            z-index: 1;
            pointer-events: none; /* This is just the gradient */
            /* REMOVED: display: flex and other layout styles */
        }
        /* NEW: Container for info (poster + text) */
        .short-info-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            /* OLD: padding: 1rem; */
            /* OLD: padding-bottom: 2.5rem; */
            padding-top: 1rem;
            padding-bottom: 2.5rem; /* Ensure space for progress bar */
            padding-left: 1rem;
            padding-right: 4.5rem; /* NEW: Increased padding for mute button (72px) */
            z-index: 4; /* Above tap overlay */
            pointer-events: none; /* Container is not interactive */
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }
        
        .short-info-container h3, .short-info-container p {
            color: #fff !important; /* Ensure text is white over video */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
        }

        /* NEW: Give poster its own pointer-events */
        .short-info-container img {
            pointer-events: none; /* Poster is not interactive */
        }

        /* REMOVED: Redundant rules for .short-overlay h3, p */

        /* NEW: Shorts Mute Button */
        .short-mute-btn {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            /* OLD: z-index: 3; */
            z-index: 5; /* NEW: Above info container */
            background-color: rgba(0,0,0,0.5);
            color: white;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-out;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            pointer-events: auto; /* Always clickable */
        }
        .short-mute-btn:hover {
            background-color: rgba(0,0,0,0.8);
            transform: scale(1.1);
        }
        .short-mute-btn svg {
            width: 24px;
            height: 24px;
        }

        /* NEW: Shorts Quick Settings Button */
        /* REMOVED .short-settings-btn styles */

        /* NEW: Shorts Quality Menu */
        /* REMOVED .short-quality-menu styles */
        /* END NEW */

        /* NEW: Shorts Progress Bar & Time */
        .short-progress-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px; /* A bit thicker */
            background-color: rgba(255, 255, 255, 0.2);
            /* MODIFIED: Was z-index: 2 */
            z-index: 3; /* Above tap overlay */
            cursor: pointer; 
            pointer-events: auto; 
        }
        .short-progress-fill {
            height: 100%;
            background-color: #e50914;
            transition: width 0.1s linear; /* Smooth fill */
            border-radius: 0 2px 2px 0;
        }
        html[dir="rtl"] .short-progress-fill {
            border-radius: 2px 0 0 2px;
        }
        .short-time-display {
            position: absolute;
            bottom: 0.5rem; /* 8px - above the progress bar */
            left: 1rem; /* 16px */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            /* MODIFIED: Was z-index: 2 */
            z-index: 3; /* Above tap overlay */
            pointer-events: none;
        }
        html[dir="rtl"] .short-time-display {
            left: 1rem; /* שונה */
            right: auto; /* שונה */
        }

        /* --- NEW: Advanced Player Settings & Styles --- */
        
        /* Settings Button Animation */
        .player-settings-btn svg {
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .player-settings-btn.rotate svg {
            transform: rotate(60deg);
            color: #e50914;
        }

        /* Settings Menu Container */
        .player-settings-menu {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 280px;
            background: rgba(20, 20, 20, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            overflow: hidden;
            opacity: 0;
            transform: translateY(15px) scale(0.96);
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 30;
            box-shadow: 0 10px 40px rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            font-family: 'Assistant', sans-serif;
        }
        
        html[dir="rtl"] .player-settings-menu {
             right: auto;
             left: 20px;
        }

        .player-settings-menu.open {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }

        /* Settings Header */
        .settings-menu-header {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .settings-back-btn {
            margin-inline-end: 12px;
            padding: 6px;
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
        }
        .settings-back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Settings Content Views */
        .settings-view {
            display: none; /* Hidden by default */
            flex-direction: column;
            max-height: 320px;
            overflow-y: auto;
        }
        .settings-view.active {
            display: flex;
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Scrollbar for menu */
        .settings-view::-webkit-scrollbar { width: 4px; }
        .settings-view::-webkit-scrollbar-track { background: transparent; }
        .settings-view::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }

        /* Menu Items */
        .settings-menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            color: #eee;
            transition: all 0.2s;
            font-size: 0.95rem;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            position: relative;
            overflow: hidden;
        }
        .settings-menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
            padding-inline-start: 20px; /* Slight movement effect */
        }
        .settings-menu-item:last-child { border-bottom: none; }
        
        .settings-menu-item .label {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .settings-menu-item .value-container {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #aaa;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Active State (Checkmark) */
        .settings-menu-item.selected {
            color: #fff;
            background: linear-gradient(90deg, rgba(229, 9, 20, 0.2), transparent);
            border-left: 3px solid #e50914; /* LTR default */
        }
        html[dir="rtl"] .settings-menu-item.selected {
            border-left: none;
            border-right: 3px solid #e50914;
        }
        
        .settings-menu-item.selected .value-container {
            color: #e50914;
        }
        
        /* Icons */
        .settings-icon { width: 20px; height: 20px; opacity: 0.9; }
        .chevron-icon { width: 16px; height: 16px; opacity: 0.6; }
        .check-icon { width: 18px; height: 18px; opacity: 0; transition: opacity 0.2s, transform 0.2s; transform: scale(0.5); }
        .settings-menu-item.selected .check-icon { opacity: 1; transform: scale(1); color: #e50914; }

        /* --- End New Player Styles --- */

        /* NEW: Scrollable full description */
        /* MODIFIED: Changed selector */
        .short-info-container p.full-description {
            max-height: 100px; /* 4-5 lines */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #e50914 #333;
            /* pointer-events: auto; */ /* Replaced by rule below */
            white-space: normal; /* Ensure text wraps */
        }
        /* NEW: Make text container scrollable, not just the p */
        /* MODIFIED: Changed selector */
        .short-info-container .short-text-container {
            pointer-events: auto;
        }
        /* MODIFIED: Changed selector */
        .short-info-container p.full-description::-webkit-scrollbar {
            width: 5px;
        }
        /* MODIFIED: Changed selector */
        .short-info-container p.full-description::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }
        /* MODIFIED: Changed selector */
        .short-info-container p.full-description::-webkit-scrollbar-thumb {
            background-color: #e50914;
            border-radius: 20px;
        }
        
        /* END NEW */

        /* NEW: Shorts Play/Pause tap overlay */
        .short-tap-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2; /* Above gradient, below info */
            cursor: pointer;
        }

        /* NEW: Play/Pause Icon (shown on tap) */
        .short-play-pause-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            z-index: 2;
            width: 70px;
            height: 70px;
            background-color: rgba(0,0,0,0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            opacity: 0;
            pointer-events: none; /* Icon itself isn't clickable */
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }
        .short-play-pause-icon.show-icon {
            transform: translate(-50%, -50%) scale(1.1); /* שונה: קנה מידה גדול יותר */
            opacity: 1;
        }
        .short-play-pause-icon.fade-out-icon { /* NEW: Class for fade out */
             transform: translate(-50%, -50%) scale(1);
             opacity: 0;
        }
        
        /* NEW: Shorts Nav Buttons fade */
        #shorts-prev-btn, #shorts-next-btn {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #shorts-view .group:hover #shorts-prev-btn,
        #shorts-view .group:hover #shorts-next-btn,
        #shorts-prev-btn:focus,
        #shorts-next-btn:focus {
            opacity: 1;
        }
        
        /* END NEW */

        /* NEW Custom TV Player Controls */
        .control-btn svg {
            color: white;
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .control-btn:hover svg {
            transform: scale(1.15);
            color: #e50914;
        }
        .volume-slider {
            accent-color: #e50914;
            cursor: pointer;
        }
        #volume-container:hover .volume-slider {
            width: 6rem; /* 96px */
            opacity: 1;
        }

        /* NEW Cast Button Style */
        google-cast-launcher {
            width: 40px;
            height: 40px;
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out;
            cursor: pointer;
            /* Force the icon to be white using filters, a more robust method */
            filter: invert(1) brightness(2) drop-shadow(0 1px 2px rgba(0,0,0,0.5));
        }
        google-cast-launcher:hover {
            transform: scale(1.15);
        }
        google-cast-launcher.casting {
            --cast-sender-connected-icon-color: #e50914; /* Red when casting */
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.5)); /* Remove invert/brightness when casting */
        }

        /* NEW Rule for controls visibility */
        #tv-view .group:hover #custom-controls-container,
        #tv-view .group.controls-visible #custom-controls-container {
            opacity: 1;
        }

        /* TV View specific styles */
        #tv-view-container {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .channel-item {
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: 1px solid transparent;
        }

        .channel-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            transform: translateX(-4px);
        }
        html[dir="ltr"] .channel-item:hover {
            transform: translateX(4px);
        }

        .channel-item.active {
            background-color: rgba(229, 9, 20, 0.2);
            border-color: #e50914;
            box-shadow: 0 0 10px rgba(229, 9, 20, 0.5);
        }

        #tv-channels-list {
            scrollbar-width: thin;
            scrollbar-color: #e50914 #333;
        }

        #tv-channels-list::-webkit-scrollbar {
            width: 8px;
        }
        #tv-channels-list::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        #tv-channels-list::-webkit-scrollbar-thumb {
            background-color: #e50914;
            border-radius: 10px;
            border: 2px solid #333;
        }

        /* NEW: EPG List Styles */
        #tv-epg-list {
            scrollbar-width: thin;
            scrollbar-color: #e50914 #333;
        }
        #tv-epg-list::-webkit-scrollbar {
            width: 8px;
        }
        #tv-epg-list::-webkit-scrollbar-track {
            background: #333;
            border-radius: 10px;
        }
        #tv-epg-list::-webkit-scrollbar-thumb {
            background-color: #e50914;
            border-radius: 10px;
            border: 2px solid #333;
        }
        .epg-item {
            background-color: rgba(255, 255, 255, 0.03); /* שונה */
            padding: 0.75rem 1rem; /* שונה */
            border-radius: 0; /* שונה */
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* חדש */
            transition: all 0.2s ease-in-out;
            /* הוסר: border-right: 4px solid transparent; */
        }

        /* חדש: אפקט ריחוף לפריטים שאינם נוכחיים */
        .epg-item:not(.current):hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* נמחק: הכלל הישן עבור LTR */
        /* html[dir="ltr"] .epg-item { ... } */

        .epg-item.current {
            background-color: rgba(229, 9, 20, 0.15); /* שונה */
            border-bottom-color: rgba(229, 9, 20, 0.4); /* שונה */
            border-right: 4px solid #e50914; /* חדש */
        }
        
        /* חדש: כלל LTR עבור פריט נוכחי */
        html[dir="ltr"] .epg-item.current {
            border-left: 4px solid #e50914;
            border-right: 0;
        }

        /* חדש: עיגול פינות לפריט הראשון והאחרון בכל קבוצת יום */
        .epg-day-header + .epg-item {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .epg-item:last-child {
            border-bottom: 0; /* לפריט האחרון אין קו תחתון */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }


        /* NEW: EPG Item with background image */
        .epg-item-with-image {
            /* הוסרו סגנונות כיוון שתכונת TMDB נמחקה */
        }
        .epg-item-with-image > * {
            /* הוסרו סגנונות */
        }
        .epg-item-with-image::before {
            /* הוסרו סגנונות */
        }
        .epg-item-with-image span, .epg-item-with-image p {
            /* הוסרו סגנונות */
        }
        /* END NEW */
        
        html.theme-glass .epg-item.current {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* NEW: EPG Day Header Light Theme */
        html.theme-light .epg-day-header {
            background-color: rgba(240, 242, 245, 0.8) !important; /* theme-light body bg with opacity */
            border-color: #e50914 !important; /* Changed from e0e0e0 to red */
            color: #d90429 !important; /* A slightly darker red for light bg */
        }

        /* Glass theme adjustments for TV view */
        html.theme-glass #tv-view-container {
             background: rgba(255, 255, 255, 0.08);
             border: 1px solid rgba(255, 255, 255, 0.15);
        }
        html.theme-glass .channel-item.active {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
            box-shadow: none;
        }

        /* Fullscreen TV AI Summary styles */
        #tv-ai-info-container.fullscreen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            margin-top: 0;
            z-index: 10;
            pointer-events: none;
            background: rgba(0,0,0,0.6);
            padding: 0.5rem 1rem;
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container {
            padding: 0.5rem;
            background: transparent;
            border: none;
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container p {
            display: none; /* Hide description */
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container .w-14,
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container .h-14 {
            width: 2.5rem; /* 40px */
            height: 2.5rem; /* 40px */
            font-size: 1.25rem;
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container .text-lg {
            font-size: 0.875rem; /* text-sm */
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container .text-5xl {
            font-size: 1.875rem; /* text-3xl */
        }
        #tv-ai-info-container.fullscreen-overlay .scoreboard-container .text-2xl {
            font-size: 1.125rem; /* text-lg */
        }
        #tv-ai-info-container.fullscreen-overlay h4 {
            font-size: 1.125rem; /* text-lg */
        }
        #tv-ai-info-container.fullscreen-overlay p {
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }
        #tv-ai-info-container.fullscreen-overlay .text-xs {
            display: none; /* Hide disclaimer in fullscreen */
        }
        #tv-ai-info-container.fullscreen-overlay #ai-timer-container {
            display: none; /* Hide timer in fullscreen */
        }

        /* NEW: Recording Button Style */
        #record-video-btn.recording svg {
            color: #e50914; /* Red color */
            animation: pulse-record 1.2s infinite ease-in-out;
        }
        @keyframes pulse-record {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Flixy AI Chat Styles */
        .flixy-fab {
            display: none; /* Hide original FAB styles */
        }
        
        /* Updated Flixy Window UI */
        .flixy-window {
            position: fixed;
            bottom: 20px; /* MODIFIED: Lowered to 20px since FAB is gone */
            right: 20px; /* תמיד בצד ימין */
            left: auto;
            width: 360px; /* קצת רחב יותר */
            max-width: calc(100vw - 40px);
            height: 550px; /* קצת גבוה יותר */
            max-height: 70vh;
            background-color: rgba(17, 24, 39, 0.95); /* gray-900 with high opacity */
            backdrop-filter: blur(12px); /* אפקט זכוכית */
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px; /* פינות עגולות יותר */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            z-index: 49;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform-origin: bottom right;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: scale(0.9) translateY(20px);
            pointer-events: none;
            font-family: 'Assistant', sans-serif;
        }

        .flixy-window.open {
            opacity: 1;
            transform: scale(1) translateY(0);
            pointer-events: auto;
        }

        /* Messages Area styling */
        .flixy-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            scrollbar-width: thin;
            scrollbar-color: #4b5563 transparent;
            background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .flixy-message {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            font-size: 0.95rem;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
        }

        .flixy-message.user {
            align-self: flex-end; 
            background: linear-gradient(135deg, #e50914 0%, #ff4f4f 100%);
            color: white;
            border-bottom-left-radius: 1.25rem;
            border-bottom-right-radius: 0.25rem;
        }
        /* Fix RTL/LTR corners */
        html[dir="rtl"] .flixy-message.user { align-self: flex-start; border-bottom-left-radius: 1.25rem; border-bottom-right-radius: 0.25rem; }
        html[dir="ltr"] .flixy-message.user { align-self: flex-end; border-bottom-right-radius: 0.25rem; border-bottom-left-radius: 1.25rem; }

        .flixy-message.bot {
            background-color: rgba(55, 65, 81, 0.8); /* gray-700 */
            color: #f3f4f6;
            border: 1px solid rgba(255,255,255,0.05);
        }
        html[dir="rtl"] .flixy-message.bot { align-self: flex-end; border-bottom-right-radius: 1.25rem; border-bottom-left-radius: 0.25rem; }
        html[dir="ltr"] .flixy-message.bot { align-self: flex-start; border-bottom-left-radius: 0.25rem; border-bottom-right-radius: 1.25rem; }

        /* Typing Dot Animation */
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* --- NEW: Premium Card Design (No Buttons) --- */
        .card {
            background-color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            aspect-ratio: 2/3;
            border: 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateZ(0); /* Hardware acceleration */
            cursor: pointer;
        }
        .card:hover {
            transform: scale(1.05) translateZ(0);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            z-index: 20;
        }
        .card-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1), filter 0.3s ease;
        }
        .card:hover .card-poster {
            transform: scale(1.12);
            filter: brightness(0.5); /* כהה יותר לקריאות טקסט */
        }
        /* Base gradient for non-hover state title visibility */
        .card-base-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.5) 50%, transparent 100%);
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .card:hover .card-base-overlay {
            opacity: 0;
        }
        /* Hover overlay with full info */
        .card-hover-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 40%, rgba(0,0,0,0.2) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 1.5rem;
            pointer-events: none;
        }
        .card:hover .card-hover-overlay {
            opacity: 1;
        }
        .card-title-base {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            right: 1rem;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            transition: opacity 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
            text-align: center;
        }
        .card:hover .card-title-base {
            opacity: 0;
        }
        /* Elements inside hover overlay */
        .card-content {
            transform: translateY(20px);
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            width: 100%;
        }
        .card:hover .card-content {
            transform: translateY(0);
        }
        .card-title-hover {
            color: white;
            font-weight: 800;
            font-size: 1.25rem;
            line-height: 1.1;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .card-meta {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: #d1d5db;
            margin-bottom: 0.75rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.1s;
            font-weight: 500;
        }
        .card:hover .card-meta {
            opacity: 1;
            transform: translateY(0);
        }
        .card-desc {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.5;
            margin-bottom: 0;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease 0.15s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .card:hover .card-desc {
            opacity: 1;
            transform: translateY(0);
        }

    </style>
</head>
<body class="p-2 sm:p-8">
    <div class="flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed top-0 right-0 bottom-0 transform translate-x-full w-72 bg-gray-900 text-white p-4 transition-transform duration-300 ease-in-out z-50 flex flex-col">
            <div class="flex justify-between items-center">
                <h2 id="nav-title" class="text-2xl font-bold text-red-600"></h2>
                <div class="flex items-center gap-4">
                    <!-- NEW: Flixy Sidebar Button (SVG Icon Style) -->
                    <button id="sidebar-flixy-btn" class="relative text-gray-400 hover:text-white transition-transform hover:scale-110 focus:outline-none" title="Flixy AI">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                        </svg>
                    </button>

                    <a href="#settings" id="sidebar-settings-shortcut" class="sidebar-link text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </a>
                    <button id="close-sidebar-btn" class="text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="sidebar-greeting" class="text-center text-lg text-gray-400 mt-4"></div>
            <nav class="mt-8 flex-1 overflow-y-auto min-h-0">
                <ul>
                    <li><a href="#home" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-home-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                        <span id="nav-home"></span>
                    </a></li>
                    <li><a href="#movies" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-movies-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55-2.275a1 1 0 011.45.894v6.762a1 1 0 01-1.45.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        <span id="nav-movies"></span>
                    </a></li>
                    <li><a href="#series" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-series-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"></path></svg>
                        <span id="nav-series"></span>
                    </a></li>
                    <!-- Discover Dropdown -->
                    <li>
                        <button class="sidebar-dropdown-toggle flex items-center justify-between w-full py-2.5 px-4 rounded transition duration-200 hover:bg-red-600">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                </svg>
                                <span data-translate="discover"></span>
                            </div>
                            <svg class="w-4 h-4 transition-transform chevron-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <ul class="sidebar-submenu">
                             <li><a href="#cinemas" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-cinemas-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5h14a2 2 0 012 2v3a2 2 0 000 4v3a2 2 0 01-2 2H5a2 2 0 01-2-2v-3a2 2 0 000-4V7a2 2 0 012-2z"></path></svg>
                                <span id="nav-cinemas"></span>
                            </a></li>
                            <li><a href="#new-releases" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-new-releases-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                </svg>
                                <span id="nav-new-releases"></span>
                            </a></li>
                            <li><a href="#shorts" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-shorts-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span id="nav-shorts"></span>
                            </a></li>
                            <li><a href="#tv" class="sidebar-link hidden flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-tv-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                </svg>
                                <span id="nav-tv-channels"></span>
                            </a></li>
                        </ul>
                    </li>

                    <!-- My Zone Dropdown -->
                    <li>
                        <button class="sidebar-dropdown-toggle flex items-center justify-between w-full py-2.5 px-4 rounded transition duration-200 hover:bg-red-600">
                            <div class="flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <span data-translate="myZone"></span>
                            </div>
                            <svg class="w-4 h-4 transition-transform chevron-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                        <ul class="sidebar-submenu">
                            <li><a href="#library" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-library-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg>
                                <span id="nav-library"></span>
                            </a></li>
                            <li><a href="#watched" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-watched-link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        <span id="nav-watched"></span>
                    </a></li>
                    <li><a href="#achievements" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-achievements-link">
                        

<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                           <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
                           <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z" />
                        </svg>
                        <span id="nav-achievements"></span>
                    </a></li>
                            <li><a href="#plugins" class="sidebar-link flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600" id="nav-plugins-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
                                </svg>
                                <span id="nav-plugins"></span>
                            </a></li>
                        </ul>
                    </li>
                    
                    <li><a href="#" id="install-app-link" class="sidebar-link hidden flex items-center gap-3 block py-2.5 px-4 rounded transition duration-200 hover:bg-red-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        <span id="nav-install"></span>
                    </a></li>
                </ul>
            </nav>
        </aside>

        <!-- Overlay for mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black opacity-50 hidden z-40"></div>
        
        <!-- Main Content -->
        <main class="flex-1 transition-all duration-300">
            <div class="max-w-7xl mx-auto">
                <header class="mb-8 flex items-center justify-between">
                    <!-- Hamburger Menu for mobile -->
                    <button id="menu-toggle-btn" class="text-gray-400 hover:text-white p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-4 6h4" />
                        </svg>
                    </button>

                    <div class="text-center flex-grow flex flex-col items-center">
                        <a href="#home" id="main-title-link" class="flex items-center gap-2 sm:gap-4 text-red-600 cursor-pointer">
                            <svg id="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8 sm:w-12 sm:h-12 text-red-600">
                                <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd"></path>
                                <path fill="#fff" d="M10.5 7.5a3 3 0 100 6 3 3 0 000-6z"></path>
                                <path fill="#fff" d="M12 9a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"></path>
                                <path fill="#e50914" d="M9.75 8.25L14.25 10.5L9.75 12.75V8.25z"></path>
                            </svg>
                            <h1 id="main-title" class="text-3xl sm:text-6xl font-bold">Find-Flix</h1>
                        </a>
                        <p id="main-subtitle" class="text-base sm:text-2xl text-gray-400"></p>
                    </div>

                    <div class="w-10"></div> <!-- Spacer for mobile header -->
                </header>

                <!-- Main Content View -->
                <div id="main-view">
                    <h2 id="page-title" class="text-4xl font-bold text-center mb-8 text-white"></h2>
                    <!-- Search & Recommendation Section -->
                    <div class="mb-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                        <div class="relative rounded-full overflow-hidden w-full max-w-lg">
                             <input type="text" id="search-input"
                                class="w-full py-2 sm:py-3 bg-gray-800 text-white placeholder-gray-400 rounded-full focus:outline-none focus:ring-2 focus:ring-red-600 border border-gray-700"
                                placeholder="">
                            <div id="search-icon-container" class="absolute inset-y-0 flex items-center text-gray-400 pointer-events-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <button id="clear-search-btn" class="absolute inset-y-0 hidden items-center text-gray-400 hover:text-white transition-colors focus:outline-none">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div id="genre-filter-container" class="relative w-full sm:w-auto">
                            <select id="genre-filter" class="lang-select rounded-full font-bold transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-600 w-full py-2 sm:py-3 text-center">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <!-- Tools Dropdown -->
                        <div id="tools-dropdown-container" class="relative">
                            <button id="tools-dropdown-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-red-600 text-white font-bold rounded-full transition-colors hover:bg-red-700 w-full sm:w-auto flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z"/>
                                  </svg>
                                <span id="tools-btn-text"></span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </button>
                            <div id="tools-dropdown-menu" class="hidden absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none z-20">
                                <div class="py-1">
                                    <button id="show-recommendation-btn" class="w-full text-right px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                          <path fill-rule="evenodd" d="M5 5a3 3 0 013-3h4a3 3 0 013 3v1h1a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h1V5zM4 13h12v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2zM8 8a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                                        </svg>
                                        <span id="surprise-me-btn-text"></span>
                                    </button>
                                    <button id="show-ai-recommender-btn" class="w-full text-right px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                                        <span id="ai-recommender-btn-text"></span>
                                    </button>
                                    <button id="show-roulette-btn" class="w-full text-right px-4 py-2 text-sm text-gray-200 hover:bg-gray-700 flex items-center gap-3">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.002 6.002 0 0110.126-1.54l-1.423 1.424a4.002 4.002 0 00-6.28 3.033l-2.423-2.917zM15.668 11.973a6.002 6.002 0 01-10.126 1.54l1.423-1.424a4.002 4.002 0 006.28-3.033l2.423 2.917zM10 12a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                                        </svg>
                                        <span id="roulette-tool-text"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendation Roulette Section -->
                    <div id="roulette-section" class="mb-12 hidden">
                        <h3 id="roulette-title" class="text-2xl font-bold text-center mb-6 text-red-500"></h3>
                        <div class="flex justify-center">
                            <button id="roulette-start-btn" class="bg-gradient-to-br from-red-600 to-purple-600 text-white font-bold py-4 px-8 rounded-full text-xl flex items-center gap-3 transition-transform hover:scale-105 shadow-lg shadow-red-500/30">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v4a1 1 0 001 1h12a1 1 0 001-1v-4a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM8 8a2 2 0 114 0H8z" />
                                </svg>
                                <span id="roulette-start-btn-text"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Content Grid & Loading State -->
                    <div id="loading-message" class="text-center text-red-500 font-bold hidden">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        טוען נתונים...
                    </div>
                    <div id="content-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                        <!-- Content cards will be inserted here by JavaScript -->
                    </div>
                    <div id="scroll-loading-message" class="text-center text-red-500 font-bold hidden my-4">
                        <div class="loading-spinner mx-auto mb-2"></div>
                        טוען עוד תכנים...
                    </div>
                </div>

                <!-- Cinemas View (Initially Hidden) -->
                <div id="cinemas-view" class="hidden">
                    <h2 id="cinemas-title" class="text-4xl font-bold text-center mb-8 text-white"></h2>
                    <div id="cinemas-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                        <!-- "Now in Cinemas" content cards will be inserted here -->
                    </div>
                </div>

                <!-- New Releases View (Initially Hidden) -->
                <div id="new-releases-view" class="hidden">
                    <h2 id="new-releases-title" class="text-4xl font-bold text-center mb-8 text-white"></h2>
                    <div id="new-releases-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                        <!-- New releases content cards will be inserted here -->
                    </div>
                </div>

                <!-- Library View (Initially Hidden) -->
                <div id="library-view" class="hidden">
                    <h2 id="library-title" class="text-4xl font-bold text-center mb-4 text-white"></h2>
                    <div id="library-notice" class="bg-blue-900/50 text-blue-200 border border-blue-700 rounded-lg p-4 text-center mb-8"></div>
                    <div id="library-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                        <!-- Saved content cards will be inserted here -->
                    </div>
                </div>

                <!-- Watched View (Initially Hidden) -->
                <div id="watched-view" class="hidden">
                    <h2 id="watched-title" class="text-4xl font-bold text-center mb-4 text-white"></h2>
                    <div id="watched-notice" class="bg-blue-900/50 text-blue-200 border border-blue-700 rounded-lg p-4 text-center mb-4"></div>
                    <div id="watched-notice-extra" class="bg-amber-900/50 text-amber-200 border border-amber-700 rounded-lg p-4 text-center mb-8"></div>
                    <div id="watched-grid" class="grid grid-cols-2 sm:grid-cols-2 md-grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                        <!-- Watched content cards will be inserted here -->
                    </div>
                </div>

                <!-- Achievements View (Initially Hidden) -->
                <div id="achievements-view" class="hidden">
                    <h2 id="achievements-title" class="text-4xl font-bold text-center mb-8 text-white"></h2>
                    
                    <!-- Streak Hero Section (New) -->
                    <div class="flex flex-col items-center justify-center mb-10">
                        <div class="relative group cursor-default select-none transform hover:scale-105 transition-transform duration-300 mb-6">
                            <!-- Main Pill -->
                            <div class="flex items-center gap-4 px-8 py-3 rounded-full bg-[#251a1a] border border-[#5c3a3a] shadow-[0_4px_20px_rgba(229,9,20,0.15)] relative overflow-hidden">
                                <!-- Background Glow Effect -->
                                <div class="absolute inset-0 bg-gradient-to-r from-orange-500/10 to-red-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                                
                                <span class="text-4xl animate-pulse filter drop-shadow-[0_0_10px_rgba(249,115,22,0.6)]">🔥</span>
                                <div class="flex flex-col items-start">
                                    <span id="streak-days-count" class="text-3xl font-bold text-white leading-none tabular-nums">1</span>
                                    <span class="text-xs text-[#d1d1d1] font-medium tracking-wide uppercase" id="streak-label-text">ימים ברצף</span>
                                </div>
                            </div>
                        </div>
                        <p id="streak-motivation" class="text-gray-400 text-lg italic"></p>
                    </div>

                    <!-- Progress Bar Section -->
                    <div id="achievement-progress-section" class="max-w-xl mx-auto mb-12 bg-gray-800/50 p-6 rounded-xl border border-gray-700">
                        <div class="flex justify-between items-center mb-3">
                            <span id="next-reward-label" class="font-bold text-gray-200">הפרס הבא:</span>
                            <span id="achievement-progress-text" class="font-mono text-red-400"></span>
                        </div>
                        <div class="progress-bar-container h-4 bg-gray-900 border-none">
                            <div id="achievement-progress-fill" class="progress-bar-fill bg-gradient-to-r from-red-700 to-orange-500" style="width: 0%;"></div>
                        </div>
                        <p id="next-reward-desc" class="text-sm text-gray-400 mt-3 text-center"></p>
                    </div>

                    <h3 id="achievements-grid-title" class="text-2xl font-bold text-white mb-6 px-4 border-s-4 border-red-600 me-4">פרסים ואבני דרך</h3>
                    <div id="achievements-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Achievement/Reward cards will be inserted here -->
                    </div>
                </div>

                <!-- Detail View (Initially Hidden) -->
                <div id="detail-view" class="hidden">
                    <div class="detail-header flex items-center justify-between mb-4">
                        <div class="flex items-center gap-4">
                            <button id="back-btn" class="text-gray-400 hover:text-white transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                            </button>
                            <button id="surprise-again-btn" class="px-4 py-2 sm:px-6 sm:py-3 bg-red-600 text-white font-bold rounded-full transition-colors hover:bg-red-700 hidden flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5 5a3 3 0 013-3h4a3 3 0 013 3v1h1a1 1 0 011 1v4a1 1 0 01-1 1H4a1 1 0 01-1-1V7a1 1 0 011-1h1V5zM4 13h12v2a1 1 0 01-1 1H5a1 1 0 01-1-1v-2zM8 8a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd" />
                                </svg>
                                <span id="surprise-again-btn-text"></span>
                            </button>
                        </div>
                        <div class="flex-grow flex justify-center items-center min-w-0">
                             <h2 id="detail-title" class="text-2xl sm:text-4xl font-bold text-center truncate px-4"></h2>
                             <img id="detail-header-logo" src="" alt="Logo" class="hidden h-10 sm:h-14 w-auto">
                        </div>
                        <div class="hidden sm:block sm:w-[196px] flex-shrink-0"></div> <!-- Spacer -->
                    </div>
                    <div id="detail-content-wrapper">
                        <!-- New Layout for Backdrop Image -->
                        <div class="relative w-full aspect-video rounded-lg shadow-lg overflow-hidden mb-6">
                            <img id="detail-image" class="w-full h-full object-cover" src="" alt="">
                            <div class="absolute inset-0 bg-gradient-to-t from-[#0d0d0d] via-transparent to-transparent"></div>
                            <div id="detail-image-banner-container" class="absolute top-4"></div>
                        </div>
                        
                        <div class="px-4 md:px-0">
                            <!-- Header (כותרת, כפתור חזרה וכו') הועבר לכאן -->
                            
                            <!-- NEW: Logo Image (Removed from here) -->
                            <!-- <img id="detail-logo" class="max-h-20 sm:max-h-28 w-auto mb-4" src="" alt="Content Logo" style="display: none;"> -->
                            
                            <div id="detail-meta" class="text-gray-400 mb-4 flex items-center flex-wrap gap-4"></div>
                            <p id="detail-tagline" class="text-xl sm:text-2xl text-gray-300 italic mb-4"></p>
                            <p id="detail-description" class="text-base sm:text-lg text-gray-400 mb-6"></p>
                            <div id="action-buttons-container" class="flex flex-wrap gap-4 mb-6"></div>
                            
                            <!-- Streaming Buttons -->
                            <div id="streaming-buttons-container" class="flex flex-col gap-4 mb-6">
                                <!-- Streaming provider logos will be inserted here dynamically -->
                            </div>
                            
                            <!-- Seasons Section -->
                            <div id="seasons-section">
                                <h3 id="seasons-heading" class="text-2xl font-semibold mb-4 text-red-600"></h3>
                                <div id="seasons-list" class="space-y-4 text-lg">
                                    <!-- Seasons will be inserted here -->
                                </div>
                            </div>

                            <!-- More Like This Section (NEW) -->
                            <div id="recommendations-section" class="mt-12">
                                <h3 id="recommendations-heading" class="text-2xl font-semibold mb-4 text-red-600"></h3>
                                <div id="recommendations-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                                    <!-- Recommendation cards will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Episodes View (Initially Hidden) -->
                <div id="episodes-view" class="hidden">
                     <div class="detail-header flex items-center justify-between mb-4">
                        <button id="back-from-episodes-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <!-- NEW: Container for Title and Season Selector -->
                        <div class="flex-grow flex flex-col sm:flex-row items-center justify-center gap-2 sm:gap-4 min-w-0 px-2">
                            <!-- V16: Add container for logo/title -->
                            <div id="episodes-title-container" class="flex items-center justify-center gap-2 sm:gap-4 min-w-0">
                                <h2 id="episodes-series-title" class="text-2xl sm:text-4xl font-bold text-center truncate"></h2>
                                <!-- NEW: Logo element, similar to detail-header-logo -->
                                <img id="episodes-header-logo" src="" alt="Logo" class="hidden h-10 sm:h-14 w-auto" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));">
                            </div>
                            <!-- V16: New span for season name -->
                            <span id="episodes-season-name" class="text-lg sm:text-2xl text-gray-400 font-semibold whitespace-nowrap"></span>
                        </div>
                        <div class="w-8 flex-shrink-0"></div> <!-- Spacer -->
                    </div>
                    <!-- NEW: Season Overview -->
                    <p id="season-overview" class="text-gray-300 text-base sm:text-lg mb-6 px-4 md:px-0 hidden"></p>
                    <div id="episodes-grid" class="grid gap-6">
                        <!-- Episode cards will be inserted here -->
                    </div>
                </div>

                <!-- Cast View (Initially Hidden) -->
                <div id="cast-view" class="hidden">
                     <div class="detail-header flex items-center justify-between mb-4">
                        <button id="back-from-cast-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <h2 id="cast-title" class="text-2xl sm:text-4xl font-bold text-center flex-grow"></h2>
                        <div class="w-8"></div> <!-- Spacer -->
                    </div>
                    <div id="cast-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 sm:gap-6">
                        <!-- Cast/Crew cards will be inserted here -->
                    </div>
                </div>

                <!-- Person Detail View (Initially Hidden) -->
                <div id="person-view" class="hidden">
                     <div class="detail-header flex items-center justify-between mb-4">
                        <button id="back-from-person-btn" class="text-gray-400 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                        </button>
                        <h2 id="person-name" class="text-2xl sm:text-4xl font-bold text-center flex-grow"></h2>
                        <!-- NEW: Gemini Translate Button -->
                        <button id="translate-person-btn" class="ml-4 p-2 bg-gray-700 text-white rounded-full transition-colors hover:bg-gray-600 flex items-center gap-2" title="Translate Biography">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 gemini-icon-color" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                            <span id="translate-person-btn-text" class="text-sm font-medium hidden sm:block"></span>
                        </button>
                        <div class="w-8"></div> <!-- Spacer -->
                    </div>
                    <div class="flex flex-col md:flex-row gap-8">
                        <div class="w-full md:w-1/3 lg:w-1/4 flex-shrink-0">
                            <img id="person-image" class="w-full h-auto rounded-lg shadow-lg object-cover" src="" alt="">
                        </div>
                        <div class="flex-1">
                            <h3 id="person-bio-heading" class="text-2xl font-semibold mb-2 text-red-600"></h3>
                            <p id="person-bio" class="text-gray-400 mb-4 max-h-60 overflow-y-auto"></p>
                            <div id="person-meta" class="text-gray-300 space-y-2"></div>
                        </div>
                    </div>
                    <div class="mt-12">
                        <h3 id="person-credits-heading" class="text-3xl font-bold mb-6 text-white"></h3>
                        <div id="person-credits-grid" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
                            <!-- Credits cards will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Settings View (Initially Hidden) -->
                <div id="settings-view" class="hidden min-h-screen flex items-start pt-8 sm:pt-16 justify-center">
                    <div class="bg-gray-800 p-4 sm:p-8 rounded-lg shadow-lg w-full max-w-2xl">
                        <div class="flex items-center justify-between mb-6">
                            <h2 id="settings-title" class="text-2xl sm:text-3xl font-bold text-white flex-1 text-center"></h2>
                        </div>
                        <div class="space-y-8">
                            <!-- My Account Section -->
                            <div>
                                <h3 id="settings-account-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="space-y-4">
                                    <!-- REMOVED PREFERENCES BUTTONS HTML -->
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <label class="text-gray-300 text-lg" id="settings-backup-restore-label"></label>
                                        <p id="settings-backup-restore-description" class="text-gray-400 text-sm mt-2 mb-4"></p>
                                        <div class="grid grid-cols-2 gap-3">
                                            <button id="export-data-btn" class="w-full px-4 py-2 bg-green-600 text-white font-bold rounded-full transition-colors hover:bg-green-700"></button>
                                            <button id="import-data-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-full transition-colors hover:bg-blue-700"></button>
                                        </div>
                                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                                    </div>
                                </div>
                            </div>
                            <!-- General Section -->
                            <div>
                                <h3 id="settings-general-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="p-4 bg-gray-900/50 rounded-lg">
                                    <div class="flex items-center justify-between">
                                        <label for="lang-select-settings" class="text-gray-300 text-lg" id="settings-language-label"></label>
                                        <select id="lang-select" class="lang-select rounded-full font-bold transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-600">
                                            <option value="he">🇮🇱 עברית</option>
                                            <option value="en">🇬🇧 English</option>
                                            <option value="ru">🇷🇺 Русский</option>
                                            <option value="ar">🇸🇦 العربية</option>
                                        </select>
                                    </div>
                                    <p id="settings-language-description" class="text-gray-400 text-sm mt-2"></p>
                                    
                                    <!-- Separator and Content Language Selection -->
                                    <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-700">
                                        <label for="tmdb-lang-select" class="text-gray-300 text-lg" id="settings-content-language-label"></label>
                                        <select id="tmdb-lang-select" class="lang-select rounded-full font-bold transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-600 max-w-[200px]">
                                            <option value="" disabled selected>Loading...</option>
                                        </select>
                                    </div>
                                    <p id="settings-content-language-description" class="text-gray-400 text-sm mt-2"></p>
                                </div>
                            </div>
                            <!-- Display Section -->
                            <div>
                                <h3 id="settings-display-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="flex flex-col gap-4">
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="theme-select" class="text-gray-300 text-lg" id="settings-display-mode-label"></label>
                                            <select id="theme-select" class="lang-select rounded-full font-bold transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-600">
                                                <option id="theme-auto-option" value="automatic"></option>
                                                <option id="theme-dark-option" value="dark"></option>
                                                <option id="theme-light-option" value="light"></option>
                                                <option id="theme-starlight-option" value="starlight" class="hidden"></option>
                                                <option id="theme-glass-option" value="glass" class="hidden"></option>
                                            </select>
                                        </div>
                                        <p id="settings-display-mode-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="density-select" class="text-gray-300 text-lg" id="settings-card-density-label"></label>
                                            <select id="density-select" class="lang-select rounded-full font-bold transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-red-600">
                                                <option id="density-compact-option" value="compact"></option>
                                                <option id="density-default-option" value="default"></option>
                                                <option id="density-comfortable-option" value="comfortable"></option>
                                            </select>
                                        </div>
                                        <p id="settings-card-density-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label class="text-gray-300 text-lg" id="settings-custom-font-label"></label>
                                            <div class="flex items-center gap-2">
                                                <button id="upload-font-btn" class="px-3 py-1 bg-blue-600 text-white font-bold rounded-full transition-colors hover:bg-blue-700 text-sm"></button>
                                                <button id="reset-font-btn" class="px-3 py-1 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-gray-700 text-sm"></button>
                                                <input type="file" id="font-file-input" class="hidden" accept=".ttf,.otf,.woff,.woff2">
                                            </div>
                                        </div>
                                        <p id="settings-custom-font-description" class="text-gray-400 text-sm mt-2"></p>
                                        <p class="text-gray-400 text-sm mt-1">
                                            <span id="current-font-label"></span>: <span id="custom-font-name" class="font-semibold text-gray-200"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <!-- Accessibility Section -->
                            <div>
                                <h3 id="settings-accessibility-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="flex flex-col gap-4">
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="font-size-slider" class="text-gray-300 text-lg" id="settings-font-size-label"></label>
                                            <div class="flex items-center gap-4">
                                                <input type="range" id="font-size-slider" min="14" max="20" step="1" class="w-32 accent-red-600">
                                                <button id="reset-font-size-btn" class="px-4 py-1 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-gray-700"></button>
                                            </div>
                                        </div>
                                        <p id="settings-font-size-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="high-contrast-toggle" class="text-gray-300 text-lg" id="settings-high-contrast-label"></label>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="high-contrast-toggle" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                            </label>
                                        </div>
                                        <p id="settings-high-contrast-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="reduced-motion-toggle" class="text-gray-300 text-lg" id="settings-reduced-motion-label"></label>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="reduced-motion-toggle" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                            </label>
                                        </div>
                                        <p id="settings-reduced-motion-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label for="underline-links-toggle" class="text-gray-300 text-lg" id="settings-underline-links-label"></label>
                                            <label class="relative inline-flex items-center cursor-pointer">
                                                <input type="checkbox" id="underline-links-toggle" class="sr-only peer">
                                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                                            </label>
                                        </div>
                                        <p id="settings-underline-links-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Information Section -->
                            <div>
                                <h3 id="settings-information-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="flex flex-col gap-4">
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label class="text-gray-300 text-lg" id="settings-whats-new-label"></label>
                                            <a id="settings-whats-new-btn" href="https://github.com/AMITYEFET/Find-Flix/blob/main/CHANGELOG.md" target="_blank" rel="noopener noreferrer" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-red-700"></a>
                                        </div>
                                        <p id="settings-whats-new-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label class="text-gray-300 text-lg" id="settings-about-label"></label>
                                            <button id="settings-about-btn" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-red-700"></button>
                                        </div>
                                        <p id="settings-about-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center justify-between">
                                            <label class="text-gray-300 text-lg" id="settings-contact-label"></label>
                                            <a id="settings-contact-btn" href="mailto:amityefet262@gmail.com" class="px-4 py-2 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-red-700"></a>
                                        </div>
                                        <p id="settings-contact-description" class="text-gray-400 text-sm mt-2"></p>
                                    </div>
                                </div>
                            </div>
                            <!-- Advanced Settings Section -->
                            <div>
                                <h3 id="settings-advanced-title" class="text-xl font-semibold text-red-500 mb-4 border-b border-gray-600 pb-2"></h3>
                                <div class="flex flex-col gap-4">
                                    <div class="p-4 bg-gray-900/50 rounded-lg">
                                        <div class="flex items-center">
                                            <label for="gemini-api-key-input" class="text-gray-300 text-lg" id="settings-gemini-api-key-label"></label>
                                        </div>
                                        <div class="flex items-center gap-2 mt-2">
                                            <input type="password" id="gemini-api-key-input" class="w-full bg-gray-700 text-white rounded-full px-4 py-2 border border-gray-600 focus:ring-2 focus:ring-red-500 focus:outline-none" placeholder="">
                                            <button id="save-gemini-api-key-btn" class="px-4 py-2 bg-green-600 text-white font-bold rounded-full transition-colors hover:bg-green-700"></button>
                                        </div>
                                        <p id="settings-gemini-api-key-description" class="text-gray-400 text-sm mt-2"></p>
            <p id="settings-gemini-api-key-notice" class="text-amber-400 text-sm mt-2 p-2 bg-amber-900/50 border border-amber-700 rounded-lg"></p>
        </div>
        <!-- NEW: Flixy Toggle -->
        <div class="p-4 bg-gray-900/50 rounded-lg">
            <div class="flex items-center justify-between">
                <label for="flixy-toggle" class="text-gray-300 text-lg" id="settings-flixy-label"></label>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="flixy-toggle" class="sr-only peer">
                    <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                </label>
            </div>
            <p id="settings-flixy-description" class="text-gray-400 text-sm mt-2"></p>
        </div>
    </div>
</div>
                                </div>
                            </div>
                            <!-- My Account Section -->
                        </div>
                    </div>
                </div>

                <!-- Plugins View (Initially Hidden) -->
                <div id="plugins-view" class="hidden">
                    <h2 id="plugins-title" class="text-4xl font-bold text-center mb-8 text-white"></h2>
                    <div id="plugins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Plugin cards will be inserted here -->
                    </div>
                </div>

                <!-- NEW Shorts View (Initially Hidden) -->
                <div id="shorts-view" class="hidden">
                    <h2 id="shorts-title" class="text-4xl font-bold text-center mb-4 text-white"></h2>
                    <!-- NEW: Wrapper for feed and nav buttons -->
                    <div class="relative max-w-md mx-auto group"> <!-- הוספתי 'group' -->
                        <div id="shorts-feed-container" class="shorts-container">
                            <!-- Short items will be inserted here by JS -->
                        </div>
                        <!-- NEW: Prev/Next Buttons -->
                        <!-- שונה: הוזז transition ל-CSS, הוחלף bg-black/40 ב-bg-black/60 לניגודיות טובה יותר -->
                        <button id="shorts-prev-btn" class="absolute top-1/2 -translate-y-1/2 p-2 bg-black/60 text-white rounded-full hover:scale-110 z-10" style="left: 0.5rem;" title="הקודם">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <button id="shorts-next-btn" class="absolute top-1/2 -translate-y-1/2 p-2 bg-black/60 text-white rounded-full hover:scale-110 z-10" style="right: 0.5rem;" title="הבא">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- TV Channels View (Initially Hidden) -->
                <div id="tv-view" class="hidden">
                    <h2 id="tv-title" class="text-4xl font-bold text-center mb-4 text-white"></h2>
                    <div id="tv-channels-down-notice" class="bg-red-900/50 text-red-200 border border-red-700 rounded-lg p-4 text-center mb-8 hidden"></div>
                    <div id="tv-experimental-notice" class="bg-amber-900/50 text-amber-200 border border-amber-700 rounded-lg p-4 text-center mb-8"></div>
                    <div id="tv-view-container">
                        <div class="flex flex-col lg:flex-row gap-8">
                            <div class="lg:flex-1">
                                <div class="relative group aspect-video bg-black rounded-lg overflow-hidden shadow-2xl shadow-black/50 border border-gray-700">
                                    <video id="tv-player" class="w-full h-full" autoplay playsinline></video>
                                    <div id="tv-player-overlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-75 p-4 transition-opacity duration-300">
                                        <div class="text-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-gray-500 mb-4" viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h16a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm2 13h4v2H6v-2zm0-4h4v2H6v-2zm0-4h4v2H6V7zm6 8h8v2h-8v-2zm0-4h8v2h-8v-2zm0-4h8v2h-8V7z"/></svg>
                                            <p id="tv-player-message" class="text-white text-lg font-semibold"></p>
                                        </div>
                                    </div>
                                    <!-- Custom Player Controls -->
                                    <div id="custom-controls-container" class="absolute bottom-0 left-0 right-0 p-2 sm:p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 transition-opacity duration-300 pointer-events-none">
                                        <div class="flex items-center justify-between pointer-events-auto">
                                            <div id="volume-container" class="flex items-center gap-2">
                                                <button id="volume-btn" class="control-btn p-2"></button>
                                                <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="1" class="volume-slider w-0 opacity-0 transition-all duration-300 ease-in-out">
                                            </div>
                                            <div class="flex items-center gap-2 sm:gap-4">
                                                <google-cast-launcher class="control-btn p-2"></google-cast-launcher>
                                                <!-- REVERSED ORDER START -->
                                                <!-- NEW Capture Frame Button (MOVED) -->
                                                <!-- NEW Record Video Button (MOVED) -->
                                                <button id="toggle-ai-summary-btn" class="control-btn p-2" title="הצג/הסתר סיכום AI">
                                                    <svg id="ai-summary-visible-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                    </svg>
                                                    <svg id="ai-summary-hidden-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6" />
                                                    </svg>
                                                </button>
                                                <button id="pip-btn" class="control-btn p-2" title="תמונה בתוך תמונה">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6z" />
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M14 14h4v4h-4v-4z" />
                                                    </svg>
                                                </button>
                                                <button id="fullscreen-btn" class="control-btn p-2" title="מסך מלא">
                                                    <svg id="fullscreen-open-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
                                                    </svg>
                                                    <svg id="fullscreen-close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                                    </svg>
                                                </button>
                                                <!-- REVERSED ORDER END -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="tv-player-controls" class="mt-4 flex justify-center items-center gap-4">
                                    <!-- Buttons moved here -->
                                    <!-- NEW Capture Frame Button -->
                                    <button id="capture-frame-btn" class="control-btn p-2 bg-gray-700/50 rounded-full" title="צלם תמונה">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                                        </svg>
                                    </button>
                                    <!-- NEW Record Video Button -->
                                    <button id="record-video-btn" class="control-btn p-2 bg-gray-700/50 rounded-full" title="הקלט וידאו">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 10l4.55-2.275a1 1 0 011.45.894v6.762a1 1 0 01-1.45.894L15 14M4 18h12a2 2 0 002-2V8a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                    </button>
                                </div>
                                <!-- NEW: Container for dynamic stream/subtitle buttons -->
                                <div id="tv-stream-controls" class="mt-4 flex justify-center items-center flex-wrap gap-2"></div>
                                <!-- NEW Disclaimer Text -->
                                <p id="capture-disclaimer" class="text-xs text-gray-500 text-center mt-2"></p>
                                <!-- NEW: EPG Scroll Button Container -->
                                <div id="epg-scroll-container" class="mt-3 flex justify-center"></div>
                                <!-- NEW AI Info Container -->
                                <div id="tv-ai-info-container" class="mt-4 hidden transition-all duration-300">
                                    <!-- AI content will be injected here -->
                                </div>
                                <!-- NEW Hidden canvas for frame capture -->
                                <canvas id="frame-capture-canvas" class="hidden" width="480" height="270"></canvas>
                            </div>
                            <div class="lg:w-96 flex-shrink-0">
                                 <div class="relative mb-4">
                                    <input type="text" id="tv-channel-search-input" class="w-full bg-gray-700/50 text-white placeholder-gray-400 rounded-full py-2.5 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="">
                                    <div id="tv-search-icon-container" class="absolute inset-y-0 flex items-center pointer-events-none">
                                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                           <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                 </div>
                                 <h3 id="tv-channels-list-title" class="text-xl font-bold mb-4"></h3>
                                 <div id="tv-channels-list" class="h-96 lg:h-[calc(100vh-25rem)] overflow-y-auto space-y-1 pr-2">
                                     <!-- Channel list will be inserted here -->
                                 </div>
                                 <!-- NEW: EPG Disclaimer -->
                                 <div id="epg-disclaimer" class="text-xs text-gray-400 text-center mt-4 px-2 hidden">
                                     <!-- Text will be set by JS -->
                                 </div>
                                 <!-- NEW: Full EPG Container -->
                                 <div id="tv-epg-container" class="mt-2 hidden"> <!-- Changed mt-6 to mt-2 -->
                                     <h3 id="tv-epg-title" class="text-xl font-bold mb-3 px-2"></h3>
                                     <div id="tv-epg-list" class="h-96 overflow-y-auto space-y-2 pr-2">
                                         <!-- EPG items will be inserted here -->
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Trailer Modal -->
    <div id="trailer-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-50">
        <div class="modal-content w-11/12 max-w-4xl rounded-xl overflow-hidden relative fade-in-scale bg-black border border-gray-800 shadow-2xl flex flex-col">
            <div class="relative group w-full aspect-video bg-black">
                <!-- Player Container -->
                <div id="trailer-player-placeholder" class="w-full h-full"></div>
                
                <!-- Close Button (Absolute Top Right) -->
                <button id="close-trailer-btn" class="absolute top-4 right-4 z-20 text-white/80 hover:text-white bg-black/40 hover:bg-black/60 backdrop-blur-sm rounded-full p-2 transition-all duration-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <!-- Center Play/Pause Animation Overlay (Click to toggle) -->
                <div id="trailer-click-overlay" class="absolute inset-0 z-10 cursor-pointer"></div>
                
                <!-- Big Center Play Icon (Optional, shows on pause) -->
                <div id="trailer-center-play" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none opacity-0 transition-opacity duration-300 z-10 bg-black/50 p-4 rounded-full backdrop-blur-sm">
                    <svg class="w-12 h-12 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                </div>

                <!-- NEW: Advanced Settings Menu -->
                <div id="trailer-settings-menu" class="player-settings-menu">
                    <!-- 1. Main Menu View -->
                    <div id="settings-view-main" class="settings-view active">
                        <!-- Loop Entry (New Feature) -->
                        <div class="settings-menu-item" onclick="toggleTrailerLoop()">
                            <div class="label">
                                <svg class="settings-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                <span id="player-loop-label">חזרה אוטומטית</span>
                            </div>
                            <div class="value-container">
                                <span id="current-loop-display">כבוי</span>
                                <svg id="loop-check-icon" class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg>
                            </div>
                        </div>
                        
                        <!-- Speed Entry -->
                        <div class="settings-menu-item" onclick="openSettingsView('speed')">
                            <div class="label">
                                <svg class="settings-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                <span id="player-speed-label">מהירות</span>
                            </div>
                            <div class="value-container">
                                <span id="current-speed-display">רגילה</span>
                                <svg class="chevron-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Speed Selection View -->
                    <div id="settings-view-speed" class="settings-view">
                        <div class="settings-menu-header">
                            <div class="settings-back-btn" onclick="openSettingsView('main')">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </div>
                            <span id="player-speed-title">מהירות</span>
                        </div>
                        <!-- Speed Options -->
                        <div class="settings-menu-item" onclick="setPlayerSpeed(0.25)"><span>0.25</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item" onclick="setPlayerSpeed(0.5)"><span>0.5</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item" onclick="setPlayerSpeed(0.75)"><span>0.75</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item selected" onclick="setPlayerSpeed(1)" id="speed-opt-1"><span id="player-speed-normal-option">רגילה</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item" onclick="setPlayerSpeed(1.25)"><span>1.25</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item" onclick="setPlayerSpeed(1.5)"><span>1.5</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <div class="settings-menu-item" onclick="setPlayerSpeed(2)"><span>2</span><svg class="check-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                    </div>
                </div>
                <!-- End Settings Menu -->

                <!-- Custom Controls Bar -->
                <div id="trailer-controls" class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/90 via-black/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-20 flex flex-col gap-2">
                    <!-- Progress Bar -->
                    <div class="relative w-full h-1.5 bg-gray-600/50 rounded-full cursor-pointer group/progress transition-all hover:h-2.5" id="trailer-progress-container">
                        <div id="trailer-progress-fill" class="absolute top-0 left-0 h-full bg-red-600 rounded-full w-0 transition-all duration-100 ease-linear"></div>
                        <!-- Hover effect line could go here -->
                    </div>

                    <!-- Buttons Row -->
                    <div class="flex items-center justify-between mt-1 select-none">
                        <div class="flex items-center gap-2 sm:gap-4">
                            <!-- Play/Pause -->
                            <button id="trailer-play-btn" class="text-white hover:text-red-500 transition-colors focus:outline-none">
                                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                            </button>

                            <!-- NEW: Replay Button (Replaces Seek Buttons) -->
                            <button onclick="restartTrailer()" class="text-gray-300 hover:text-white transition-colors focus:outline-none" title="נגן מההתחלה">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                            </button>
                            
                            <div class="flex items-center gap-2 group/volume">
                                <button id="trailer-volume-btn" class="text-white hover:text-red-500 transition-colors focus:outline-none">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                                </button>
                                <input type="range" id="trailer-volume-slider" min="0" max="100" value="100" class="w-0 overflow-hidden group-hover/volume:w-24 transition-all duration-300 accent-red-600 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                            </div>

                            <div class="text-xs font-mono text-gray-300 ml-2">
                                <span id="trailer-current-time">0:00</span> / <span id="trailer-duration">0:00</span>
                            </div>
                        </div>

                        <div class="flex items-center gap-2">
                             <!-- NEW: Platform Link Button -->
                             <button onclick="openTrailerOnPlatform()" class="text-white hover:text-red-500 p-2 rounded-full hover:bg-white/10 transition-all focus:outline-none" title="פתח ב-YouTube">
                                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
                             </button>

                             <!-- Settings Button -->
                             <button id="trailer-settings-btn" class="player-settings-btn text-white hover:text-red-500 p-2 rounded-full hover:bg-white/10 transition-all focus:outline-none">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 011.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 01-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.397.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 01.12-1.45l.527-.737c.25-.35.273-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.107-1.204l-.527-.738a1.125 1.125 0 01.12-1.45l.773-.773a1.125 1.125 0 011.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                             </button>
                             <!-- Fixed Fullscreen Button (Clean Vector) -->
                             <button id="trailer-fullscreen-btn" class="text-white hover:text-red-500 p-2 rounded-full hover:bg-white/10 transition-all focus:outline-none">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                             </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- Season Videos Modal (NEW) -->
    <div id="season-videos-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-50">
        <div class="modal-content w-11/12 max-w-4xl rounded-xl p-6 relative bg-gray-900 text-white fade-in-scale max-h-[80vh] overflow-y-auto border border-gray-700 shadow-2xl">
             <button id="close-season-videos-btn" class="absolute top-4 right-4 text-gray-400 hover:text-white z-50 p-2 bg-black/50 rounded-full transition-colors cursor-pointer">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="season-videos-title" class="text-2xl font-bold mb-6 pr-14 text-white sticky top-0 bg-gray-900 z-10 py-2 border-b border-gray-800"></h3>
            <div id="season-videos-content" class="space-y-8 pb-4">
                <!-- Categories and grids go here -->
            </div>
        </div>
    </div>

    <!-- Update Modal -->
    <div id="update-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-50">
        <div class="modal-content w-11/12 max-w-lg rounded-lg p-6 relative bg-gray-800 text-white fade-in-scale">
            <button id="close-update-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-start gap-4">
                 <svg class="w-8 h-8 flex-shrink-0 mt-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <h3 id="update-modal-title" class="text-2xl font-bold mb-2"></h3>
                    <p id="update-modal-description" class="text-gray-300"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="about-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-50">
        <div class="modal-content w-11/12 max-w-lg rounded-lg p-6 relative bg-gray-800 text-white fade-in-scale">
            <button id="close-about-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-start gap-4">
                 <svg class="w-8 h-8 flex-shrink-0 mt-1 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div>
                    <h3 id="about-modal-title" class="text-2xl font-bold mb-2"></h3>
                    <p id="about-modal-description" class="text-gray-300"></p>
                    <div id="about-social-links" class="mt-4 flex justify-center gap-6">
                        <a href="https://www.tiktok.com/@boogie_down262?_t=ZS-8zwAQkBBvjc&_r=1" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" title="TikTok">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <g transform="translate(4 4)">
                                    <path d="M9 0h1.98c.144.715.54 1.617 1.235 2.512C12.895 3.389 13.797 4 15 4v2c-1.753 0-3.07-.814-4-1.829V11a5 5 0 1 1-5-5v2a3 3 0 1 0 3 3V0Z"/>
                                </g>
                            </svg>
                        </a>
                        <a href="https://github.com/AMITYEFET/Find-Flix" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" title="GitHub">
                            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.477 2 12c0 4.418 2.865 8.168 6.839 9.492.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.031-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.378.203 2.398.1 2.651.64.7 1.03 1.595 1.03 2.688 0 3.848-2.338 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.001 10.001 0 0022 12c0-5.523-4.477-10-10-10z" clip-rule="evenodd"/>
                            </svg>
                        </a>
                        <a href="https://fnstoryhe.edgeone.app/" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" title="Fortnite Story HW">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cookie Consent Banner -->
    <div id="cookie-consent-banner" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 p-4 z-[60] transform translate-y-full transition-transform duration-500 ease-in-out hidden">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
            <p id="cookie-consent-message" class="text-gray-300 text-center sm:text-right"></p>
            <button id="cookie-consent-btn" class="px-6 py-2 bg-red-600 text-white font-bold rounded-full transition-colors hover:bg-red-700 flex-shrink-0">
                <!-- Text set by JS -->
            </button>
        </div>
    </div>

    <!-- Reward Preview Modal -->
    <div id="reward-preview-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-50">
        <div class="modal-content w-11/12 max-w-lg rounded-lg p-6 relative bg-gray-800 text-white fade-in-scale">
            <button id="close-reward-preview-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div id="reward-preview-content">
                <!-- Preview content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div id="onboarding-view" class="fixed inset-0 bg-gray-900/95 z-[100] flex items-start justify-center p-4 py-8 hidden overflow-y-auto">
        <div class="bg-gray-800 p-4 sm:p-8 rounded-lg shadow-xl w-full max-w-3xl text-center fade-in-scale">
            <h2 id="onboarding-title" class="text-xl sm:text-3xl font-bold text-red-500 mb-4"></h2>
            <p id="onboarding-subtitle" class="text-gray-300 mb-6 sm:mb-8"></p>

            <div class="space-y-4 sm:space-y-6 text-right">
                <div>
                    <h3 id="onboarding-age-label" class="text-base sm:text-xl font-semibold mb-3 text-white text-center"></h3>
                    <div id="onboarding-age-groups" class="flex justify-center flex-wrap gap-2 sm:gap-4">
                        <!-- Age group buttons will be injected here -->
                    </div>
                </div>

                <div>
                    <h3 id="onboarding-genres-label" class="text-base sm:text-xl font-semibold mb-3 text-white text-center"></h3>
                    <p id="onboarding-genres-instruction" class="text-gray-400 mb-4 text-center"></p>
                    <div id="onboarding-genres-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2 sm:gap-3 max-h-48 sm:max-h-64 overflow-y-auto p-2 bg-gray-900/50 rounded-lg">
                        <!-- Genre buttons will be injected here -->
                    </div>
                </div>
            </div>

            <button id="onboarding-submit-btn" class="mt-6 sm:mt-8 w-full max-w-xs mx-auto p-3 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed">
            </button>
            <button id="onboarding-skip-btn" class="mt-4 px-8 py-2 border border-gray-600 text-gray-400 font-bold rounded-full transition-colors hover:bg-gray-700 hover:text-white"></button>
            <p id="onboarding-skip-notice" class="mt-3 text-xs text-gray-500 max-w-xs mx-auto"></p>
        </div>
    </div>

    <!-- Gemini AI Modal -->
    <div id="gemini-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-[70]">
        <div class="modal-content w-11/12 max-w-2xl rounded-lg p-6 relative bg-gray-800 text-white flex flex-col gap-4 fade-in-scale">
            <button id="close-gemini-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0 gemini-icon-color" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                <h3 id="gemini-modal-title" class="text-2xl font-bold"></h3>
            </div>
            <div id="gemini-modal-content" class="text-gray-300 max-h-80 overflow-y-auto pr-2">
                <div id="gemini-loading" class="text-center p-8">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p id="gemini-loading-text"></p>
                </div>
                <div id="gemini-response" class="hidden prose max-w-none"></div>
                <div id="gemini-audio-player" class="hidden flex flex-col items-center gap-4">
                    <audio id="podcast-audio-element" class="hidden"></audio>
                    <div class="flex items-center gap-4 w-full">
                        <button id="podcast-play-pause-btn" class="p-2 text-white bg-red-600 rounded-full"></button>
                        <span id="podcast-current-time">0:00</span>
                        <input type="range" id="podcast-seeker" value="0" class="flex-grow accent-red-600">
                        <span id="podcast-duration">0:00</span>
                        <a id="podcast-download-btn" href="#" class="p-2 text-white bg-blue-600 rounded-full transition-colors hover:bg-blue-700" title="הורד MP3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            <p id="gemini-disclaimer" class="text-xs text-center text-gray-500"></p>
        </div>
    </div>

    <!-- AI Recommender Modal -->
    <div id="ai-recommender-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-[70]">
        <div class="modal-content w-11/12 max-w-lg rounded-lg p-6 relative bg-gray-800 text-white flex flex-col gap-4 fade-in-scale">
            <button id="close-ai-recommender-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <div class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 flex-shrink-0" viewBox="0 0 24 24"><path fill="white" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                <h3 id="ai-recommender-modal-title" class="text-2xl font-bold"></h3>
            </div>
            <p id="ai-recommender-modal-instructions" class="text-gray-300"></p>
            <textarea id="ai-recommender-input" class="w-full h-24 bg-gray-900 text-gray-300 rounded-lg p-2 resize-none border border-gray-600 focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder=""></textarea>
            <button id="get-ai-recommendation-btn" class="w-full px-6 py-3 bg-purple-600 text-white font-bold rounded-full transition-colors hover:bg-purple-700 flex items-center justify-center gap-2 disabled:bg-gray-500 disabled:cursor-not-allowed">
                <span id="ai-recommender-submit-text"></span>
                <div id="ai-recommender-spinner" class="loading-spinner hidden"></div>
            </button>
            <p id="ai-recommender-disclaimer" class="text-xs text-center text-gray-500 -mt-2"></p>
        </div>
    </div>

    <!-- Recommendation Roulette Modal -->
    <div id="roulette-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-[70]">
        <div id="roulette-modal-content" class="modal-content w-11/12 max-w-sm rounded-lg p-6 relative bg-gray-800 text-white flex flex-col items-center gap-4 overflow-hidden fade-in-scale">
            <button id="close-roulette-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white z-10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="roulette-modal-title" class="text-2xl font-bold text-center mb-2"></h3>
            <div id="roulette-animation-container" class="w-full h-[300px] flex items-center justify-center">
                <div id="roulette-wheel" class="w-48 h-72 rounded-lg overflow-hidden relative shadow-lg bg-gray-900">
                    <div id="roulette-strip" class="absolute top-0 left-0 w-full">
                        <!-- Posters will be injected here by JS -->
                    </div>
                    <!-- Overlays to create a focal point -->
                <div class="absolute top-0 left-0 w-full h-1/3 bg-gradient-to-b from-gray-800 via-gray-800/80 to-transparent z-20 pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 w-full h-1/3 bg-gradient-to-t from-gray-800 via-gray-800/80 to-transparent z-20 pointer-events-none"></div>
                <!-- Selection indicator -->
                <div class="absolute inset-y-0 left-0 right-0 flex items-center justify-center pointer-events-none z-10">
                    <div class="roulette-selector w-full h-16"></div>
                </div>
            </div>
        </div>
        <div id="roulette-result-container" class="hidden w-full">
                <!-- Result will be injected here -->
            </div>
        </div>
    </div>

    <!-- Back to Top Button -->
    <button id="back-to-top-btn" title="חזרה למעלה" class="p-3 bg-red-600 text-white font-bold rounded-full transition-all duration-300 hover:bg-red-700 shadow-lg hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
        </svg>
    </button>

    <!-- Flixy Chat Interface -->
    <!-- FAB Removed -->

    <div id="flixy-window" class="flixy-window shadow-2xl">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b border-white/10 bg-gray-900/90 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img src="https://cdn-icons-png.flaticon.com/512/8943/8943377.png" alt="Flixy" class="w-10 h-10 rounded-full bg-gray-800 p-1 border border-white/10">
                    <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-gray-900 rounded-full shadow-sm"></span>
                </div>
                <div class="flex flex-col">
                    <div class="flex items-center gap-2">
                        <h3 class="font-bold text-white text-lg leading-tight">Flixy AI</h3>
                    </div>
                    <p class="text-[11px] text-gray-400 flex items-center gap-1">
                        <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button id="clear-flixy-btn" class="p-2 text-gray-400 hover:text-red-400 hover:bg-white/5 rounded-full transition-colors" title="נקה שיחה">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
                <button id="close-flixy-btn" class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors" title="סגור">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
        </div>
        
        <!-- Messages Area -->
        <div id="flixy-messages" class="flixy-messages">
            <!-- Messages go here -->
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-gray-900 border-t border-white/10">
            <div class="relative flex items-center">
                <input type="text" id="flixy-input" class="w-full bg-gray-800 text-white rounded-full pl-4 pr-12 py-3 text-sm focus:outline-none border border-transparent focus:border-red-500/50 focus:bg-gray-800/80 placeholder-gray-500 transition-all" placeholder="...">
                <button id="flixy-send-btn" class="absolute right-1.5 p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:hover:scale-100 disabled:cursor-not-allowed shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 transform rotate-90" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                </button>
            </div>
            <p class="text-[10px] text-gray-600 text-center mt-2 opacity-60">Flixy המופעל על ידי Gemini עלול לטעות, לכן חשוב לבדוק את התשובות שלו במקורות נוספים.</p>
        </div>
    </div>

    <!-- NEW TV Settings Modal -->
    <div id="tv-settings-modal" class="fixed inset-0 modal-overlay items-center justify-center hidden z-[70]">
        <div class="modal-content w-11/12 max-w-lg rounded-lg p-6 relative bg-gray-800 text-white flex flex-col gap-4 fade-in-scale">
            <button id="close-tv-settings-btn" class="absolute top-0 right-0 mt-3 mr-3 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="tv-settings-modal-title" class="text-2xl font-bold text-center"></h3>
            <div class="flex flex-col gap-4">
                <div class="p-4 bg-gray-900/50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <label for="ai-tv-identifier-toggle" class="text-gray-300 text-lg" id="settings-ai-tv-identifier-label"></label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="ai-tv-identifier-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <p id="settings-ai-tv-identifier-description" class="text-gray-400 text-sm mt-2"></p>
                </div>
                <div id="ai-tv-timer-setting-container" class="p-4 bg-gray-900/50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <label for="ai-tv-timer-slider" class="text-gray-300 text-lg" id="settings-ai-tv-timer-label"></label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="ai-tv-timer-slider" min="15" max="60" step="5" class="w-32 accent-red-600">
                            <span id="ai-tv-timer-value" class="font-bold text-white w-12 text-center"></span>
                        </div>
                    </div>
                    <p id="settings-ai-tv-timer-description" class="text-gray-400 text-sm mt-2"></p>
                </div>
                <!-- NEW Sports Scoreboard Setting -->
                <div class="p-4 bg-gray-900/50 rounded-lg">
                    <div class="flex items-center justify-between">
                        <label for="sports-scoreboard-toggle" class="text-gray-300 text-lg" id="settings-sports-scoreboard-label"></label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="sports-scoreboard-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                        </label>
                    </div>
                    <p id="settings-sports-scoreboard-description" class="text-gray-400 text-sm mt-2"></p>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // TMDB API Configuration
        const API_KEY = '7c8e74d94f46b889acfa7bf61e6fb8ae'; // The API key
        const BASE_URL = 'https://api.themoviedb.org/3';
        const IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/w500';
        const BACKDROP_BASE_URL = 'https://image.tmdb.org/t/p/w1280';
        const LOGO_BASE_URL = 'https://image.tmdb.org/t/p/original';

        // Gemini API Configuration
        let GEMINI_API_KEY = localStorage.getItem('findFlixGeminiApiKey') || ""; // Can be updated by user
        const GEMINI_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        // Using the most advanced supported model in this environment
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';

        // NEW: Watermark Logo
        const logoSvg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#e50914">
                <path fill-rule="evenodd" d="M10.5 3.75a6.75 6.75 0 100 13.5 6.75 6.75 0 000-13.5zM2.25 10.5a8.25 8.25 0 1114.59 5.28l4.69 4.69a.75.75 0 11-1.06 1.06l-4.69-4.69A8.25 8.25 0 012.25 10.5z" clip-rule="evenodd" fill-opacity="0.8"></path>
                <path fill="#fff" fill-opacity="0.8" d="M10.5 7.5a3 3 0 100 6 3 3 0 000-6z"></path>
                <path fill="#fff" fill-opacity="0.8" d="M12 9a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"></path>
                <path fill="#e50914" fill-opacity="0.8" d="M9.75 8.25L14.25 10.5L9.75 12.75V8.25z"></path>
            </svg>
        `;
        const logoImg = new Image();
        logoImg.src = 'data:image/svg+xml;base64,' + btoa(logoSvg);
        const logoLoadPromise = new Promise((resolve, reject) => {
            logoImg.onload = resolve;
            logoImg.onerror = reject;
        });
        // END NEW

        // Sport Emoji map
        const sportEmojis = {
            soccer: '⚽️',
            basketball: '🏀',
            boxing: '🥊',
            football: '🏈',
            tennis: '🎾',
            volleyball: '🏐',
            baseball: '⚾️',
            ice_hockey: '🏒',
            motorsport: '🏎️',
            wrestling: '🤼',
            judo: '🥋',
            golf: '⛳️'
        };

        const PLUGINS = {
            'cineby': {
                icon: 'https://www.cineby.ru/logo.png',
                experimental: false
            },
            'tv': {
                icon: 'https://image2url.com/images/1761057677180-46996023-069e-4d3b-b757-ae430654d58a.png',
                experimental: false
            }
            // Wikipedia plugin removed
        };

        // Translations object for all supported languages
        const translations = {
            'he': {
                langDir: 'rtl',
                allGenres: 'כל הז\'אנרים',
                home: 'דף הבית',
                movies: 'סרטים',
                series: 'סדרות',
                nowInCinemasNav: 'עכשיו בקולנוע',
                newReleasesNav: 'חדש על המסך',
                myLibrary: 'הספרייה שלי',
                settings: 'הגדרות',
                discover: 'גלה',
                myZone: 'האזור שלי',
                navShorts: 'שורטס',
                more: 'עוד',
                general: 'כללי',
                language: 'שפת ממשק',
                languageDescription: 'שנה את שפת הממשק של האפליקציה (תפריטים, כפתורים).',
                contentLanguage: 'שפת תוכן',
                contentLanguageDescription: 'שנה את השפה בה מוצגים שמות הסרטים, הסדרות והתקצירים.',
                settingsDisplay: 'תצוגה',
                settingsDisplayMode: 'ערכת נושא',
                displayModeDescription: 'בחר ערכת נושא מאפשרויות ברירת המחדל או השג עוד מהשלמת הישגים.',
                settingsCardDensity: 'צפיפות תצוגה',
                settingsCardDensityDescription: 'שנה את הרווח בין הכרטיסים כדי להציג יותר או פחות פריטים על המסך.',
                densityCompact: 'קומפקטי',
                densityDefault: 'רגיל',
                densityComfortable: 'מרווח',
                settingsAccessibility: 'נגישות',
                highContrast: 'ניגודיות גבוהה',
                highContrastDescription: 'שפר את הקריאות על ידי הגברת הניגוד בין הטקסט לרקע.',
                reducedMotion: 'הפחתת תנועה',
                reducedMotionDescription: 'הפחת או בטל אנימציות ומעברים בממשק לחוויה רגועה יותר.',
                settingsUnderlineLinks: 'הדגשת קישורים בקו תחתון',
                settingsUnderlineLinksDescription: 'הוסף קו תחתון לכל הקישורים כדי לזהות אותם בקלות.',
                fontSize: 'גודל גופן',
                fontSizeDescription: 'הגדל או הקטן את הטקסט באפליקציה לקריאה נוחה יותר.',
                reset: 'איפוס',
                themeAutomatic: 'אוטומטי',
                themeDark: 'כהה',
                themeLight: 'בהיר',
                themeStarlight: 'אור כוכבים', // NEW
                themeGlass: 'זכוכית נוזלית',
                whatsNew: 'מה חדש?',
                about: 'אודות',
                installApp: 'התקן אפליקציה',
                aboutTitle: 'אודות Find-Flix',
                aboutDescription: 'אתר זה נוצר כפרויקט אישי על ידי עמית יפת ואין לו קשר רשמי לשירותי הסטרימינג המוזכרים. המידע נאסף ממקורות ציבוריים ומוצג למטרות מידע בלבד באמצעות ה-API של TMDB, ואנו אסירי תודה להם. איננו תומכים או מעודדים צפייה בתוכן פיראטי. © 2025 כל הזכויות שמורות. כדי להשתמש בתכונות AI, יש להזין מפתח API של Gemini בהגדרות.',
                navigationTitle: 'תפריט',
                searchResults: 'תוצאות חיפוש',
                subtitle: 'מצא את הסרט או הסדרה הבאה שלך.',
                surpriseMeBtn: 'הפתע אותי',
                toolsBtnText: 'כלים',
                surpriseAgainBtn: 'הפתע אותי שוב!',
                contactUs: 'צור קשר',
                loading: 'טוען נתונים...',
                scrollLoading: 'טוען עוד תכנים...',
                posterAlt: 'פוסטר של',
                descriptionNotAvailable: 'תקציר אינו זמין כרגע.',
                movie: 'סרט',
                rating: 'דירוג',
                duration: 'שעות',
                hours: 'שעות',
                minutes: 'דקות',
                webSearchBtn: 'חיפוש ברשת',
                noProviders: 'לא הצלחנו למצוא מידע על שירותי סטרימינג עבור תוכן זה.',
                seasonsHeading: 'עונות',
                loadingSeasons: 'טוען עונות...',
                episodes: 'פרקים',
                noSeasons: 'אין מידע על עונות זמינות.',
                noResults: 'לא נמצאו תוצאות.',
                noResultsTip: 'נסה לחפש תוכן פופולרי יותר.',
                reportProblemContentSubject: 'דיווח בעיה בתוכן:',
                reportContentProblem: 'דווח על בעיה בתוכן',
                castAndCrew: 'שחקנים ויוצרים',
                biography: 'ביוגרפיה',
                biographyNotAvailable: 'ביוגרפיה אינה זמינה.',
                born: 'תאריך לידה',
                placeOfBirth: 'מקום לידה',
                knownFor: 'ידוע/ה בזכות',
                noCreditsFound: 'לא נמצאו פריטים בפילמוגרפיה.',
                searchPlaceholder: [ "דברים מוזרים", "בית הדרקון", "המנדלוריאן", "משחקי הכס", "הפלאש", "הכתר", "שלדון הצעיר", "גילמור המאושר" ],
                goodMorning: 'בוקר טוב!',
                goodAfternoon: 'צהריים טובים!',
                goodEvening: 'ערב טוב!',
                goodNight: 'לילה טוב!',
                maintenanceTitle: 'עדכון חדש!',
                maintenanceDescription: 'עדכון חדש זמין - נוספה קטגוריית "עכשיו בקולנוע", שיפורי יציבות ותיקוני באגים.',
                episodesPageTitle: '{seriesName} - פרקים לעונה {seasonNumber}',
                backToSeries: 'חזרה לסדרה',
                episode: 'פרק',
                watchTrailer: 'צפה בטריילר',
                nowInCinemas: 'עכשיו בקולנוע!',
                newContent: 'חדש על המסך!',
                addToLibrary: 'הוסף לספרייה',
                removeFromLibrary: 'הסר מהספרייה',
                libraryEmpty: 'הספרייה שלך ריקה.',
                libraryNotice: 'התכנים ששמרת מאוחסנים באופן מקומי בדפדפן בלבד. ניקוי נתוני הדפדפן ימחק אותם.',
                addedToLibrary: 'נוסף לספרייה!',
                removedFromLibrary: 'הוסר מהספרייה.',
                navWatched: 'היסטוריית צפייה',
                addToWatched: 'הוסף להיסטוריית צפייה',
                removeFromWatched: 'הסר מהיסטוריית הצפייה',
                watchedEmpty: 'עדיין לא סימנת שום תוכן.',
                addedToWatchedToast: 'נוסף להיסטוריית הצפייה!',
                removedFromWatched: 'הוסר מהיסטוריית הצפייה.',
                watchedNoticeExtra: 'שימו לב: תכנים שסומנו כנצפו לא יופיעו בהמלצות של "הפתע אותי".',
                noNewRecommendations: 'אין המלצות חדשות כרגע.',
                noRecommendations: 'לא נמצאו כותרים דומים.', // NEW
                buyTicket: 'רכוש כרטיס',
                share: 'שתף',
                linkCopied: 'הקישור הועתק!',
                shareMessage: 'תראו את {title} ב-Find-Flix!',
                // shareEpisodeMessage removed
                cookieMessage: 'היי! אנחנו משתמשים בקובצי עוגיות, (לא כאלה שאפשר לאכול לצערי 🍪), כדי שהאתר הזה יעבוד כמו שצריך. לחיצה על "אני מסכים" היא כמו לתת לנו יד כדי שנוכל להציע לך חוויה טובה יותר. 🫡',
                cookieAgree: 'אני מסכים',
                metaDescription: 'Find-Flix עוזר לך למצוא את הסרט או הסדרה הבאה שלך, עם המלצות, חיפוש, ומידע על איפה לצפות. גלה תכנים פופולריים וקבל המלצה אישית בלחיצת כפתור.',
                metaKeywords: 'סרטים, סדרות, נטפליקס, המלצות, חיפוש סרטים, דיסני פלוס, אמזון פריים, find-flix, movies, series, netflix, recommendations, search movies, קולנוע',
                welcomeTitle: 'ברוכים הבאים ל-Find-Flix!',
                welcomeSubtitle: 'ספרו לנו קצת עליכם כדי שנוכל למצוא לכם המלצות מושלמות.',
                ageLabel: 'מה טווח הגילאים שלך?',
                ageGroup1: '12 ומטה',
                ageGroup2: '13-17',
                ageGroup3: '18+',
                genresLabel: "אילו סגנונות (ז'אנרים) אתם אוהבים?",
                genresInstruction: 'בחרו לפחות 3.',
                onboardingSubmit: 'יאללה נתחיל!',
                recommendationsForYou: 'המלצות אישיות',
                myAccount: 'החשבון שלי',
                changePreferences: 'שנה העדפות',
                preferencesDescription: 'עבור מחדש על שאלון ההעדפות כדי לעדכן את ההמלצות עבורך.',
                resetPreferences: 'אפס העדפות',
                resetPreferencesDescription: 'פעולה זו תמחק את העדפותיך האישיות. דף הבית יציג כעת תכנים פופולריים כלליים במקום המלצות מותאמות אישית.',
                preferencesResetSuccess: 'ההעדפות אופסו!',
                skip: 'דלג',
                skipNotice: '*דילוג יציג תכנים פופולריים כלליים במקום המלצות מותאמות אישית.',
                settingsInformationTitle: 'מידע',
                viewBtn: 'צפה',
                settingsWhatsNewLabel: 'מה חדש?',
                settingsWhatsNewDescription: 'צפה במידע על העדכון האחרון של האפליקציה.',
                settingsAboutLabel: 'אודות',
                settingsAboutDescription: 'מידע על האפליקציה, היוצר והטכנולוגיות.',
                settingsContactLabel: 'צור קשר',
                settingsContactDescription: 'יש לכם שאלה, הצעה או דיווח? נשמח לשמוע מכם.',
                backupRestore: 'גיבוי ושחזור',
                backupRestoreDescription: 'שמור או טען את כל הנתונים וההגדרות שלך באמצעות קובץ גיבוי.',
                exportFile: 'ייצוא קובץ',
                importFile: 'ייבוא קובץ',
                exportData: 'ייצוא נתונים',
                importData: 'ייבוא נתונים',
                importSuccess: 'הנתונים יובאו בהצלחה! האפליקציה תיטען מחדש.',
                importError: 'שגיאה בייבוא הנתונים. וודא שהקובץ מכיל נתונים מתאימים ו/או נסה שוב.',
                exportCode: 'ייצוא באמצעות קוד',
                importCode: 'ייבוא באמצעות קוד',
                exportCodeModalTitle: 'קוד הגיבוי שלך',
                exportCodeModalInstructions: 'העתק את הקוד הזה ושמור אותו במקום בטוח. תוכל להשתמש בו כדי לשחזר את הנתונים שלך מאוחר יותר.',
                copyCode: 'העתק קוד',
                codeCopied: 'הקוד הועתק!',
                importCodeModalTitle: 'הדבק קוד גיבוי',
                importCodeModalInstructions: 'הדבק את קוד הגיבוי ששמרת בתיבת הטקסט למטה.',
                pasteCodePlaceholder: 'הדבק את הקוד כאן...',
                importBtn: 'ייבוא',
                navAchievements: 'הרצף שלי', // Changed from 'הישגים'
                achievementsTitle: 'מעקב רצף ופרסים', // Changed Title
                achievementsGridTitle: 'פרסים ואבני דרך', // NEW KEY
                achievementUnlocked: 'הישג חדש!',
                streakLabel: 'ימים ברצף',
                highestStreak: 'שיא אישי', // NEW
                achievedOn: 'הושג ב-', // NEW
                nextReward: 'הפרס הבא',
                streakMotivation: [
                    "רק התחלנו! בוא נראה לאן נגיע.",
                    "הקצב עולה! שלושה ימים ברצף.",
                    "וואו! שבוע שלם של בינג'.",
                    "אתה בדרך להיות מאסטר!",
                    "חודש שלם?! פשוט אגדה."
                ],
                rewards: {
                    day1: { title: "התחלה טובה", desc: "התחברת לאפליקציה בפעם הראשונה." },
                    day3: { title: "מתחמם", desc: "3 ימים ברצף. התמדה היא המפתח!" },
                    day7: { title: "רצף של שבוע!", desc: "7 ימים ברצף. המשך כך!" },
                    day14: { title: "מתמיד רציני", desc: "14 ימים ברצף. חצי דרך למאסטר!" },
                    day30: { title: "אמן הזכוכית", desc: "30 ימים ברצף. פותח את ערכת הנושא היוקרתית 'זכוכית'." },
                    day60: { title: "חודשיים של קולנוע", desc: "60 ימים ברצף! אתה כבר חלק מהמשפחה." },
                    day120: { title: "מכור למסך", desc: "120 ימים ברצף. אין יום בלי סרט?" },
                    day200: { title: "אגדת צפייה", desc: "200 ימים! ההתמדה שלך ראויה להערצה." },
                    day365: { title: "שנה מהסרטים", desc: "365 ימים! שנה שלמה של בינג' יומיומי. מדהים!" },
                    day500: { title: "מאסטר Find-Flix", desc: "500 ימים!!! אין מילים. אתה השליט הבלתי מעורער." }
                },
                achievement_first_watch_name: 'צעד ראשון',
                achievement_first_watch_desc: 'צפה בסרט או סדרה בפעם הראשונה.',
                achievement_collector_1_name: 'אספן מתחיל',
                achievement_collector_1_desc: 'הוסף 5 פריטים לספרייה שלך.',
                achievement_collector_2_name: 'אספן רציני',
                achievement_collector_2_desc: 'הוסף 25 פריטים לספרייה שלך.',
                achievement_movie_buff_name: 'תולעת סרטים',
                achievement_movie_buff_desc: 'סמן 10 סרטים כנצפו.',
                achievement_series_binger_name: 'בינג\'ר מקצועי',
                achievement_series_binger_desc: 'סמן 10 סדרות כנצפו.',
                achievement_explorer_name: 'חוקר ז\'אנרים',
                achievement_explorer_desc: 'סנן לפי 3 ז\'אנרים שונים.',
                achievement_lucky_name: 'מרגיש בר-מזל',
                achievement_lucky_desc: 'השתמש ב"הפתע אותי" 5 פעמים.',
                achievement_power_user_name: 'משתמש על',
                achievement_power_user_desc: 'פתח 5 הישגים אחרים.',
                achievement_time_traveler_name: 'נוסע בזמן',
                achievement_time_traveler_desc: 'צפה בתוכן מ-6 עשורים שונים (שנות ה-70 עד היום).',
                reward_glass_theme: 'פרס: ערכת נושא "זכוכית נוזלית"!',
                settingsAdvancedTitle: 'הגדרות מתקדמות',
                settingsCustomFontLabel: 'גופן מותאם אישית',
                settingsCustomFontDescription: 'העלה קובץ גופן משלך (.ttf, .otf, .woff). תכונה זו עשויה להשפיע על עיצוב האפליקציה. שימו לב: חלק מהגופנים עשויים שלא לתמוך בכל השפות.',
                uploadFont: 'העלה גופן',
                resetFont: 'אפס',
                currentFontLabel: 'גופן נוכחי',
                defaultFont: 'ברירת מחדל',
                fontUploadSuccess: "הגופן '{fontName}' הוחל בהצלחה!",
                fontUploadError: 'שגיאה בטעינת קובץ הגופן.',
                fontResetSuccess: 'הגופן אופס לברירת המחדל.',
                getAiSummary: 'קבל תובנות AI',
                aiSummaryTitle: 'תובנות AI עבור {title}',
                aiLoading: 'חושב... ה-AI מנתח את התוכן...',
                aiError: 'אוי. ה-AI לא הצליח ליצור סיכום כרגע. נסה שוב מאוחר יותר.',
                apiKeyNeeded: 'נדרש מפתח API של Gemini. אנא הגדר אותו בהגדרות.',
                apiKeySaved: 'מפתח API נשמר!',
                saveBtn: 'שמור',
                settingsGeminiApiKeyLabel: 'מפתח API של Gemini',
                settingsGeminiApiKeyDescription: 'נדרש כדי להשתמש בתכונות ה-AI שבאתר. ניתן להשיג מפתח אישי בחינם מ-<a href="https://aistudio.google.com/api-keys" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Google AI Studio</a>.',
                geminiApiKeyNotice: 'למפתחות Gemini יש מגבלות שימוש. אם נתקלתם בשגיאות חוזרות במהלך ניסיון שימוש במפתח, אנא נסו מאוחר יותר או צרו מפתח חדש.',
                aiRecommenderBtn: 'המלצת AI',
                aiRecommenderTitle: 'יועץ התוכן האישי שלך',
                aiRecommenderInstructions: 'תאר איזה סרט או סדרה בא לך לראות (לדוגמה: "סרט מתח פסיכולוגי עם טוויסט מפתיע"), וה-AI שלנו ימצא לך המלצה.',
                aiRecommenderPlaceholder: 'לדוגמה: קומדיה רומנטית קלילה וכיפית...',
                aiRecommenderSubmit: 'מצא לי המלצה',
                aiRecommenderSearching: 'מחפש...',
                aiRecommendationFailed: 'לא הצלחנו למצוא המלצה מתאימה כרגע. נסה תיאור אחר.',
                aiDisclaimer: '‫Gemini בתוך Find-Flix עלול לטעות, לכן חשוב לבדוק את התשובות שלו במקורות נוספים.',
                generatePodcast: 'הפק פודקאסט',
                podcastTitle: 'פודקאסט על {title}',
                podcastLoading: 'מפיק פודקאסט... ה-AI כותב את התסריט...',
                downloadPodcast: 'הורד MP3',
                achievement_ai_consultant_name: 'יועץ AI',
                achievement_ai_consultant_desc: 'השתמש בתכונות ה-AI שלוש פעמים.',
                rouletteTitle: 'לא מצליחים להחליט?',
                rouletteStartBtnText: 'סובב את רולטת ההמלצות',
                rouletteToolText: 'רולטת המלצות',
                rouletteModalTitle: 'וההמלצה היא...',
                spinAgain: 'סובב שוב',
                moreDetails: 'פרטים נוספים',
                watchOnCineby: 'צפה ב-CINEBY',
                navPlugins: 'תוספים',
                plugin_cineby_name: 'תוסף CINEBY',
                plugin_cineby_desc: 'הוסף כפתור לפתיחת צפייה ישירה דרך CINEBY. עלול להכיל פרסומות וחלונות קופצים - השימוש באחריות המשתמש בלבד.',
                navTvChannels: 'ערוצי טלוויזיה',
                tvChannelsTitle: 'טלוויזיה בשידור חי',
                epgTitle: 'לוח שידורים', // NEW KEY
                epgToday: 'היום', // NEW KEY
                epgTomorrow: 'מחר', // NEW KEY
                epgDisclaimer: 'זיהוי התכנים בלוח השידורים לא מדויק ועשוי להיות שגוי.', // NEW KEY
                plugin_tv_name: 'תוסף ערוצי טלוויזיה',
                plugin_tv_desc: 'צפה בערוצי טלוויזיה ישראליים בשידור חי. דורש חיבור אינטרנט יציב. איכות השידור עשויה להשתנות.',
                subtitleToggleOn: 'כתוביות: ✓',
                subtitleToggleOff: 'כתוביות: ✗',
                selectChannelPrompt: 'בחר ערוץ מהרשימה כדי להתחיל לצפות.',
                searchChannelsPlaceholder: 'חפש ערוץ...',
                identifyTvContent: 'מה משודר? (AI)',
                identifyingContent: 'הבינה מזהה את התוכן...',
                contentNotIdentified: 'לא זוהה תוכן',
                settingsAiTvIdentifierLabel: 'זיהוי תוכן AI בטלוויזיה',
                settingsAiTvIdentifierDescription: 'זהה באופן אוטומטי מה משודר בערוצי טלוויזיה חיים באמצעות AI.',
                settingsAiTvTimerLabel: 'מרווח רענון AI',
                tvSettingsModalTitle: 'הגדרות זיהוי תוכן AI',
                secondsUnit: 'שניות',
                settingsSportsScoreboardLabel: 'לוח תוצאות ספורט',
                settingsSportsScoreboardDescription: 'הצג לוח תוצאות מיוחד עבור שידורי ספורט.',
                multiChannelTag: 'מספר ערוצים',
                tvCategories: {
                    news: 'חדשות',
                    kids: 'ילדים ונוער',
                    religion: 'דת',
                    sports: 'ספורט',
                    general: 'כללי',
                    science: 'מדע וטבע',
                    drama: 'דרמות וטלונובלות',
                    free_tv: 'Free TV',
                    hot: 'HOT'
                },
                settingsExperimentalTag: 'ניסיוני',
                // Wikipedia translations removed
                fortniteTrailerBtnTitle: 'צפה בטריילר',
                navEvents: 'אירועים',
                eventsTitle: 'אירועים מיוחדים',
                tvChannelsDownNotice: 'אנו מודעים לבעיה שגורמת לרוב הערוצים לא להיות זמינים. אנחנו עובדים על פתרון בהקדם האפשרי.',
                director: 'במאי',
                writer: 'כותב',
                guestStars: 'שחקנים אורחים',
                translateToEnglish: 'תרגם לאנגלית',
                translateToHebrew: 'תרגם לעברית',
                translating: 'מתרגם...', // NEW
                translationError: 'שגיאה בתרגום.', // NEW
                'connectingTo': 'מתחבר ל...',
                'aiIdentifyingWillRetry': 'הבינה ממשיכה לנסות לזהות ברקע...',
                'screenshotFailedSecurity': 'לא ניתן לצלם מסך. הדפדפן חוסם צילום משידורים מאובטחים מטעמי זכויות יוצרים.',
                'screenshotFailedGeneric': 'צילום המסך נכשל.',
                'recordVideo': 'הקלט וידאו',
                'stopRecording': 'עצור הקלטה',
                'recording': 'מקליט...',
                'recordingFailedSecurity': 'לא ניתן להקליט. הדפדפן חוסם הקלטת וידאו משידורים מאובטחים מטעמי זכויות יוצרים.',
                'recordingFailedGeneric': 'ההקלטה נכשלה.',
                'recordingStarted': 'ההקלטה החלה!',
                'recordingStopped': 'ההקלטה נעצרה. הקובץ יורד...',
                'moreLikeThis': 'עוד כותרים שאולי תאהב',
                'captureDisclaimer': 'צילום תכנים עשוי להיות מקוטע ו/או להשפיע על יציבות השידור.',
                'videoQuality': 'איכות וידאו',
                'qualityAuto': 'אוטומטי',
                'qualityHD1080': 'גבוהה (1080p)',
                'qualityHD720': 'גבוהה (720p)',
                settingsFlixyLabel: 'הצג את Flixy (עוזר AI)',
                settingsFlixyDescription: 'הצג או הסתר את כפתור הצ\'אט הצף של העוזר החכם.',
                loginStreak: '{days} ימים ברצף',
                streakLost: 'אוי לא! איבדת את הרצף. מתחילים מחדש! 💪', // NEW
                streakExtended: 'השגת יום נוסף לרצף! 🔥 ({days} ימים)', // NEW
                streakStarted: 'התחלת את רצף הצפייה הראשון שלך! 🚀', // NEW
                newMilestone: 'אבן דרך חדשה נפתחה: {title} 🏆', // NEW
                genres: {
                    "28": "אקשן", "12": "הרפתקאות", "16": "אנימציה", "35": "קומדיה", "80": "פשע", "99": "דוקומנטרי", "18": "דרמה",
                    "10751": "משפחה", "14": "פנטזיה", "36": "היסטוריה", "27": "אימה", "10402": "מוזיקה", "9648": "מסתורין", "10749": "רומנטיקה",
                    "878": "מדע בדיוני", "10770": "סרט טלוויזיה", "53": "מותחן", "10752": "מלחמה", "37": "מערבון", "10759": "אקשן והרפתקאות",
                    "10762": "ילדים", "10763": "חדשות", "10764": "ריאליטי", "10765": "מדע בדיוני ופנטזיה", "10766": "אופרת סבון", "10767": "אירוח", "10768": "מלחמה ופוליטיקה"
                },
                videoTypes: {
                    'Trailer': 'טריילר',
                    'Teaser': 'טיזר',
                    'Clip': 'קטע',
                    'Featurette': 'פיצ\'ר',
                    'Behind the Scenes': 'מאחורי הקלעים',
                    'Bloopers': 'פספוסים',
                    'Recap': 'תקציר',
                    'Opening Credits': 'פתיח'
                },
                // NEW: Player Translations
                playerLoop: 'חזרה אוטומטית',
                playerSpeed: 'מהירות',
                playerCopyLink: 'העתק קישור',
                playerStateOn: 'פעיל',
                playerStateOff: 'כבוי',
                speedNormal: 'רגילה'
            },
            'en': {
                langDir: 'ltr',
                allGenres: 'All Genres',
                home: 'Home',
                movies: 'Movies',
                series: 'Series',
                nowInCinemasNav: 'In Cinemas',
                newReleasesNav: 'New Releases',
                myLibrary: 'My Library',
                settings: 'Settings',
                discover: 'Discover',
                myZone: 'My Zone',
                navShorts: 'Shorts',
                more: 'More',
                general: 'General',
                language: 'Interface Language',
                languageDescription: 'Change the display language of the application interface (menus, buttons).',
                contentLanguage: 'Content Language',
                contentLanguageDescription: 'Change the language for movie titles, series names, and overviews.',
                settingsDisplay: 'Display',
                settingsDisplayMode: 'Theme',
                displayModeDescription: 'Choose between Dark, Light, or Automatic synchronization with your system settings.',
                settingsCardDensity: 'Card Density',
                settingsCardDensityDescription: 'Change the spacing between cards to show more or fewer items on screen.',
                densityCompact: 'Compact',
                densityDefault: 'Default',
                densityComfortable: 'Comfortable',
                settingsAccessibility: 'Accessibility',
                highContrast: 'High Contrast',
                highContrastDescription: 'Improve readability by increasing the contrast between text and background.',
                reducedMotion: 'Reduced Motion',
                reducedMotionDescription: 'Reduce or disable animations and transitions in the interface for a calmer experience.',
                settingsUnderlineLinks: 'Underline Links',
                settingsUnderlineLinksDescription: 'Add an underline to all links to make them easier to identify.',
                fontSize: 'Font Size',
                fontSizeDescription: 'Increase or decrease the text size in the app for more comfortable reading.',
                reset: 'Reset',
                themeAutomatic: 'Automatic',
                themeDark: 'Dark',
                themeLight: 'Light',
                themeStarlight: 'Starlight', // NEW
                themeGlass: 'Liquid Glass',
                whatsNew: "What's New",
                about: 'About',
                installApp: 'Install App',
                aboutTitle: 'About Find-Flix',
                aboutDescription: 'This site was created as a personal project by Amit Yefet and has no official affiliation with the streaming services mentioned. The information is collected from public sources and displayed for informational purposes only using the TMDB API, and we are very grateful to them. We do not support or encourage watching pirated content. © 2025 All rights reserved. To use AI features, a Gemini API key must be entered in the settings.',
                navigationTitle: 'Menu',
                searchResults: 'Search Results',
                subtitle: 'Find your next movie or series.',
                surpriseMeBtn: 'Surprise Me',
                toolsBtnText: 'Tools',
                surpriseAgainBtn: 'Surprise Me Again!',
                contactUs: 'Contact Us',
                loading: 'Loading data...',
                scrollLoading: 'Loading more content...',
                posterAlt: 'Poster of',
                descriptionNotAvailable: 'Description is not available at the moment.',
                movie: 'Movie',
                rating: 'Rating',
                duration: 'h',
                hours: 'h',
                minutes: 'm',
                webSearchBtn: 'Web Search',
                noProviders: 'We could not find information about streaming services for this content.',
                seasonsHeading: 'Seasons',
                loadingSeasons: 'Loading seasons...',
                episodes: 'episodes',
                noSeasons: 'No season information available.',
                noResults: 'No results found.',
                noResultsTip: 'Try searching for more popular content.',
                reportProblemContentSubject: 'Content Problem Report:',
                reportContentProblem: 'Report Content Problem',
                castAndCrew: 'Cast & Crew',
                biography: 'Biography',
                biographyNotAvailable: 'Biography not available.',
                born: 'Born',
                placeOfBirth: 'Place of Birth',
                knownFor: 'Known For',
                noCreditsFound: 'No filmography credits found.',
                searchPlaceholder: [ "Stranger Things", "House of the Dragon", "The Mandalorian", "Game of Thrones", "The Flash", "The Crown", "Young Sheldon", "Gilmore Girls" ],
                goodMorning: 'Good Morning!',
                goodAfternoon: 'Good Afternoon!',
                goodEvening: 'Good Evening!',
                goodNight: 'Good Night!',
                maintenanceTitle: 'New Update!',
                maintenanceDescription: 'A new update is available - added an "In Cinemas" category, stability improvements, and bug fixes.',
                episodesPageTitle: '{seriesName} - Season {seasonNumber} Episodes',
                backToSeries: 'Back to Series',
                episode: 'Episode',
                watchTrailer: 'Watch Trailer',
                nowInCinemas: 'Now in Cinemas!',
                newContent: 'New!',
                addToLibrary: 'Add to Library',
                removeFromLibrary: 'Remove from Library',
                libraryEmpty: 'Your library is empty.',
                libraryNotice: 'Your saved items are stored locally in your browser. Clearing your browser data will delete them.',
                addedToLibrary: 'Added to your library!',
                removedFromLibrary: 'Removed from your library.',
                navWatched: 'Watched History',
                addToWatched: 'Add to Watched History',
                removeFromWatched: 'Remove from Watched History',
                watchedEmpty: 'You haven\'t marked any content as watched yet.',
                addedToWatchedToast: 'Added to your watched history!',
                removedFromWatched: 'Removed from your watched history.',
                watchedNoticeExtra: 'Note: Content marked as watched will be excluded from "Surprise Me" recommendations.',
                noNewRecommendations: 'No new recommendations available right now.',
                buyTicket: 'Buy Ticket',
                share: 'Share',
                linkCopied: 'Link copied!',
                shareMessage: 'Check out {title} on Find-Flix!',
                // shareEpisodeMessage removed
                cookieMessage: 'Hey! We use cookies (not the edible kind, unfortunately 🍪) to make this site work properly. Clicking "I Agree" is like giving us a high-five so we can offer you a better experience. 🫡',
                cookieAgree: 'I Agree',
                metaDescription: 'Find-Flix helps you find your next movie or series, with recommendations, search, and info on where to watch. Discover popular content and get personal recommendations.',
                metaKeywords: 'movies, series, netflix, recommendations, search movies, disney plus, amazon prime, find-flix, cinema',
                welcomeTitle: 'Welcome to Find-Flix!',
                welcomeSubtitle: 'Tell us a bit about yourself so we can find perfect recommendations for you.',
                ageLabel: "What's your age range?",
                ageGroup1: '12 & Under',
                ageGroup2: '13-17',
                ageGroup3: '18+',
                genresLabel: 'Which genres do you like?',
                genresInstruction: 'Choose at least 3.',
                onboardingSubmit: "Let's Get Started!",
                recommendationsForYou: 'Personalized Recommendations',
                myAccount: 'My Account',
                changePreferences: 'Change Preferences',
                preferencesDescription: 'Re-take the preferences quiz to update your recommendations.',
                resetPreferences: 'Reset Preferences',
                resetPreferencesDescription: 'This will erase your personalized preferences. The home page will now show general trending content instead of recommendations.',
                preferencesResetSuccess: 'Preferences reset!',
                skip: 'Skip',
                skipNotice: '*Skipping will show general trending content instead of personalized recommendations.',
                settingsInformationTitle: 'Information',
                viewBtn: 'View',
                settingsWhatsNewLabel: "What's New?",
                settingsWhatsNewDescription: 'View information about the latest app update.',
                settingsAboutLabel: 'About',
                settingsAboutDescription: 'Information about the app, its creator, and technologies.',
                settingsContactLabel: 'Contact Us',
                settingsContactDescription: 'Have a question, suggestion, or report? We\'d love to hear from you.',
                backupRestore: 'Backup & Restore',
                backupRestoreDescription: 'Save or load all your data and settings using a backup file.',
                exportFile: 'Export File',
                importFile: 'Import File',
                exportData: 'Export Data',
                importData: 'Import Data',
                importSuccess: 'Data imported successfully! The app will now reload.',
                importError: 'Error importing file. Please ensure it\'s a valid Find-Flix backup file.',
                exportCode: 'Export via Code',
                importCode: 'Import from Code',
                exportCodeModalTitle: 'Your Backup Code',
                exportCodeModalInstructions: 'Copy this code and save it somewhere safe. You can use it to restore your data later.',
                copyCode: 'Copy Code',
                codeCopied: 'Code copied!',
                importCodeModalTitle: 'Paste Backup Code',
                importCodeModalInstructions: 'Paste the backup code you saved into the text box below.',
                pasteCodePlaceholder: 'Paste your code here...',
                importBtn: 'Import',
                navAchievements: 'My Streak', // Changed
                achievementsTitle: 'Streak & Rewards', // Changed
                achievementsGridTitle: 'Awards & Milestones', // NEW KEY
                achievementUnlocked: 'Achievement Unlocked!',
                streakLabel: 'Days Streak',
                highestStreak: 'Personal Best', // NEW
                achievedOn: 'Achieved on', // NEW
                nextReward: 'Next Reward',
                streakMotivation: [
                    "Just getting started! Let's keep it going.",
                    "Heating up! 3 days in a row.",
                    "Wow! A full week of binge-watching.",
                    "You're on your way to mastery!",
                    "A whole month?! Legend."
                ],
                rewards: {
                    day1: { title: "Good Start", desc: "Logged in for the first time." },
                    day3: { title: "Heating Up", desc: "3 days streak. Consistency is key!" },
                    day7: { title: "Week Streak!", desc: "7 days streak. Keep it up!" },
                    day14: { title: "Serious Streak", desc: "14 days streak. Keep it up!" },
                    day30: { title: "Theme: Glass", desc: "30 days streak. Unlocks the premium 'Glass' theme." },
                    day60: { title: "Two Months Strong", desc: "60 days streak! You're part of the family." },
                    day120: { title: "Screen Addict", desc: "120 days streak. No day without a movie?" },
                    day200: { title: "Viewing Legend", desc: "200 days! Your consistency is admirable." },
                    day365: { title: "Movie Year", desc: "365 days! A whole year of daily binging. Amazing!" },
                    day500: { title: "Find-Flix Master", desc: "500 days!!! No words. You are the undisputed ruler." }
                },
                achievement_first_watch_name: 'First Steps',
                achievement_first_watch_desc: 'Watch your first movie or series.',
                achievement_collector_1_name: 'Budding Collector',
                achievement_collector_1_desc: 'Add 5 items to your library.',
                achievement_collector_2_name: 'Serious Collector',
                achievement_collector_2_desc: 'Add 25 items to your library.',
                achievement_movie_buff_name: 'Movie Buff',
                achievement_movie_buff_desc: 'Mark 10 movies as watched.',
                achievement_series_binger_name: 'Series Binger',
                achievement_series_binger_desc: 'Mark 10 series as watched.',
                achievement_explorer_name: 'Genre Explorer',
                achievement_explorer_desc: 'Filter by 3 different genres.',
                achievement_lucky_name: 'Feeling Lucky',
                achievement_lucky_desc: 'Use "Surprise Me" 5 times.',
                achievement_power_user_name: 'Power User',
                achievement_power_user_desc: 'Unlock 5 other achievements.',
                achievement_time_traveler_name: 'Time Traveler',
                achievement_time_traveler_desc: 'Watch content from 6 different decades (1970s to today).',
                reward_glass_theme: 'Reward: "Liquid Glass" Theme!',
                settingsAdvancedTitle: 'Advanced Settings',
                settingsCustomFontLabel: 'Custom Font',
                settingsCustomFontDescription: 'Upload your own font file (.ttf, .otf, .woff). This feature may affect the app\'s design. Note: Some fonts may not support all languages.',
                uploadFont: 'Upload Font',
                resetFont: 'Reset',
                currentFontLabel: 'Current Font',
                defaultFont: 'Default',
                fontUploadSuccess: "Font '{fontName}' applied successfully!",
                fontUploadError: 'Error loading font file.',
                fontResetSuccess: 'Font reset to default.',
                getAiSummary: 'Get AI Insights',
                aiSummaryTitle: 'AI Insights for {title}',
                aiLoading: 'Thinking... The AI is analyzing the content...',
                aiError: 'Oops. The AI couldn\'t generate a summary right now. Please try again later.',
                apiKeyNeeded: 'Gemini API key required. Please set it in the settings.',
                apiKeySaved: 'API Key saved!',
                saveBtn: 'Save',
                settingsGeminiApiKeyLabel: 'Gemini API Key',
                settingsGeminiApiKeyDescription: 'Required to use the AI summary feature. You can get a free key from <a href="https://aistudio.google.com/api-keys" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Google AI Studio</a>.',
                geminiApiKeyNotice: 'Gemini keys have usage limits. If you encounter repeated errors while trying to use a key, please try again later or create a new key.',
                aiRecommenderBtn: 'AI Recommender',
                aiRecommenderTitle: 'Your Personal Content Advisor',
                aiRecommenderInstructions: 'Describe the movie or series you\'re in the mood for (e.g., "a psychological thriller with a surprising twist"), and our AI will find a recommendation for you.',
                aiRecommenderPlaceholder: 'e.g., A light and fun romantic comedy...',
                aiRecommenderSubmit: 'Find Recommendation',
                aiRecommenderSearching: 'Searching...',
                aiRecommendationFailed: 'Could not find a suitable recommendation right now. Please try a different description.',
                aiDisclaimer: 'AI-generated content may be inaccurate. Verify important information.',
                generatePodcast: 'Generate Podcast',
                podcastTitle: 'Podcast about {title}',
                podcastLoading: 'Generating Podcast... The AI is writing the script...',
                downloadPodcast: 'Download MP3',
                achievement_ai_consultant_name: 'AI Consultant',
                achievement_ai_consultant_desc: 'Use the AI features 3 times.',
                rouletteTitle: 'Can\'t Decide?',
                rouletteStartBtnText: 'Spin the Roulette',
                rouletteToolText: 'Recommendation Roulette',
                rouletteModalTitle: 'And the recommendation is...',
                spinAgain: 'Spin Again',
                moreDetails: 'More Details',
                watchOnCineby: 'Watch on CINEBY',
                navPlugins: 'Plugins',
                plugin_cineby_name: 'CINEBY Plugin',
                plugin_cineby_desc: 'Add a button to watch directly via CINEBY. May contain ads and pop-ups - use at your own risk.',
                navTvChannels: 'TV Channels',
                tvChannelsTitle: 'Live TV',
                epgTitle: 'Schedule', // NEW KEY
                epgToday: 'Today', // NEW KEY
                epgTomorrow: 'Tomorrow', // NEW KEY
                epgDisclaimer: 'Content identification in the schedule is not accurate and may be incorrect.', // NEW KEY
                plugin_tv_name: 'TV Channels Plugin',
                plugin_tv_desc: 'Watch live Israeli TV channels. Requires a stable internet connection. Stream quality may vary.',
                subtitleToggleOn: 'Subtitles: On',
                subtitleToggleOff: 'Subtitles: Off',
                selectChannelPrompt: 'Select a channel from the list to start watching.',
                searchChannelsPlaceholder: 'Search channel...',
                identifyTvContent: 'What\'s Playing? (AI)',
                identifyingContent: 'AI is identifying the content...',
                contentNotIdentified: 'Content not identified',
                settingsAiTvIdentifierLabel: 'AI TV Content Identifier',
                settingsAiTvIdentifierDescription: 'Automatically identify what\'s playing on live TV channels using AI.',
                settingsAiTvTimerLabel: 'AI Refresh Interval',
                tvSettingsModalTitle: 'AI Content Identifier Settings',
                secondsUnit: 'sec',
                settingsSportsScoreboardLabel: 'Sports Scoreboard',
                settingsSportsScoreboardDescription: 'Display a special scoreboard for sports broadcasts.',
                multiChannelTag: 'Multi-Channel',
                tvCategories: {
                    news: 'News',
                    kids: 'Kids & Youth',
                    religion: 'Religion',
                    sports: 'Sports',
                    general: 'General',
                    science: 'Science & Nature',
                    drama: 'Dramas & Telenovelas'
                },
                settingsExperimentalTag: 'Experimental',
                // Wikipedia translations removed
                fortniteTrailerBtnTitle: 'Watch Trailer',
                navEvents: 'Events',
                eventsTitle: 'Special Events',
                tvChannelsDownNotice: 'We are aware of an issue causing most channels to be unavailable. We are working on a fix as soon as possible.',
                director: 'Director',
                writer: 'Writer',
                guestStars: 'Guest Stars',
                translateToEnglish: 'Translate to English',
                translateToHebrew: 'תרגם לעברית',
                translating: 'Translating...', // NEW
                translationError: 'Translation error.', // NEW
                'connectingTo': 'Connecting to...',
                'aiIdentifyingWillRetry': 'The AI will keep trying to identify in the background...',
                'screenshotFailedSecurity': 'Screenshot failed. The browser blocks capturing secured video streams due to copyright restrictions.',
                'screenshotFailedGeneric': 'Screenshot failed.',
                'recordVideo': 'Record Video',
                'stopRecording': 'Stop Recording',
                'recording': 'Recording...',
                'recordingFailedSecurity': 'Recording failed. The browser blocks recording secured video streams due to copyright restrictions.',
                'recordingFailedGeneric': 'Recording failed.',
                'recordingStarted': 'Recording started!',
                'recordingStopped': 'Recording stopped. Downloading file...',
                'moreLikeThis': 'More Like This',
                'noRecommendations': 'No similar recommendations found.',
                'captureDisclaimer': 'Capturing content may be choppy and/or affect broadcast stability.',
                'videoQuality': 'Video Quality',
                'qualityAuto': 'Auto',
                'qualityHD1080': 'High (1080p)',
                'qualityHD720': 'High (720p)',
                settingsFlixyLabel: 'Show Flixy (AI Assistant)',
                settingsFlixyDescription: 'Show or hide the floating AI assistant chat button.',
                loginStreak: '{days} Day Streak',
                streakLost: 'Oh no! Streak lost. Starting over! 💪', // NEW
                streakExtended: 'Streak extended! 🔥 ({days} days)', // NEW
                streakStarted: 'Started your first streak! 🚀', // NEW
                newMilestone: 'New milestone unlocked: {title} 🏆', // NEW
                genres: {
                    "28": "Action", "12": "Adventure", "16": "Animation", "35": "Comedy", "80": "Crime", "99": "Documentary", "18": "Drama",
                    "10751": "Family", "14": "Fantasy", "36": "History", "27": "Horror", "10402": "Music", "9648": "Mystery", "10749": "Romance",
                    "878": "Sci-Fi", "10770": "TV Movie", "53": "Thriller", "10752": "War", "37": "Western", "10759": "Action & Adventure",
                    "10762": "Kids", "10763": "News", "10764": "Reality", "10765": "Sci-Fi & Fantasy", "10766": "Soap", "10767": "Talk", "10768": "War & Politics"
                },
                // NEW: Player Translations
                playerLoop: 'Auto Loop',
                playerSpeed: 'Speed',
                playerCopyLink: 'Copy Link',
                playerStateOn: 'On',
                playerStateOff: 'Off',
                speedNormal: 'Normal'
            },
            'ru': {
                langDir: 'ltr',
                allGenres: 'Все жанры',
                home: 'Главная',
                movies: 'Фильмы',
                series: 'Сериалы',
                nowInCinemasNav: 'В кино',
                newReleasesNav: 'Новинки',
                myLibrary: 'Моя библиотека',
                settings: 'Настройки',
                discover: 'Обзор',
                myZone: 'Моя зона',
                navShorts: 'Shorts',
                more: 'Еще',
                general: 'Общие',
                language: 'Язык интерфейса',
                languageDescription: 'Измените язык интерфейса приложения (меню, кнопки).',
                contentLanguage: 'Язык контента',
                contentLanguageDescription: 'Измените язык названий фильмов, сериалов и описаний.',
                settingsDisplay: 'Отображение',
                settingsDisplayMode: 'Тема',
                displayModeDescription: 'Выберите темную, светлую тему или автоматическую синхронизацию с настройками системы.',
                settingsCardDensity: 'Плотность карт',
                settingsCardDensityDescription: 'Измените расстояние между картами, чтобы показать больше или меньше элементов на экране.',
                densityCompact: 'Компактный',
                densityDefault: 'По умолчанию',
                densityComfortable: 'Комфортный',
                settingsAccessibility: 'Специальные возможности',
                highContrast: 'Высокий контраст',
                highContrastDescription: 'Улучшите читаемость, увеличив контраст между текстом и фоном.',
                reducedMotion: 'Уменьшение движения',
                reducedMotionDescription: 'Уменьшите или отключите анимацию и переходы в интерфейсе для более спокойного восприятия.',
                settingsUnderlineLinks: 'Подчеркивание ссылок',
                settingsUnderlineLinksDescription: 'Добавьте подчеркивание ко всем ссылкам, чтобы их было легче идентифицировать.',
                fontSize: 'Размер шрифта',
                fontSizeDescription: 'Увеличьте или уменьшите размер текста в приложении для более комфортного чтения.',
                reset: 'Сброс',
                themeAutomatic: 'Автоматически',
                themeDark: 'Темная',
                themeLight: 'Светлая',
                themeStarlight: 'Звездный свет', // NEW
                themeGlass: 'Жидкое стекло',
                whatsNew: "Что нового",
                about: 'О приложении',
                installApp: 'Установить приложение',
                aboutTitle: 'О Find-Flix',
                aboutDescription: 'Этот сайт был создан как личный проект Амита Йефета и не имеет официальной связи с упомянутыми стриминговыми сервисами. Информация собирается из открытых источников и отображается в информационных целях с использованием API TMDB, и мы им очень благодарны. Мы не поддерживаем и не поощряем просмотр пиратского контента. © 2025 Все права защищены. Для использования функций ИИ необходимо ввести ключ API Gemini в настройках.',
                navigationTitle: 'Меню',
                searchResults: 'Результаты поиска',
                subtitle: 'Найдите следующий фильм или сериал.',
                surpriseMeBtn: 'Удиви меня',
                toolsBtnText: 'Инструменты',
                surpriseAgainBtn: 'Удиви меня снова!',
                contactUs: 'Связаться с нами',
                loading: 'Загрузка данных...',
                scrollLoading: 'Загрузка контента...',
                posterAlt: 'Постер',
                descriptionNotAvailable: 'Описание недоступно в данный момент.',
                movie: 'Фильм',
                rating: 'Рейтинг',
                duration: 'ч',
                hours: 'ч',
                minutes: 'м',
                webSearchBtn: 'Поиск в Интернете',
                noProviders: 'Мы не смогли найти информацию о стриминговых сервисах для этого контента.',
                seasonsHeading: 'Сезоны',
                loadingSeasons: 'Загрузка сезонов...',
                episodes: 'эпизодов',
                noSeasons: 'Информация о сезонах недоступна.',
                noResults: 'Результатов не найдено.',
                noResultsTip: 'Попробуйте поискать более популярный контент.',
                reportProblemContentSubject: 'Отчет о проблеме с контентом:',
                reportContentProblem: 'Сообщить о проблеме',
                castAndCrew: 'Актеры и создатели',
                biography: 'Биография',
                biographyNotAvailable: 'Биография недоступна.',
                born: 'Дата рождения',
                placeOfBirth: 'Место рождения',
                knownFor: 'Известен по',
                noCreditsFound: 'Фильмография не найдена.',
                searchPlaceholder: [ "Очень странные дела", "Дом Дракона", "Мандалорец", "Игра престолов", "Флэш", "Корона", "Детство Шелдона", "Девочки Гилмор" ],
                goodMorning: 'Доброе утро!',
                goodAfternoon: 'Добрый день!',
                goodEvening: 'Добрый вечер!',
                goodNight: 'Доброй ночи!',
                maintenanceTitle: 'Новое обновление!',
                maintenanceDescription: 'Доступно новое обновление - добавлена категория "В кино", улучшения стабильности и исправления ошибок.',
                episodesPageTitle: '{seriesName} - Сезон {seasonNumber} Эпизоды',
                backToSeries: 'Назад к сериалу',
                episode: 'Эпизод',
                watchTrailer: 'Смотреть трейлер',
                nowInCinemas: 'Сейчас в кино!',
                newContent: 'Новинка!',
                addToLibrary: 'Добавить в библиотеку',
                removeFromLibrary: 'Удалить из библиотеки',
                libraryEmpty: 'Ваша библиотека пуста.',
                libraryNotice: 'Сохраненные элементы хранятся локально в вашем браузере. Очистка данных браузера удалит их.',
                addedToLibrary: 'Добавлено в библиотеку!',
                removedFromLibrary: 'Удалено из библиотеки.',
                navWatched: 'История просмотра',
                addToWatched: 'Добавить в просмотренные',
                removeFromWatched: 'Удалить из просмотренных',
                watchedEmpty: 'Вы еще ничего не отметили как просмотренное.',
                addedToWatchedToast: 'Добавлено в историю просмотра!',
                removedFromWatched: 'Удалено из истории просмотра.',
                watchedNoticeExtra: 'Примечание: Контент, отмеченный как просмотренный, будет исключен из рекомендаций "Удиви меня".',
                noNewRecommendations: 'На данный момент новых рекомендаций нет.',
                noRecommendations: 'Похожие названия не найдены.',
                buyTicket: 'Купить билет',
                share: 'Поделиться',
                linkCopied: 'Ссылка скопирована!',
                shareMessage: 'Посмотри {title} на Find-Flix!',
                // shareEpisodeMessage removed
                cookieMessage: 'Привет! Мы используем куки (к сожалению, не съедобные 🍪), чтобы этот сайт работал правильно. Нажатие "Я согласен" похоже на "дай пять", чтобы мы могли предложить вам лучший опыт. 🫡',
                cookieAgree: 'Я согласен',
                metaDescription: 'Find-Flix поможет вам найти следующий фильм или сериал, с рекомендациями, поиском и информацией о том, где смотреть. Откройте для себя популярный контент и получите персональные рекомендации.',
                metaKeywords: 'фильмы, сериалы, нетфликс, рекомендации, поиск фильмов, дисней плюс, амазон прайм, find-flix, кино',
                welcomeTitle: 'Добро пожаловать в Find-Flix!',
                welcomeSubtitle: 'Расскажите нам немного о себе, чтобы мы могли подобрать для вас идеальные рекомендации.',
                ageLabel: "Ваш возраст?",
                ageGroup1: '12 и младше',
                ageGroup2: '13-17',
                ageGroup3: '18+',
                genresLabel: 'Какие жанры вам нравятся?',
                genresInstruction: 'Выберите не менее 3.',
                onboardingSubmit: "Давайте начнем!",
                recommendationsForYou: 'Персональные рекомендации',
                myAccount: 'Мой аккаунт',
                changePreferences: 'Изменить предпочтения',
                preferencesDescription: 'Пройдите опрос о предпочтениях заново, чтобы обновить рекомендации.',
                resetPreferences: 'Сбросить предпочтения',
                resetPreferencesDescription: 'Это сотрет ваши персональные предпочтения. Главная страница будет показывать общий популярный контент вместо рекомендаций.',
                preferencesResetSuccess: 'Предпочтения сброшены!',
                skip: 'Пропустить',
                skipNotice: '*Пропуск покажет общий популярный контент вместо персональных рекомендаций.',
                settingsInformationTitle: 'Информация',
                viewBtn: 'Просмотр',
                settingsWhatsNewLabel: "Что нового?",
                settingsWhatsNewDescription: 'Посмотреть информацию о последнем обновлении приложения.',
                settingsAboutLabel: 'О приложении',
                settingsAboutDescription: 'Информация о приложении, его создателе и технологиях.',
                settingsContactLabel: 'Связаться с нами',
                settingsContactDescription: 'У вас есть вопрос, предложение или отчет? Мы будем рады услышать от вас.',
                backupRestore: 'Резервное копирование и восстановление',
                backupRestoreDescription: 'Сохраните или загрузите все ваши данные и настройки, используя файл резервной копии.',
                exportFile: 'Экспорт файла',
                importFile: 'Импорт файла',
                exportData: 'Экспорт данных',
                importData: 'Импорт данных',
                importSuccess: 'Данные успешно импортированы! Приложение перезагрузится.',
                importError: 'Ошибка импорта файла. Пожалуйста, убедитесь, что это действительный файл резервной копии Find-Flix.',
                exportCode: 'Экспорт через код',
                importCode: 'Импорт из кода',
                exportCodeModalTitle: 'Ваш код резервной копии',
                exportCodeModalInstructions: 'Скопируйте этот код и сохраните его в надежном месте. Вы можете использовать его для восстановления данных позже.',
                copyCode: 'Копировать код',
                codeCopied: 'Код скопирован!',
                importCodeModalTitle: 'Вставить код резервной копии',
                importCodeModalInstructions: 'Вставьте сохраненный код резервной копии в текстовое поле ниже.',
                pasteCodePlaceholder: 'Вставьте ваш код сюда...',
                importBtn: 'Импорт',
                navAchievements: 'Мой стрик',
                achievementsTitle: 'Стрик и награды',
                achievementsGridTitle: 'Награды и этапы',
                achievementUnlocked: 'Достижение разблокировано!',
                streakLabel: 'Дней подряд',
                highestStreak: 'Личный рекорд',
                achievedOn: 'Достигнуто',
                nextReward: 'Следующая награда',
                streakMotivation: [
                    "Только начало! Продолжаем в том же духе.",
                    "Разогреваемся! 3 дня подряд.",
                    "Вау! Целая неделя просмотра.",
                    "Вы на пути к мастерству!",
                    "Целый месяц?! Легенда."
                ],
                rewards: {
                    day1: { title: "Хорошее начало", desc: "Вошли в первый раз." },
                    day3: { title: "Разогрев", desc: "3 дня подряд. Постоянство - ключ к успеху!" },
                    day7: { title: "Недельный стрик!", desc: "7 дней подряд. Так держать!" },
                    day14: { title: "Серьезный стрик", desc: "14 дней подряд. Продолжайте!" },
                    day30: { title: "Мастер стекла", desc: "30 дней подряд. Разблокирует премиальную тему 'Жидкое стекло'." },
                    day60: { title: "Два месяца", desc: "60 дней подряд! Вы часть семьи." },
                    day120: { title: "Экранный маньяк", desc: "120 дней подряд. Ни дня без фильма?" },
                    day200: { title: "Легенда просмотра", desc: "200 дней! Ваше постоянство восхищает." },
                    day365: { title: "Год кино", desc: "365 дней! Целый год ежедневного просмотра. Потрясающе!" },
                    day500: { title: "Мастер Find-Flix", desc: "500 дней!!! Нет слов. Вы неоспоримый правитель." }
                },
                achievement_first_watch_name: 'Первые шаги',
                achievement_first_watch_desc: 'Посмотрите свой первый фильм или сериал.',
                achievement_collector_1_name: 'Начинающий коллекционер',
                achievement_collector_1_desc: 'Добавьте 5 элементов в библиотеку.',
                achievement_collector_2_name: 'Серьезный коллекционер',
                achievement_collector_2_desc: 'Добавьте 25 элементов в библиотеку.',
                achievement_movie_buff_name: 'Киноман',
                achievement_movie_buff_desc: 'Отметьте 10 фильмов как просмотренные.',
                achievement_series_binger_name: 'Сериальный маньяк',
                achievement_series_binger_desc: 'Отметьте 10 сериалов как просмотренные.',
                achievement_explorer_name: 'Исследователь жанров',
                achievement_explorer_desc: 'Отфильтруйте по 3 разным жанрам.',
                achievement_lucky_name: 'Везунчик',
                achievement_lucky_desc: 'Используйте "Удиви меня" 5 раз.',
                achievement_power_user_name: 'Продвинутый пользователь',
                achievement_power_user_desc: 'Разблокируйте 5 других достижений.',
                achievement_time_traveler_name: 'Путешественник во времени',
                achievement_time_traveler_desc: 'Посмотрите контент из 6 разных десятилетий (с 1970-х по сегодня).',
                reward_starlight_theme: 'Награда: Тема "Звездный свет"!',
                reward_glass_theme: 'Награда: Тема "Жидкое стекло"!',
                settingsAdvancedTitle: 'Расширенные настройки',
                settingsCustomFontLabel: 'Пользовательский шрифт',
                settingsCustomFontDescription: 'Загрузите свой файл шрифта (.ttf, .otf, .woff). Эта функция может повлиять на дизайн приложения. Примечание: Некоторые шрифты могут не поддерживать все языки.',
                uploadFont: 'Загрузить шрифт',
                resetFont: 'Сброс',
                currentFontLabel: 'Текущий шрифт',
                defaultFont: 'По умолчанию',
                fontUploadSuccess: "Шрифт '{fontName}' успешно применен!",
                fontUploadError: 'Ошибка загрузки файла шрифта.',
                fontResetSuccess: 'Шрифт сброшен на по умолчанию.',
                getAiSummary: 'Получить ИИ-инсайт',
                aiSummaryTitle: 'ИИ-инсайты для {title}',
                aiLoading: 'Думаю... ИИ анализирует контент...',
                aiError: 'Упс. ИИ не смог создать сводку прямо сейчас. Пожалуйста, попробуйте позже.',
                apiKeyNeeded: 'Требуется ключ API Gemini. Пожалуйста, установите его в настройках.',
                apiKeySaved: 'API ключ сохранен!',
                saveBtn: 'Сохранить',
                settingsGeminiApiKeyLabel: 'Ключ API Gemini',
                settingsGeminiApiKeyDescription: 'Требуется для использования функции сводки ИИ. Вы можете получить бесплатный ключ в <a href="https://aistudio.google.com/api-keys" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Google AI Studio</a>.',
                geminiApiKeyNotice: 'У ключей Gemini есть ограничения на использование. Если вы столкнулись с повторяющимися ошибками при попытке использовать ключ, попробуйте позже или создайте новый ключ.',
                aiRecommenderBtn: 'ИИ-рекомендатор',
                aiRecommenderTitle: 'Ваш личный консультант по контенту',
                aiRecommenderInstructions: 'Опишите фильм или сериал, который вы хотите посмотреть (например, "психологический триллер с неожиданным поворотом"), и наш ИИ найдет для вас рекомендацию.',
                aiRecommenderPlaceholder: 'например, Легкая и веселая романтическая комедия...',
                aiRecommenderSubmit: 'Найти рекомендацию',
                aiRecommenderSearching: 'Поиск...',
                aiRecommendationFailed: 'Не удалось найти подходящую рекомендацию. Пожалуйста, попробуйте другое описание.',
                aiDisclaimer: 'Контент, созданный ИИ, может быть неточным. Проверяйте важную информацию.',
                generatePodcast: 'Создать подкаст',
                podcastTitle: 'Подкаст о {title}',
                podcastLoading: 'Создание подкаста... ИИ пишет сценарий...',
                downloadPodcast: 'Скачать MP3',
                achievement_ai_consultant_name: 'ИИ-консультант',
                achievement_ai_consultant_desc: 'Используйте функции ИИ 3 раза.',
                rouletteTitle: 'Не можете решить?',
                rouletteStartBtnText: 'Крутить рулетку',
                rouletteToolText: 'Рулетка рекомендаций',
                rouletteModalTitle: 'И рекомендация...',
                spinAgain: 'Крутить снова',
                moreDetails: 'Подробнее',
                watchOnCineby: 'Смотреть на CINEBY',
                navPlugins: 'Плагины',
                plugin_cineby_name: 'Плагин CINEBY',
                plugin_cineby_desc: 'Добавляет кнопку для просмотра напрямую через CINEBY. Может содержать рекламу и всплывающие окна - используйте на свой страх и риск.',
                navTvChannels: 'ТВ каналы',
                tvChannelsTitle: 'Прямой эфир ТВ',
                epgTitle: 'Расписание',
                epgToday: 'Сегодня',
                epgTomorrow: 'Завтра',
                epgDisclaimer: 'Идентификация контента в расписании не точна и может быть неверной.',
                plugin_tv_name: 'Плагин ТВ каналов',
                plugin_tv_desc: 'Смотрите прямые трансляции израильских телеканалов. Требуется стабильное подключение к интернету. Качество потока может варьироваться.',
                subtitleToggleOn: 'Субтитры: Вкл',
                subtitleToggleOff: 'Субтитры: Выкл',
                selectChannelPrompt: 'Выберите канал из списка, чтобы начать просмотр.',
                searchChannelsPlaceholder: 'Поиск канала...',
                identifyTvContent: 'Что идет? (ИИ)',
                identifyingContent: 'ИИ определяет контент...',
                contentNotIdentified: 'Контент не определен',
                settingsAiTvIdentifierLabel: 'ИИ-идентификатор ТВ контента',
                settingsAiTvIdentifierDescription: 'Автоматически определять, что идет на телеканалах с помощью ИИ.',
                settingsAiTvTimerLabel: 'Интервал обновления ИИ',
                tvSettingsModalTitle: 'Настройки ИИ-идентификатора',
                secondsUnit: 'сек',
                settingsSportsScoreboardLabel: 'Спортивное табло',
                settingsSportsScoreboardDescription: 'Отображать специальное табло для спортивных трансляций.',
                multiChannelTag: 'Мультиканал',
                tvCategories: {
                    news: 'Новости',
                    kids: 'Дети и молодежь',
                    religion: 'Религия',
                    sports: 'Спорт',
                    general: 'Общие',
                    science: 'Наука и природа',
                    drama: 'Драмы и теленовеллы',
                    free_tv: 'Free TV',
                    hot: 'HOT'
                },
                settingsExperimentalTag: 'Экспериментально',
                fortniteTrailerBtnTitle: 'Смотреть трейлер',
                navEvents: 'События',
                eventsTitle: 'Специальные события',
                tvChannelsDownNotice: 'Мы знаем о проблеме, из-за которой большинство каналов недоступны. Мы работаем над исправлением как можно скорее.',
                director: 'Режиссер',
                writer: 'Сценарист',
                guestStars: 'Приглашенные звезды',
                translateToEnglish: 'Перевести на английский',
                translateToHebrew: 'Перевести на иврит',
                translating: 'Перевод...', // NEW
                translationError: 'Ошибка перевода.', // NEW
                'connectingTo': 'Подключение к...',
                'aiIdentifyingWillRetry': 'ИИ продолжит попытки идентификации в фоновом режиме...',
                'screenshotFailedSecurity': 'Скриншот не удался. Браузер блокирует захват защищенных видеопотоков из-за ограничений авторского права.',
                'screenshotFailedGeneric': 'Скриншот не удался.',
                'recordVideo': 'Записать видео',
                'stopRecording': 'Остановить запись',
                'recording': 'Запись...',
                'recordingFailedSecurity': 'Запись не удалась. Браузер блокирует запись защищенных видеопотоков из-за ограничений авторского права.',
                'recordingFailedGeneric': 'Запись не удалась.',
                'recordingStarted': 'Запись началась!',
                'recordingStopped': 'Запись остановлена. Скачивание файла...',
                'moreLikeThis': 'Вам также может понравиться',
                'captureDisclaimer': 'Захват контента может быть прерывистым и/или влиять на стабильность трансляции.',
                'videoQuality': 'Качество видео',
                'qualityAuto': 'Авто',
                'qualityHD1080': 'Высокое (1080p)',
                'qualityHD720': 'Высокое (720p)',
                'qualityLarge': 'Стандартное (480p)',
                'qualityMedium': 'Среднее (360p)',
                'playbackSpeed': 'Скорость воспроизведения',
                'speedNormal': 'Обычная (1x)',
                'settingsFlixyLabel': 'Показать Flixy (ИИ-помощник)',
                'settingsFlixyDescription': 'Показать или скрыть плавающую кнопку чата ИИ-помощника.',
                'loginStreak': 'Стрик {days} дней',
                'streakLost': 'О нет! Стрик потерян. Начинаем заново! 💪',
                'streakExtended': 'Стрик продлен! 🔥 ({days} дней)',
                genres: {
                    "28": "Боевик", "12": "Приключения", "16": "Мультфильм", "35": "Комедия", "80": "Криминал", "99": "Документальный", "18": "Драма",
                    "10751": "Семейный", "14": "Фэнтези", "36": "История", "27": "Ужасы", "10402": "Музыка", "9648": "Детектив", "10749": "Мелодрама",
                    "878": "Фантастика", "10770": "Телефильм", "53": "Триллер", "10752": "Военный", "37": "Вестерн", "10759": "Боевик и Приключения",
                    "10762": "Детский", "10763": "Новости", "10764": "Реалити-шоу", "10765": "Научная фантастика и фэнтези", "10766": "Мыльная опера", "10767": "Ток-шоу", "10768": "Война и Политика"
                },
                // NEW: Player Translations
                playerLoop: 'Автоповтор',
                playerSpeed: 'Скорость',
                playerCopyLink: 'Копировать ссылку',
                playerStateOn: 'Вкл',
                playerStateOff: 'Выкл',
                speedNormal: 'Обычная'
            },
            'ar': {
                langDir: 'rtl',
                allGenres: 'كل الأنواع',
                home: 'الرئيسية',
                movies: 'أفلام',
                series: 'مسلسلات',
                nowInCinemasNav: 'في السينما',
                newReleasesNav: 'إصدارات جديدة',
                myLibrary: 'مكتبتي',
                settings: 'الإعدادات',
                discover: 'اكتشف',
                myZone: 'منطقتي',
                navShorts: 'فيديوهات قصيرة',
                more: 'المزيد',
                general: 'عام',
                language: 'لغة الواجهة',
                languageDescription: 'تغيير لغة واجهة التطبيق (القوائم، الأزرار).',
                contentLanguage: 'لغة المحتوى',
                contentLanguageDescription: 'تغيير لغة عناوين الأفلام والمسلسلات والوصف.',
                settingsDisplay: 'العرض',
                settingsDisplayMode: 'السمة',
                displayModeDescription: 'اختر بين الوضع الداكن، الفاتح، أو المزامنة التلقائية مع إعدادات النظام.',
                settingsCardDensity: 'كثافة البطاقة',
                settingsCardDensityDescription: 'تغيير التباعد بين البطاقات لعرض المزيد أو الأقل من العناصر على الشاشة.',
                densityCompact: 'مدمج',
                densityDefault: 'افتراضي',
                densityComfortable: 'مريح',
                settingsAccessibility: 'سهولة الوصول',
                highContrast: 'تباين عالي',
                highContrastDescription: 'تحسين القراءة عن طريق زيادة التباين بين النص والخلفية.',
                reducedMotion: 'تقليل الحركة',
                reducedMotionDescription: 'تقليل أو تعطيل الرسوم المتحركة والانتقالات في الواجهة لتجربة أكثر هدوءًا.',
                settingsUnderlineLinks: 'تسطير الروابط',
                settingsUnderlineLinksDescription: 'إضافة خط تحت جميع الروابط لتسهيل التعرف عليها.',
                fontSize: 'حجم الخط',
                fontSizeDescription: 'زيادة أو تقليل حجم النص في التطبيق لقراءة أكثر راحة.',
                reset: 'إعادة تعيين',
                themeAutomatic: 'تلقائي',
                themeDark: 'داكن',
                themeLight: 'فاتح',
                themeStarlight: 'ضوء النجوم',
                themeGlass: 'زجاج سائل',
                whatsNew: "ما الجديد؟",
                about: 'حول',
                installApp: 'تثبيت التطبيق',
                aboutTitle: 'حول Find-Flix',
                aboutDescription: 'تم إنشاء هذا الموقع كمشروع شخصي بواسطة Amit Yefet وليس له صلة رسمية بخدمات البث المذكورة. يتم جمع المعلومات من مصادر عامة وعرضها لأغراض إعلامية فقط باستخدام TMDB API. نحن لا ندعم أو نشجع مشاهدة المحتوى المقرصن. © 2025 جميع الحقوق محفوظة. لاستخدام ميزات الذكاء الاصطناعي، يجب إدخال مفتاح Gemini API في الإعدادات.',
                navigationTitle: 'القائمة',
                searchResults: 'نتائج البحث',
                subtitle: 'اعثر على فيلمك أو مسلسلك القادم.',
                surpriseMeBtn: 'فاجئني',
                toolsBtnText: 'أدوات',
                surpriseAgainBtn: 'فاجئني مرة أخرى!',
                contactUs: 'اتصل بنا',
                loading: 'جارٍ تحميل البيانات...',
                scrollLoading: 'جارٍ تحميل المزيد من المحتوى...',
                posterAlt: 'ملصق لـ',
                descriptionNotAvailable: 'الوصف غير متوفر حالياً.',
                movie: 'فيلم',
                rating: 'التقييم',
                duration: 'س',
                hours: 'س',
                minutes: 'د',
                webSearchBtn: 'بحث في الويب',
                noProviders: 'لم نتمكن من العثور على معلومات حول خدمات البث لهذا المحتوى.',
                seasonsHeading: 'المواسم',
                loadingSeasons: 'جارٍ تحميل المواسم...',
                episodes: 'حلقات',
                noSeasons: 'لا توجد معلومات عن المواسم.',
                noResults: 'لم يتم العثور على نتائج.',
                noResultsTip: 'جرب البحث عن محتوى أكثر شهرة.',
                reportProblemContentSubject: 'إبلاغ عن مشكلة في المحتوى:',
                reportContentProblem: 'إبلاغ عن مشكلة في المحتوى',
                castAndCrew: 'طاقم العمل',
                biography: 'السيرة الذاتية',
                biographyNotAvailable: 'السيرة الذاتية غير متوفرة.',
                born: 'تاريخ الميلاد',
                placeOfBirth: 'مكان الميلاد',
                knownFor: 'معروف بـ',
                noCreditsFound: 'لم يتم العثور على أعمال.',
                searchPlaceholder: [ "أشياء غريبة", "بيت التنين", "الماندلوري", "صراع العروش", "التاج", "شيلدون الشاب" ],
                goodMorning: 'صباح الخير!',
                goodAfternoon: 'مساء الخير!',
                goodEvening: 'مساء الخير!',
                goodNight: 'تصبح على خير!',
                maintenanceTitle: 'تحديث جديد!',
                maintenanceDescription: 'تحديث جديد متاح - تمت إضافة فئة "في السينما"، تحسينات في الاستقرار وإصلاحات للأخطاء.',
                episodesPageTitle: '{seriesName} - حلقات الموسم {seasonNumber}',
                backToSeries: 'العودة للمسلسل',
                episode: 'حلقة',
                watchTrailer: 'شاهد الإعلان',
                nowInCinemas: 'الآن في السينما!',
                newContent: 'جديد!',
                addToLibrary: 'أضف إلى المكتبة',
                removeFromLibrary: 'إزالة من المكتبة',
                libraryEmpty: 'مكتبتك فارغة.',
                libraryNotice: 'يتم تخزين العناصر المحفوظة محليًا في متصفحك. مسح بيانات المتصفح سيؤدي إلى حذفها.',
                addedToLibrary: 'تمت الإضافة إلى مكتبتك!',
                removedFromLibrary: 'تمت الإزالة من مكتبتك.',
                navWatched: 'سجل المشاهدة',
                addToWatched: 'أضف إلى سجل المشاهدة',
                removeFromWatched: 'إزالة من سجل المشاهدة',
                watchedEmpty: 'لم تقم بتمييز أي محتوى كمشاهد بعد.',
                addedToWatchedToast: 'تمت الإضافة إلى سجل المشاهدة!',
                removedFromWatched: 'تمت الإزالة من سجل المشاهدة.',
                watchedNoticeExtra: 'ملاحظة: سيتم استبعاد المحتوى الذي تم وضع علامة عليه كمشاهد من توصيات "فاجئني".',
                noNewRecommendations: 'لا توجد توصيات جديدة متاحة الآن.',
                noRecommendations: 'لم يتم العثور على عناوين مشابهة.',
                buyTicket: 'شراء تذكرة',
                share: 'مشاركة',
                linkCopied: 'تم نسخ الرابط!',
                shareMessage: 'تحقق من {title} على Find-Flix!',
                // shareEpisodeMessage removed
                cookieMessage: 'مرحباً! نحن نستخدم ملفات تعريف الارتباط (للأسف ليست صالحة للأكل 🍪) لجعل هذا الموقع يعمل بشكل صحيح. النقر على "أوافق" يشبه إعطاءنا تحية لنتمكن من تقديم تجربة أفضل لك. 🫡',
                cookieAgree: 'أوافق',
                metaDescription: 'يساعدك Find-Flix في العثور على فيلمك أو مسلسلك القادم، مع توصيات وبحث ومعلومات حول مكان المشاهدة.',
                metaKeywords: 'أفلام، مسلسلات، نتفليكس، توصيات، بحث أفلام، سينما',
                welcomeTitle: 'مرحباً بك في Find-Flix!',
                welcomeSubtitle: 'أخبرنا قليلاً عن نفسك حتى نتمكن من العثور على توصيات مثالية لك.',
                ageLabel: "ما هي فئتك العمرية؟",
                ageGroup1: '12 وأقل',
                ageGroup2: '13-17',
                ageGroup3: '18+',
                genresLabel: 'ما الأنواع التي تفضلها؟',
                genresInstruction: 'اختر 3 على الأقل.',
                onboardingSubmit: "لنبدأ!",
                recommendationsForYou: 'توصيات مخصصة',
                myAccount: 'حسابي',
                changePreferences: 'تغيير التفضيلات',
                preferencesDescription: 'أعد إجراء اختبار التفضيلات لتحديث توصياتك.',
                resetPreferences: 'إعادة تعيين التفضيلات',
                resetPreferencesDescription: 'سيؤدي هذا إلى مسح تفضيلاتك الشخصية.',
                preferencesResetSuccess: 'تم إعادة تعيين التفضيلات!',
                skip: 'تخطي',
                skipNotice: '*سيؤدي التخطي إلى عرض محتوى شائع عام بدلاً من التوصيات الشخصية.',
                settingsInformationTitle: 'معلومات',
                viewBtn: 'عرض',
                settingsWhatsNewLabel: "ما الجديد؟",
                settingsWhatsNewDescription: 'عرض معلومات حول آخر تحديث للتطبيق.',
                settingsAboutLabel: 'حول',
                settingsAboutDescription: 'معلومات حول التطبيق ومنشئه والتقنيات المستخدمة.',
                settingsContactLabel: 'اتصل بنا',
                settingsContactDescription: 'هل لديك سؤال أو اقتراح؟ نود أن نسمع منك.',
                backupRestore: 'النسخ الاحتياطي والاستعادة',
                backupRestoreDescription: 'احفظ أو حمل جميع بياناتك وإعداداتك باستخدام ملف نسخ احتياطي.',
                exportFile: 'تصدير ملف',
                importFile: 'استيراد ملف',
                exportData: 'تصدير البيانات',
                importData: 'استيراد البيانات',
                importSuccess: 'تم استيراد البيانات بنجاح! سيتم إعادة تحميل التطبيق.',
                importError: 'خطأ في استيراد الملف.',
                exportCode: 'تصدير عبر الرمز',
                importCode: 'استيراد من الرمز',
                exportCodeModalTitle: 'رمز النسخ الاحتياطي الخاص بك',
                exportCodeModalInstructions: 'انسخ هذا الرمز واحفظه في مكان آمن.',
                copyCode: 'نسخ الرمز',
                codeCopied: 'تم نسخ الرمز!',
                importCodeModalTitle: 'لصق رمز النسخ الاحتياطي',
                importCodeModalInstructions: 'الصق رمز النسخ الاحتياطي الذي حفظته في مربع النص أدناه.',
                pasteCodePlaceholder: 'الصق الرمز هنا...',
                importBtn: 'استيراد',
                navAchievements: 'سلسلة المشاهدة',
                achievementsTitle: 'السلسلة والجوائز',
                achievementsGridTitle: 'الجوائز والمعالم',
                achievementUnlocked: 'تم فتح إنجاز!',
                streakLabel: 'أيام متتالية',
                highestStreak: 'أفضل رقم شخصي',
                achievedOn: 'تحقق في',
                nextReward: 'الجائزة التالية',
                streakMotivation: [
                    "لقد بدأنا للتو! لنستمر.",
                    "بدأت الأمور تسخن! 3 أيام متتالية.",
                    "واو! أسبوع كامل من المشاهدة.",
                    "أنت في طريقك للاحتراف!",
                    "شهر كامل؟! أسطورة."
                ],
                rewards: {
                    day1: { title: "بداية جيدة", desc: "تم تسجيل الدخول لأول مرة." },
                    day3: { title: "تسخين", desc: "3 أيام متتالية. الاستمرارية هي المفتاح!" },
                    day7: { title: "سلسلة أسبوع!", desc: "7 أيام متتالية. استمر!" },
                    day14: { title: "سلسلة جادة", desc: "14 يوم متتالي. أحسنت!" },
                    day30: { title: "سيد الزجاج", desc: "30 يوم متتالي. يفتح سمة 'الزجاج السائل' المميزة." },
                    day60: { title: "شهران من القوة", desc: "60 يوم متتالي! أنت جزء من العائلة." },
                    day120: { title: "مدمن شاشة", desc: "120 يوم متتالي. لا يوم بدون فيلم؟" },
                    day200: { title: "أسطورة المشاهدة", desc: "200 يوم! استمرارك مثير للإعجاب." },
                    day365: { title: "عام الأفلام", desc: "365 يوم! عام كامل من المشاهدة اليومية. مذهل!" },
                    day500: { title: "سيد Find-Flix", desc: "500 يوم!!! لا توجد كلمات. أنت الحاكم بلا منازع." }
                },
                achievement_first_watch_name: 'الخطوات الأولى',
                achievement_first_watch_desc: 'شاهدت فيلمك أو مسلسلك الأول.',
                achievement_collector_1_name: 'جامع مبتدئ',
                achievement_collector_1_desc: 'أضف 5 عناصر إلى مكتبتك.',
                achievement_collector_2_name: 'جامع جاد',
                achievement_collector_2_desc: 'أضف 25 عنصرًا إلى مكتبتك.',
                achievement_movie_buff_name: 'مهووس بالأفلام',
                achievement_movie_buff_desc: 'ضع علامة "شوهد" على 10 أفلام.',
                achievement_series_binger_name: 'عاشق المسلسلات',
                achievement_series_binger_desc: 'ضع علامة "شوهد" على 10 مسلسلات.',
                achievement_explorer_name: 'مستكشف الأنواع',
                achievement_explorer_desc: 'تصفية حسب 3 أنواع مختلفة.',
                achievement_lucky_name: 'محظوظ',
                achievement_lucky_desc: 'استخدم "فاجئني" 5 مرات.',
                achievement_power_user_name: 'مستخدم محترف',
                achievement_power_user_desc: 'فتح 5 إنجازات أخرى.',
                achievement_time_traveler_name: 'مسافر عبر الزمن',
                achievement_time_traveler_desc: 'شاهد محتوى من 6 عقود مختلفة.',
                reward_starlight_theme: 'جائزة: سمة "ضوء النجوم"!',
                reward_glass_theme: 'جائزة: سمة "الزجاج السائل"!',
                settingsAdvancedTitle: 'إعدادات متقدمة',
                settingsCustomFontLabel: 'خط مخصص',
                settingsCustomFontDescription: 'قم بتحميل ملف الخط الخاص بك.',
                uploadFont: 'تحميل خط',
                resetFont: 'إعادة تعيين',
                currentFontLabel: 'الخط الحالي',
                defaultFont: 'افتراضي',
                fontUploadSuccess: "تم تطبيق الخط '{fontName}' بنجاح!",
                fontUploadError: 'خطأ في تحميل ملف الخط.',
                fontResetSuccess: 'تم إعادة تعيين الخط للافتراضي.',
                getAiSummary: 'احصل على رؤى الذكاء الاصطناعي',
                aiSummaryTitle: 'رؤى الذكاء الاصطناعي لـ {title}',
                aiLoading: 'يفكر... الذكاء الاصطناعي يحلل المحتوى...',
                aiError: 'عفواً. لم يتمكن الذكاء الاصطناعي من إنشاء ملخص الآن.',
                apiKeyNeeded: 'مطلوب مفتاح Gemini API. يرجى تعيينه في الإعدادات.',
                apiKeySaved: 'تم حفظ مفتاح API!',
                saveBtn: 'حفظ',
                settingsGeminiApiKeyLabel: 'متاح Gemini API',
                settingsGeminiApiKeyDescription: 'مطلوب لاستخدام ميزات الذكاء الاصطناعي.',
                geminiApiKeyNotice: 'مفاتيح Gemini لها حدود استخدام.',
                aiRecommenderBtn: 'موصي الذكاء الاصطناعي',
                aiRecommenderTitle: 'مستشارك الشخصي للمحتوى',
                aiRecommenderInstructions: 'صف الفيلم أو المسلسل الذي ترغب في مشاهدته.',
                aiRecommenderPlaceholder: 'مثال: كوميديا رومانسية خفيفة وممتعة...',
                aiRecommenderSubmit: 'ابحث عن توصية',
                aiRecommenderSearching: 'جارٍ البحث...',
                aiRecommendationFailed: 'لم نتمكن من العثور على توصية مناسبة.',
                aiDisclaimer: 'قد يكون المحتوى الذي تم إنشاؤه بواسطة الذكاء الاصطناعي غير دقيق.',
                generatePodcast: 'إنشاء بودكاست',
                podcastTitle: 'بودكاست عن {title}',
                podcastLoading: 'جارٍ إنشاء البودكاست... الذكاء الاصطناعي يكتب النص...',
                downloadPodcast: 'تنزيل MP3',
                achievement_ai_consultant_name: 'مستشار الذكاء الاصطناعي',
                achievement_ai_consultant_desc: 'استخدم ميزات الذكاء الاصطناعي 3 مرات.',
                rouletteTitle: 'لا تستطيع أن تقرر؟',
                rouletteStartBtnText: 'أدر الروليت',
                rouletteToolText: 'روليت التوصيات',
                rouletteModalTitle: 'والتوصية هي...',
                spinAgain: 'أدر مرة أخرى',
                moreDetails: 'المزيد من التفاصيل',
                watchOnCineby: 'شاهد على CINEBY',
                navPlugins: 'الإضافات',
                plugin_cineby_name: 'إضافة CINEBY',
                plugin_cineby_desc: 'أضف زرًا للمشاهدة مباشرة عبر CINEBY.',
                navTvChannels: 'قنوات التلفزيون',
                tvChannelsTitle: 'بث تلفزيوني مباشر',
                epgTitle: 'جدول البث',
                epgToday: 'اليوم',
                epgTomorrow: 'غداً',
                epgDisclaimer: 'التعرف على المحتوى في الجدول ليس دقيقاً وقد يكون غير صحيح.',
                plugin_tv_name: 'إضافة قنوات التلفزيون',
                plugin_tv_desc: 'شاهد قنوات التلفزيون الإسرائيلية مباشرة.',
                subtitleToggleOn: 'ترجمة: تشغيل',
                subtitleToggleOff: 'ترجمة: إيقاف',
                selectChannelPrompt: 'اختر قناة من القائمة لبدء المشاهدة.',
                searchChannelsPlaceholder: 'بحث عن قناة...',
                identifyTvContent: 'ماذا يُعرض؟ (AI)',
                identifyingContent: 'الذكاء الاصطناعي يحدد المحتوى...',
                contentNotIdentified: 'لم يتم تحديد المحتوى',
                settingsAiTvIdentifierLabel: 'معرف محتوى التلفزيون بالذكاء الاصطناعي',
                settingsAiTvIdentifierDescription: 'التعرف تلقائيًا على ما يُعرض على قنوات التلفزيون المباشرة.',
                settingsAiTvTimerLabel: 'فاصل تحديث الذكاء الاصطناعي',
                tvSettingsModalTitle: 'إعدادات معرف محتوى الذكاء الاصطناعي',
                secondsUnit: 'ثانية',
                settingsSportsScoreboardLabel: 'لوحة النتائج الرياضية',
                settingsSportsScoreboardDescription: 'عرض لوحة نتائج خاصة للبث الرياضي.',
                multiChannelTag: 'متعدد القنوات',
                tvCategories: {
                    news: 'أخبار',
                    kids: 'أطفال وشباب',
                    religion: 'دين',
                    sports: 'رياضة',
                    general: 'عام',
                    science: 'علوم وطبيعة',
                    drama: 'دراما ومسلسلات',
                    free_tv: 'Free TV',
                    hot: 'HOT'
                },
                settingsExperimentalTag: 'تجريبي',
                fortniteTrailerBtnTitle: 'شاهد الإعلان',
                navEvents: 'أحداث',
                eventsTitle: 'أحداث خاصة',
                tvChannelsDownNotice: 'نحن على علم بمشكلة تسبب عدم توفر معظم القنوات.',
                director: 'المخرج',
                writer: 'الكاتب',
                guestStars: 'نجوم ضيوف',
                translateToEnglish: 'ترجم إلى الإنجليزية',
                translateToHebrew: 'ترجم إلى العبرية',
                translating: 'جارٍ الترجمة...',
                translationError: 'خطأ في الترجمة.',
                'connectingTo': 'جارٍ الاتصال بـ...',
                'aiIdentifyingWillRetry': 'سيستمر الذكاء الاصطناعي في محاولة التحديد في الخلفية...',
                'screenshotFailedSecurity': 'فشل لقطة الشاشة. المتصفح يحظر التقاط التدفقات المحمية.',
                'screenshotFailedGeneric': 'فشل لقطة الشاشة.',
                'recordVideo': 'تسجيل فيديو',
                'stopRecording': 'إيقاف التسجيل',
                'recording': 'جارٍ التسجيل...',
                'recordingFailedSecurity': 'فشل التسجيل. المتصفح يحظر تسجيل التدفقات المحمية.',
                'recordingFailedGeneric': 'فشل التسجيل.',
                'recordingStarted': 'بدأ التسجيل!',
                'recordingStopped': 'توقف التسجيل. جارٍ تنزيل الملف...',
                'moreLikeThis': 'المزيد مثل هذا',
                'captureDisclaimer': 'قد يكون التقاط المحتوى متقطعًا.',
                'videoQuality': 'جودة الفيديو',
                'qualityAuto': 'تلقائي',
                'qualityHD1080': 'عالية (1080p)',
                'qualityHD720': 'عالية (720p)',
                'qualityLarge': 'قياسية (480p)',
                'qualityMedium': 'متوسطة (360p)',
                'playbackSpeed': 'سرعة التشغيل',
                'speedNormal': 'عادية (1x)',
                'settingsFlixyLabel': 'إظهار Flixy (مساعد الذكاء الاصطناعي)',
                'settingsFlixyDescription': 'إظهار أو إخفاء زر الدردشة العائم لمساعد الذكاء الاصطناعي.',
                'loginStreak': 'سلسلة {days} أيام',
                'streakLost': 'أوه لا! فقدت السلسلة. لنبدأ من جديد! 💪',
                'streakExtended': 'تم تمديد السلسلة! 🔥 ({days} أيام)',
                'streakStarted': 'بدأت سلسلتك الأولى! 🚀',
                'newMilestone': 'تم فتح معلم جديد: {title} 🏆',
                'genres': {
                    "28": "أكشن", "12": "مغامرة", "16": "رسوم متحركة", "35": "كوميديا", "80": "جريمة", "99": "وثائقي", "18": "دراما",
                    "10751": "عائلي", "14": "فانتاسيا", "36": "تاريخ", "27": "رعب", "10402": "موسيقى", "9648": "غموض", "10749": "رومانسية",
                    "878": "خيال علمي", "10770": "فيلم تلفزيوني", "53": "إثارة", "10752": "حرب", "37": "غرب أمريكي", "10759": "أكشن ومغامرة",
                    "10762": "أطفال", "10763": "أخبار", "10764": "واقع", "10765": "خيال علمي وفانتاسيا", "10766": "أوبرا الصابون", "10767": "برنامج حواري", "10768": "حرب وسياسة"
                },
                // NEW: Player Translations
                playerLoop: 'تكرار تلقائي',
                playerSpeed: 'السرعة',
                playerCopyLink: 'نسخ الرابط',
                playerStateOn: 'تشغيل',
                playerStateOff: 'إيقاف',
                speedNormal: 'عادية'
            }
            
        };
        const genreEmojis = {
            // Movie & TV Genres
            28: '💥',    // Action
            12: '🗺️',    // Adventure
            16: '🎨',    // Animation
            35: '😂',    // Comedy
            80: '🔪',    // Crime
            99: '📄',    // Documentary
            18: '🎭',    // Drama
            10751: '👨‍👩‍👧‍👦', // Family
            14: '✨',    // Fantasy
            36: '📜',    // History
            27: '👻',    // Horror
            10402: '🎵',  // Music
            9648: '❓',  // Mystery
            10749: '❤️',   // Romance
            878: '👽',   // Science Fiction
            10770: '📺',  // TV Movie
            53: '😨',   // Thriller
            10752: '⚔️',   // War
            37: '🤠',    // Western
            // TV Only Genres
            10759: '🗺️', // Action & Adventure
            10762: '🧒', // Kids
            10763: '📰', // News
            10764: '👁️', // Reality
            10765: '🧙', // Sci-Fi & Fantasy
            10766: '🧼', // Soap
            10767: '💬', // Talk
            10768: '🏛️'  // War & Politics
        };
        const cinemaTicketUrls = {
            'he': 'https://www.cinema-city.co.il/',
            'en': 'https://www.amctheatres.com/',
            'ru': 'https://kinoteatr.ru/',
            'ar': 'https://ksa.voxcinemas.com/',
            'de': 'https://www.cinestar.de/',
            'es': 'https://www.yelmocines.es/',
            'it': 'https://www.ucicinemas.it/',
            'fr': 'https://www.pathe.fr/',
            'pt': 'https://www.cinemas.nos.pt/'
        };
        
        // NEW: Centralized Streak Milestones
        const STREAK_MILESTONES = [
            { days: 1, id: 'day1', icon: '🌱' },
            { days: 3, id: 'day3', icon: '🌶️' },
            { days: 7, id: 'day7', icon: '✨' },
            { days: 14, id: 'day14', icon: '🧊' },
            { days: 30, id: 'day30', icon: '👑', rewardId: 'glass_theme' },
            { days: 60, id: 'day60', icon: '🥈' },
            { days: 120, id: 'day120', icon: '🥇' },
            { days: 200, id: 'day200', icon: '🎖️' },
            { days: 365, id: 'day365', icon: '📅' },
            { days: 500, id: 'day500', icon: '🚀' }
        ];
 
// DOM Elements
const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const menuToggleBtn = document.getElementById('menu-toggle-btn');
        const mainView = document.getElementById('main-view');
        const detailView = document.getElementById('detail-view');
        const episodesView = document.getElementById('episodes-view');
        const libraryView = document.getElementById('library-view');
        const cinemasView = document.getElementById('cinemas-view');
        const newReleasesView = document.getElementById('new-releases-view');
        const settingsView = document.getElementById('settings-view');
        const watchedView = document.getElementById('watched-view');
        const achievementsView = document.getElementById('achievements-view');
        const castView = document.getElementById('cast-view');
        const personView = document.getElementById('person-view');
        const pluginsView = document.getElementById('plugins-view');
        const shortsView = document.getElementById('shorts-view');
        const tvView = document.getElementById('tv-view');
        const contentGrid = document.getElementById('content-grid');
        const libraryGrid = document.getElementById('library-grid');
        const cinemasGrid = document.getElementById('cinemas-grid');
        const newReleasesGrid = document.getElementById('new-releases-grid');
        const watchedGrid = document.getElementById('watched-grid');
        const mainTitle = document.getElementById('main-title');
        const mainSubtitle = document.getElementById('main-subtitle');
        const langSelect = document.getElementById('lang-select');
        const searchInput = document.getElementById('search-input');
        const showRecommendationBtn = document.getElementById('show-recommendation-btn');
        const loadingMessage = document.getElementById('loading-message');
        const scrollLoadingMessage = document.getElementById('scroll-loading-message');
        const pageTitle = document.getElementById('page-title');
        const themeSelect = document.getElementById('theme-select');
        const fontSizeSlider = document.getElementById('font-size-slider');
        const resetFontSizeBtn = document.getElementById('reset-font-size-btn');
        const docElement = document.documentElement;
        const backToTopBtn = document.getElementById('back-to-top-btn');
        
        // State variables
        let isLoading = false;
        let isSearchMode = false;
        let searchResultsCache = { query: '', results: [] };
        let currentLanguage = 'he';
        let tmdbLanguage = localStorage.getItem('findFlixTmdbLang') || 'he'; // שפת התוכן (TMDB)
        let selectedGenreId = null;
        let contentCache = {
            home: { items: [], page: 1, allIds: new Set(), canLoadMore: true, type: 'trending' },
            movies: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
            series: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
            shorts: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
        };
        let cameFromSurpriseMe = false;
        let nowPlayingMovieIds = new Set();
        let scrollPositions = { home: 0, movies: 0, series: 0, cinemas: 0, newReleases: 0, library: 0, watched: 0, search: 0, achievements: 0, 'ai-results': 0, shorts: 0 };
        let currentView = null; // 'home', 'movies', 'series'
        let libraryItems = [];
        let watchedItems = [];
        let aiResultsCache = [];
        let userAchievements = { unlocked: new Set(), progress: {} };
        let isShowingDetails = false;
        let allGenres = {};
        let hls;
        let tvContentInterval = null; // NEW: Interval for auto-identifying TV content
        let isAIIdentifying = false; // NEW: Flag to prevent concurrent AI calls
        let currentPlayingChannel = null; // NEW
        let controlsTimeout = null; // NEW: Timer for hiding TV controls
        let currentPodcastRequestId = 0; // To prevent race conditions in podcast generation
        let epgDataStore = {};
        let tvEpgIntervals = []; // NEW: Array to store EPG cycling intervals
        let fullEpgInterval = null; // NEW: Interval for full EPG auto-refresh
        let channelsRefreshInterval = null; // NEW: Interval for channels list auto-refresh
        let mediaRecorder = null; // NEW: For video recording
        let recordedChunks = []; // NEW: For video recording
        let isShortsFeedMuted = true; // NEW: Global state for shorts mute
        /* REMOVED let currentShortsQuality = localStorage.getItem('findFlixShortsQuality') || 'auto'; // NEW: Global quality state */
        /* REMOVED let currentShortsSpeed = parseFloat(localStorage.getItem('findFlixShortsSpeed') || 1); // NEW: Global speed state */

        // NEW: Shorts player state
        let shortsPlayers = new Map();
        let shortsIntervals = new Map();
        let isYouTubeApiReady = false;
        let apiReadyQueue = [];

        // NEW: Trailer Player State
        let trailerPlayer = null;
        let trailerUpdateInterval = null;
        let isTrailerDragging = false;
        let isSettingsOpen = false;
        let isTrailerLooping = localStorage.getItem('findFlixTrailerLoop') === 'true'; // NEW: Loop State

        // NEW: Robust check for YouTube API
        if (window.YT && window.YT.Player) {
            // Case 1: API script loaded *before* this module script.
            // We can't rely on the callback, so we just set the flag.
            isYouTubeApiReady = true;
        } else {
            // Case 2: API script hasn't loaded or isn't ready.
            // Assign our callback function.
            window.onYouTubeIframeAPIReady = function() {
                isYouTubeApiReady = true;
                // Process any iframes that were queued while we waited
                apiReadyQueue.forEach(iframeId => createShortPlayer(iframeId));
                apiReadyQueue = []; // Clear the queue
            };
        }

        // NEW: Global formatTime function
        const formatTime = (seconds) => {
            if (isNaN(seconds) || seconds < 0) return "0:00";
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        };

        // REMOVED: Old YouTube API Ready Callback
        /*
        window.onYouTubeIframeAPIReady = function() {
            isYouTubeApiReady = true;
            // Process any iframes that loaded before the API was ready
            apiReadyQueue.forEach(iframeId => createShortPlayer(iframeId));
            apiReadyQueue = []; // Clear the queue
        };
        */

        // NEW: Function to create a YT Player instance
        function createShortPlayer(iframeId) {
            if (shortsPlayers.has(iframeId)) return; // Already created
            
            const player = new YT.Player(iframeId, {
                events: {
                    'onReady': onShortPlayerReady,
                    'onStateChange': onShortPlayerStateChange
                }
            });
            shortsPlayers.set(iframeId, player);
        }

        // NEW: Function to init Trailer Player
        function initTrailerPlayer(videoId) {
            if (trailerPlayer) {
                // If player exists, load new video
                trailerPlayer.loadVideoById(videoId);
                resetTrailerControls();
                // We'll update settings once the new video emits events
                return;
            }

            trailerPlayer = new YT.Player('trailer-player-placeholder', {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: {
                    'autoplay': 1,
                    'controls': 0, // Hide default controls
                    'rel': 0, // No related videos at end
                    'modestbranding': 1,
                    'playsinline': 1,
                    'disablekb': 1, // Disable keyboard controls (we handle them)
                    'enablejsapi': 1,
                    'origin': window.location.origin // Security best practice
                },
                events: {
                    'onReady': onTrailerPlayerReady,
                    'onStateChange': onTrailerPlayerStateChange,
                    'onPlaybackRateChange': onTrailerRateChange
                }
            });
        }

        function onTrailerPlayerReady(event) {
            event.target.playVideo();
            updateTrailerVolumeIcon(event.target.getVolume());
            // Set slider to current volume
            const volSlider = document.getElementById('trailer-volume-slider');
            if(volSlider) volSlider.value = event.target.getVolume();
            
            // Initial UI Sync
            updateTrailerSettingsUI();
        }

        function onTrailerRateChange(event) {
            updateTrailerSpeedDisplay(event.data);
        }
        
        // Expose to window for HTML onclick handlers
        window.openSettingsView = function(viewName) {
            const views = document.querySelectorAll('.settings-view');
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(`settings-view-${viewName}`).classList.add('active');
        };

        // NEW: Toggle Loop Function
        window.toggleTrailerLoop = function() {
            isTrailerLooping = !isTrailerLooping;
            localStorage.setItem('findFlixTrailerLoop', isTrailerLooping);
            
            updateTrailerSettingsUI();
            
            const t = translations[currentLanguage];
            const msg = isTrailerLooping 
                ? `${t.playerLoop}: ${t.playerStateOn}` 
                : `${t.playerLoop}: ${t.playerStateOff}`;
            showToast(msg, 'info');
        };

        // NEW: Open on Platform Function
        window.openTrailerOnPlatform = function() {
            if (!trailerPlayer || !trailerPlayer.getVideoUrl) return;
            const url = trailerPlayer.getVideoUrl();
            window.open(url, '_blank');
        };

        // NEW: Restart Function
        window.restartTrailer = function() {
            if (!trailerPlayer) return;
            trailerPlayer.seekTo(0);
            trailerPlayer.playVideo();
        };

        // NEW: Seek Helper Function (Kept for keyboard shortcuts)
        window.seekTrailerBy = function(seconds) {
            if (!trailerPlayer || !trailerPlayer.getCurrentTime) return;
            const currentTime = trailerPlayer.getCurrentTime();
            const duration = trailerPlayer.getDuration();
            let newTime = currentTime + seconds;
            
            // Bounds check
            if (newTime < 0) newTime = 0;
            if (newTime > duration) newTime = duration;
            
            trailerPlayer.seekTo(newTime, true);
        };

        window.setPlayerSpeed = function(rate) {
            if (!trailerPlayer) return;
            trailerPlayer.setPlaybackRate(rate);
            // Close menu
            closeSettingsMenu();
            
            const t = translations[currentLanguage];
            const label = rate === 1 ? t.speedNormal : `x${rate}`;
            showToast(`${t.playerSpeed}: ${label}`, 'info');
        };

        function closeSettingsMenu() {
            const menu = document.getElementById('trailer-settings-menu');
            const btn = document.getElementById('trailer-settings-btn');
            menu.classList.remove('open');
            btn.classList.remove('rotate');
            isSettingsOpen = false;
            // Reset to main view after a delay
            setTimeout(() => window.openSettingsView('main'), 300);
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('trailer-settings-menu');
            const btn = document.getElementById('trailer-settings-btn');
            
            if (isSettingsOpen) {
                closeSettingsMenu();
            } else {
                // Update text translations before opening
                updatePlayerUIText(); 
                menu.classList.add('open');
                btn.classList.add('rotate');
                isSettingsOpen = true;
                updateTrailerSettingsUI(); // Refresh on open
            }
        }
        
        // NEW: Function to update player setting texts
        function updatePlayerUIText() {
            const t = translations[currentLanguage];
            
            // Labels
            const loopLabel = document.getElementById('player-loop-label');
            if(loopLabel) loopLabel.textContent = t.playerLoop;
            
            const speedLabel = document.getElementById('player-speed-label');
            if(speedLabel) speedLabel.textContent = t.playerSpeed;
            
            const speedTitle = document.getElementById('player-speed-title');
            if(speedTitle) speedTitle.textContent = t.playerSpeed;
            
            const speedNormalOption = document.getElementById('player-speed-normal-option');
            if(speedNormalOption) speedNormalOption.textContent = t.speedNormal;
        }

        function updateTrailerSettingsUI() {
            if (!trailerPlayer) return;
            const t = translations[currentLanguage];
            
            // Update Speed UI Highlighting
            const currentSpeed = trailerPlayer.getPlaybackRate();
            
            // Update speed display label
            const label = currentSpeed === 1 ? t.speedNormal : currentSpeed;
            const displayEl = document.getElementById('current-speed-display');
            if(displayEl) displayEl.textContent = label;
            
            // Reset speed items selection
            const speedView = document.getElementById('settings-view-speed');
            speedView.querySelectorAll('.settings-menu-item').forEach(el => el.classList.remove('selected'));
            
            // Find and select current speed
            const speedItems = speedView.querySelectorAll('.settings-menu-item');
            speedItems.forEach(item => {
                const text = item.querySelector('span').textContent;
                // Check against translation or value
                if (text === t.speedNormal && currentSpeed === 1) item.classList.add('selected');
                else if (parseFloat(text) === currentSpeed) item.classList.add('selected');
            });

            // NEW: Update Loop UI
            const loopDisplay = document.getElementById('current-loop-display');
            const loopCheck = document.getElementById('loop-check-icon');
            const loopItem = document.querySelector('#settings-view-main .settings-menu-item[onclick="toggleTrailerLoop()"]');
            
            if (loopDisplay && loopCheck && loopItem) {
                if (isTrailerLooping) {
                    loopDisplay.textContent = t.playerStateOn;
                    loopDisplay.style.color = '#e50914';
                    loopCheck.style.opacity = '1';
                    loopCheck.style.color = '#e50914';
                    loopItem.classList.add('selected');
                } else {
                    loopDisplay.textContent = t.playerStateOff;
                    loopDisplay.style.color = '#aaa';
                    loopCheck.style.opacity = '0';
                    loopItem.classList.remove('selected');
                }
            }
        }
        
        function updateTrailerSpeedDisplay(speed) {
            // Deprecated, logic moved to updateTrailerSettingsUI
        }

        function onTrailerPlayerStateChange(event) {
            const playBtn = document.getElementById('trailer-play-btn');
            const centerPlay = document.getElementById('trailer-center-play');
            
            if (event.data === YT.PlayerState.PLAYING) {
                // Change icon to Pause
                if(playBtn) playBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
                if(centerPlay) centerPlay.classList.add('opacity-0');
                startTrailerInterval();
            } else {
                // Change icon to Play
                if(playBtn) playBtn.innerHTML = `<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                if(centerPlay && event.data !== YT.PlayerState.BUFFERING) centerPlay.classList.remove('opacity-0');
                stopTrailerInterval();
                
                // NEW: Handle Loop on End
                if (event.data === YT.PlayerState.ENDED) {
                    if (isTrailerLooping) {
                        trailerPlayer.seekTo(0);
                        trailerPlayer.playVideo();
                    }
                }
            }
            
            // Refresh settings on play
            if (event.data === YT.PlayerState.PLAYING) {
                updateTrailerSettingsUI();
            }
        }

        function startTrailerInterval() {
            stopTrailerInterval();
            trailerUpdateInterval = setInterval(updateTrailerProgress, 500);
        }

        function stopTrailerInterval() {
            if (trailerUpdateInterval) {
                clearInterval(trailerUpdateInterval);
                trailerUpdateInterval = null;
            }
        }

        function updateTrailerProgress() {
            if (!trailerPlayer || !trailerPlayer.getCurrentTime || isTrailerDragging) return;
            
            const currentTime = trailerPlayer.getCurrentTime();
            const duration = trailerPlayer.getDuration();
            
            if (duration) {
                const percent = (currentTime / duration) * 100;
                const fill = document.getElementById('trailer-progress-fill');
                if(fill) fill.style.width = `${percent}%`;
                
                document.getElementById('trailer-current-time').textContent = formatTime(currentTime);
                document.getElementById('trailer-duration').textContent = formatTime(duration);
            }
        }

        function resetTrailerControls() {
            const fill = document.getElementById('trailer-progress-fill');
            if(fill) fill.style.width = '0%';
            document.getElementById('trailer-current-time').textContent = '0:00';
            document.getElementById('trailer-duration').textContent = '0:00';
        }

        function updateTrailerVolumeIcon(volume) {
            const btn = document.getElementById('trailer-volume-btn');
            if (!btn) return;
            
            if (volume === 0 || trailerPlayer.isMuted()) {
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l-5-5m0 5l5-5" /></svg>`;
            } else if (volume < 50) {
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
            } else {
                btn.innerHTML = `<svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`;
            }
        }

        // NEW: Setup Trailer Controls Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // ... (keep existing listeners)

            // Settings Button Listener
            const settingsBtn = document.getElementById('trailer-settings-btn');
            if (settingsBtn) {
                settingsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSettingsMenu();
                });
            }
            
            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('trailer-settings-menu');
                const btn = document.getElementById('trailer-settings-btn');
                
                if (isSettingsOpen && menu && !menu.contains(e.target) && !btn.contains(e.target)) {
                    closeSettingsMenu();
                }
            });

            // Play/Pause
            document.getElementById('trailer-play-btn').addEventListener('click', toggleTrailerPlay);
            document.getElementById('trailer-click-overlay').addEventListener('click', toggleTrailerPlay);

            function toggleTrailerPlay() {
                if (!trailerPlayer) return;
                const state = trailerPlayer.getPlayerState();
                if (state === YT.PlayerState.PLAYING) {
                    trailerPlayer.pauseVideo();
                } else {
                    trailerPlayer.playVideo();
                }
            }

            // Volume
            const volBtn = document.getElementById('trailer-volume-btn');
            const volSlider = document.getElementById('trailer-volume-slider');
            
            volBtn.addEventListener('click', () => {
                if (!trailerPlayer) return;
                if (trailerPlayer.isMuted()) {
                    trailerPlayer.unMute();
                    // Restore volume if 0
                    if (trailerPlayer.getVolume() === 0) trailerPlayer.setVolume(100);
                } else {
                    if (trailerPlayer.getVolume() > 0) {
                        trailerPlayer.mute();
                    } else {
                        trailerPlayer.unMute();
                        trailerPlayer.setVolume(100);
                    }
                }
                updateTrailerVolumeIcon(trailerPlayer.isMuted() ? 0 : trailerPlayer.getVolume());
                volSlider.value = trailerPlayer.isMuted() ? 0 : trailerPlayer.getVolume();
            });

            volSlider.addEventListener('input', (e) => {
                if (!trailerPlayer) return;
                const val = parseInt(e.target.value);
                trailerPlayer.setVolume(val);
                if (val > 0 && trailerPlayer.isMuted()) trailerPlayer.unMute();
                updateTrailerVolumeIcon(val);
            });

            // Progress Bar Seeking
            const progressContainer = document.getElementById('trailer-progress-container');
            
            progressContainer.addEventListener('mousedown', (e) => {
                isTrailerDragging = true;
                seekTrailer(e);
            });
            
            // Allow dragging specifically on this container
            progressContainer.addEventListener('mousemove', (e) => {
                if (isTrailerDragging) seekTrailer(e);
            });

            document.addEventListener('mouseup', () => {
                if (isTrailerDragging) isTrailerDragging = false;
            });

            function seekTrailer(e) {
                if (!trailerPlayer) return;
                const rect = progressContainer.getBoundingClientRect();
                // Handle RTL/LTR for seek bar? Usually seek bar is LTR even in RTL interfaces for media players
                // But let's stick to standard LTR logic for the bar itself as videos play LTR
                let x = e.clientX - rect.left;
                let percent = Math.max(0, Math.min(1, x / rect.width));
                
                const fill = document.getElementById('trailer-progress-fill');
                if(fill) fill.style.width = `${percent * 100}%`;
                
                const duration = trailerPlayer.getDuration();
                if (duration) {
                    trailerPlayer.seekTo(duration * percent, true);
                    document.getElementById('trailer-current-time').textContent = formatTime(duration * percent);
                }
            }

            // Fullscreen
            document.getElementById('trailer-fullscreen-btn').addEventListener('click', () => {
                const modalContent = document.querySelector('#trailer-modal .aspect-video'); // The container of the player
                if (!document.fullscreenElement) {
                    if (modalContent.requestFullscreen) {
                        modalContent.requestFullscreen();
                    } else if (modalContent.webkitRequestFullscreen) {
                        modalContent.webkitRequestFullscreen();
                    }
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });

            // NEW: Keyboard Shortcuts for Trailer Player
            document.addEventListener('keydown', (e) => {
                const trailerModal = document.getElementById('trailer-modal');
                // Only active if trailer modal is visible and not typing in an input
                if (trailerModal.classList.contains('hidden') || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch(e.key.toLowerCase()) {
                    case ' ': // Space
                    case 'k':
                        e.preventDefault(); // Prevent page scroll
                        toggleTrailerPlay();
                        break;
                    case 'arrowleft':
                    case 'j':
                        e.preventDefault();
                        seekTrailerBy(-5);
                        break;
                    case 'arrowright':
                    case 'l':
                        e.preventDefault();
                        seekTrailerBy(5);
                        break;
                    case 'm':
                        if (trailerPlayer) {
                            if (trailerPlayer.isMuted()) trailerPlayer.unMute();
                            else trailerPlayer.mute();
                            updateTrailerVolumeIcon(trailerPlayer.isMuted() ? 0 : trailerPlayer.getVolume());
                            document.getElementById('trailer-volume-slider').value = trailerPlayer.isMuted() ? 0 : trailerPlayer.getVolume();
                        }
                        break;
                    case 'f':
                        document.getElementById('trailer-fullscreen-btn').click();
                        break;
                    case 'r': // 'R' for Restart/Replay
                        restartTrailer();
                        break;
                }
            });
        });

        // NEW: Player Ready Handler
        function onShortPlayerReady(event) {
            const player = event.target;
            // The observer will handle playing, but we must set the mute state
            if (isShortsFeedMuted) {
                player.mute();
            } else {
                player.unMute();
            }

            // REMOVED: Set preferred quality from here
            /*
            if (currentShortsQuality !== 'auto') {
                player.setPlaybackQuality(currentShortsQuality);
            }
            */
            // END REMOVED

            // Update UI once duration is available
            updateShortProgress(player, player.getIframe().closest('.short-item'));
        }

        // NEW: Player State Change Handler
        function onShortPlayerStateChange(event) {
            const player = event.target;
            const iframe = player.getIframe();
            if (!iframe) return;
            const iframeId = iframe.id;
            const shortItem = iframe.closest('.short-item');
            if (!shortItem) return;

            if (event.data === YT.PlayerState.PLAYING) {
                // Clear any other playing interval, just in case
                shortsIntervals.forEach((interval, id) => {
                    if (id !== iframeId) clearPlayerInterval(id);
                });
                
                // Clear existing interval for this player before starting a new one
                clearPlayerInterval(iframeId);
                
                const intervalId = setInterval(() => updateShortProgress(player, shortItem), 250);
                shortsIntervals.set(iframeId, intervalId);

                // NEW: Set quality on play (more reliable)
                // We only set it if the "auto" quality isn't selected
                /* REMOVED quality setting logic
                if (currentShortsQuality !== 'auto') {
                    // Check if we've already set it for this video load
                    if (shortItem.dataset.qualitySet !== "true") {
                        player.setPlaybackQuality(currentShortsQuality);
                        shortItem.dataset.qualitySet = "true"; // Mark as set
                    }
                } else {
                    // If quality is 'auto', ensure the flag is reset for the next video
                    shortItem.dataset.qualitySet = "false";
                }
                */
                // END NEW

                // --- REVISED: Set speed on play ---
                /* REMOVED speed setting logic
                const currentRate = player.getPlaybackRate();
                if (currentRate !== currentShortsSpeed) {
                    const availableRates = player.getAvailablePlaybackRates();
                    if (availableRates && availableRates.includes(currentShortsSpeed)) {
                        player.setPlaybackRate(currentShortsSpeed);
                    } else if (availableRates && availableRates.length > 0 && !availableRates.includes(currentShortsSpeed)) {
                        // If desired speed isn't available, but we have rates,
                        // and the current rate is not 1, set it to 1.
                        if (currentRate !== 1) {
                            player.setPlaybackRate(1);
                        }
                        // Log a warning if we can't set the desired speed
                        console.warn(`Speed ${currentShortsSpeed}x not available. Defaulting to 1x.`);
                    } else if (availableRates && availableRates.length === 0) {
                        // This can happen. The API is tricky.
                        // We'll just try to set it. If it fails, it fails.
                        // But we'll try again on the next PLAYING state change (e.g. buffering).
                        player.setPlaybackRate(currentShortsSpeed);
                    } else {
                         // Default case: availableRates is null or undefined, just try setting it.
                         player.setPlaybackRate(currentShortsSpeed);
                    }
                }
                */
                // --- END REVISED ---

                // Sync mute button UI
                const muteBtn = shortItem.querySelector('.short-mute-btn');
                if (muteBtn) {
                    if (player.isMuted()) {
                        muteBtn.innerHTML = shortsMuteIcon;
                        shortItem.dataset.isMuted = 'true';
                    } else {
                        muteBtn.innerHTML = shortsUnmuteIcon;
                        shortItem.dataset.isMuted = 'false';
                    }
                }
                shortItem.dataset.isPlaying = 'true';

            } else { // Paused, ended, buffering, etc.
                clearPlayerInterval(iframeId);
                shortItem.dataset.isPlaying = 'false';
                
                if (event.data === YT.PlayerState.ENDED) {
                    // Loop the video
                    player.seekTo(0);
                    player.playVideo();
                } else if (event.data === YT.PlayerState.PAUSED) {
                    // This is handled by the click handler, but good to set state
                } else {
                    // Buffering or Cued, reset time to 0 if it's the start
                    if (player.getCurrentTime() < 1) {
                         updateShortProgress(player, shortItem, true); // Force reset UI
                    }
                }
            }
        }

        // NEW: Helper to clear intervals
        function clearPlayerInterval(iframeId) {
            if (shortsIntervals.has(iframeId)) {
                clearInterval(shortsIntervals.get(iframeId));
                shortsIntervals.delete(iframeId);
            }
        }

        // NEW: Helper to update progress UI
        function updateShortProgress(player, shortItem, forceReset = false) {
            if (!player || !shortItem) return;

            const progressFill = shortItem.querySelector('.short-progress-fill');
            const currentTimeEl = shortItem.querySelector('.short-current-time');
            const durationEl = shortItem.querySelector('.short-duration');
            if (!progressFill || !currentTimeEl || !durationEl) return;

            const duration = player.getDuration();
            const currentTime = player.getCurrentTime();

            if (forceReset || duration <= 0) {
                progressFill.style.width = '0%';
                currentTimeEl.textContent = '0:00';
                durationEl.textContent = formatTime(duration > 0 ? duration : 0);
                return;
            }

            const percent = (currentTime / duration) * 100;
            progressFill.style.width = percent + '%';
            currentTimeEl.textContent = formatTime(currentTime);
            durationEl.textContent = formatTime(duration);
        }

        // NEW: Shorts player icons
        const shortsPlayIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M10.804 8 5 4.633v6.734L10.804 8z"/></svg>`;
        const shortsPauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"/></svg>`;
        const shortsMuteIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" /></svg>`;
        const shortsUnmuteIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25H4.51c-.88 0-1.704.507-1.938-1.354A9.01 9.01 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72Z" /></svg>`;
        // END NEW

        let placeholderIndex = 0;
        let currentText = '';
        let typingTimeout;

        // NEW: Intersection Observer for Shorts
        const shortsObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const iframe = entry.target.querySelector('iframe');
                if (!iframe) return;
                // NEW: Get control elements
                const shortItem = entry.target;
                const playPauseIconEl = shortItem.querySelector('.short-play-pause-icon');
                const muteBtn = shortItem.querySelector('.short-mute-btn');

                if (entry.isIntersecting) {
                    if (iframe && iframe.dataset.src) {
                        // First time loading
                        iframe.src = iframe.dataset.src;
                        iframe.removeAttribute('data-src'); // Load only once
                        
                        // NEW: Wait for the iframe to load before creating the player
                        iframe.onload = () => {
                            if (isYouTubeApiReady) {
                                createShortPlayer(iframe.id);
                            } else {
                                // API not ready yet, add to queue
                                if (!apiReadyQueue.includes(iframe.id)) {
                                    apiReadyQueue.push(iframe.id);
                                }
                            }
                            // The onShortPlayerReady will handle play/mute
                        };
                    } else if (iframe && iframe.src) { 
                        // It's already loaded (scrolling back up)
                        // Use the YT.Player API to play
                        if (shortsPlayers.has(iframe.id)) {
                            const player = shortsPlayers.get(iframe.id);
                            player.playVideo();
                            if (isShortsFeedMuted) {
                                player.mute();
                                if(muteBtn) muteBtn.innerHTML = shortsMuteIcon;
                                shortItem.dataset.isMuted = 'true';
                            } else {
                                player.unMute();
                                if(muteBtn) muteBtn.innerHTML = shortsUnmuteIcon;
                                shortItem.dataset.isMuted = 'false';
                            }
                        }
                    }
                    
                    // NEW: Update playing state and icon
                    shortItem.dataset.isPlaying = 'true';
                    if(playPauseIconEl) {
                        playPauseIconEl.innerHTML = shortsPauseIcon;
                        playPauseIconEl.classList.remove('show-icon'); // Hide icon on auto-play
                    }
                    
                } else {
                    // NEW: Send pause command ONLY
                    if (iframe && iframe.src) {
                        if (shortsPlayers.has(iframe.id)) {
                            shortsPlayers.get(iframe.id).pauseVideo();
                        }
                        clearPlayerInterval(iframe.id);
                    }
                    // NEW: Update playing state and icon
                    shortItem.dataset.isPlaying = 'false';
                    if(playPauseIconEl) {
                        playPauseIconEl.innerHTML = shortsPlayIcon;
                        playPauseIconEl.classList.remove('show-icon'); // Hide icon on auto-pause
                    }
                }
            });
        }, { threshold: 0.8 }); // MODIFIED: Trigger when 80% visible for a better "snap" effect

        function createCard(item, isLibraryCard = false, isWatchedCard = false, suppressBanners = false) {
            const card = document.createElement('div');
            card.className = 'card scroll-animate group';
            
            const title = item.name || item.title;
            const posterPath = item.poster_path ? `${IMAGE_BASE_URL}${item.poster_path}` : 'https://placehold.co/500x750/1a1a1a/f5f5f5?text=No+Image';
            const releaseDate = item.release_date || item.first_air_date;
            const year = releaseDate ? new Date(releaseDate).getFullYear() : '';
            const rating = item.vote_average ? item.vote_average.toFixed(1) : 'N/A';
            
            // Localized Language Name
            let langName = '';
            if (item.original_language) {
                try {
                    // Get the language name in the current UI language
                    const languageNames = new Intl.DisplayNames([currentLanguage], {type: 'language'});
                    langName = languageNames.of(item.original_language);
                } catch (e) {
                    langName = item.original_language.toUpperCase();
                }
            }

            let genreName = '';
            // Try to find the first genre name by ID
            if (item.genre_ids && item.genre_ids.length > 0 && allGenres[item.genre_ids[0]]) {
                genreName = allGenres[item.genre_ids[0]];
            }

            // Generate short description
            let overview = item.overview || translations[currentLanguage].descriptionNotAvailable;
            
            // Determine Banner
            let bannerHtml = '';
            const bannerClass = translations[currentLanguage].langDir === 'rtl' ? 'left-3' : 'right-3';
            
            if (!suppressBanners) {
                if (item.media_type === 'movie' && nowPlayingMovieIds.has(item.id) && currentView !== 'cinemas') {
                    bannerHtml = `<div class="absolute top-3 ${bannerClass} bg-pink-600/90 backdrop-blur-sm text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg z-10 tracking-wide uppercase">${translations[currentLanguage].nowInCinemas}</div>`;
                } else {
                    const releaseDateObj = releaseDate ? new Date(releaseDate) : null;
                    if (releaseDateObj) {
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        if (releaseDateObj > thirtyDaysAgo && releaseDateObj <= new Date()) {
                            bannerHtml = `<div class="absolute top-3 ${bannerClass} bg-blue-500/90 backdrop-blur-sm text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg z-10 tracking-wide uppercase">${translations[currentLanguage].newContent}</div>`;
                        }
                    }
                }
            }

            const t = translations[currentLanguage];

            // Localize Media Type Label
            let mediaTypeLabel = '';
            if (item.media_type === 'tv') {
                if (currentLanguage === 'he') mediaTypeLabel = 'סדרה';
                else if (currentLanguage === 'ru') mediaTypeLabel = 'Сериал';
                else if (currentLanguage === 'ar') mediaTypeLabel = 'مسلسل';
                else mediaTypeLabel = 'TV Series';
            } else {
                mediaTypeLabel = t.movie || 'Movie';
            }

            card.innerHTML = `
                ${bannerHtml}
                <img class="card-poster" src="${posterPath}" alt="${t.posterAlt} ${title}" loading="lazy">
                
                <!-- Base Overlay (Visible by default) -->
                <div class="card-base-overlay"></div>
                <div class="card-title-base">${title}</div>

                <!-- Hover Overlay (Visible on hover) -->
                <div class="card-hover-overlay">
                    <div class="card-content">
                        <h3 class="card-title-hover">${title}</h3>
                        
                        <div class="card-meta">
                            <span class="text-yellow-400 font-bold flex items-center gap-1">★ ${rating}</span>
                            <span>${year}</span>
                            ${genreName ? `<span class="text-gray-300 opacity-80 text-[0.75rem]">• ${genreName}</span>` : ''}
                            <div class="flex gap-1.5 mt-1 w-full flex-wrap">
                                ${langName ? `<span class="bg-white/10 border border-white/20 px-1.5 py-0.5 rounded text-[10px] font-bold text-gray-200 uppercase tracking-wider">${langName}</span>` : ''}
                                <span class="bg-red-600/80 px-1.5 py-0.5 rounded text-[10px] font-bold text-white uppercase tracking-wider">${mediaTypeLabel}</span>
                            </div>
                        </div>

                        <p class="card-desc">${overview}</p>
                    </div>
                </div>
            `;

            // Click handler for the whole card
            card.addEventListener('click', (e) => {
                const currentHash = window.location.hash;
                if (currentHash.startsWith('#search=')) {
                    scrollPositions.search = window.scrollY;
                } else if (currentView) {
                    scrollPositions[currentView] = window.scrollY;
                }
                window.location.hash = `details-${item.media_type}-${item.id}`;
            });

            return card;
        }


        // API Fetching Functions
        async function fetchAPI(endpoint, params = {}, langOverride = null) {
            isLoading = true;
            const url = new URL(`${BASE_URL}${endpoint}`);
            url.searchParams.append('api_key', API_KEY);
            url.searchParams.append('language', langOverride || tmdbLanguage); // שימוש בשפת התוכן במקום שפת הממשק
            for (const key in params) {
                url.searchParams.append(key, params[key]);
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error("API Error:", error);
                return null;
            } finally {
                isLoading = false;
            }
        }

        async function fetchTrendingContent(page = 1) {            
            const viewCache = contentCache.home;
            if (isLoading || (!viewCache.canLoadMore && page > viewCache.page)) return;

            isLoading = true;
            
            if (page === 1) {
                loadingMessage.classList.remove('hidden');
            } else {
                scrollLoadingMessage.classList.remove('hidden');
            }

            let data;
            if (selectedGenreId) {
                // Fetch both movies and TV shows for the selected genre and combine them
                const [movieData, tvData] = await Promise.all([
                    fetchAPI('/discover/movie', { page, with_genres: selectedGenreId, 'sort_by': 'popularity.desc' }),
                    fetchAPI('/discover/tv', { page, with_genres: selectedGenreId, 'sort_by': 'popularity.desc' })
                ]);
                
                let combinedResults = [];
                if (movieData && movieData.results) {
                    movieData.results.forEach(item => item.media_type = 'movie');
                    combinedResults.push(...movieData.results);
                }
                if (tvData && tvData.results) {
                    tvData.results.forEach(item => item.media_type = 'tv');
                    combinedResults.push(...tvData.results);
                }
                
                combinedResults.sort((a, b) => b.popularity - a.popularity);
                data = { results: combinedResults };

            } else {
                 data = await fetchAPI('/trending/all/week', { page });
            }
            
            loadingMessage.classList.add('hidden');
            scrollLoadingMessage.classList.add('hidden');
            isLoading = false;

            if (data && data.results) {
                 if (data.results.length === 0) {
                    viewCache.canLoadMore = false;
                    return;
                }
                const newItems = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && !viewCache.allIds.has(item.id) && item.poster_path);
                newItems.forEach(item => viewCache.allIds.add(item.id));
                viewCache.items.push(...newItems);
                viewCache.page = page;
                renderContent(newItems, false); // false = append, not replace
            } else {
                viewCache.canLoadMore = false;
            }
        }

        async function fetchPersonalizedRecommendations(page = 1) {
            const viewCache = contentCache.home;
            if (isLoading || !viewCache.canLoadMore) return;

            const prefsString = localStorage.getItem('findFlixUserPreferences');
            if (!prefsString) return;
            const prefs = JSON.parse(prefsString);
            if (!prefs || !prefs.genreIds || prefs.genreIds.length === 0) return;
            
            // If a filter is active, it overrides personalization.
            if (selectedGenreId) {
                // fetchTrendingContent already handles fetching mixed content by genre
                await fetchTrendingContent(page);
                return;
            }

            isLoading = true;
            page === 1 ? loadingMessage.classList.remove('hidden') : scrollLoadingMessage.classList.remove('hidden');

            const genreQuery = prefs.genreIds.join('|');

            // Fetch both movies and TV shows
            const [movieData, tvData] = await Promise.all([
                fetchAPI('/discover/movie', { page, with_genres: genreQuery, 'sort_by': 'popularity.desc' }),
                fetchAPI('/discover/tv', { page, with_genres: genreQuery, 'sort_by': 'popularity.desc' })
            ]);
            
            loadingMessage.classList.add('hidden');
            scrollLoadingMessage.classList.add('hidden');
            isLoading = false;

            let combinedResults = [];
            if (movieData && movieData.results) {
                movieData.results.forEach(item => item.media_type = 'movie');
                combinedResults.push(...movieData.results);
            }
            if (tvData && tvData.results) {
                tvData.results.forEach(item => item.media_type = 'tv');
                combinedResults.push(...tvData.results);
            }
            
            combinedResults.sort((a, b) => b.popularity - a.popularity);

            if (combinedResults.length === 0 && page > 1) {
                viewCache.canLoadMore = false;
                return;
            }

            const newItems = combinedResults.filter(item => !viewCache.allIds.has(item.id) && item.poster_path);
            
            if (newItems.length === 0 && page > 1) {
                 viewCache.canLoadMore = false;
            }

            newItems.forEach(item => viewCache.allIds.add(item.id));
            viewCache.items.push(...newItems);
            viewCache.page = page;
            renderContent(newItems, page === 1);
        }

        async function fetchPopularContent(type = 'movie', page = 1) {
            const viewKey = type === 'movie' ? 'movies' : 'series';
            const viewCache = contentCache[viewKey];
            if (isLoading || (!viewCache.canLoadMore && page > viewCache.page)) return;

            isLoading = true;

            if (page === 1) {
                loadingMessage.classList.remove('hidden');
            } else {
                scrollLoadingMessage.classList.remove('hidden');
            }
            
            let data;
            if (selectedGenreId) {
                const endpoint = `/discover/${type}`;
                const params = { page, 'sort_by': 'popularity.desc', with_genres: selectedGenreId };
                data = await fetchAPI(endpoint, params);
            } else {
                const endpoint = type === 'movie' ? '/movie/popular' : '/tv/popular';
                data = await fetchAPI(endpoint, { page });
            }

            loadingMessage.classList.add('hidden');
            scrollLoadingMessage.classList.add('hidden');
            isLoading = false;

            if (data && data.results) {
                if (data.results.length === 0) {
                    viewCache.canLoadMore = false;
                    return;
                }
                 const newItems = data.results.filter(item => !viewCache.allIds.has(item.id) && item.poster_path);
                 newItems.forEach(item => {
                     viewCache.allIds.add(item.id);
                     item.media_type = type;
                 });
                 viewCache.items.push(...newItems);
                 viewCache.page = page;
                 renderContent(newItems, page === 1); // true if first page, false if appending
            } else {
                viewCache.canLoadMore = false;
            }
        }

        async function showAndPerformSearch(query) {
            resetView();
            mainView.classList.remove('hidden');

            document.getElementById('genre-filter-container').classList.add('hidden');
            isSearchMode = true;
            currentView = null; 
            cameFromSurpriseMe = false;

            const t = translations[currentLanguage];
            pageTitle.textContent = `${t.searchResults}: "${query}"`;
            if (document.activeElement !== searchInput) {
                searchInput.value = query;
            }
            contentGrid.innerHTML = '';
            loadingMessage.classList.remove('hidden');

            // The hash is the source of truth, so we perform the search.
            const data = await fetchAPI('/search/multi', { query });
            
            loadingMessage.classList.add('hidden');
            
            if (data && data.results) {
                const filteredResults = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
                searchResultsCache.query = query;
                searchResultsCache.results = filteredResults;
                renderContent(filteredResults, true);
            } else {
                searchResultsCache.query = query;
                searchResultsCache.results = [];
                renderContent([], true);
            }
        }

        async function fetchDetails(itemId, mediaType) {
            return await fetchAPI(`/${mediaType}/${itemId}`, { append_to_response: 'credits,external_ids,images' });
        }

        async function fetchVideos(itemId, mediaType) {
            const data = await fetchAPI(`/${mediaType}/${itemId}/videos`);
            if (data && data.results) {
                const trailer = data.results.find(video => video.type === 'Trailer' && video.site === 'YouTube');
                return trailer || data.results.find(video => video.site === 'YouTube') || null;
            }
            return null;
        }

        async function fetchProviders(itemId, mediaType) {
            const data = await fetchAPI(`/${mediaType}/${itemId}/watch/providers`);
            return data && data.results ? data.results : {};
        }
        
        async function fetchSeasons(seriesId, seasonCount) {
            const seasonsList = document.getElementById('seasons-list');
            seasonsList.innerHTML = `<div class="text-gray-400">${translations[currentLanguage].loadingSeasons}</div>`;
            const seasonPromises = [];
            for (let i = 1; i <= seasonCount; i++) {
                // MODIFIED: Fetch videos as well
                seasonPromises.push(fetchAPI(`/tv/${seriesId}/season/${i}`, { append_to_response: 'videos' }));
            }
            try {
                const seasonsDetails = await Promise.all(seasonPromises);
                seasonsList.innerHTML = '';
                seasonsDetails.forEach(season => {
                    if (season && season.episodes && season.episodes.length > 0) {
                        // MODIFIED: Changed from <a> to <div> to handle nested buttons correctly
                        const seasonElement = document.createElement('div');
                        // seasonElement.href = ... (removed, handled via onclick)
                        seasonElement.className = 'block p-4 bg-gray-800 rounded-lg hover:bg-gray-700 transition-colors cursor-pointer relative group'; 
                        
                        // Handle navigation to episodes
                        seasonElement.onclick = (e) => {
                            // Prevent navigation if clicking the trailer button
                            if (!e.target.closest('button')) {
                                window.location.hash = `#episodes-${seriesId}-${season.season_number}`;
                            }
                        };
                        
                        let overviewHtml = '';
                        if (season.overview) {
                            let overviewText = season.overview;
                            if (overviewText.length > 150) {
                                overviewText = overviewText.substring(0, 150) + '...';
                            }
                            overviewHtml = `<p class="text-sm text-gray-400 mt-2">${overviewText}</p>`;
                        }

                        // Season Poster Logic
                        let posterHtml = '';
                        if (season.poster_path) {
                             const posterUrl = `${IMAGE_BASE_URL}${season.poster_path}`;
                             posterHtml = `<img src="${posterUrl}" alt="${season.name}" class="w-16 h-auto aspect-[2/3] object-cover rounded-md shadow-sm flex-shrink-0">`;
                        }

                        // NEW: Season Trailer & Videos Logic
                        let buttonsHtml = '';
                        let hasVideos = false;
                        
                        if (season.videos && season.videos.results && season.videos.results.length > 0) {
                            hasVideos = true;
                            const youtubeVideos = season.videos.results.filter(v => v.site === 'YouTube');
                            
                            if (youtubeVideos.length > 0) {
                                // Main Trailer Button (if exists)
                                const trailer = youtubeVideos.find(v => v.type === 'Trailer') || youtubeVideos.find(v => v.type === 'Teaser');
                                
                                if (trailer) {
                                    buttonsHtml += `
                                        <button class="season-trailer-btn inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-600 text-white text-xs font-bold rounded-full transition-colors hover:bg-red-700 shadow-sm z-10 relative" data-key="${trailer.key}">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                            </svg>
                                            ${translations[currentLanguage].watchTrailer}
                                        </button>
                                    `;
                                }

                                // More Videos Button
                                const moreText = currentLanguage === 'he' ? 'סרטונים נוספים' : 'More Videos';
                                buttonsHtml += `
                                    <button class="season-videos-btn inline-flex items-center gap-1.5 px-3 py-1.5 bg-gray-600 text-white text-xs font-bold rounded-full transition-colors hover:bg-gray-500 shadow-sm z-10 relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                                        </svg>
                                        ${moreText}
                                    </button>
                                `;
                            }
                        }

                        seasonElement.innerHTML = `
                            <div class="flex gap-4 items-start">
                                ${posterHtml}
                                <div class="flex-grow min-w-0">
                                    <div class="flex justify-between items-start">
                                        <span class="font-bold text-white text-lg">${season.name}</span>
                                        <span class="text-gray-400 text-sm whitespace-nowrap ml-2 flex-shrink-0">${season.episodes.length} ${translations[currentLanguage].episodes}</span>
                                    </div>
                                    ${overviewHtml}
                                    <div class="flex flex-wrap gap-2 mt-3">
                                        ${buttonsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Attach click handlers
                        if (hasVideos) {
                            const trailerBtn = seasonElement.querySelector('.season-trailer-btn');
                            if (trailerBtn) {
                                trailerBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    showTrailerModal(`https://www.youtube.com/embed/${trailerBtn.dataset.key}`);
                                };
                            }
                            
                            const videosBtn = seasonElement.querySelector('.season-videos-btn');
                            if (videosBtn) {
                                videosBtn.onclick = (e) => {
                                    e.stopPropagation();
                                    showSeasonVideosModal(season.name, season.videos.results);
                                };
                            }
                        }

                        seasonsList.appendChild(seasonElement);
                    }
                });
                if (seasonsList.innerHTML === '') {
                     seasonsList.innerHTML = `<div class="text-gray-400">${translations[currentLanguage].noSeasons}</div>`;
                }
            } catch (error) {
                console.error('Error fetching seasons:', error);
                seasonsList.innerHTML = `<div class="text-red-500">Error loading seasons.</div>`;
            }
        }

        // NEW: Helper to get translated video type
        function getVideoTypeName(type) {
            const t = translations[currentLanguage];
            if (t.videoTypes && t.videoTypes[type]) {
                return t.videoTypes[type];
            }
            return type; // Fallback to original if translation missing
        }

        // NEW: Function to handle fetching and displaying ALL series videos grouped by season
        async function showAllTvVideos(seriesDetails, generalVideos) {
            const t = translations[currentLanguage];
            const modal = document.getElementById('season-videos-modal');
            const titleEl = document.getElementById('season-videos-title');
            const contentEl = document.getElementById('season-videos-content');
            
            // Show modal with loading state
            titleEl.textContent = seriesDetails.name;
            contentEl.innerHTML = `<div class="loading-spinner mx-auto my-8"></div>`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');

            try {
                // Fetch videos for all seasons
                const seasonPromises = [];
                // TMDB seasons usually start from 1, sometimes 0 (Specials)
                // We use seriesDetails.seasons to get the actual available season numbers
                if (seriesDetails.seasons) {
                    seriesDetails.seasons.forEach(season => {
                        seasonPromises.push(
                            fetchAPI(`/tv/${seriesDetails.id}/season/${season.season_number}/videos`)
                                .then(data => ({
                                    seasonNumber: season.season_number,
                                    name: season.name,
                                    videos: data.results || []
                                }))
                        );
                    });
                }

                const seasonsData = await Promise.all(seasonPromises);

                // Prepare groups object
                const groups = {};

                // 1. Add General Videos (Show Level) if exist
                if (generalVideos && generalVideos.length > 0) {
                    const generalTitle = currentLanguage === 'he' ? 'כללי' : 'General / Extras';
                    groups[generalTitle] = generalVideos;
                }

                // 2. Add Season Videos
                seasonsData.forEach(season => {
                    if (season.videos.length > 0) {
                        const youtubeVideos = season.videos.filter(v => v.site === 'YouTube');
                        if (youtubeVideos.length > 0) {
                            groups[season.name] = youtubeVideos;
                        }
                    }
                });

                // Call the render function with the grouped object
                // We pass true for isGroupedObject
                renderVideosInModal(seriesDetails.name, groups, true);

            } catch (error) {
                console.error("Error fetching all series videos:", error);
                contentEl.innerHTML = `<p class="text-center text-red-500">Error loading videos.</p>`;
            }
        }

        // NEW: Helper function to fetch YouTube duration via scraping (Fallback method)
        async function fetchYoutubeDuration(videoId, elementId) {
            try {
                // Using a CORS proxy to fetch the YouTube page source
                const response = await fetch(`https://corsproxy.io/?https://www.youtube.com/watch?v=${videoId}`);
                if (!response.ok) return;
                
                const text = await response.text();
                // Extract approxDurationMs from the page source
                const match = text.match(/"approxDurationMs":"(\d+)"/);
                
                if (match && match[1]) {
                    const milliseconds = parseInt(match[1]);
                    const seconds = Math.floor(milliseconds / 1000);
                    
                    const durationStr = formatTime(seconds);
                    const el = document.getElementById(elementId);
                    if (el) {
                        el.textContent = durationStr;
                        el.classList.remove('hidden');
                        el.classList.add('fade-in'); // Add smooth appearance
                    }
                }
            } catch (e) {
                // Silently fail if proxy or parsing fails
                console.warn(`Could not fetch duration for ${videoId}`);
            }
        }

        // MODIFIED: Updated to handle both flat array (auto-group by type) AND grouped object
        function showSeasonVideosModal(title, videosOrGroups) {
            // If it's an array, it's the old behavior (single season or movie).
            // If it's an object, it's likely our new grouped structure.
            
            if (Array.isArray(videosOrGroups)) {
                renderVideosInModal(title, videosOrGroups, false);
            } else {
                renderVideosInModal(title, videosOrGroups, true);
            }
        }

        function renderVideosInModal(modalTitleText, data, isGroupedObject = false) {
            const modal = document.getElementById('season-videos-modal');
            const titleEl = document.getElementById('season-videos-title');
            const contentEl = document.getElementById('season-videos-content');
            
            titleEl.textContent = modalTitleText;
            contentEl.innerHTML = '';

            let groupsToRender = {};

            if (isGroupedObject) {
                // Data is already { "Season 1": [...], "Season 2": [...] }
                groupsToRender = data;
            } else {
                // Data is Array of videos. Group them by Type (Trailer, Teaser, etc.)
                const videos = data;
                const categories = {};
                const commonTypes = ['Trailer', 'Teaser', 'Recap', 'Clip', 'Featurette', 'Behind the Scenes', 'Bloopers', 'Opening Credits'];
                
                // Initialize
                commonTypes.forEach(t => categories[t] = []);
                categories['Other'] = [];

                videos.forEach(v => {
                    if (v.site === 'YouTube') {
                        // Check if type is one of the common types
                        if (commonTypes.includes(v.type)) {
                            categories[v.type].push(v);
                        } else {
                            categories['Other'].push(v);
                        }
                    }
                });

                // Convert to display groups with translated titles
                commonTypes.forEach(type => {
                    if (categories[type].length > 0) {
                        const translatedType = getVideoTypeName(type);
                        groupsToRender[translatedType] = categories[type];
                    }
                });
                if (categories['Other'].length > 0) {
                    const otherTitle = getVideoTypeName('Other') || (currentLanguage === 'he' ? 'אחר' : 'Other');
                    groupsToRender[otherTitle] = categories['Other'];
                }
            }

            let hasVideos = false;
            const t = translations[currentLanguage]; // Get translations for UI elements

            // Render each group
            Object.keys(groupsToRender).forEach(groupTitle => {
                const videos = groupsToRender[groupTitle];
                if (videos && videos.length > 0) {
                    hasVideos = true;
                    
                    const section = document.createElement('div');
                    // Improved Section Header styling with Sticky positioning and count
                    // Using bg-gray-900 and border-gray-600 allows CSS themes to override colors correctly (e.g. Light Mode / Glass Mode)
                    section.innerHTML = `
                        <div class="sticky top-0 bg-gray-900 z-10 py-3 mb-4 border-b border-gray-600 backdrop-blur-md shadow-sm transition-colors duration-300">
                            <h4 class="text-xl font-bold text-red-600 inline-flex items-center gap-2 px-1">
                                ${groupTitle} 
                                <span class="text-sm font-normal text-gray-300 bg-gray-800 px-2 py-0.5 rounded-full border border-gray-700/30">${videos.length}</span>
                            </h4>
                        </div>
                    `;
                    
                    // Improved Grid layout (up to 4 cols on XL screens)
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-10 px-1';
                    
                    videos.forEach(video => {
                        const vidCard = document.createElement('div');
                        // Improved Card Styling: modern look, hover effects
                        vidCard.className = 'bg-gray-800 rounded-xl overflow-hidden cursor-pointer hover:shadow-xl hover:shadow-black/50 transition-all duration-300 group border border-gray-700/50 hover:border-gray-500 hover:-translate-y-1 flex flex-col h-full relative';
                        
                        vidCard.onclick = () => {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                            showTrailerModal(`https://www.youtube.com/embed/${video.key}`);
                        };
                        
                        // Translate type label
                        const typeLabel = video.type ? getVideoTypeName(video.type) : '';
                        
                        // Date formatting
                        let dateStr = '';
                        if (video.published_at) {
                            dateStr = new Date(video.published_at).toLocaleDateString(currentLanguage, { year: 'numeric', month: 'short', day: 'numeric' });
                        }

                        // NEW: Duration Badge logic
                        const durationElementId = `duration-${video.key}`;

                        vidCard.innerHTML = `
                            <div class="relative aspect-video bg-black overflow-hidden">
                                <img src="https://img.youtube.com/vi/${video.key}/mqdefault.jpg" 
                                     class="w-full h-full object-cover opacity-90 group-hover:opacity-100 transition-all duration-500 transform group-hover:scale-110" 
                                     alt="${video.name}" 
                                     loading="lazy">
                                
                                <!-- Play Button Overlay -->
                                <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-black/30 backdrop-blur-[1px]">
                                    <div class="w-12 h-12 bg-red-600 rounded-full flex items-center justify-center text-white shadow-lg transform scale-50 group-hover:scale-100 transition-transform duration-300">
                                        <svg class="w-6 h-6 ml-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                                    </div>
                                </div>

                                <!-- Badges -->
                                <div class="absolute top-2 right-2 flex flex-col gap-1 items-end">
                                    ${isGroupedObject && typeLabel ? `<span class="text-[10px] font-bold text-white bg-black/60 backdrop-blur-sm px-2 py-1 rounded border border-white/10 shadow-sm">${typeLabel}</span>` : ''}
                                </div>
                                <div class="absolute bottom-2 right-2">
                                     <span id="${durationElementId}" class="text-[10px] font-mono text-gray-200 bg-black/60 backdrop-blur-sm px-1.5 py-0.5 rounded border border-white/10 shadow-sm hidden"></span>
                                </div>
                            </div>
                            
                            <div class="p-4 flex flex-col flex-grow justify-between gap-3">
                                <p class="text-sm text-gray-100 font-medium line-clamp-2 leading-snug group-hover:text-red-400 transition-colors" title="${video.name}">${video.name}</p>
                                
                                <div class="flex justify-between items-center pt-3 border-t border-gray-700/50 mt-auto">
                                    <span class="text-xs text-gray-500 font-medium flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        ${dateStr}
                                    </span>
                                </div>
                            </div>
                        `;
                        grid.appendChild(vidCard);
                        
                        // Trigger async duration fetch
                        fetchYoutubeDuration(video.key, durationElementId);
                    });
                    
                    section.appendChild(grid);
                    contentEl.appendChild(section);
                }
            });

            if (!hasVideos) {
                const noResultsText = currentLanguage === 'he' ? 'לא נמצאו סרטונים נוספים.' : 'No additional videos found.';
                contentEl.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-gray-500 opacity-60">
                        <svg class="w-20 h-20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.55-2.275a1 1 0 011.45.894v6.762a1 1 0 01-1.45.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 6l12 12" />
                        </svg>
                        <p class="text-xl font-medium">${noResultsText}</p>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        async function fetchEpisodes(seriesId, seasonNumber) {
            const data = await fetchAPI(`/tv/${seriesId}/season/${seasonNumber}`, { append_to_response: 'videos' });
            // return data ? data.episodes : []; // OLD
            return data; // NEW: Return the whole season object
        }

        async function fetchPersonDetails(personId) {
            return await fetchAPI(`/person/${personId}`, { append_to_response: 'combined_credits' });
        }

        async function fetchAndStoreGenres() {
            const [movieGenres, tvGenres] = await Promise.all([
                fetchAPI('/genre/movie/list'),
                fetchAPI('/genre/tv/list')
            ]);

            const genres = {};
            if (movieGenres && movieGenres.genres) {
                movieGenres.genres.forEach(g => { genres[g.id] = g.name });
            }
            if (tvGenres && tvGenres.genres) {
                tvGenres.genres.forEach(g => { if(!genres[g.id]) genres[g.id] = g.name });
            }
            allGenres = genres;
        }

        // NEW: Function to populate all TMDB supported languages
        async function populateContentLanguages() {
            const select = document.getElementById('tmdb-lang-select');
            if (!select) return;

            const currentSelection = localStorage.getItem('findFlixTmdbLang') || 'he';

            try {
                // Fetch languages from TMDB configuration
                const languages = await fetchAPI('/configuration/languages');
                
                if (languages && Array.isArray(languages)) {
                    // Sort by English Name for easier searching
                    languages.sort((a, b) => a.english_name.localeCompare(b.english_name));

                    select.innerHTML = ''; // Clear loading option

                    languages.forEach(lang => {
                        // Filter out "No Language" if present
                        if (lang.iso_639_1 === 'xx') return;

                        const option = document.createElement('option');
                        option.value = lang.iso_639_1;
                        
                        // Format: Native Name (English Name) -> e.g. "עברית (Hebrew)"
                        // If native name is missing or same as english, just show english
                        let label = lang.english_name;
                        if (lang.name && lang.name !== lang.english_name) {
                            label = `${lang.name} (${lang.english_name})`;
                        }
                        option.textContent = label;
                        select.appendChild(option);
                    });

                    // Set the current selected value
                    select.value = currentSelection;
                    
                    // Fallback if selection is invalid
                    if (!select.value) {
                        select.value = 'he'; // Default fallback
                    }
                }
            } catch (error) {
                console.error("Error fetching content languages:", error);
                // Fallback static list in case of API error
                select.innerHTML = `
                    <option value="he">Hebrew (עברית)</option>
                    <option value="en">English</option>
                    <option value="ru">Russian (Pусский)</option>
                    <option value="ar">Arabic (العربية)</option>
                    <option value="fr">French (Français)</option>
                    <option value="es">Spanish (Español)</option>
                    <option value="de">German (Deutsch)</option>
                    <option value="it">Italian (Italiano)</option>
                    <option value="pt">Portuguese (Português)</option>
                    <option value="ja">Japanese (日本語)</option>
                    <option value="ko">Korean (한국어/조선말)</option>
                `;
                select.value = currentSelection;
            }
        }

        async function fetchAndDisplayRecommendations(itemId, mediaType) {
            const recGrid = document.getElementById('recommendations-grid');
            const recHeading = document.getElementById('recommendations-heading');
            if (!recGrid || !recHeading) return; // הגנה במקרה שהאלמנטים לא קיימים
            
            const t = translations[currentLanguage];

            recHeading.textContent = t.moreLikeThis;
            recGrid.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;

            try {
                const data = await fetchAPI(`/${mediaType}/${itemId}/recommendations`);
                
                if (data && data.results && data.results.length > 0) {
                    recGrid.innerHTML = '';
                    // הצג עד 8 המלצות
                    const recommendations = data.results.slice(0, 8); 
                    recommendations.forEach(item => {
                        // ה-API של המלצות לא תמיד מחזיר media_type, אז נוודא שהוא קיים
                        item.media_type = item.media_type || mediaType; 
                        recGrid.appendChild(createCard(item, false, false));
                    });
                    if (window.observeElements) window.observeElements();
                } else {
                    recGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">${t.noRecommendations}</p>`;
                }
            } catch (error) {
                console.error("Error fetching recommendations:", error);
                recGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading recommendations.</p>`;
            }
        }

        async function fetchNowPlayingMovies() {
            const data = await fetchAPI('/movie/now_playing', { region: getRegionForLanguage() });
            if (data && data.results) {
                data.results.forEach(movie => nowPlayingMovieIds.add(movie.id));
            }
        }

        // NEW: Helper function to find a backdrop for an EPG item
        async function fetchTmdbImageForEpg(programName, channelName = null) { // <-- Add channelName parameter
            // Simple cache to avoid re-fetching for the same program name
            if (!window.epgImageCache) {
                window.epgImageCache = new Map();
            }

            // NEW: Improved cleaning logic
            const isSeries = /פרק|עונה/i.test(programName.toLowerCase());
            
            let cleanedName = programName.split(',')[0]; // Handle "..., חדש! פרק 18"
            cleanedName = cleanedName.replace(/חדש!/g, ''); // Remove "חדש!"

            if (isSeries) {
                cleanedName = cleanedName.replace(/פרק .*$/, ''); // Remove "פרק..." and anything after
                cleanedName = cleanedName.replace(/עונה .*$/, ''); // Remove "עונה..." and anything after
                cleanedName = cleanedName.replace(/\s\d+$/, ''); // Remove trailing standalone numbers (e.g., episode/season number)
            }
            
            cleanedName = cleanedName.trim();

            // Use the original name if cleaning results in an empty string
            if (cleanedName.length === 0) {
                cleanedName = programName;
            }
            // END NEW

            if (window.epgImageCache.has(cleanedName)) {
                return window.epgImageCache.get(cleanedName);
            }

            // NEW: Block list for generic program names like "החדשות", "שבע", etc.
            const genericNamesToBlock = [
                'החדשות', 'חדשות', 'מבט', 'מהדורה', 'מגזין',
                'שלוש', 'ארבע', 'חמש', 'שש', 'שבע', 'שמונה', 'תשע', 'עשר'
            ];

            const lowerCleanedName = cleanedName.toLowerCase();

            // Check if the cleaned name is exactly or starts with a blocked name
            const isGeneric = genericNamesToBlock.some(blockedName => 
                lowerCleanedName === blockedName || lowerCleanedName.startsWith(blockedName + ' ')
            );

            if (isGeneric) {
                window.epgImageCache.set(cleanedName, null); // Cache the failure
                return null;
            }
            // END NEW

            try {
                // --- NEW MASTERCHEF HARDCODE (Priority) ---
                /* REMOVED as per user request
                const lowerCleanedName = cleanedName.toLowerCase();
                if (channelName === 'קשת 12' && lowerCleanedName.startsWith('מאסטר שף')) {
                    const itemInfo = {
                        id: 40308,
                        media_type: 'tv',
                        backdrop_path: '/7m13vN3yBEF3lETxLgY1gup1GgM.jpg' // Hardcoded backdrop for MasterChef Israel
                    };
                    window.epgImageCache.set(cleanedName, itemInfo);
                    return itemInfo;
                }
                // --- NEW SABRI MARANAN HARDCODE (Priority) ---
                else if ((channelName === 'קשת 12' || channelName === 'ערוץ 24') && lowerCleanedName.startsWith('סברי מרנן')) {
                    const itemInfo = {
                        id: 51096, // Updated ID based on user link
                        media_type: 'tv',
                        backdrop_path: '/bK0YpXpFEw41jYJGX0YvTwfVzVq.jpg' // Updated backdrop path from user link
                    };
                    window.epgImageCache.set(cleanedName, itemInfo);
                    return itemInfo;
                }
                // --- NEW SPONGEBOB HARDCODE (Priority) ---
                else if (lowerCleanedName.startsWith('בובספוג מכנסמרובע') || lowerCleanedName.startsWith('בובספוג') || lowerCleanedName.startsWith('בוספוג')) {
                    const itemInfo = {
                        id: 387, // SpongeBob ID (FIXED from 456 as per user request)
                        media_type: 'tv',
                        backdrop_path: '/l0M3TqYgKmB0bLh4qT4Pu2d3G9i.jpg' // Updated backdrop for ID 387
                    };
                    window.epgImageCache.set(cleanedName, itemInfo);
                    return itemInfo;
                }
                */
                // --- END NEW SPONGEBOB HARDCODE ---

                // NEW: Specific handling for "מאסטר שף" on Channel 12
                let searchQuery = cleanedName;
                let searchParams = { query: searchQuery }; // Default params

                /* REMOVED previous attempt
                if (channelName === 'קשת 12' && cleanedName.toLowerCase() === 'מאסטר שף') {
                    // Search for "מאסטר שף" but specify the start year 2010 to get the Israeli version.
                    searchParams.first_air_date_year = 2010;
                }
                */
                // END NEW

                // Use search/multi to find the item
                const data = await fetchAPI('/search/multi', searchParams); // Use searchParams
                if (data && data.results && data.results.length > 0) {
                    
                    // --- START UPDATED MATCHING LOGIC ---
                    const lowerProgramName = cleanedName.toLowerCase(); // Use cleanedName
                    const validResults = data.results.filter(item => item.backdrop_path && (item.media_type === 'movie' || item.media_type === 'tv'));

                    // Helper for fuzzy name matching (e.g., בוספוג vs בובספוג)
                    const getFuzzy = (name) => name.toLowerCase().replace('בוספוג', 'בובספוג');
                    const fuzzyProgramName = getFuzzy(lowerProgramName);

                    let foundItem;

                    // --- NEW MASTERCHEF HARDCODE ---
                    /* MOVED TO TOP OF TRY BLOCK
                    if (channelName === 'קשת 12' && lowerProgramName === 'מאסטר שף') {
                        // Try to find the specific Israeli version by ID from the user's link
                        foundItem = validResults.find(item => item.id === 40308 && item.media_type === 'tv');
                    }
                    */
                    // --- END NEW MASTERCHEF HARDCODE ---

                    // 1. Prioritize results that match the detected media type (isSeries)
                    if (!foundItem && isSeries) { // <-- Added !foundItem check
                        // 1a. Series: Find TV show that starts with the name
                        foundItem = validResults.find(item => {
                            const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                            return item.media_type === 'tv' && fuzzyItemTitle.startsWith(fuzzyProgramName);
                        });
                        // 1b. Series: Find TV show that includes the name (fallback)
                        if (!foundItem) {
                            foundItem = validResults.find(item => {
                                const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                                return item.media_type === 'tv' && fuzzyItemTitle.includes(fuzzyProgramName);
                            });
                        }
                    } else {
                        // 1a. Movie: Find Movie that *is* the name (for "לבד בבית 5")
                        foundItem = validResults.find(item => {
                            const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                            return item.media_type === 'movie' && fuzzyItemTitle === fuzzyProgramName;
                        });
                        // 1b. Movie: Find Movie that starts with the name
                        if (!foundItem) {
                            foundItem = validResults.find(item => {
                                const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                                return item.media_type === 'movie' && fuzzyItemTitle.startsWith(fuzzyProgramName);
                            });
                        }
                        // 1c. Movie: Find Movie that includes the name (fallback)
                        if (!foundItem) {
                            foundItem = validResults.find(item => {
                                const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                                return item.media_type === 'movie' && fuzzyItemTitle.includes(fuzzyProgramName);
                            });
                        }
                    }

                    // 2. If no type-preferred match, try finding *any* match that starts with the name
                    if (!foundItem) { // <-- Added !foundItem check
                        foundItem = validResults.find(item => {
                            const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                            return fuzzyItemTitle.startsWith(fuzzyProgramName);
                        });
                    }

                    // 3. If still no match, fall back to any 'includes' match
                    if (!foundItem) { // <-- Added !foundItem check
                        foundItem = validResults.find(item => {
                            const fuzzyItemTitle = getFuzzy(item.name || item.title || '');
                            return fuzzyItemTitle.includes(fuzzyProgramName);
                        });
                    }

                    // 4. If *still* no match, fall back to the very first valid result
                    if (!foundItem && validResults.length > 0) { // <-- Added !foundItem check
                        foundItem = validResults[0];
                    }
                    // --- END UPDATED MATCHING LOGIC ---

                    if (foundItem) {
                        const itemInfo = {
                            id: foundItem.id,
                            media_type: foundItem.media_type,
                            backdrop_path: foundItem.backdrop_path
                        };
                        window.epgImageCache.set(cleanedName, itemInfo); // Use cleanedName
                        return itemInfo;
                    }
                }
            } catch (error) {
                console.error(`Failed to fetch TMDB image for ${programName} (cleaned: ${cleanedName}):`, error);
            }

            window.epgImageCache.set(cleanedName, null); // Cache the failure so we don't retry // Use cleanedName
            return null;
        }

        // UI Manipulation Functions
        async function populateDetailsView(itemId, mediaType) {
            const fullDetails = await fetchDetails(itemId, mediaType);
            if (!fullDetails) return;

            // Clear buttons AFTER await to prevent race condition duplicates
            const actionButtonsContainer = document.getElementById('action-buttons-container');
            actionButtonsContainer.innerHTML = '';

            // --- NEW LOGO LOGIC ---
            let logoUrl = null;
            if (fullDetails.images && fullDetails.images.logos && fullDetails.images.logos.length > 0) {
                const logos = fullDetails.images.logos;
                // Try to find a logo in the current language, or English, or the first one
                let bestLogo = logos.find(logo => logo.iso_639_1 === currentLanguage) ||
                               logos.find(logo => logo.iso_639_1 === 'en') ||
                               logos.find(logo => logo.iso_639_1 === null) || // No language
                               logos[0];
                
                if (bestLogo) {
                    logoUrl = `${LOGO_BASE_URL}${bestLogo.file_path}`;
                }
            }
            // --- END NEW LOGO LOGIC ---

            const title = fullDetails.name || fullDetails.title;
            const detailTitleEl = document.getElementById('detail-title');
            const detailHeaderLogoEl = document.getElementById('detail-header-logo');
            
            // NEW: Always set title text for sharing functionality (even if element is hidden)
            detailTitleEl.textContent = title;

            // --- NEW: Populate Logo/Title in Header ---
            if (logoUrl) {
                detailHeaderLogoEl.src = logoUrl;
                detailHeaderLogoEl.alt = `${title} Logo`;
                detailHeaderLogoEl.classList.remove('hidden');
                detailTitleEl.classList.add('hidden');
            } else {
                detailHeaderLogoEl.classList.add('hidden');
                detailTitleEl.classList.remove('hidden');
            }
            // --- END Populate Logo/Title in Header ---
            
            // --- REMOVED old logo logic ---
            // const logoImg = document.getElementById('detail-logo');
            // if (logoUrl) {
            //     logoImg.src = logoUrl;
            //     logoImg.alt = `${title} Logo`;
            //     logoImg.style.display = 'block';
            // } else {
            //     logoImg.src = '';
            //     logoImg.style.display = 'none';
            // }
            // --- END REMOVED old logo logic ---
            
            const imagePath = fullDetails.backdrop_path 
                ? `${BACKDROP_BASE_URL}${fullDetails.backdrop_path}` 
                : (fullDetails.poster_path ? `${IMAGE_BASE_URL}${fullDetails.poster_path}` : 'https://placehold.co/1280x720/1a1a1a/f5f5f5?text=No+Image');
            document.getElementById('detail-image').src = imagePath;
            document.getElementById('detail-image').alt = `${translations[currentLanguage].posterAlt} ${title}`;

            // NEW: Populate Tagline
            const taglineEl = document.getElementById('detail-tagline');
            if (fullDetails.tagline) {
                taglineEl.textContent = fullDetails.tagline;
                taglineEl.classList.remove('hidden');
            } else {
                taglineEl.textContent = '';
                taglineEl.classList.add('hidden');
            }
            
            document.getElementById('detail-description').textContent = fullDetails.overview || translations[currentLanguage].descriptionNotAvailable;

            // Meta Info
            const metaContainer = document.getElementById('detail-meta');
            metaContainer.innerHTML = '';
            let hasMetaInfo = false;

            const releaseDate = fullDetails.release_date || fullDetails.first_air_date;
            if (releaseDate) {
                metaContainer.innerHTML += `<span class="bg-gray-700 px-3 py-1 rounded-full">🗓️ ${new Date(releaseDate).getFullYear()}</span>`;
                hasMetaInfo = true;
            }
            if (fullDetails.vote_average) {
                metaContainer.innerHTML += `<span class="bg-gray-700 px-3 py-1 rounded-full">⭐ ${fullDetails.vote_average.toFixed(1)}</span>`;
                hasMetaInfo = true;
            }
            if (mediaType === 'movie' && fullDetails.runtime) {
                const runtimeString = formatRuntime(fullDetails.runtime, currentLanguage);
                if (runtimeString) {
                        metaContainer.innerHTML += `<span class="bg-gray-700 px-3 py-1 rounded-full">⌛ ${runtimeString}</span>`;
                        hasMetaInfo = true;
                }
            }
            
            // Add separator if there was meta info AND there are genres
            if (hasMetaInfo && fullDetails.genres && fullDetails.genres.length > 0) {
                 metaContainer.innerHTML += `<div class="border-l border-gray-600 h-6"></div>`;
            }

            // Genres
            if (fullDetails.genres && fullDetails.genres.length > 0) {
                fullDetails.genres.forEach(genre => {
                    const emoji = genreEmojis[genre.id] || '🎟️'; // Use mapped emoji or fallback
                    metaContainer.innerHTML += `<span class="bg-gray-700 px-3 py-1 rounded-full">${emoji} ${genre.name}</span>`;
                });
            }

            const primaryActionsContainer = document.createElement('div');
            primaryActionsContainer.className = 'flex flex-wrap items-center gap-4';

            const isCinebyEnabled = localStorage.getItem('findFlixPlugin_cineby') === 'true';

            if (isCinebyEnabled) {
                const cinebyBtn = document.createElement('a');
                cinebyBtn.className = 'px-4 py-2 sm:px-6 sm:py-3 bg-purple-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-purple-700';
                cinebyBtn.target = '_blank';
                
                let cinebyUrl = '';
                if (mediaType === 'movie') {
                    cinebyUrl = `https://www.cineby.app/movie/${fullDetails.id}?play=true`;
                } else { // tv
                    // For the main series page, link to the series without a specific episode
                    cinebyUrl = `https://www.cineby.app/tv/${fullDetails.id}?play=true`;
                }
                cinebyBtn.href = cinebyUrl;

                cinebyBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    ${translations[currentLanguage].watchOnCineby}
                `;
                primaryActionsContainer.appendChild(cinebyBtn);
            }

            const moreOptionsContainer = document.createElement('div');
            moreOptionsContainer.className = 'more-options-container';

            const moreOptionsBtn = document.createElement('button');
            moreOptionsBtn.className = 'px-4 py-2 sm:px-4 sm:py-3 bg-gray-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-gray-700';
            moreOptionsBtn.setAttribute('aria-label', 'More options');
            moreOptionsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg>`;
            
            const moreOptionsDropdown = document.createElement('div');
            moreOptionsDropdown.id = 'more-options-dropdown-menu';
            moreOptionsDropdown.className = 'more-options-dropdown';

            moreOptionsBtn.onclick = (e) => {
                e.stopPropagation();
                if (moreOptionsDropdown.classList.contains('show')) {
                    // Close it
                    moreOptionsDropdown.classList.add('animate-dropdown-up-out');
                    moreOptionsDropdown.classList.remove('animate-dropdown-up');
                    setTimeout(() => {
                        moreOptionsDropdown.classList.remove('show');
                        moreOptionsDropdown.classList.remove('animate-dropdown-up-out');
                    }, 200);
                } else {
                    // Open it
                    moreOptionsDropdown.classList.add('show');
                    moreOptionsDropdown.classList.remove('animate-dropdown-up-out');
                    moreOptionsDropdown.classList.add('animate-dropdown-up');
                }
            };

            moreOptionsContainer.appendChild(moreOptionsBtn);
            moreOptionsContainer.appendChild(moreOptionsDropdown);

            const createDropdownItem = (innerHTML, onClickOrHref) => {
                let item;
                const baseClasses = 'flex items-center gap-3 w-full text-right';
                if (typeof onClickOrHref === 'string') {
                    item = document.createElement('a');
                    item.href = onClickOrHref;
                    item.target = '_blank';
                    item.rel = 'noopener noreferrer';
                    item.className = baseClasses;
                } else {
                    item = document.createElement('button');
                    item.onclick = onClickOrHref;
                    item.className = baseClasses;
                }
                item.innerHTML = innerHTML;
                return item;
            };

            const bannerContainer = document.getElementById('detail-image-banner-container');
            bannerContainer.innerHTML = ''; // Clear previous banners
            const bannerClass = translations[currentLanguage].langDir === 'rtl' ? 'right-[-5px]' : 'left-[-5px]';
            let topPosition = 'top-2.5';
            
            // "Now in Cinemas" Banner
            if (nowPlayingMovieIds.has(fullDetails.id)) {
                bannerContainer.innerHTML += `<div class="in-cinemas-banner absolute ${topPosition} ${bannerClass}">${translations[currentLanguage].nowInCinemas}</div>`;
                topPosition = 'top-14'; // Increased spacing to prevent overlap
            }

            // "New Content" Banner
            const releaseDateObj = releaseDate ? new Date(releaseDate) : null;
            if (releaseDateObj) {
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                if (releaseDateObj > thirtyDaysAgo && releaseDateObj <= new Date()) {
                    bannerContainer.innerHTML += `<div class="new-content-banner absolute ${topPosition} ${bannerClass}">${translations[currentLanguage].newContent}</div>`;
                }
            }

            
            const updateLibraryButton = () => {
                const existingBtn = document.getElementById('library-action-btn');
                if (existingBtn) existingBtn.remove();
                
                const isSaved = isItemInLibrary(fullDetails.id);
                const libBtn = document.createElement('button');
                libBtn.id = 'library-action-btn';
                libBtn.className = isSaved 
                    ? 'px-4 py-2 sm:px-6 sm:py-3 bg-gray-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-gray-700'
                    : 'px-4 py-2 sm:px-6 sm:py-3 bg-red-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-red-700';

                libBtn.innerHTML = isSaved 
                    ? `<svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"></path></svg> ${translations[currentLanguage].removeFromLibrary}` 
                    : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"></path></svg> ${translations[currentLanguage].addToLibrary}`;
                
                libBtn.onclick = () => {
                    if (isSaved) {
                        removeFromLibrary(fullDetails.id, fullDetails.name || fullDetails.title);
                    } else {
                        const itemToSave = {
                            id: fullDetails.id,
                            title: fullDetails.name || fullDetails.title,
                            name: fullDetails.name || fullDetails.title,
                            poster_path: fullDetails.poster_path,
                            media_type: mediaType,
                            release_date: fullDetails.release_date || fullDetails.first_air_date,
                            overview: fullDetails.overview,
                        };
                        addToLibrary(itemToSave);
                    }
                    updateLibraryButton();
                };
                
                if (primaryActionsContainer.firstChild) {
                    primaryActionsContainer.insertBefore(libBtn, primaryActionsContainer.firstChild);
                } else {
                    primaryActionsContainer.appendChild(libBtn);
                }
            };
            updateLibraryButton();

            const updateWatchedButton = () => {
                const existingBtn = document.getElementById('watched-action-btn');
                if (existingBtn) existingBtn.remove();

                const isWatched = isItemInWatched(fullDetails.id);
                const watchedBtn = document.createElement('button');
                watchedBtn.id = 'watched-action-btn';
                watchedBtn.className = isWatched 
                    ? 'px-4 py-2 sm:px-6 sm:py-3 bg-gray-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-gray-700'
                    : 'px-4 py-2 sm:px-6 sm:py-3 bg-teal-600 text-white font-bold rounded-full transition-all hover:scale-105 hover:bg-teal-700 flex items-center gap-2';

                watchedBtn.innerHTML = isWatched
                    ? `<svg class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10c1.232-4.23 4.964-7 9.542-7s8.31 2.77 9.542 7c-1.232 4.23-4.964 7-9.542 7S1.732 14.23.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg> ${translations[currentLanguage].removeFromWatched}`
                    : `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg> ${translations[currentLanguage].addToWatched}`;

                watchedBtn.onclick = () => {
                    if (isWatched) {
                        removeFromWatched(fullDetails.id, fullDetails.name || fullDetails.title);
                    } else {
                        const itemToSave = {
                            id: fullDetails.id,
                            title: fullDetails.name || fullDetails.title,
                            name: fullDetails.name || fullDetails.title,
                            poster_path: fullDetails.poster_path,
                            media_type: mediaType,
                            release_date: fullDetails.release_date || fullDetails.first_air_date,
                            overview: fullDetails.overview,
                        };
                        addToWatched(itemToSave);
                    }
                    updateWatchedButton();
                };
                
                const libraryBtn = document.getElementById('library-action-btn');
                if (libraryBtn) {
                    libraryBtn.insertAdjacentElement('afterend', watchedBtn);
                } else if (primaryActionsContainer.firstChild) {
                    primaryActionsContainer.insertBefore(watchedBtn, primaryActionsContainer.firstChild);
                } else {
                    primaryActionsContainer.appendChild(watchedBtn);
                }
            };
            updateWatchedButton();

            // Fetch Videos logic updated to include "More Videos" button
            const videoData = await fetchAPI(`/${mediaType}/${itemId}/videos`); // Fetch all videos
            let trailer = null;
            let allVideos = [];

            if (videoData && videoData.results) {
                allVideos = videoData.results.filter(v => v.site === 'YouTube');
                trailer = allVideos.find(video => video.type === 'Trailer') || allVideos.find(video => video.type === 'Teaser');
            }

            if (trailer) {
                const trailerBtn = document.createElement('button');
                trailerBtn.className = 'px-4 py-2 sm:px-6 sm:py-3 bg-white text-black font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-gray-200';
                trailerBtn.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> ${translations[currentLanguage].watchTrailer}`;
                trailerBtn.onclick = () => showTrailerModal(`https://www.youtube.com/embed/${trailer.key}`);
                primaryActionsContainer.appendChild(trailerBtn);
            }

            // NEW: More Videos Button for Details View - Logic Updated
            // If it's a TV show, show the button even if no general videos, as long as seasons exist (implied by tv type)
            // If it's a movie, show only if general videos exist.
            if ((mediaType === 'tv') || allVideos.length > 0) {
                 const moreVideosBtn = document.createElement('button');
                 moreVideosBtn.className = 'px-4 py-2 sm:px-6 sm:py-3 bg-gray-700 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-gray-600';
                 const moreText = currentLanguage === 'he' ? 'סרטונים נוספים' : 'More Videos';
                 moreVideosBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                    </svg>
                    ${moreText}
                 `;
                 
                 // MODIFIED: Click handler split based on media type
                 if (mediaType === 'tv') {
                     moreVideosBtn.onclick = () => showAllTvVideos(fullDetails, allVideos);
                 } else {
                     moreVideosBtn.onclick = () => showSeasonVideosModal(title, allVideos);
                 }
                 
                 primaryActionsContainer.appendChild(moreVideosBtn);
            }

            if (nowPlayingMovieIds.has(fullDetails.id)) {
                const buyTicketBtn = document.createElement('a');
                buyTicketBtn.href = cinemaTicketUrls[currentLanguage] || cinemaTicketUrls['en'];
                buyTicketBtn.target = '_blank';
                buyTicketBtn.className = 'px-4 py-2 sm:px-6 sm:py-3 bg-green-600 text-white font-bold rounded-full flex items-center gap-2 transition-all hover:scale-105 hover:bg-green-700';
                buyTicketBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 100 4v2a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg> ${translations[currentLanguage].buyTicket}`;
                primaryActionsContainer.appendChild(buyTicketBtn);
            }
            
            const webSearchHref = `https://www.google.com/search?q=${encodeURIComponent(title)}`;
            const webSearchItem = createDropdownItem(
                `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> <span>${translations[currentLanguage].webSearchBtn}</span>`,
                webSearchHref
            );
            moreOptionsDropdown.appendChild(webSearchItem);

            // Wikipedia button logic removed

            const shareItem = createDropdownItem(
                 `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg> <span>${translations[currentLanguage].share}</span>`,
                 shareContent
            );
            moreOptionsDropdown.appendChild(shareItem);

            const reportProblemOnClick = () => {
                const t = translations[currentLanguage];
                const subject = `${t.reportProblemContentSubject} ${title} (${mediaType} ID: ${itemId})`;
                window.location.href = `mailto:amityefet262@gmail.com?subject=${encodeURIComponent(subject)}`;
            };
            const reportProblemItem = createDropdownItem(
                 `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd" /></svg> <span>${translations[currentLanguage].reportContentProblem}</span>`,
                 reportProblemOnClick
            );
            moreOptionsDropdown.appendChild(reportProblemItem);


            if (fullDetails.credits && (fullDetails.credits.cast.length > 0 || fullDetails.credits.crew.length > 0)) {
                const castItem = createDropdownItem(
                    `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg> <span>${translations[currentLanguage].castAndCrew}</span>`,
                    () => window.location.hash = `#cast-${mediaType}-${itemId}`
                );
                moreOptionsDropdown.appendChild(castItem);
            }
            
            // Add Gemini AI Summary button
            const geminiItem = createDropdownItem(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg> <span>${translations[currentLanguage].getAiSummary}</span>`,
                () => getGeminiSummary(title, mediaType)
            );
            moreOptionsDropdown.appendChild(geminiItem);

            const releaseDateForPodcast = fullDetails.release_date || fullDetails.first_air_date;
            const yearForPodcast = releaseDateForPodcast ? new Date(releaseDateForPodcast).getFullYear() : '';
            const descriptionForPodcast = fullDetails.overview || '';
            const podcastItem = createDropdownItem(
                `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" /><path d="M5.5 8.5a.5.5 0 01.5.5v1.5a4 4 0 004 4h0a4 4 0 004-4V9a.5.5 0 011 0v1.5a5 5 0 01-4.712 4.975V17h3a.5.5 0 010 1h-7a.5.5 0 010-1h3v-1.525A5 5 0 014.5 10.5V9a.5.5 0 01.5-.5z" /></svg> <span>${translations[currentLanguage].generatePodcast}</span>`,
                () => getPodcastScript(title, mediaType, yearForPodcast, descriptionForPodcast)
            );
            moreOptionsDropdown.appendChild(podcastItem);

            actionButtonsContainer.appendChild(primaryActionsContainer);
            if (moreOptionsDropdown.hasChildNodes()) {
                primaryActionsContainer.appendChild(moreOptionsContainer);
            }

            // Providers
            const providers = await fetchProviders(itemId, mediaType);
            const providersContainer = document.getElementById('streaming-buttons-container');
            providersContainer.innerHTML = '';
            const region = getRegionForLanguage();

            // Start with the providers for the current region, if they exist.
            let regionProviders = (providers[region] && providers[region].flatrate) ? [...providers[region].flatrate] : [];
            const regionLink = providers[region]?.link; // General JustWatch link from API

            // If the region is Israel, check for US Disney+ availability and add it if it's missing.
            if (region === 'IL') {
                const usProviders = providers['US']?.flatrate || [];
                const hasUSDisneyPlus = usProviders.some(p => p.provider_name === "Disney Plus");

                if (hasUSDisneyPlus) {
                    const hasILDisneyPlus = regionProviders.some(p => p.provider_name === "Disney Plus");
                    if (!hasILDisneyPlus) {
                        const disneyPlusProvider = usProviders.find(p => p.provider_name === "Disney Plus");
                        if (disneyPlusProvider) {
                            regionProviders.push(disneyPlusProvider);
                        }
                    }
                }
            }

            if (regionProviders.length > 0) {
                regionProviders.forEach(provider => {
                    const providerElement = document.createElement('a');
                    // Prevent clicking on streaming services as requested
                    providerElement.href = '#';
                    providerElement.onclick = (e) => e.preventDefault();
                    
                    providerElement.className = 'flex items-center gap-4 p-3 bg-gray-800 rounded-lg transition-colors cursor-not-allowed';
                    providerElement.innerHTML = `
                        <img src="${LOGO_BASE_URL}${provider.logo_path}" alt="${provider.provider_name}" class="w-12 h-12 rounded-md">
                        <span class="text-lg font-semibold">${provider.provider_name}</span>
                    `;
                    providersContainer.appendChild(providerElement);
                });
            } else {
                providersContainer.innerHTML = `<p class="text-gray-400">${translations[currentLanguage].noProviders}</p>`;
            }
            
            const seasonsSection = document.getElementById('seasons-section');
            if (mediaType === 'tv') {
                seasonsSection.style.display = 'block';
                document.getElementById('seasons-heading').textContent = translations[currentLanguage].seasonsHeading;
                fetchSeasons(fullDetails.id, fullDetails.number_of_seasons);
            } else {
                seasonsSection.style.display = 'none';
            }

            // NEW: Fetch and display recommendations
            fetchAndDisplayRecommendations(fullDetails.id, mediaType);

            const surpriseAgainBtn = document.getElementById('surprise-again-btn');
            const backBtn = document.getElementById('back-btn');

            if (cameFromSurpriseMe) {
                surpriseAgainBtn.classList.remove('hidden');
                backBtn.classList.remove('hidden');
            } else {
                surpriseAgainBtn.classList.add('hidden');
                backBtn.classList.remove('hidden');
            }
        }

        function resetView() {
            mainView.classList.add('hidden');
            detailView.classList.add('hidden');
            episodesView.classList.add('hidden');
            libraryView.classList.add('hidden');
            cinemasView.classList.add('hidden');
            newReleasesView.classList.add('hidden');
            settingsView.classList.add('hidden');
            watchedView.classList.add('hidden');
            achievementsView.classList.add('hidden');
            castView.classList.add('hidden');
            personView.classList.add('hidden');
            pluginsView.classList.add('hidden');
            shortsView.classList.add('hidden');
            tvView.classList.add('hidden');
            document.getElementById('roulette-section').classList.add('hidden');
            
            // NEW: Manually pause all shorts players when changing views
            // This prevents audio from playing in the background when navigating away
            if (currentView === 'shorts' && shortsPlayers.size > 0) {
                shortsPlayers.forEach(player => {
                    // Check if player and pauseVideo function exist
                    if (player && typeof player.pauseVideo === 'function') {
                        // Use a try-catch as the player might be in an unpaused state
                        try {
                            player.pauseVideo();
                        } catch (e) {
                            console.warn("Error pausing shorts player:", e);
                        }
                    }
                });
            }
            // END NEW
            
            // NEW: Remove shorts scroll listener
            const shortsContainer = document.getElementById('shorts-feed-container');
            if (shortsContainer) shortsContainer.onscroll = null;
            // END NEW

            // NEW: Remove temporary detail view loader if it exists
            const detailLoader = document.getElementById('detail-view-loader');
            if (detailLoader) {
                detailLoader.remove();
            }
        }
        
        async function showDetailsView(itemId, mediaType) {
            if (isShowingDetails) return;
            isShowingDetails = true;
            try {
                resetView();
                detailView.classList.remove('hidden');
                
                // NEW: Add a loader *before* populating
                const detailContentWrapper = document.getElementById('detail-content-wrapper');
                detailContentWrapper.classList.add('hidden'); // Hide content while loading
                
                // Clear header content to prevent flash of old title/logo
                document.getElementById('detail-title').textContent = '';
                document.getElementById('detail-header-logo').classList.add('hidden');

                // Create and show a temporary loader
                const loader = document.createElement('div');
                loader.id = 'detail-view-loader';
                loader.className = 'text-center text-red-500 font-bold p-16';
                loader.innerHTML = `<div class="loading-spinner mx-auto mb-2"></div>${translations[currentLanguage].loading}`;
                detailView.appendChild(loader);


                await populateDetailsView(itemId, mediaType);

                // NEW: Remove loader and show content
                loader.remove();
                detailContentWrapper.classList.remove('hidden');
                detailContentWrapper.classList.add('fade-in-scale'); // Add animation

            } finally {
                isShowingDetails = false;
            }
        }
        
        async function showEpisodesView(seriesId, seasonNumber, seriesName) {
            resetView();
            episodesView.classList.remove('hidden');

            const t = translations[currentLanguage];
            
            // --- V16: עדכון כותרת מסך פרקים ---
            const titleEl = document.getElementById('episodes-series-title');
            const logoEl = document.getElementById('episodes-header-logo');
            const seasonNameEl = document.getElementById('episodes-season-name');

            // Set default title first
            titleEl.textContent = seriesName;
            titleEl.classList.remove('hidden');
            logoEl.classList.add('hidden');
            seasonNameEl.textContent = ''; // Clear previous

            // Fetch details to get logo and season name
            try {
                // Fetch details to get logo and specific season name
                const seriesDetails = await fetchAPI(`/tv/${seriesId}`, { append_to_response: 'images' });
                
                // 1. Set Logo or Title
                let logoUrl = null;
                if (seriesDetails && seriesDetails.images && seriesDetails.images.logos && seriesDetails.images.logos.length > 0) {
                    const logos = seriesDetails.images.logos;
                    let bestLogo = logos.find(logo => logo.iso_639_1 === currentLanguage) ||
                                   logos.find(logo => logo.iso_639_1 === 'en') ||
                                   logos.find(logo => logo.iso_639_1 === null) ||
                                   logos[0];
                    if (bestLogo) {
                        logoUrl = `${LOGO_BASE_URL}${bestLogo.file_path}`;
                    }
                }

                if (logoUrl) {
                    logoEl.src = logoUrl;
                    logoEl.alt = `${seriesName} Logo`;
                    logoEl.classList.remove('hidden');
                    titleEl.classList.add('hidden');
                } else {
                    titleEl.textContent = seriesName;
                    titleEl.classList.remove('hidden');
                    logoEl.classList.add('hidden');
                }

                // 2. Set Season Name
                let seasonNameFound = false;
                if (seriesDetails && seriesDetails.seasons) {
                    // Find the season, even if it's season 0 ("Specials")
                    const season = seriesDetails.seasons.find(s => s.season_number == seasonNumber);
                    if (season && season.name) {
                        // Add a separator. Use `|` as a visual separator.
                        seasonNameEl.textContent = `| ${season.name}`;
                        seasonNameFound = true;
                    }
                }
                
                if (!seasonNameFound) {
                    // Fallback if season name isn't found
                    const seasonText = (seasonNumber == 0) ? (t.genres['10759'] || 'Specials') : `${t.seasonsHeading || 'Season'} ${seasonNumber}`;
                    seasonNameEl.textContent = `| ${seasonText}`;
                }

            } catch (error) {
                console.error("Error fetching series details for episode header:", error);
                // Fallback to defaults (title is already set)
                const seasonText = (seasonNumber == 0) ? (t.genres['10759'] || 'Specials') : `${t.seasonsHeading || 'Season'} ${seasonNumber}`;
                seasonNameEl.textContent = `| ${seasonText}`;
            }
            // --- סוף V16 ---
                
            const episodesGrid = document.getElementById('episodes-grid');
            
            // Generate skeleton loaders
            let skeletonHtml = '';
            for (let i = 0; i < 5; i++) {
                skeletonHtml += `
                    <div class="bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col sm:flex-row">
                        <div class="skeleton-loader w-full sm:w-1/3 md:w-1/4 lg:w-1/5 flex-shrink-0 aspect-video sm:aspect-auto ${t.langDir === 'rtl' ? 'sm:border-l sm:border-gray-700' : 'sm:border-r sm:border-gray-700'}"></div>
                        <div class="flex-1 p-4 space-y-3">
                            <!-- NEW: Skeleton for Number + Title/Meta block -->
                            <div class="flex gap-4 items-start">
                                <div class="skeleton-loader h-10 w-10 rounded flex-shrink-0"></div> <!-- For the number -->
                                <div class="flex-grow space-y-2 min-w-0">
                                    <div class="flex justify-between items-start">
                                        <div class="skeleton-loader h-6 rounded w-3/4"></div> <!-- Title -->
                                        <div class="skeleton-loader h-5 w-20 rounded ml-2"></div> <!-- Rating (widened) -->
                                    </div>
                                    <div class="skeleton-loader h-4 rounded w-full"></div> <!-- Meta line 1 -->
                                    <div class="skeleton-loader h-4 rounded w-5/6"></div> <!-- Meta line 2 -->
                                </div>
                            </div>
                            <!-- Skeleton for Overview + Guest Stars block -->
                            <div class="space-y-2 pt-2">
                                <div class="skeleton-loader h-4 rounded w-full"></div>
                                <div class="skeleton-loader h-4 rounded w-full"></div>
                                <div class="skeleton-loader h-4 rounded w-1/2"></div> <!-- Guest stars line -->
                            </div>
                        </div>
                    </div>
                `;
            }
            episodesGrid.innerHTML = skeletonHtml;

            // const episodes = await fetchEpisodes(seriesId, seasonNumber); // OLD
            const seasonData = await fetchEpisodes(seriesId, seasonNumber); // NEW: This now returns the season object
            const episodes = seasonData ? seasonData.episodes : []; // NEW: Get episodes from the object

            // NEW: Add season overview
            const seasonOverviewEl = document.getElementById('season-overview');
            if (seasonData && seasonData.overview) {
                seasonOverviewEl.textContent = seasonData.overview;
                seasonOverviewEl.classList.remove('hidden');
            } else {
                seasonOverviewEl.textContent = '';
                seasonOverviewEl.classList.add('hidden');
            }
            // END NEW

            // NEW: Add Season Trailer Button logic
            const existingTrailerBtn = document.getElementById('season-page-trailer-btn');
            if (existingTrailerBtn) existingTrailerBtn.remove(); // Clean up old button if exists
            
            // NEW: Clean up old More Videos button if exists
            const existingMoreVideosBtn = document.getElementById('season-page-more-videos-btn');
            if (existingMoreVideosBtn) existingMoreVideosBtn.remove();
            // Clean up container
            const existingButtonsContainer = document.getElementById('season-page-buttons-container');
            if (existingButtonsContainer) existingButtonsContainer.remove();

            if (seasonData && seasonData.videos && seasonData.videos.results) {
                const youtubeVideos = seasonData.videos.results.filter(v => v.site === 'YouTube');
                const trailer = youtubeVideos.find(v => v.type === 'Trailer' && v.site === 'YouTube') || 
                                youtubeVideos.find(v => v.type === 'Teaser' && v.site === 'YouTube');
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.id = 'season-page-buttons-container';
                buttonsContainer.className = 'flex flex-wrap gap-3 mb-6 mx-4 md:mx-0';

                if (trailer) {
                    const trailerBtn = document.createElement('button');
                    trailerBtn.id = 'season-page-trailer-btn';
                    trailerBtn.className = 'inline-flex items-center gap-2 px-6 py-2.5 bg-red-600 text-white font-bold rounded-full transition-all hover:bg-red-700 hover:scale-105 shadow-lg';
                    trailerBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        <span>${t.watchTrailer}</span>
                    `;
                    trailerBtn.onclick = () => showTrailerModal(`https://www.youtube.com/embed/${trailer.key}`);
                    buttonsContainer.appendChild(trailerBtn);
                }

                // NEW: More Videos Button for Season Page
                if (youtubeVideos.length > 0) {
                    const moreVideosBtn = document.createElement('button');
                    moreVideosBtn.id = 'season-page-more-videos-btn';
                    moreVideosBtn.className = 'inline-flex items-center gap-2 px-6 py-2.5 bg-gray-700 text-white font-bold rounded-full transition-all hover:bg-gray-600 hover:scale-105 shadow-lg';
                    const moreText = currentLanguage === 'he' ? 'סרטונים נוספים' : 'More Videos';
                    moreVideosBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                             <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z" />
                        </svg>
                        <span>${moreText}</span>
                    `;
                    const seasonTitle = document.getElementById('episodes-season-name').textContent.replace('|', '').trim();
                    const seriesTitle = document.getElementById('episodes-series-title').textContent;
                    const fullTitle = `${seriesTitle} - ${seasonTitle}`;

                    moreVideosBtn.onclick = () => showSeasonVideosModal(fullTitle, youtubeVideos);
                    buttonsContainer.appendChild(moreVideosBtn);
                }

                // Insert button container after overview element
                if (seasonOverviewEl.nextSibling) {
                    seasonOverviewEl.parentNode.insertBefore(buttonsContainer, seasonOverviewEl.nextSibling);
                } else {
                    seasonOverviewEl.parentNode.appendChild(buttonsContainer);
                }
            }
            // END NEW Season Trailer Button logic

            episodesGrid.innerHTML = ''; // Clear skeletons before rendering real content

            if (episodes && episodes.length > 0) {
                const isCinebyEnabled = localStorage.getItem('findFlixPlugin_cineby') === 'true';

                episodes.forEach(episode => {
                    const episodeCard = document.createElement('div');
                    episodeCard.className = 'bg-gray-800 rounded-lg overflow-hidden shadow-lg flex flex-col sm:flex-row scroll-animate';
                    
                    // const stillPath = episode.still_path ? `${IMAGE_BASE_URL}${episode.still_path}` : 'https://placehold.co/300x170/1a1a1a/f5f5f5?text=No+Image';
                    
                    // NEW: Create imageHTML only if still_path exists
                    let imageHtml = '';
                    if (episode.still_path) {
                        const stillPath = `${IMAGE_BASE_URL}${episode.still_path}`;
                        imageHtml = `<img src="${stillPath}" alt="${episode.name}" class="w-full sm:w-1/3 md:w-1/4 lg:w-1/5 flex-shrink-0 object-cover aspect-video sm:aspect-auto ${t.langDir === 'rtl' ? 'sm:rounded-r-lg sm:border-l sm:border-gray-700' : 'sm:rounded-l-lg sm:border-r sm:border-gray-700'}">`;
                    }
                    // END NEW

                    let cinebyButtonHtml = '';
                    if (isCinebyEnabled) {
                        const cinebyUrl = `https://www.cineby.app/tv/${seriesId}/${episode.season_number}/${episode.episode_number}?play=true`;
                        cinebyButtonHtml = `
                            <a href="${cinebyUrl}" target="_blank" class="mt-3 inline-flex items-center gap-2 px-3 py-1 bg-purple-600 text-white text-sm font-bold rounded-full transition-colors hover:bg-purple-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                                ${t.watchOnCineby}
                            </a>
                        `;
                    }

                    // NEW: Extract more episode info
                    const airDate = episode.air_date ? new Date(episode.air_date).toLocaleDateString(currentLanguage.split('-')[0], { year: 'numeric', month: 'long', day: 'numeric' }) : null;
                    const runtime = episode.runtime ? formatRuntime(episode.runtime, currentLanguage) : null;
                    const director = episode.crew.find(c => c.job === 'Director');
                    const writer = episode.crew.find(c => c.job === 'Writer' || c.job === 'Screenplay');
                    const guestStars = episode.guest_stars && episode.guest_stars.length > 0 ? episode.guest_stars.slice(0, 5) : []; // Get top 5 guest stars

                    let metaItems = [];
                    if (airDate) metaItems.push(`<span>${airDate}</span>`);
                    if (runtime) metaItems.push(`<span>${runtime}</span>`);
                    // בודק את שפת הממשק כדי להציג את הטקסט הנכון
                    const directorLabel = t.director;
                    const writerLabel = t.writer;
                    
                    if (director) metaItems.push(`<span><strong class="font-semibold">${directorLabel}:</strong> ${director.name}</span>`);
                    if (writer) metaItems.push(`<span><strong class="font-semibold">${writerLabel}:</strong> ${writer.name}</span>`);
                    
                    const metaHtml = metaItems.length > 0 ? `<div class="flex flex-wrap gap-x-3 gap-y-1 text-sm text-gray-400 mt-2">${metaItems.join('<span class="opacity-50">•</span>')}</div>` : '';

                    // NEW: Guest stars HTML
                    let guestStarsHtml = '';
                    if (guestStars.length > 0) {
                        const guestStarLabel = t.guestStars;
                        const guestStarNames = guestStars.map(star => star.name).join(', ');
                        // MODIFICATION: Removed mt-3 from this string
                        guestStarsHtml = `<p class="text-sm text-gray-400"><strong class="font-semibold text-gray-300">${guestStarLabel}:</strong> ${guestStarNames}</p>`;
                    }
                    
                    // UPDATED Card HTML
                    episodeCard.innerHTML = `
                        ${imageHtml}
                        
                        <div class="flex-1 p-4">
                            <!-- NEW Layout for Number + Title/Meta -->
                            <div class="flex gap-4 items-start">
                                <div class="flex-shrink-0">
                                    <span class="text-4xl sm:text-5xl font-extrabold text-gray-700" style="line-height: 1;">${episode.episode_number}</span>
                                </div>
                                <div class="flex-grow min-w-0">
                                    <div class="flex justify-between items-start mb-1">
                                        <h4 class="text-xl font-bold text-white pr-4 truncate" title="${episode.name}">${episode.name}</h4>
                                        ${episode.vote_average && episode.vote_average > 0 ? `<span class="text-yellow-400 font-bold flex-shrink-0 flex items-center gap-1">⭐ ${episode.vote_average.toFixed(1)} <span class="text-gray-400 text-xs font-normal">(${episode.vote_count})</span></span>` : ''}
                                    </div>
                                    ${metaHtml}
                                </div>
                            </div>

                            <!-- NEW: Wrapper for Overview and Guest Stars -->
                            <div class="mt-4 space-y-3">
                                <p class="text-gray-300">${episode.overview || t.descriptionNotAvailable}</p>
                                ${guestStarsHtml}
                            </div>
                            
                            ${cinebyButtonHtml ? `<div class="mt-4">${cinebyButtonHtml}</div>` : ''}
                        </div>
                    `;
                    episodesGrid.appendChild(episodeCard);
                });
                if (window.observeElements) window.observeElements();
            } else {
                episodesGrid.innerHTML = `<p class="text-center text-gray-400">No episodes found for this season.</p>`;
            }
        }

        async function showCastView(itemId, mediaType) {
            resetView();
            const castView = document.getElementById('cast-view');
            castView.classList.remove('hidden');

            const t = translations[currentLanguage];
            const details = await fetchDetails(itemId, mediaType);
            if (!details) return;

            const title = details.name || details.title;
            document.getElementById('cast-title').textContent = `${title} - ${t.castAndCrew}`;
                
            const castGrid = document.getElementById('cast-grid');
            castGrid.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;

            const credits = details.credits;
            castGrid.innerHTML = '';

            if (credits && (credits.cast.length > 0 || credits.crew.length > 0)) {
                // Combine and filter unique people
                const people = new Map();
                credits.cast.forEach(p => {
                    if (p.profile_path && !people.has(p.id)) {
                        people.set(p.id, { ...p, role: p.character });
                    }
                });
                credits.crew.forEach(p => {
                    if (p.profile_path && !people.has(p.id) && ['Director', 'Writer', 'Screenplay', 'Creator'].includes(p.job)) {
                         people.set(p.id, { ...p, role: p.job });
                    }
                });

                people.forEach(person => {
                    const personCard = document.createElement('div');
                    personCard.className = 'text-center scroll-animate cursor-pointer transition-transform hover:scale-105';
                    const profilePath = `${IMAGE_BASE_URL}${person.profile_path}`;
                    personCard.innerHTML = `
                        <img src="${profilePath}" alt="${person.name}" class="w-full h-auto rounded-lg shadow-md mb-2 object-cover aspect-[2/3]" loading="lazy">
                        <p class="font-bold text-white truncate">${person.name}</p>
                        <p class="text-sm text-gray-400 truncate">${person.role}</p>
                    `;
                    personCard.addEventListener('click', () => {
                        scrollPositions['cast'] = window.scrollY;
                        window.location.hash = `#person-${person.id}`;
                    });
                    castGrid.appendChild(personCard);
                });
                if (window.observeElements) window.observeElements();

            } else {
                castGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">No cast information available.</p>`;
            }
        }

        async function showPersonView(personId) {
            resetView();
            personView.classList.remove('hidden');
            personView.classList.add('fade-in-scale');
            window.scrollTo(0, 0);

            const personDetailsContainer = document.querySelector('#person-view > div:nth-child(2)');
            const personCreditsContainer = document.querySelector('#person-view > div:nth-child(3)');
            personDetailsContainer.classList.add('hidden');
            personCreditsContainer.classList.add('hidden');

            const loader = `<div class="loading-spinner mx-auto col-span-full mt-8"></div>`;
            document.getElementById('person-credits-grid').innerHTML = loader;

            let data = await fetchPersonDetails(personId);

            if (!data) {
                document.getElementById('person-credits-grid').innerHTML = `<p class="col-span-full text-center text-gray-400">Could not load person details.</p>`;
                return;
            }

            let isHebrewBioAvailable = (currentLanguage === 'he' && data.biography); // Flag: Did we get a Hebrew bio?

            // Fallback to English biography if not available in the current language
            if (!data.biography && currentLanguage === 'he') { // Specifically check 'he'
                const englishData = await fetchAPI(`/person/${personId}`, { append_to_response: 'combined_credits' }, 'en');
                if (englishData && englishData.biography) {
                    data.biography = englishData.biography;
                    // isHebrewBioAvailable remains false, which is correct.
                }
            }

            const t = translations[currentLanguage];

            // Populate person details
            document.getElementById('person-name').textContent = data.name;
            document.getElementById('person-image').src = data.profile_path ? `${IMAGE_BASE_URL}${data.profile_path}` : 'https://placehold.co/500x750/1a1a1a/f5f5f5?text=No+Profile';
            document.getElementById('person-image').alt = data.name;
            
            document.getElementById('person-bio-heading').textContent = t.biography;
            const bioText = data.biography || t.biographyNotAvailable;
            const personBioEl = document.getElementById('person-bio');
            personBioEl.textContent = bioText;
            personBioEl.dataset.originalContent = bioText; // Store original text
            personBioEl.dataset.isTranslated = 'false';

            const metaContainer = document.getElementById('person-meta');
            metaContainer.innerHTML = '';
            if (data.birthday) {
                const birthdayDate = new Date(data.birthday);
                const age = new Date().getFullYear() - birthdayDate.getFullYear();
                metaContainer.innerHTML += `<div><strong>${t.born}:</strong> ${birthdayDate.toLocaleDateString(currentLanguage.split('-')[0])} (Age ${age})</div>`;
            }
            if (data.place_of_birth) {
                metaContainer.innerHTML += `<div><strong>${t.placeOfBirth}:</strong> ${data.place_of_birth}</div>`;
            }
            metaContainer.dataset.originalContent = metaContainer.innerHTML; // Store original HTML
            metaContainer.dataset.isTranslated = 'false';

            // NEW: Setup Translation Button
            const translateBtn = document.getElementById('translate-person-btn');
            const translateBtnText = document.getElementById('translate-person-btn-text');
            
            // By default, hide the button
            translateBtn.classList.add('hidden');

            // User Conditions:
            // 1. Current language must be Hebrew.
            // 2. The biography from TMDB must NOT be in Hebrew (isHebrewBioAvailable is false).
            // 3. The bio must not be the "not available" text.
            if (currentLanguage === 'he' && !isHebrewBioAvailable && bioText !== t.biographyNotAvailable) {
                translateBtn.classList.remove('hidden'); // Show the button
            
                const updateTranslateButtonText = () => {
                    const isTranslated = personBioEl.dataset.isTranslated === 'true';
                    if (isTranslated) {
                        // It's translated (to Hebrew), so button shows "Translate back to English"
                        translateBtnText.textContent = t.translateToEnglish; 
                    } else {
                        // It's not translated (it's in English), so button shows "Translate to Hebrew"
                        translateBtnText.textContent = t.translateToHebrew; 
                    }
                };
                
                updateTranslateButtonText(); // Set initial text

                translateBtn.onclick = () => {
                    // Pass the *original* state to the handler
                    const isCurrentlyTranslated = personBioEl.dataset.isTranslated === 'true';
                    handleTranslatePersonInfo(personBioEl, metaContainer, translateBtn, translateBtnText, isCurrentlyTranslated);
                };
            }
            // END NEW

            // Populate credits
            document.getElementById('person-credits-heading').textContent = t.knownFor;
            const personCreditsGrid = document.getElementById('person-credits-grid');
            personCreditsGrid.innerHTML = '';

            if (data.combined_credits && data.combined_credits.cast) {
                // Use a Map to filter out duplicate credits by their ID
                const uniqueCredits = new Map();
                data.combined_credits.cast.forEach(credit => {
                    if (!uniqueCredits.has(credit.id)) {
                        uniqueCredits.set(credit.id, credit);
                    }
                });

                const credits = Array.from(uniqueCredits.values())
                    .filter(credit => credit.poster_path && (credit.media_type === 'movie' || credit.media_type === 'tv'))
                    .sort((a, b) => (b.popularity || 0) - (a.popularity || 0))
                    .slice(0, 20);

                credits.forEach(credit => {
                    personCreditsGrid.appendChild(createCard(credit));
                });
                if(window.observeElements) window.observeElements();
            }

            if (personCreditsGrid.innerHTML === '') {
                personCreditsGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">${t.noCreditsFound}</p>`;
            }
            
            personDetailsContainer.classList.remove('hidden');
            personCreditsContainer.classList.remove('hidden');
        }

        async function showAIResultsView() {
            resetView();
            mainView.classList.remove('hidden');
            document.getElementById('genre-filter-container').classList.add('hidden');
            isSearchMode = true; // Behave like a search page to disable infinite scroll
            currentView = null; 
            cameFromSurpriseMe = false;
            
            const t = translations[currentLanguage];
            pageTitle.textContent = t.aiRecommenderTitle;
            
            if (aiResultsCache && aiResultsCache.length > 0) {
                renderContent(aiResultsCache, true);
            } else {
                // If cache is empty (e.g., on refresh), go home
                window.location.hash = '#home';
            }
        }

        // NEW: Function to translate person info
        async function handleTranslatePersonInfo(bioEl, metaEl, btn, btnText, isTranslated) {
            const t = translations[currentLanguage];
            if (!GEMINI_API_KEY) {
                showToast(t.apiKeyNeeded, 'danger', '#settings');
                return;
            }

            // 1. Revert to original if already translated
            if (isTranslated) {
                bioEl.textContent = bioEl.dataset.originalContent;
                metaEl.innerHTML = metaEl.dataset.originalContent;
                bioEl.dataset.isTranslated = 'false';
                metaEl.dataset.isTranslated = 'false';
                btnText.textContent = t.translateToHebrew; // Back to "Translate to Hebrew"
                return;
            }

            // 2. Translate to new language (which is *always* Hebrew in this flow)
            const originalBioText = bioEl.dataset.originalContent || bioEl.textContent;
            const originalMetaHtml = metaEl.dataset.originalContent || metaEl.innerHTML;
            
            // Store original content if not already stored
            if (!bioEl.dataset.originalContent) bioEl.dataset.originalContent = originalBioText;
            if (!metaEl.dataset.originalContent) metaEl.dataset.originalContent = originalMetaHtml;

            // Convert meta HTML to clean text for translation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalMetaHtml;
            const originalMetaText = tempDiv.textContent || "";
            
            const targetLanguage = 'Hebrew'; // Hardcode this, as the button only shows when lang is 'he' and bio is 'en'

            // Set loading state
            const originalBtnText = btnText.textContent;
            btnText.textContent = t.translating;
            btn.disabled = true;

            try {
                const systemPrompt = `You are an expert translator. You will be given text from a person's biography and their meta-information. Translate all of it to ${targetLanguage}. Respond ONLY with a JSON object in the format: {"biography": "...", "metaInfo": "..."}. Do not add any other text. Preserve line breaks with \\n.`;
                const userQuery = `Please translate the following content to ${targetLanguage}:\n\nBiography:\n${originalBioText}\n\nMeta Info:\n${originalMetaText}`;
                
                const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Gemini API call failed with status: ${response.status}`);

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error('No valid JSON response from Gemini.');

                const translated = JSON.parse(jsonText);

                if (!translated.biography || !translated.metaInfo) {
                    throw new Error('Incomplete JSON response from Gemini.');
                }
                
                // Update content with translated text
                bioEl.textContent = translated.biography; // Use textContent for plain text
                metaEl.innerHTML = translated.metaInfo.replace(/\n/g, '<br>'); // Use innerHTML to render line breaks

                bioEl.dataset.isTranslated = 'true';
                metaEl.dataset.isTranslated = 'true';
                btnText.textContent = t.translateToEnglish; // Now shows "Translate back to English"
                
                trackProgress('ai_consultant', 1);
                checkAchievements();

            } catch (error) {
                console.error("Translation error:", error);
                showToast(t.translationError, 'danger');
                // Revert button on failure
                btnText.textContent = originalBtnText;
            } finally {
                btn.disabled = false;
            }
        }

        async function showHomeView() {
            resetView();
            mainView.classList.remove('hidden');
            mainView.classList.add('fade-in');
            document.getElementById('genre-filter-container').classList.remove('hidden');
            isSearchMode = false;
            cameFromSurpriseMe = false;
            
            const t = translations[currentLanguage];
            
            // MODIFIED: Always use generic Home title and Trending content
            pageTitle.textContent = t.home;
            
            currentView = 'home';
            populateGenreFilter();
            const viewCache = contentCache.home;
            const cacheType = 'trending'; // Always trending, removed 'personalized' logic

            if (viewCache.type !== cacheType && !selectedGenreId) {
                // Clear cache if the type of content for home has changed and no filter is active
                viewCache.items = [];
                viewCache.page = 1;
                viewCache.allIds.clear();
                viewCache.canLoadMore = true;
                contentGrid.innerHTML = '';
            }
             viewCache.type = cacheType;

            if (viewCache.items.length > 0) {
                renderContent(viewCache.items, true);
            } else {
                contentGrid.innerHTML = ''; // Clear existing content before fetching
                await fetchTrendingContent(1);
            }
        }

        async function showMoviesView() {
            resetView();
            mainView.classList.remove('hidden');
            mainView.classList.add('fade-in');
            document.getElementById('genre-filter-container').classList.remove('hidden');
            isSearchMode = false;
            cameFromSurpriseMe = false;
            
            const t = translations[currentLanguage];
            pageTitle.textContent = t.movies;

            currentView = 'movies';
            populateGenreFilter();
            const viewCache = contentCache.movies;

            if (viewCache.items.length > 0) {
                renderContent(viewCache.items, true);
            } else {
                contentGrid.innerHTML = ''; // Clear existing content before fetching
                await fetchPopularContent('movie', 1);
            }
        }

        async function showSeriesView() {
            resetView();
            mainView.classList.remove('hidden');
            mainView.classList.add('fade-in');
            document.getElementById('genre-filter-container').classList.remove('hidden');
            isSearchMode = false;
            cameFromSurpriseMe = false;
            
            const t = translations[currentLanguage];
            pageTitle.textContent = t.series;

            currentView = 'series';
            populateGenreFilter();
            const viewCache = contentCache.series;

            if (viewCache.items.length > 0) {
                renderContent(viewCache.items, true);
            } else {
                contentGrid.innerHTML = ''; // Clear existing content before fetching
                await fetchPopularContent('tv', 1);
            }
        }

        async function showCinemasView() {
            resetView();
            cinemasView.classList.add('hidden');
            newReleasesView.classList.add('hidden');
            settingsView.classList.add('hidden');
            watchedView.classList.add('hidden');
            cinemasView.classList.remove('hidden');
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('cinemas-title').textContent = t.nowInCinemasNav;

            cinemasGrid.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;
            const data = await fetchAPI('/movie/now_playing', { region: getRegionForLanguage() });
            cinemasGrid.innerHTML = ``;
            if (data && data.results) {
                data.results.forEach(movie => {
                    movie.media_type = 'movie';
                    cinemasGrid.appendChild(createCard(movie, false, false));
                });
                if (window.observeElements) window.observeElements();
            }
        }

        async function showNewReleasesView() {
            resetView();
            newReleasesView.classList.remove('hidden');
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('new-releases-title').textContent = t.newReleasesNav;

            const newReleasesGrid = document.getElementById('new-releases-grid');
            newReleasesGrid.innerHTML = `<div class="loading-spinner mx-auto col-span-full"></div>`;
            
            // Fetch upcoming movies and on-the-air TV shows
            const [upcomingMoviesData, onTheAirTvData] = await Promise.all([
                fetchAPI('/movie/upcoming', { region: getRegionForLanguage() }),
                fetchAPI('/tv/on_the_air', { region: getRegionForLanguage() })
            ]);

            newReleasesGrid.innerHTML = '';
            
            let combinedResults = [];
            if (upcomingMoviesData && upcomingMoviesData.results) {
                upcomingMoviesData.results.forEach(item => item.media_type = 'movie');
                combinedResults.push(...upcomingMoviesData.results);
            }
            if (onTheAirTvData && onTheAirTvData.results) {
                onTheAirTvData.results.forEach(item => item.media_type = 'tv');
                combinedResults.push(...onTheAirTvData.results);
            }
            
            // Sort by popularity as a simple way to mix them
            combinedResults.sort((a, b) => b.popularity - a.popularity);

            if (combinedResults.length > 0) {
                combinedResults.forEach(item => {
                    if (item.poster_path) { // Ensure there is a poster to display
                        newReleasesGrid.appendChild(createCard(item, false, false, true)); // Pass true to suppress banners
                    }
                });
                if (window.observeElements) window.observeElements();
            } else {
                 newReleasesGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">${t.noResults}</p>`;
            }
        }

        function showLibraryView() {
            resetView();
            libraryView.classList.remove('hidden');
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('library-title').textContent = t.myLibrary;
            document.getElementById('library-notice').textContent = t.libraryNotice;
            
            renderLibrary();
        }

        function showWatchedView() {
            resetView();
            watchedView.classList.remove('hidden');
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('watched-title').textContent = t.navWatched;
            document.getElementById('watched-notice').textContent = t.libraryNotice;
            document.getElementById('watched-notice-extra').textContent = t.watchedNoticeExtra;
            
            renderWatched();
        }

        function showSettingsView() {
            resetView();
            settingsView.classList.remove('hidden');
            isSearchMode = false;

            updateSettingsText();
        }

        function showAchievementsView() {
            resetView();
            achievementsView.classList.remove('hidden');
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('achievements-title').textContent = t.achievementsTitle;
            renderAchievements();
        }

        function showPluginsView() {
            resetView();
            pluginsView.classList.remove('hidden');
            isSearchMode = false;
            currentView = 'plugins';
            
            const t = translations[currentLanguage];
            document.getElementById('plugins-title').textContent = t.navPlugins;
            
            renderPlugins();
        }

        async function showShortsView() {
            resetView();
            shortsView.classList.remove('hidden');
            shortsView.classList.add('fade-in');
            isSearchMode = false;
            currentView = 'shorts';

            const t = translations[currentLanguage];
            document.getElementById('shorts-title').textContent = t.navShorts;

            // NEW: Add scroll listener for infinite scroll
            const feedContainer = document.getElementById('shorts-feed-container');
            /* בוטל - הגלילה האינסופית בוטלה יחד עם הגלילה הידנית
            feedContainer.onscroll = () => {
                if (isLoading || !contentCache.shorts.canLoadMore) return;

                // Load more when 500px from the bottom
                if (feedContainer.scrollTop + feedContainer.clientHeight >= feedContainer.scrollHeight - 500) {
                    const nextPage = contentCache.shorts.page + 1;
                    fetchShortsContent(nextPage);
                }
            };
            */
            // END NEW

            const viewCache = contentCache.shorts;
            
            // --- NEW ---
            // Clear the cache to load new shorts every time
            /*
            viewCache.items = [];
            viewCache.page = 1; // This will be overwritten by fetchShortsContent
            viewCache.allIds.clear();
            viewCache.canLoadMore = true;
            */
            // --- END NEW ---

            // --- MODIFICATION START ---
            // Check if cache is empty OR if the DOM is empty. Only fetch if it is.
            if (viewCache.items.length > 0 && feedContainer.childElementCount > 0) {
                // Items exist and are rendered. This is a "return" trip.
                // Do nothing. Scroll restoration in handleRouting will handle positioning,
                // and the shortsObserver will automatically play the video in view.
            } else {
                // First time load, or cache was cleared (e.g., lang change). Rebuild.
                viewCache.items = [];
                viewCache.page = 1;
                viewCache.allIds.clear();
                viewCache.canLoadMore = true;
                await fetchShortsContent(1); // This will render the items.
            }
            // --- MODIFICATION END ---
        }

        async function fetchShortsContent(page = 1) {
            const viewCache = contentCache.shorts;
            if (isLoading || (!viewCache.canLoadMore && page > 1)) return; // MODIFIED
            isLoading = true;

            const feedContainer = document.getElementById('shorts-feed-container');
            
            // --- NEW ---
            let pageToFetch = page;
            if (page === 1) {
                // If it's the first page load, pick a random page from the first 20 pages
                // to ensure new content on each visit.
                pageToFetch = Math.floor(Math.random() * 20) + 1;
            }
            // --- END NEW ---

            if (page === 1) {
                feedContainer.innerHTML = `<div class="loading-spinner mx-auto mt-16"></div>`;
            } else {
                // NEW: Show a mini-loader at the bottom
                const scrollLoader = document.createElement('div');
                scrollLoader.id = 'shorts-scroll-loader';
                scrollLoader.className = 'flex justify-center items-center p-4';
                scrollLoader.innerHTML = `<div class="loading-spinner"></div>`;
                feedContainer.appendChild(scrollLoader);
            }

            // Fetch trending content
            const data = await fetchAPI('/trending/all/week', { page: pageToFetch }); // Use pageToFetch

            // NEW: Remove mini-loader
            const scrollLoader = document.getElementById('shorts-scroll-loader');
            if (scrollLoader) scrollLoader.remove();
            // END NEW

            if (!data || !data.results || data.results.length === 0) {
                viewCache.canLoadMore = false;
                if (page === 1) feedContainer.innerHTML = `<p class="text-center text-gray-400 p-8">${translations[currentLanguage].noResults}</p>`;
                isLoading = false;
                return;
            }

            // Fetch videos for each item
            const videoPromises = data.results.map(item => fetchVideos(item.id, item.media_type));
            const videos = await Promise.all(videoPromises);

            const newItems = [];
            data.results.forEach((item, index) => {
                const trailer = videos[index];
                if (trailer && !viewCache.allIds.has(item.id) && item.poster_path) {
                    item.trailerKey = trailer.key;
                    viewCache.allIds.add(item.id);
                    newItems.push(item);
                }
            });

            viewCache.items.push(...newItems);
            viewCache.page = pageToFetch; // --- MODIFIED ---
            renderShorts(newItems, page === 1);
            isLoading = false;
        }

        function renderShorts(items, isNew) {
            const feedContainer = document.getElementById('shorts-feed-container');
            if (isNew) {
                feedContainer.innerHTML = '';
            }
            if (items.length === 0 && isNew) {
                feedContainer.innerHTML = `<p class="text-center text-gray-400 p-8">${translations[currentLanguage].noResults}</p>`;
                return;
            }

            items.forEach(item => {
                const shortItem = document.createElement('div');
                shortItem.className = 'short-item';
                // NEW: Add initial state
                shortItem.dataset.isPlaying = 'false';
                shortItem.dataset.isMuted = isShortsFeedMuted.toString(); // <-- NEW: Use global state

                const title = item.name || item.title;
                const posterPath = item.poster_path ? `${IMAGE_BASE_URL}${item.poster_path}` : 'https://placehold.co/500x750/1a1a1a/f5f5f5?text=No+Image';
                const t = translations[currentLanguage]; // NEW: Get translations
            // MODIFIED: Add autoplay=1&mute=1. enablejsapi=1 allows postMessage control.
                // NEW: Added origin parameter for API security
                const videoUrl = `https://www.youtube.com/embed/${item.trailerKey}?autoplay=1&mute=1&controls=0&modestbranding=1&rel=0&loop=1&playlist=${item.trailerKey}&enablejsapi=1&origin=${window.location.origin}`;

                shortItem.innerHTML = `
                    <iframe 
                        id="short-iframe-${item.id}"
                        data-src="${videoUrl}" 
                        title="${title}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen
                        loading="lazy"
                    ></iframe>
                    <!-- NEW: Progress Bar & Time -->
                    <div class="short-progress-container">
                        <div class="short-progress-fill"></div>
                    </div>
                    <div class="short-time-display text-white text-xs font-mono">
                        <span class="short-current-time">0:00</span> / <span class="short-duration">0:00</span>
                    </div>
                    <!-- MODIFIED: This is just the gradient now -->
                    <div class="short-overlay"></div>
                    
                    <!-- NEW: Separate container for info, on top of tap overlay -->
                    <div class="short-info-container">
                        <!-- Poster Image -->
                        <img src="${posterPath}" alt="${title}" class="h-32 w-auto rounded-md flex-shrink-0" style="aspect-ratio: 2/3; object-fit: cover; border: 1px solid rgba(255,255,255,0.2);">
                        
                        <!-- Text container with class -->
                        <div class="flex-grow min-w-0 short-text-container">
                            <h3 class="text-white text-lg font-bold truncate">${title}</h3>
                            <p class="text-gray-300 text-sm full-description">${item.overview || t.descriptionNotAvailable}</p>
                            <!-- REMOVED: Details Button -->
                        </div>
                        
                        <!-- REMOVED Spacer Div -->
                    </div>
                    
                    <!-- NEW: Custom Controls -->
                    <div class="short-tap-overlay" data-action="playpause"></div>
                    <div class="short-play-pause-icon">
                        ${shortsPlayIcon}
                    </div>
                    <div class="short-bottom-controls">
                        <!-- NEW: Details Button (moved here and restyled as icon button) -->
                        <a href="#details-${item.media_type}-${item.id}" 
                           class="absolute bottom-[4.75rem] right-4 w-11 h-11 inline-flex items-center justify-center gap-1.5 bg-black/50 text-white text-xs font-bold rounded-full transition-all hover:scale-110 hover:bg-black/80 z-[5]" 
                           style="pointer-events: auto; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.2);"
                           title="${t.moreDetails}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </a>
                        
                        <!-- NEW: Quick Settings Button (REMOVED) -->
                        
                        <!-- NEW: Quality Menu (REMOVED) -->

                        <button class="short-mute-btn" data-action="muteunmute">
                            ${isShortsFeedMuted ? shortsMuteIcon : shortsUnmuteIcon} <!-- NEW: Use global state -->
                        </button>
                    </div>
                `;

                feedContainer.appendChild(shortItem);
                shortsObserver.observe(shortItem); // Observe the new item
            });
        }

        function showOnboardingView() {
            const onboardingView = document.getElementById('onboarding-view');
            onboardingView.classList.remove('hidden');
            
            // Hide original labels/instructions
            document.getElementById('onboarding-age-label').classList.add('hidden');
            document.getElementById('onboarding-genres-label').classList.add('hidden');
            document.getElementById('onboarding-genres-instruction').classList.add('hidden');
            document.getElementById('onboarding-age-groups').innerHTML = ''; 
            document.getElementById('onboarding-skip-btn').classList.add('hidden');
            document.getElementById('onboarding-skip-notice').classList.add('hidden');

            // Prepare content container
            const contentContainer = document.getElementById('onboarding-genres-grid');
            // Reset classes to generic flex container
            contentContainer.className = 'flex flex-col items-center justify-center min-h-[250px] text-center transition-all duration-300 ease-in-out';

            // Prepare button
            const submitBtn = document.getElementById('onboarding-submit-btn');
            const newSubmitBtn = submitBtn.cloneNode(true);
            submitBtn.parentNode.replaceChild(newSubmitBtn, submitBtn);
            
            newSubmitBtn.disabled = false;
            newSubmitBtn.className = 'mt-8 w-full max-w-xs mx-auto p-3 bg-red-600 text-white font-bold rounded-full hover:bg-red-700 transition-colors shadow-lg hover:shadow-red-600/50';

            // Language Selection Phase
            let tempLang = getBrowserLanguage(); // Start with device language or English fallback

            const renderLanguageSelection = () => {
                // Set titles directly here as setupUI hasn't run with the user's choice yet
                document.getElementById('onboarding-title').textContent = "Select Language / בחר שפה";
                document.getElementById('onboarding-subtitle').textContent = "Please choose your preferred language / אנא בחר את השפה המועדפת עליך";

                // Render Language Options
                contentContainer.innerHTML = `
                    <div class="flex flex-col gap-4 w-full max-w-xs fade-in-scale">
                        <button class="lang-option p-4 rounded-xl border-2 flex items-center justify-between transition-all ${tempLang === 'he' ? 'border-red-600 bg-red-600/20' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-700'}" onclick="window.selectOnboardingLang('he')">
                            <span class="text-2xl">🇮🇱</span>
                            <span class="text-lg font-bold text-white">עברית</span>
                            ${tempLang === 'he' ? '<span class="text-red-500 font-bold">✓</span>' : '<span></span>'}
                        </button>
                        <button class="lang-option p-4 rounded-xl border-2 flex items-center justify-between transition-all ${tempLang === 'en' ? 'border-red-600 bg-red-600/20' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-700'}" onclick="window.selectOnboardingLang('en')">
                            <span class="text-2xl">🇺🇸</span>
                            <span class="text-lg font-bold text-white">English</span>
                            ${tempLang === 'en' ? '<span class="text-red-500 font-bold">✓</span>' : '<span></span>'}
                        </button>
                        <button class="lang-option p-4 rounded-xl border-2 flex items-center justify-between transition-all ${tempLang === 'ru' ? 'border-red-600 bg-red-600/20' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-700'}" onclick="window.selectOnboardingLang('ru')">
                            <span class="text-2xl">🇷🇺</span>
                            <span class="text-lg font-bold text-white">Русский</span>
                            ${tempLang === 'ru' ? '<span class="text-red-500 font-bold">✓</span>' : '<span></span>'}
                        </button>
                        <button class="lang-option p-4 rounded-xl border-2 flex items-center justify-between transition-all ${tempLang === 'ar' ? 'border-red-600 bg-red-600/20' : 'border-gray-600 hover:border-gray-400 hover:bg-gray-700'}" onclick="window.selectOnboardingLang('ar')">
                            <span class="text-2xl">🇸🇦</span>
                            <span class="text-lg font-bold text-white">العربية</span>
                            ${tempLang === 'ar' ? '<span class="text-red-500 font-bold">✓</span>' : '<span></span>'}
                        </button>
                    </div>
                `;

                if (tempLang === 'he') newSubmitBtn.textContent = 'המשך';
                else if (tempLang === 'ru') newSubmitBtn.textContent = 'Продолжить';
                else if (tempLang === 'ar') newSubmitBtn.textContent = 'استمرار';
                else newSubmitBtn.textContent = 'Continue';

                // Global handler for the inline onclick
                window.selectOnboardingLang = (lang) => {
                    tempLang = lang;
                    renderLanguageSelection();
                };

                newSubmitBtn.onclick = () => {
                    // Apply selected language
                    currentLanguage = tempLang;
                    localStorage.setItem('findFlixLang', currentLanguage);
                    
                    // NEW: Automatically set content language to match interface language on first setup
                    tmdbLanguage = tempLang;
                    localStorage.setItem('findFlixTmdbLang', tmdbLanguage);

                    setupUI(); // Apply translations and direction to the entire app (including onboarding modal)
                    
                    // Proceed to Tour
                    delete window.selectOnboardingLang; // Cleanup
                    startTour();
                };
            };

            const startTour = () => {
                // Re-set button behavior for tour flow
                newSubmitBtn.onclick = null; 

                // Define tour texts for all languages
                const tourTexts = {
                    'he': {
                        introTitle: 'ברוכים הבאים ל-Find-Flix',
                        introDesc: 'הפלטפורמה האולטימטיבית לחובבי קולנוע וטלוויזיה. בואו לסיבוב קצר!',
                        moviesTitle: 'סרטים וסדרות',
                        moviesDesc: 'מידע מקיף על אלפי כותרים, טריילרים, דירוגים, שחקנים וחיפוש מתקדם.',
                        tvTitle: 'טלוויזיה בשידור חי',
                        tvDesc: 'צפייה ישירה בערוצים מובילים מישראל והעולם, כולל לוח שידורים (EPG) וזיהוי תוכן חכם.',
                        shortsTitle: 'Shorts',
                        shortsDesc: 'גלו תכנים חדשים בפיד סרטונים קצרים, מהירים ומהנים (בסגנון TikTok).',
                        aiTitle: 'כוח ה-AI',
                        aiDesc: 'קבלו המלצות חכמות, זיהוי תוכן בשידור חי, תרגום ביוגרפיות וסיכומים אישיים בעזרת Gemini.',
                        moreTitle: 'ועוד המון!',
                        moreDesc: 'היסטוריית צפייה, ספרייה אישית, הישגים, ערכות נושא מתחלפות ותוספים.',
                        startBtn: 'התחל לגלוש! 🚀',
                        nextBtn: 'הבא'
                    },
                    'ru': {
                        introTitle: 'Добро пожаловать в Find-Flix',
                        introDesc: 'Идеальная платформа для любителей кино и телевидения. Давайте проведем небольшую экскурсию!',
                        moviesTitle: 'Фильмы и сериалы',
                        moviesDesc: 'Полная информация о тысячах названий, трейлеры, рейтинги, актеры и расширенный поиск.',
                        tvTitle: 'Прямой эфир ТВ',
                        tvDesc: 'Смотрите ведущие телеканалы Израиля и мира, включая программу передач (EPG) и умное распознавание контента.',
                        shortsTitle: 'Shorts',
                        shortsDesc: 'Открывайте новый контент через ленту коротких видео (в стиле TikTok).',
                        aiTitle: 'Сила ИИ',
                        aiDesc: 'Получайте умные рекомендации, распознавание контента в прямом эфире, перевод биографий и личные сводки с помощью Gemini.',
                        moreTitle: 'И многое другое!',
                        moreDesc: 'История просмотра, личная библиотека, достижения, темы и плагины.',
                        startBtn: 'Начать просмотр! 🚀',
                        nextBtn: 'Далее'
                    },
                    'en': {
                        introTitle: 'Welcome to Find-Flix',
                        introDesc: 'The ultimate platform for movie and TV fans. Let\'s take a quick tour!',
                        moviesTitle: 'Movies & Series',
                        moviesDesc: 'Comprehensive info on thousands of titles, trailers, ratings, cast, and advanced search.',
                        tvTitle: 'Live TV',
                        tvDesc: 'Watch leading live TV channels from Israel and the world, including EPG and smart content identification.',
                        shortsTitle: 'Shorts',
                        shortsDesc: 'Discover new content via a fun, fast-paced short video feed (TikTok style).',
                        aiTitle: 'AI Power',
                        aiDesc: 'Get smart recommendations, live content identification, biography translations, and personal summaries powered by Gemini.',
                        moreTitle: 'And Much More!',
                        moreDesc: 'Watch history, personal library, achievements, themes, and plugins.',
                        startBtn: 'Start Browsing! 🚀',
                        nextBtn: 'Next'
                    },
                    'ar': {
                        introTitle: 'مرحباً بك في Find-Flix',
                        introDesc: 'المنصة المثالية لعشاق الأفلام والبرامج التلفزيونية. لنقم بجولة سريعة!',
                        moviesTitle: 'أفلام ومسلسلات',
                        moviesDesc: 'معلومات شاملة عن آلاف العناوين، إعلانات، تقييمات، طاقم العمل وبحث متقدم.',
                        tvTitle: 'بث تلفزيوني مباشر',
                        tvDesc: 'شاهد قنوات تلفزيونية رائدة من إسرائيل والعالم، بما في ذلك جدول البث (EPG) والتعرف الذكي على المحتوى.',
                        shortsTitle: 'فيديوهات قصيرة',
                        shortsDesc: 'اكتشف محتوى جديد عبر موجز فيديو قصير ممتع وسريع الوتيرة (بأسلوب TikTok).',
                        aiTitle: 'قوة الذكاء الاصطناعي',
                        aiDesc: 'احصل على توصيات ذكية، تعرف على المحتوى المباشر، ترجمة السير الذاتية، وملخصات شخصية مدعومة بـ Gemini.',
                        moreTitle: 'وأكثر من ذلك بكثير!',
                        moreDesc: 'سجل المشاهدة، مكتبة شخصية، إنجازات، سمات، وإضافات.',
                        startBtn: 'ابدأ التصفح! 🚀',
                        nextBtn: 'التالي'
                    }
                };

                const txt = tourTexts[currentLanguage] || tourTexts['en'];

                const features = [
                    {
                        id: 'intro',
                        title: txt.introTitle,
                        desc: txt.introDesc,
                        demo: `<div class="text-7xl mb-4 transform transition-transform hover:scale-110 duration-300 cursor-default">👋</div>`
                    },
                    {
                        id: 'movies',
                        title: txt.moviesTitle,
                        desc: txt.moviesDesc,
                        demo: `
                            <div class="flex gap-2 justify-center items-end h-32 mb-4">
                                <div class="w-16 h-24 bg-gray-700 rounded-lg shadow-lg transform -rotate-6 border border-gray-600"></div>
                                <div class="w-20 h-28 bg-red-600 rounded-lg shadow-xl z-10 flex items-center justify-center border border-red-500">
                                    <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <div class="w-16 h-24 bg-gray-700 rounded-lg shadow-lg transform rotate-6 border border-gray-600"></div>
                            </div>`
                    },
                    {
                        id: 'tv',
                        title: txt.tvTitle,
                        desc: txt.tvDesc,
                        demo: `
                            <div class="relative w-48 h-28 bg-black rounded-lg border-2 border-gray-700 mx-auto flex items-center justify-center overflow-hidden shadow-lg mb-4">
                                <div class="absolute top-2 right-2 bg-red-600 text-white text-[8px] font-bold px-1 rounded animate-pulse">LIVE</div>
                                <div class="absolute bottom-0 left-0 right-0 h-1 bg-red-600 w-2/3"></div>
                                <svg class="w-10 h-10 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            </div>`
                    },
                    {
                        id: 'shorts',
                        title: txt.shortsTitle,
                        desc: txt.shortsDesc,
                        demo: `
                            <div class="w-24 h-40 bg-gray-800 rounded-xl border border-gray-600 mx-auto relative overflow-hidden shadow-lg flex flex-col justify-between p-2 mb-4">
                                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50"></div>
                                <div class="z-10 self-end text-white/80"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>
                                <div class="z-10 text-white text-[8px] space-y-1">
                                    <div class="h-1 w-12 bg-gray-400/50 rounded"></div>
                                    <div class="h-1 w-8 bg-gray-400/50 rounded"></div>
                                </div>
                            </div>`
                    },
                    {
                        id: 'ai',
                        title: txt.aiTitle,
                        desc: txt.aiDesc,
                        demo: `
                            <div class="w-full max-w-[220px] mx-auto space-y-2 mb-4">
                                <div class="flex gap-2 items-center bg-gray-700/50 p-2 rounded-lg rounded-tl-none border border-gray-600">
                                    <span class="text-xs text-gray-300">בא לי סרט מתח...</span>
                                </div>
                                <div class="flex gap-2 items-center flex-row-reverse bg-purple-900/30 p-2 rounded-lg rounded-tr-none border border-purple-500/30">
                                    <svg class="w-4 h-4 text-purple-400 flex-shrink-0" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                                    <span class="text-xs text-purple-200">מצאתי לך משהו!</span>
                                </div>
                            </div>`
                    },
                    {
                        id: 'more',
                        title: txt.moreTitle,
                        desc: txt.moreDesc,
                        demo: `
                            <div class="grid grid-cols-2 gap-3 max-w-[180px] mx-auto mb-4">
                                <div class="bg-gray-700/80 p-3 rounded-lg flex items-center justify-center border border-gray-600 shadow-sm"><span class="text-2xl">📚</span></div>
                                <div class="bg-gray-700/80 p-3 rounded-lg flex items-center justify-center border border-gray-600 shadow-sm"><span class="text-2xl">🏆</span></div>
                                <div class="bg-gray-700/80 p-3 rounded-lg flex items-center justify-center border border-gray-600 shadow-sm"><span class="text-2xl">🎨</span></div>
                                <div class="bg-gray-700/80 p-3 rounded-lg flex items-center justify-center border border-gray-600 shadow-sm"><span class="text-2xl">🔌</span></div>
                            </div>`
                    }
                ];

                let currentStep = 0;

                const renderStep = () => {
                    const feature = features[currentStep];
                    
                    // Title is updated in the header
                    document.getElementById('onboarding-title').textContent = feature.title;
                    document.getElementById('onboarding-subtitle').textContent = ''; // Clear subtitle

                    // Render Content with animation
                    contentContainer.innerHTML = `
                        <div class="fade-in-scale w-full">
                            ${feature.demo}
                        </div>
                        <p class="text-lg sm:text-xl text-gray-200 leading-relaxed max-w-md mx-auto fade-in px-4 mt-2">${feature.desc}</p>
                        
                        <!-- Dots Indicator -->
                        <div class="flex gap-3 mt-8 justify-center">
                            ${features.map((_, idx) => `
                                <div class="w-2.5 h-2.5 rounded-full transition-all duration-300 ${idx === currentStep ? 'bg-red-600 scale-125 w-4' : 'bg-gray-600'}"></div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Add fade-in animation to the container content
                    const descEl = contentContainer.querySelector('p');
                    if (descEl) descEl.style.animation = 'fadeIn 0.5s ease-out';

                    // Update Button Text
                    if (currentStep === features.length - 1) {
                        if (currentLanguage === 'he') newSubmitBtn.textContent = 'התחל לגלוש! 🚀';
                        else if (currentLanguage === 'ru') newSubmitBtn.textContent = 'Начать просмотр! 🚀';
                        else if (currentLanguage === 'ar') newSubmitBtn.textContent = 'ابدأ التصفح! 🚀';
                        else newSubmitBtn.textContent = 'Start Browsing! 🚀';
                    } else {
                        if (currentLanguage === 'he') newSubmitBtn.textContent = 'הבא';
                        else if (currentLanguage === 'ru') newSubmitBtn.textContent = 'Далее';
                        else if (currentLanguage === 'ar') newSubmitBtn.textContent = 'التالي';
                        else newSubmitBtn.textContent = 'Next';
                    }
                };

                newSubmitBtn.onclick = () => {
                    if (currentStep < features.length - 1) {
                        currentStep++;
                        renderStep();
                    } else {
                        handleOnboardingSubmit();
                    }
                };

                // Initial Render of Tour
                renderStep();
            };

            // Start with Language Selection
            renderLanguageSelection();
        }

        function updateOnboardingUIText() {
            // Text updates are handled dynamically in showOnboardingView
        }

        function updateOnboardingButtonState() {
            // No longer needed
        }

        function handleOnboardingSubmit() {
            // Mark onboarding as "skipped" (meaning default/trending view) since we don't collect prefs anymore
            localStorage.setItem('findFlixOnboardingSkipped', 'true');
            // Ensure no old preferences linger
            localStorage.removeItem('findFlixUserPreferences');

            const onboardingView = document.getElementById('onboarding-view');
            onboardingView.classList.add('hidden');
            
            // Now initialize the main app
            setupUI();
            handleRouting();
            initPWA();
        }

        function handleOnboardingSkip() {
             handleOnboardingSubmit(); // Same behavior
        }

         // Render Functions
        function renderContent(data, isNewSearch = false) {
            if (isNewSearch) {
                contentGrid.innerHTML = '';
            }
            if (data.length === 0 && isNewSearch) {
                const message = document.createElement('p');
                message.className = 'col-span-full text-center text-gray-400';
                message.innerHTML = `${translations[currentLanguage].noResults}<br>${translations[currentLanguage].noResultsTip}`;
                contentGrid.appendChild(message);
            } else {
                for (const item of data) {
                    contentGrid.appendChild(createCard(item, false, false));
                }
            }
            if(window.observeElements) window.observeElements();
        }
        
        async function handleSurpriseMe() {
            const viewCache = contentCache[currentView] || contentCache.home;
            let availableForSurprise = viewCache.items.filter(item => !isItemInWatched(item.id));

            if (availableForSurprise.length === 0 && viewCache.canLoadMore) { // Limit fetching to avoid infinite loops
                const nextPage = viewCache.page + 1;
                if (currentView === 'movies') await fetchPopularContent('movie', nextPage);
                else if (currentView === 'series') await fetchPopularContent('tv', nextPage);
                else await fetchTrendingContent(nextPage);

                availableForSurprise = viewCache.items.filter(item => !isItemInWatched(item.id));
            }

            if (availableForSurprise.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableForSurprise.length);
                const randomItem = availableForSurprise[randomIndex];
                
                cameFromSurpriseMe = true;
                window.location.hash = `details-${randomItem.media_type}-${randomItem.id}`;
            } else {
                showToast(translations[currentLanguage].noNewRecommendations, 'danger');
            }
            
            trackProgress('lucky', 1);
            checkAchievements();
        }

        async function handleSurpriseAgainAnimation() {
            const detailWrapper = document.getElementById('detail-content-wrapper');
            if (detailWrapper) {
                // Apply the 'out' animation
                detailWrapper.style.animation = 'surprise-out 0.4s ease-out forwards';
                
                // Wait for the animation to finish before getting the next item
                setTimeout(() => {
                    handleSurpriseMe(); // This will change the hash and trigger a re-render
                    
                    // The detailView gets a fade-in-scale, but let's reset this specific wrapper's animation
                    // after a bit so it's ready for the next click.
                    setTimeout(() => {
                        const newWrapper = document.getElementById('detail-content-wrapper');
                        if(newWrapper) {
                           newWrapper.style.animation = '';
                        }
                    }, 1000); // Give it enough time to be replaced/re-rendered

                }, 400);
            } else {
                handleSurpriseMe(); // Fallback
            }
        }

        function updateActiveSidebarLink(hash) {
            // Reset all links, toggles, and submenus first
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.querySelectorAll('.sidebar-dropdown-toggle').forEach(toggle => toggle.classList.remove('active'));
            document.querySelectorAll('.sidebar-submenu').forEach(submenu => submenu.classList.remove('open'));
            document.querySelectorAll('.chevron-icon').forEach(icon => icon.classList.remove('open'));
        
            // Find the active link
            const activeLink = document.querySelector(`.sidebar-link[href="${hash}"]`);
            
            if (activeLink) {
                activeLink.classList.add('active');
                
                // Check if it's inside a submenu
                const parentSubmenu = activeLink.closest('.sidebar-submenu');
                if (parentSubmenu) {
                    const toggleButton = parentSubmenu.previousElementSibling;
                    parentSubmenu.classList.add('open');
                    toggleButton.classList.add('active');
                    if (toggleButton.querySelector('.chevron-icon')) {
                        toggleButton.querySelector('.chevron-icon').classList.add('open');
                    }
                }
            }
        }

        // Language and UI Setup
        function updateSettingsText() {
            const t = translations[currentLanguage];
            document.getElementById('settings-title').textContent = t.settings;
            document.getElementById('settings-general-title').textContent = t.general;
            document.getElementById('settings-language-label').textContent = t.language;
            document.getElementById('settings-language-description').textContent = t.languageDescription;
            document.getElementById('settings-content-language-label').textContent = t.contentLanguage; 
            document.getElementById('settings-content-language-description').textContent = t.contentLanguageDescription; 
            document.getElementById('settings-display-title').textContent = t.settingsDisplay;
            document.getElementById('settings-display-mode-label').textContent = t.settingsDisplayMode;
            document.getElementById('settings-display-mode-description').textContent = t.displayModeDescription;
            document.getElementById('theme-auto-option').textContent = t.themeAutomatic;
            document.getElementById('theme-dark-option').textContent = t.themeDark;
            document.getElementById('theme-light-option').textContent = t.themeLight;
            document.getElementById('theme-glass-option').textContent = t.themeGlass;
            
            // Card Density
            document.getElementById('settings-card-density-label').textContent = t.settingsCardDensity;
            document.getElementById('settings-card-density-description').textContent = t.settingsCardDensityDescription;
            document.getElementById('density-compact-option').textContent = t.densityCompact;
            document.getElementById('density-default-option').textContent = t.densityDefault;
            document.getElementById('density-comfortable-option').textContent = t.densityComfortable;

            // New Accessibility Section
            document.getElementById('settings-accessibility-title').textContent = t.settingsAccessibility;
            document.getElementById('settings-font-size-label').textContent = t.fontSize;
            document.getElementById('settings-font-size-description').textContent = t.fontSizeDescription;
            document.getElementById('reset-font-size-btn').textContent = t.reset;
            document.getElementById('settings-high-contrast-label').textContent = t.highContrast;
            document.getElementById('settings-high-contrast-description').textContent = t.highContrastDescription;
            document.getElementById('settings-reduced-motion-label').textContent = t.reducedMotion;
            document.getElementById('settings-reduced-motion-description').textContent = t.reducedMotionDescription;
            document.getElementById('settings-underline-links-label').textContent = t.settingsUnderlineLinks;
            document.getElementById('settings-underline-links-description').textContent = t.settingsUnderlineLinksDescription;

            // My Account Section
            document.getElementById('settings-account-title').textContent = t.myAccount;
            // REMOVED PREFERENCES TEXT UPDATES
            
            // Export/Import translations
            document.getElementById('settings-backup-restore-label').textContent = t.backupRestore;
            document.getElementById('settings-backup-restore-description').textContent = t.backupRestoreDescription;
            document.getElementById('export-data-btn').textContent = t.exportFile;
            document.getElementById('import-data-btn').textContent = t.importFile;

            // Information Section
            document.getElementById('settings-information-title').textContent = t.settingsInformationTitle;
            document.getElementById('settings-whats-new-label').textContent = t.settingsWhatsNewLabel;
            document.getElementById('settings-whats-new-btn').textContent = t.viewBtn;
            document.getElementById('settings-whats-new-description').textContent = t.settingsWhatsNewDescription;
            document.getElementById('settings-about-label').textContent = t.settingsAboutLabel;
            document.getElementById('settings-about-btn').textContent = t.viewBtn;
            document.getElementById('settings-about-description').textContent = t.settingsAboutDescription;
            document.getElementById('settings-contact-label').textContent = t.settingsContactLabel;
            document.getElementById('settings-contact-btn').textContent = t.contactUs;
            document.getElementById('settings-contact-description').textContent = t.settingsContactDescription;
            document.getElementById('settings-advanced-title').textContent = t.settingsAdvancedTitle;
            document.getElementById('settings-custom-font-label').textContent = t.settingsCustomFontLabel;
            document.getElementById('settings-custom-font-description').textContent = t.settingsCustomFontDescription;
            document.getElementById('upload-font-btn').textContent = t.uploadFont;
            document.getElementById('reset-font-btn').textContent = t.resetFont;
            document.getElementById('current-font-label').textContent = t.currentFontLabel;
            document.getElementById('custom-font-name').textContent = localStorage.getItem('findFlixCustomFontName') || t.defaultFont;
            document.getElementById('settings-gemini-api-key-label').textContent = t.settingsGeminiApiKeyLabel;
            document.getElementById('save-gemini-api-key-btn').textContent = t.saveBtn;
            document.getElementById('settings-gemini-api-key-description').innerHTML = t.settingsGeminiApiKeyDescription;
            document.getElementById('settings-gemini-api-key-notice').textContent = t.geminiApiKeyNotice;
            document.getElementById('gemini-api-key-input').placeholder = 'AIza...';
            document.getElementById('settings-flixy-label').textContent = t.settingsFlixyLabel;
            document.getElementById('settings-flixy-description').textContent = t.settingsFlixyDescription;

            // AI TV Identifier Settings
            document.getElementById('settings-ai-tv-identifier-label').textContent = t.settingsAiTvIdentifierLabel;
            document.getElementById('settings-ai-tv-identifier-description').textContent = t.settingsAiTvIdentifierDescription;
            document.getElementById('settings-ai-tv-timer-label').textContent = t.settingsAiTvTimerLabel;
            document.getElementById('settings-ai-tv-timer-description').textContent = t.settingsAiTvTimerDescription;
            const timerValueSpan = document.getElementById('ai-tv-timer-value');
            if (timerValueSpan) {
                const slider = document.getElementById('ai-tv-timer-slider');
                timerValueSpan.textContent = `${slider.value} ${t.secondsUnit}`;
            }
            // NEW Sports Scoreboard Setting Text
            document.getElementById('settings-sports-scoreboard-label').textContent = t.settingsSportsScoreboardLabel;
            document.getElementById('settings-sports-scoreboard-description').textContent = t.settingsSportsScoreboardDescription;
        }

        function setupUI() {
            const t = translations[currentLanguage];
            document.documentElement.lang = currentLanguage;
            document.documentElement.dir = t.langDir;

            const searchIconContainer = document.getElementById('search-icon-container');
            const clearSearchBtn = document.getElementById('clear-search-btn');

            // Reset classes to avoid conflicts on language switch
            searchInput.classList.remove('pr-12', 'pl-12');
            
            if (t.langDir === 'rtl') {
                // Magnifying glass on the right
                searchIconContainer.classList.remove('left-0', 'pl-4');
                searchIconContainer.classList.add('right-0', 'pr-4');
                // Clear button on the left
                clearSearchBtn.classList.remove('right-0', 'pr-4');
                clearSearchBtn.classList.add('left-0', 'pl-4');
                // Padding on both sides for input
                searchInput.classList.add('pr-12', 'pl-12'); 
            } else { // LTR
                // Magnifying glass on the left
                searchIconContainer.classList.remove('right-0', 'pr-4');
                searchIconContainer.classList.add('left-0', 'pl-4');
                // Clear button on the right
                clearSearchBtn.classList.remove('left-0', 'pl-4');
                clearSearchBtn.classList.add('right-0', 'pr-4');
                // Padding on both sides for input
                searchInput.classList.add('pl-12', 'pl-12');
            }

            searchInput.dir = t.langDir;

            // NEW: TV Channel Search input direction
            const tvSearchInput = document.getElementById('tv-channel-search-input');
            const tvSearchIconContainer = document.getElementById('tv-search-icon-container');
            if (tvSearchInput && tvSearchIconContainer) {
                tvSearchInput.dir = t.langDir;
                tvSearchInput.classList.remove('pl-10', 'pr-10');
                tvSearchIconContainer.classList.remove('left-0', 'pl-3', 'right-0', 'pr-3');

                if (t.langDir === 'rtl') {
                    tvSearchInput.classList.add('pr-10');
                    tvSearchIconContainer.classList.add('right-0', 'pr-3');
                } else {
                    tvSearchInput.classList.add('pl-10');
                    tvSearchIconContainer.classList.add('left-0', 'pl-3');
                }
            }

            mainSubtitle.textContent = t.subtitle;
            document.getElementById('surprise-me-btn-text').textContent = t.surpriseMeBtn;
            document.getElementById('surprise-again-btn-text').textContent = t.surpriseAgainBtn;
            document.getElementById('ai-recommender-btn-text').textContent = t.aiRecommenderBtn;
            document.getElementById('tools-btn-text').textContent = t.toolsBtnText;
            
            // Sidebar Translations
            document.getElementById('nav-title').textContent = t.navigationTitle;
            document.getElementById('nav-home').textContent = t.home;
            document.getElementById('nav-movies').textContent = t.movies;
            document.getElementById('nav-series').textContent = t.series;
            document.getElementById('nav-cinemas').textContent = t.nowInCinemasNav;
            document.getElementById('nav-new-releases').textContent = t.newReleasesNav;
            document.getElementById('nav-library').textContent = t.myLibrary;
            document.getElementById('nav-watched').textContent = t.navWatched;
            document.getElementById('sidebar-settings-shortcut').title = t.settings;
            document.getElementById('nav-install').textContent = t.installApp;
            document.getElementById('nav-achievements').textContent = t.navAchievements;
            document.getElementById('nav-plugins').textContent = t.navPlugins;
            document.getElementById('nav-shorts').textContent = t.navShorts;
            document.getElementById('nav-tv-channels').textContent = t.navTvChannels;
            document.getElementById('achievements-grid-title').textContent = t.achievementsGridTitle; // NEW LINE

            // Translate new dropdown titles using data-translate attribute
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            langSelect.value = currentLanguage;
            // Note: tmdb-lang-select value is managed by populateContentLanguages
            
            const hour = new Date().getHours();
            const greeting = hour < 12 ? t.goodMorning : hour < 18 ? t.goodAfternoon : hour < 22 ? t.goodEvening : t.goodNight;
            
            // Login Streak Display Logic
            const streak = parseInt(localStorage.getItem('findFlixLoginStreak') || '1', 10);
            const daysText = currentLanguage === 'he' ? 'ימים ברצף' : 'Days Streak';
            
            const greetingHtml = `
                <div class="flex flex-col items-center">
                    <span class="text-lg text-gray-400 mb-3">${greeting}</span>
                    <div class="relative group cursor-default select-none transform hover:scale-105 transition-transform duration-300">
                        
                        <!-- Main Pill -->
                        <div class="flex items-center gap-2 px-5 py-1.5 rounded-full bg-[#251a1a] border border-[#5c3a3a] shadow-[0_2px_8px_rgba(0,0,0,0.2)] relative overflow-hidden">
                            <!-- Background Glow Effect -->
                            <div class="absolute inset-0 bg-gradient-to-r from-orange-500/5 to-red-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                            
                            <span class="text-xl animate-pulse filter drop-shadow-[0_0_6px_rgba(249,115,22,0.8)]">🔥</span>
                            <div class="flex items-baseline gap-1.5">
                                <span class="text-lg font-bold text-white" style="font-variant-numeric: tabular-nums;">${streak}</span>
                                <span class="text-xs text-[#d1d1d1] font-medium tracking-wide">${daysText}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('sidebar-greeting').innerHTML = greetingHtml;

            // Translate Roulette Section
            document.getElementById('roulette-title').textContent = t.rouletteTitle;
            document.getElementById('roulette-start-btn-text').textContent = t.rouletteStartBtnText;
            document.getElementById('roulette-tool-text').textContent = t.rouletteToolText;

            // NEW: Set capture disclaimer text
            const captureDisclaimerEl = document.getElementById('capture-disclaimer');
            if (captureDisclaimerEl) {
                captureDisclaimerEl.textContent = t.captureDisclaimer;
            }

            // Update meta tags for SEO and PWA manifest
            document.getElementById('meta-description').setAttribute('content', t.metaDescription);
            document.getElementById('meta-keywords').setAttribute('content', t.metaKeywords);

            updateSettingsText();
            startTypingAnimation();
        }
        
        // Library Functions
        function loadLibraryFromStorage() {
            const stored = localStorage.getItem('findFlixLibrary');
            libraryItems = stored ? JSON.parse(stored) : [];
        }

        function saveLibraryToStorage() {
            localStorage.setItem('findFlixLibrary', JSON.stringify(libraryItems));
        }

        function addToLibrary(item) {
            if (!isItemInLibrary(item.id)) {
                libraryItems.push(item);
                saveLibraryToStorage();
                const message = (translations[currentLanguage].addedToLibrary || "{itemName} added to library!").replace('{itemName}', item.name);
                showToast(message, 'success', '#library');
                checkAchievements();
            }
        }

        function removeFromLibrary(itemId, itemName) {
            const item = libraryItems.find(i => i.id === parseInt(itemId));
            const name = itemName || (item ? item.name : '');
            libraryItems = libraryItems.filter(i => i.id !== parseInt(itemId));
            saveLibraryToStorage();
            if (currentView === 'library') renderLibrary(); // Re-render if in library view
            const message = (translations[currentLanguage].removedFromLibrary || "{itemName} removed from library.").replace('{itemName}', name);
            showToast(message, 'danger');
        }

        function isItemInLibrary(itemId) {
            return libraryItems.some(item => item.id === parseInt(itemId));
        }

        function renderLibrary() {
            libraryGrid.innerHTML = '';
            if (libraryItems.length === 0) {
                libraryGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">${translations[currentLanguage].libraryEmpty}</p>`;
                return;
            }
            libraryItems.forEach(item => {
                libraryGrid.appendChild(createCard(item, true, false));
            });
            if(window.observeElements) window.observeElements();
        }

        // Watched History Functions
        function loadWatchedFromStorage() {
            const stored = localStorage.getItem('findFlixWatched');
            watchedItems = stored ? JSON.parse(stored) : [];
        }

        function saveWatchedToStorage() {
            localStorage.setItem('findFlixWatched', JSON.stringify(watchedItems));
        }

        function addToWatched(item) {
            if (!isItemInWatched(item.id)) {
                watchedItems.push(item);
                saveWatchedToStorage();
                showToast(translations[currentLanguage].addedToWatchedToast, 'success', '#watched');
                checkAchievements();
            }
        }

        function removeFromWatched(itemId, itemName) {
            const item = watchedItems.find(i => i.id === parseInt(itemId));
            const name = itemName || (item ? item.name : '');
            watchedItems = watchedItems.filter(i => i.id !== parseInt(itemId));
            saveWatchedToStorage();
            if (currentView === 'watched') renderWatched();
            const message = (translations[currentLanguage].removedFromWatched || "Removed from watched history.").replace('{itemName}', name);
            showToast(message, 'danger');
        }

        function isItemInWatched(itemId) {
            return watchedItems.some(item => item.id === parseInt(itemId));
        }
        
        function renderWatched() {
            watchedGrid.innerHTML = '';
            if (watchedItems.length === 0) {
                watchedGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">${translations[currentLanguage].watchedEmpty}</p>`;
                return;
            }
            watchedItems.forEach(item => {
                watchedGrid.appendChild(createCard(item, false, true));
            });
            if(window.observeElements) window.observeElements();
        }

        // Plugin Functions
        function updatePluginUI() {
            const isTvEnabled = localStorage.getItem('findFlixPlugin_tv') === 'true';
            const tvLink = document.getElementById('nav-tv-link');
            
            if (tvLink) {
                tvLink.classList.toggle('hidden', !isTvEnabled);
            }

            // If TV plugin is disabled and user is on TV page, redirect
            if (!isTvEnabled && window.location.hash === '#tv') {
                window.location.hash = '#home';
            }
        }
        
        function renderPlugins() {
            const grid = document.getElementById('plugins-grid');
            grid.innerHTML = '';
            const t = translations[currentLanguage];

            Object.keys(PLUGINS).forEach(id => {
                const plugin = PLUGINS[id];
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-6 rounded-lg flex flex-col gap-4';

                const isEnabled = localStorage.getItem(`findFlixPlugin_${id}`) === 'true';

                let experimentalTag = '';
                if (plugin.experimental) {
                    experimentalTag = `<span class="bg-yellow-500 text-black text-xs font-bold px-2 py-0.5 rounded-full">${t.settingsExperimentalTag}</span>`;
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-3">
                            <div class="w-10 h-10 flex-shrink-0 bg-gray-700 rounded-lg flex items-center justify-center p-1">
                                <img src="${plugin.icon}" alt="${t[`plugin_${id}_name`]}" class="w-full h-full object-contain">
                            </div>
                             <h3 class="text-xl font-bold">${t[`plugin_${id}_name`]}</h3>
                             ${experimentalTag}
                         </div>
                         <div class="flex items-center gap-4">
                            ${(id === 'tv' && isEnabled) ? `
                                <a href="#tv" title="${t.navTvChannels}" class="text-gray-400 hover:text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 1.414L10.586 9H7a1 1 0 100 2h3.586l-1.293 1.293a1 1 0 101.414 1.414l3-3a1 1 0 000-1.414z" clip-rule="evenodd" />
                                    </svg>
                                </a>
                                <button title="${t.settings}" class="text-gray-400 hover:text-white transition-colors tv-settings-opener">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </button>
                            ` : ''}
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="plugin-toggle-${id}" class="sr-only peer" ${isEnabled ? 'checked' : ''}>
                                <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-red-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-red-600"></div>
                            </label>
                         </div>
                    </div>
                    <p class="text-gray-400">${t[`plugin_${id}_desc`]}</p>
                `;
                grid.appendChild(card);

                document.getElementById(`plugin-toggle-${id}`).addEventListener('change', (e) => {
                    localStorage.setItem(`findFlixPlugin_${id}`, e.target.checked);
                    updatePluginUI();
                    renderPlugins();
                });

                const settingsBtn = card.querySelector('.tv-settings-opener');
                if (settingsBtn) {
                    settingsBtn.addEventListener('click', showTvSettingsModal);
                }
            });
        }

        function showRouletteModal() {
            const t = translations[currentLanguage];
            const modal = document.getElementById('roulette-modal');
            const modalTitle = document.getElementById('roulette-modal-title');
            const animationContainer = document.getElementById('roulette-animation-container');
            const resultContainer = document.getElementById('roulette-result-container');

            modalTitle.textContent = t.rouletteModalTitle;
            animationContainer.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            resultContainer.innerHTML = '';

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function hideRouletteModal() {
            const modal = document.getElementById('roulette-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function handleRouletteSpin() {
            showRouletteModal();
            const t = translations[currentLanguage];
            const animationContainer = document.getElementById('roulette-animation-container');
            const resultContainer = document.getElementById('roulette-result-container');
            const strip = document.getElementById('roulette-strip');

            try {
                // Fetch two pages to get a good variety
                const [page1, page2] = await Promise.all([
                    fetchAPI('/movie/popular', { page: Math.floor(Math.random() * 10) + 1 }),
                    fetchAPI('/tv/popular', { page: Math.floor(Math.random() * 10) + 1 })
                ]);

                let items = [];
                if (page1 && page1.results) items.push(...page1.results.map(i => ({...i, media_type: 'movie'})));
                if (page2 && page2.results) items.push(...page2.results.map(i => ({...i, media_type: 'tv'})));
                
                let validItems = items.filter(item => item.poster_path && !isItemInWatched(item.id));
                
                if (validItems.length < 10) { // Fallback if not enough unwatched items
                     validItems = items.filter(item => item.poster_path);
                }

                if (validItems.length === 0) throw new Error("No items found for roulette.");

                // Shuffle and select items for animation
                for (let i = validItems.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [validItems[i], validItems[j]] = [validItems[j], validItems[i]];
                }
                
                const animationItems = validItems.slice(0, 30);
                const winnerIndex = Math.floor(Math.random() * (animationItems.length - 10)) + 5; // Pick winner not too close to edges
                const winner = animationItems[winnerIndex];

                // Create a longer strip for a seamless loop effect
                const stripItems = [...animationItems.slice(-5), ...animationItems, ...animationItems.slice(0, 5)];
                strip.innerHTML = '';
                stripItems.forEach(item => {
                    const posterPath = `${IMAGE_BASE_URL}${item.poster_path}`;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'roulette-item h-72 w-48 flex-shrink-0';
                    itemDiv.innerHTML = `<img src="${posterPath}" class="w-full h-full object-cover rounded-lg">`;
                    strip.appendChild(itemDiv);
                });

                // Spind the wheel
                strip.style.transition = 'none';
                strip.style.transform = 'translateY(0)';
                
                await new Promise(resolve => setTimeout(resolve, 50)); // Allow DOM to update

                const itemHeight = 288; // h-72
                const targetPosition = -((winnerIndex + 5) * itemHeight - itemHeight / 2); // Center the winner
                const randomOffset = (Math.random() - 0.5) * (itemHeight * 0.6);
                const finalPosition = targetPosition + randomOffset;
                const fullSpins = 3;
                const initialPosition = -(stripItems.length * itemHeight * fullSpins);

                strip.style.transition = 'transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)';
                strip.style.transform = `translateY(${finalPosition}px)`;

                // Wait for animation to end
                await new Promise(resolve => setTimeout(resolve, 4200));

                animationContainer.classList.add('hidden');
                
                const title = winner.title || winner.name;
                const posterPath = winner.poster_path ? `${IMAGE_BASE_URL}${winner.poster_path}` : 'https://placehold.co/500x750/1a1a1a/f5f5f5?text=No+Image';
                let overview = winner.overview || t.descriptionNotAvailable;
                if (overview.length > 150) {
                    overview = overview.substring(0, 150) + '...';
                }

                resultContainer.innerHTML = `
                    <div class="roulette-result-card w-full flex flex-col items-center text-center">
                        <img src="${posterPath}" alt="${title}" class="w-2/3 rounded-lg shadow-lg mb-4">
                        <h4 class="text-2xl font-bold mb-2">${title}</h4>
                        <p class="text-gray-400 mb-4">${overview}</p>
                        <div class="flex items-center gap-4 mt-2">
                            <button id="spin-again-btn" class="px-5 py-2 bg-gray-600 text-white font-bold rounded-full transition-colors hover:bg-gray-700">${t.spinAgain}</button>
                            <a href="#details-${winner.media_type}-${winner.id}" id="roulette-details-btn" class="px-5 py-2 bg-red-600 text-white font-bold rounded-full transition-colors hover:bg-red-700">${t.moreDetails}</a>
                        </div>
                    </div>
                `;
                resultContainer.classList.remove('hidden');

                document.getElementById('spin-again-btn').addEventListener('click', handleRouletteSpin);
                document.getElementById('roulette-details-btn').addEventListener('click', () => {
                    cameFromSurpriseMe = false;
                    hideRouletteModal();
                });

            } catch (error) {
                console.error("Roulette Error:", error);
                showToast(t.noNewRecommendations, 'danger');
                hideRouletteModal();
            }
        }

        // Achievement Functions
        const ACHIEVEMENTS = {
            'first_watch': {
                icon: '▶️',
                checker: () => watchedItems.length >= 1,
                progress: () => ({ current: watchedItems.length, target: 1 })
            }
        };

        function loadAchievementsFromStorage() {
            const stored = localStorage.getItem('findFlixAchievements');
            if (stored) {
                const parsed = JSON.parse(stored);
                userAchievements.unlocked = new Set(parsed.unlocked || []);
                // Ensure progress data is correctly loaded (Set needs to be reconstructed)
                userAchievements.progress = parsed.progress || {};
                if (userAchievements.progress.genres_explored) {
                    userAchievements.progress.genres_explored = new Set(userAchievements.progress.genres_explored);
                }
            }
        }

        function saveAchievementsToStorage() {
            // Convert Set to Array for JSON serialization
            const serializableAchievements = {
                unlocked: Array.from(userAchievements.unlocked),
                progress: { ...userAchievements.progress }
            };
            if (serializableAchievements.progress.genres_explored) {
                serializableAchievements.progress.genres_explored = Array.from(serializableAchievements.progress.genres_explored);
            }
            localStorage.setItem('findFlixAchievements', JSON.stringify(serializableAchievements));
        }
        
        function trackProgress(key, value) {
            if (key === 'genres_explored') {
                if (!userAchievements.progress.genres_explored) {
                    userAchievements.progress.genres_explored = new Set();
                }
                userAchievements.progress.genres_explored.add(value);
            } else {
                 userAchievements.progress[key] = (userAchievements.progress[key] || 0) + value;
            }
            saveAchievementsToStorage();
        }

        function checkAchievements() {
            Object.keys(ACHIEVEMENTS).forEach(id => {
                if (!userAchievements.unlocked.has(id)) {
                    if (ACHIEVEMENTS[id].checker()) {
                        unlockAchievement(id);
                    }
                }
            });
        }
        
        function unlockAchievement(id) {
            userAchievements.unlocked.add(id);
            saveAchievementsToStorage();
            
            const t = translations[currentLanguage];
            const name = t[`achievement_${id}_name`] || id;
            showToast(`${t.achievementUnlocked} ${name}`, 'success', '#achievements');

            // Handle specific rewards
            if (ACHIEVEMENTS[id].reward === 'starlight_theme') {
                const starlightOption = document.getElementById('theme-starlight-option');
                if (starlightOption) {
                    starlightOption.classList.remove('hidden');
                }
                showToast(t.reward_starlight_theme, 'info');
            }
            if (ACHIEVEMENTS[id].reward === 'glass_theme') {
                const glassOption = document.getElementById('theme-glass-option');
                if (glassOption) {
                    glassOption.classList.remove('hidden');
                }
                showToast(t.reward_glass_theme, 'info');
            }

            // After unlocking an achievement, check if it triggers the power_user achievement
            checkAchievements();
        }

        function renderAchievements() {
            const grid = document.getElementById('achievements-grid');
            grid.innerHTML = '';
            const t = translations[currentLanguage];
            
            // --- NEW STREAK LOGIC ---
            const streak = parseInt(localStorage.getItem('findFlixLoginStreak') || '1', 10);
            
            // Get Highest Streak Data
            const highestStreak = parseInt(localStorage.getItem('findFlixHighestStreak') || streak, 10);
            const highestStreakDateStr = localStorage.getItem('findFlixHighestStreakDate');
            let highestStreakText = '';
            
            if (highestStreakDateStr) {
                const dateObj = new Date(highestStreakDateStr);
                const formattedDate = dateObj.toLocaleDateString(currentLanguage, { day: 'numeric', month: 'short', year: 'numeric' });
                highestStreakText = `${formattedDate}`;
            } else {
                // If no date stored yet (first run with feature), assume today
                const today = new Date();
                highestStreakText = today.toLocaleDateString(currentLanguage, { day: 'numeric', month: 'short', year: 'numeric' });
            }

            // Update Hero Section
            document.getElementById('streak-days-count').textContent = streak;
            document.getElementById('streak-label-text').textContent = t.streakLabel;
            
            // --- NEW: Add Highest Streak Display ---
            // Remove old highest streak element if exists to prevent duplicates on re-render
            const existingRecordEl = document.getElementById('highest-streak-display');
            if (existingRecordEl) existingRecordEl.remove();

            const streakContainer = document.getElementById('streak-days-count').closest('.flex.flex-col.items-center');
            
            // Only create if not already there (though we remove it above, good practice for structure)
            const recordHtml = `
                <div id="highest-streak-display" class="mt-6 flex flex-col items-center animate-fade-in opacity-80 hover:opacity-100 transition-opacity">
                    <div class="text-[10px] text-gray-500 uppercase tracking-wider font-bold mb-1">${t.highestStreak}</div>
                    <div class="flex items-center gap-2 bg-gray-800/80 px-4 py-1.5 rounded-full border border-gray-700/50 shadow-sm">
                        <span class="text-yellow-500 text-sm">🏆</span>
                        <span class="text-white font-bold font-mono text-sm">${highestStreak}</span>
                        <span class="text-gray-500 text-[10px] border-l border-gray-600 pl-2 ml-1 ${t.langDir === 'rtl' ? 'border-r-0 border-l pl-2 ml-1' : 'border-l pl-2 ml-1'}">${highestStreakText}</span>
                    </div>
                </div>
            `;
            
            // Append nicely below the main streak circle
            if (streakContainer) {
                 // Check if we need to insert it into the DOM
                 // The streakContainer is actually the parent of the pill in the HTML structure.
                 // Let's find the parent div of the main pill to append after.
                 const heroParent = document.querySelector('#achievements-view .flex.flex-col.items-center.justify-center.mb-10');
                 if (heroParent) {
                     // Create a temp container
                     const temp = document.createElement('div');
                     temp.innerHTML = recordHtml;
                     heroParent.appendChild(temp.firstElementChild);
                 }
            }
            // --- END NEW ---
            
            // Motivation Text
            let motivationIndex = 0;
            if (streak >= 30) motivationIndex = 4;
            else if (streak >= 14) motivationIndex = 3;
            else if (streak >= 7) motivationIndex = 2;
            else if (streak >= 3) motivationIndex = 1;
            document.getElementById('streak-motivation').textContent = t.streakMotivation[motivationIndex];

            // Define Rewards based on streak (using centralized constant)
            const milestones = STREAK_MILESTONES.map(m => ({
                ...m,
                unlocked: streak >= m.days
            }));

            // Find next milestone for progress bar
            const nextMilestone = milestones.find(m => !m.unlocked) || milestones[milestones.length - 1];
            const prevMilestoneDays = milestones.filter(m => m.unlocked).pop()?.days || 0;
            
            // Calculate progress
            let percentage = 100;
            if (!nextMilestone.unlocked) {
                const totalRange = nextMilestone.days - prevMilestoneDays;
                const progressInRange = streak - prevMilestoneDays;
                percentage = Math.min(100, Math.max(0, (progressInRange / totalRange) * 100));
                
                // Update Text
                document.getElementById('next-reward-label').textContent = `${t.nextReward}: ${t.rewards[nextMilestone.id].title}`;
                document.getElementById('achievement-progress-text').textContent = `${streak} / ${nextMilestone.days}`;
                document.getElementById('next-reward-desc').textContent = t.rewards[nextMilestone.id].desc;
            } else {
                // Max level
                document.getElementById('next-reward-label').textContent = "מקסימום!";
                document.getElementById('achievement-progress-text').textContent = "🏆";
                document.getElementById('next-reward-desc').textContent = "השיג את כל הפרסים האפשריים!";
            }
            
            document.getElementById('achievement-progress-fill').style.width = `${percentage}%`;

            // Render Reward Cards
            milestones.forEach(m => {
                const rewardInfo = t.rewards[m.id];
                const card = document.createElement('div');
                // Using the new dark style for cards
                const statusClass = m.unlocked 
                    ? 'border-yellow-500/30 bg-gradient-to-br from-yellow-900/10 to-transparent' 
                    : 'border-gray-700 bg-gray-800/30 grayscale opacity-60';
                
                const iconGlow = m.unlocked ? 'drop-shadow-[0_0_8px_rgba(234,179,8,0.5)]' : '';

                // Check if this milestone unlocks a theme and handle it
                if (m.unlocked && m.rewardId) {
                    // Unlock the achievement in the system if not already
                    if (!userAchievements.unlocked.has(m.rewardId)) {
                        // We manually trigger the unlock logic for themes
                        if (m.rewardId === 'starlight_theme') {
                            document.getElementById('theme-starlight-option')?.classList.remove('hidden');
                        }
                        if (m.rewardId === 'glass_theme') {
                            document.getElementById('theme-glass-option')?.classList.remove('hidden');
                        }
                        // Add to set without showing toast (to avoid spam on render)
                        userAchievements.unlocked.add(m.rewardId);
                        saveAchievementsToStorage();
                    }
                }

                card.className = `border rounded-xl p-4 flex items-center gap-4 transition-all duration-300 ${statusClass}`;
                
                // Determine "Apply" button for themes
                let actionHtml = '';
                if (m.unlocked && m.rewardId) {
                    const themeValue = m.rewardId === 'starlight_theme' ? 'starlight' : 'glass';
                    actionHtml = `
                        <button class="apply-theme-btn mt-2 text-xs bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-full transition-colors" data-theme="${themeValue}">
                            החל
                        </button>
                    `;
                }

                card.innerHTML = `
                    <div class="text-3xl ${iconGlow}">${m.icon}</div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-white truncate">${rewardInfo.title}</h4>
                            ${m.unlocked ? '<span class="text-yellow-500 text-xs font-bold">✓</span>' : `<span class="text-gray-500 text-xs">${m.days} ימים</span>`}
                        </div>
                        <p class="text-xs text-gray-400 mt-1 leading-relaxed">${rewardInfo.desc}</p>
                        ${actionHtml}
                    </div>
                `;
                
                // Add event listener for theme buttons
                const themeBtn = card.querySelector('.apply-theme-btn');
                if (themeBtn) {
                    themeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const theme = e.target.dataset.theme;
                        localStorage.setItem('findFlixTheme', theme);
                        // Update selector
                        const themeSelect = document.getElementById('theme-select');
                        if(themeSelect) themeSelect.value = theme;
                        applyTheme(theme);
                        showToast('ערכת נושא הוחלה!', 'success');
                    });
                }

                grid.appendChild(card);
            });
            
            if (window.observeElements) window.observeElements();
        }

        function showRewardPreviewModal(rewardId) {
            const modal = document.getElementById('reward-preview-modal');
            const contentContainer = document.getElementById('reward-preview-content');
            const t = translations[currentLanguage];

            contentContainer.innerHTML = ''; // Clear previous content

            if (rewardId === 'starlight_theme') {
                const themeName = t.themeStarlight;
                const rewardTitle = t.reward_starlight_theme;

                contentContainer.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4 text-center">${rewardTitle}</h3>
                    <div class="theme-starlight-preview w-full h-48 rounded-lg p-4 border border-purple-400/50">
                        <style>
                            .theme-starlight-preview {
                                background-color: #0c0a18; color: #e0e0ff;
                                background-image: radial-gradient(white, rgba(255,255,255,.2) 1px, transparent 20px), radial-gradient(white, rgba(255,255,255,.15) 0.5px, transparent 15px);
                                background-size: 250px 250px, 150px 150px; background-position: 0 0, 20px 30px;
                            }
                            .theme-starlight-preview .preview-card {
                                background-color: rgba(20, 18, 38, 0.8); backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);
                                border: 1px solid rgba(128, 128, 255, 0.2); padding: 1rem; border-radius: 0.5rem;
                            }
                            .theme-starlight-preview .preview-title { color: #fff; font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem; }
                            .theme-starlight-preview .preview-text { color: #e0e0ff; margin-bottom: 1rem; }
                            .theme-starlight-preview .preview-button { background-color: #9333ea; color: white; padding: 0.5rem 1rem; border-radius: 9999px; }
                        </style>
                        <div class="preview-card">
                            <h4 class="preview-title">${themeName}</h4>
                            <p class="preview-text">טקסט לדוגמה / Example Text</p>
                            <button class="preview-button">Button</button>
                        </div>
                    </div>
                `;
            } else if (rewardId === 'glass_theme') {
                const themeName = t.themeGlass;
                const rewardTitle = t.reward_glass_theme;
                contentContainer.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4 text-center">${rewardTitle}</h3>
                    <div class="glass-theme-preview w-full h-48 rounded-lg p-4 border border-white/20 relative overflow-hidden flex items-center justify-center">
                         <style>
                            .glass-theme-preview {
                                background: #0d0d0d; /* This is the actual background of the theme */
                            }
                            .glass-theme-preview .preview-card {
                                background: rgba(255, 255, 255, 0.08);
                                backdrop-filter: blur(30px);
                                -webkit-backdrop-filter: blur(30px);
                                border-radius: 16px;
                                border: 1px solid rgba(255, 255, 255, 0.15);
                                box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
                                padding: 1rem;
                                color: #fff;
                                text-shadow: 0 1px 4px rgba(0,0,0,0.6);
                            }
                         </style>
                         <div class="preview-card">
                            <h4 class="text-xl font-bold">${themeName}</h4>
                            <p>טקסט לדוגמה / Example Text</p>
                         </div>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function hideRewardPreviewModal() {
            const modal = document.getElementById('reward-preview-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        // Utility Functions
        function formatRuntime(minutes, lang) {
            const t = translations[lang];
            if (!minutes || minutes <= 0) return '';

            const h = Math.floor(minutes / 60);
            const m = minutes % 60;

            if (lang === 'he') {
                const parts = [];
                if (h > 0) {
                    if (h === 1) parts.push('שעה');
                    else if (h === 2) parts.push('שעתיים');
                    else parts.push(`${h} שעות`);
                }
                if (m > 0) {
                    if (m === 1) parts.push('דקה');
                    else parts.push(`${m} דקות`);
                }
                return parts.join(' ו-');
            }

            // Default for other languages
            const parts = [];
            if (h > 0) {
                parts.push(`${h}${t.hours}`);
            }
            if (m > 0) {
                parts.push(`${m}${t.minutes}`);
            }
            return parts.join(' ');
        }
        
        async function shareContent() {
            const t = translations[currentLanguage];
            // Get title safely (now guaranteed to be populated even if hidden)
            const title = document.getElementById('detail-title').textContent;
            const url = window.location.href;
            const shareText = t.shareMessage.replace('{title}', title);

            const shareData = {
                title: title,
                text: shareText,
                url: url,
            };

            try {
                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                     fallbackShare(shareText, url);
                }
            } catch (error) {
                console.error('Web Share API failed, falling back to clipboard.', error);
                fallbackShare(shareText, url);
            }
        }

        function fallbackShare(text, url) {
            const textArea = document.createElement('textarea');
            // Ensure newline is explicitly added between text and URL
            textArea.value = (text && url) ? `${text}\n${url}` : window.location.href;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast(translations[currentLanguage].linkCopied, 'success');
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }

        function populateGenreFilter() {
            const genreFilter = document.getElementById('genre-filter');
            if (!genreFilter) return;

            genreFilter.innerHTML = ''; // Clear
            const t = translations[currentLanguage];

            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            
            // MODIFIED: Removed personalization check, always show "All Genres"
            defaultOption.textContent = t.allGenres;
            genreFilter.appendChild(defaultOption);

            // Using the translated genres for consistency and sorting
            const sortedGenres = Object.entries(t.genres)
                .map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name, currentLanguage));

            for (const genre of sortedGenres) {
                const option = document.createElement('option');
                option.value = genre.id;
                option.textContent = genre.name;
                genreFilter.appendChild(option);
            }

            genreFilter.value = selectedGenreId || '';
        }

        function getBrowserLanguage() {
            const savedLang = localStorage.getItem('findFlixLang');
            if (savedLang && translations[savedLang]) {
                return savedLang;
            }
            const lang = navigator.language.split('-')[0];
            // Default to 'en' if language is not supported
            return translations[lang] ? lang : 'en'; 
        }

        function getRegionForLanguage() {
            const langToRegion = {
                'he': 'IL', 'en': 'US', 'ru': 'RU', 'ar': 'SA',
                'de': 'DE', 'es': 'ES', 'it': 'IT', 'fr': 'FR', 'pt': 'PT'
            };
            return langToRegion[currentLanguage] || 'US';
        }

        function updateCookieBannerText() {
            const t = translations[currentLanguage];
            const cookieBtn = document.getElementById('cookie-consent-btn');
            const cookieMessage = document.getElementById('cookie-consent-message');
            if (cookieBtn) cookieBtn.textContent = t.cookieAgree;
            if (cookieMessage) cookieMessage.textContent = t.cookieMessage;
        }

        // Login Streak Logic
        function initLoginStreak() {
            const today = new Date().toISOString().split('T')[0];
            const lastLogin = localStorage.getItem('findFlixLastLoginDate');
            let streak = parseInt(localStorage.getItem('findFlixLoginStreak') || '0', 10);
            let highestStreak = parseInt(localStorage.getItem('findFlixHighestStreak') || '0', 10);
            const t = translations[currentLanguage];

            if (lastLogin === today) return; // Already processed today

            let message = '';
            let type = 'info';
            let isStreakExtended = false;

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            if (lastLogin === yesterdayStr) {
                // Streak continues
                streak++;
                message = t.streakExtended.replace('{days}', streak);
                type = 'success';
                isStreakExtended = true;
                
                // Check for Milestones
                const milestone = STREAK_MILESTONES.find(m => m.days === streak);
                if (milestone) {
                    const title = t.rewards[milestone.id].title;
                    setTimeout(() => {
                        showToast(t.newMilestone.replace('{title}', title), 'success', '#achievements');
                        // Unlock special rewards logic
                        if (milestone.rewardId) {
                             if (milestone.rewardId === 'starlight_theme' || milestone.rewardId === 'glass_theme') {
                                 if (!userAchievements.unlocked.has(milestone.rewardId)) {
                                     userAchievements.unlocked.add(milestone.rewardId);
                                     saveAchievementsToStorage();
                                 }
                             }
                        }
                    }, 2500); // Delay milestone toast slightly
                }

            } else {
                // Streak broken or first time
                if (lastLogin) {
                    // Was logged in before, but missed a day
                    streak = 1;
                    message = t.streakLost;
                    type = 'danger';
                } else {
                    // First time ever
                    streak = 1;
                    message = t.streakStarted;
                    type = 'success';
                }
            }

            // Save new values
            localStorage.setItem('findFlixLoginStreak', streak);
            localStorage.setItem('findFlixLastLoginDate', today);
            
            if (streak > highestStreak) {
                localStorage.setItem('findFlixHighestStreak', streak);
                localStorage.setItem('findFlixHighestStreakDate', today);
            }

            // Show Notification
            if (message) {
                showToast(message, type, '#achievements');
            }
        }

        // Event Listeners
        window.addEventListener('hashchange', () => handleRouting());
        window.addEventListener('popstate', () => handleRouting());

        showRecommendationBtn.addEventListener('click', handleSurpriseMe);
        
        let searchDebounceTimeout;
        searchInput.addEventListener('input', (e) => {
            const clearSearchBtn = document.getElementById('clear-search-btn');
            const query = e.target.value.trim();

            if (query) {
                clearSearchBtn.classList.remove('hidden');
                clearSearchBtn.classList.add('flex');
            } else {
                clearSearchBtn.classList.add('hidden');
                clearSearchBtn.classList.remove('flex');
            }

            clearTimeout(searchDebounceTimeout);
            searchDebounceTimeout = setTimeout(() => {
                if (query) {
                    window.location.hash = `#search=${encodeURIComponent(query)}`;
                } else if (window.location.hash.startsWith('#search=')) {
                    // If the user clears the search bar while on a search page, go home.
                    window.location.hash = '#home'; 
                }
            }, 500);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // מונע התנהגות ברירת מחדל של טופס
                const query = searchInput.value.trim();
                if (query) {
                    clearTimeout(searchDebounceTimeout); // מבטל חיפוש אוטומטי ממתין
                    window.location.hash = `#search=${encodeURIComponent(query)}`;
                }
            }
        });
        
        document.getElementById('genre-filter').addEventListener('change', (e) => {
            selectedGenreId = e.target.value || null;

            if (currentView && contentCache[currentView]) {
                // Clear cache for current view to force a refetch
                const viewCache = contentCache[currentView];
                viewCache.items = [];
                viewCache.page = 1;
                viewCache.allIds.clear();
                viewCache.canLoadMore = true;
            }
            trackProgress('genres_explored', selectedGenreId);
            // Rerunning the routing will trigger the correct view function, 
            // which will now find an empty cache and fetch new, filtered data.
            handleRouting();
            checkAchievements();
        });

        langSelect.addEventListener('change', (e) => {
            const newLanguage = e.target.value;
            if (newLanguage === currentLanguage) return;

            const mainContent = document.querySelector('main');
            mainContent.style.transition = 'opacity 0.3s ease-out';
            mainContent.style.opacity = '0';

            setTimeout(() => {
                currentLanguage = newLanguage;
                localStorage.setItem('findFlixLang', currentLanguage);

                // Clear cache on language change
                contentCache = {
                    home: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                    movies: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                    series: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                    shorts: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                };
                
                setupUI();
                handleRouting();
                updateCookieBannerText();
                initPWA(); // Re-initialize PWA with new language for manifest

                mainContent.style.transition = 'opacity 0.5s ease-in';
                mainContent.style.opacity = '1';
            }, 300);
        });

        // NEW: Event Listener for Content Language (TMDB)
        const tmdbLangSelect = document.getElementById('tmdb-lang-select');
        if (tmdbLangSelect) {
            tmdbLangSelect.addEventListener('change', (e) => {
                const newTmdbLang = e.target.value;
                if (newTmdbLang === tmdbLanguage) return;

                const mainContent = document.querySelector('main');
                mainContent.style.transition = 'opacity 0.3s ease-out';
                mainContent.style.opacity = '0';

                setTimeout(() => {
                    tmdbLanguage = newTmdbLang;
                    localStorage.setItem('findFlixTmdbLang', tmdbLanguage);

                    // Clear content cache to force refresh with new language
                    contentCache = {
                        home: { items: [], page: 1, allIds: new Set(), canLoadMore: true, type: 'trending' },
                        movies: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                        series: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                        shorts: { items: [], page: 1, allIds: new Set(), canLoadMore: true },
                    };
                    
                    // We don't need to re-setup UI direction/labels (setupUI), just re-fetch content
                    handleRouting(); 

                    mainContent.style.transition = 'opacity 0.5s ease-in';
                    mainContent.style.opacity = '1';
                    showToast('שפת התוכן עודכנה!', 'success');
                }, 300);
            });
        }
        
        menuToggleBtn.addEventListener('click', () => {
            sidebar.classList.remove('translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            document.body.classList.add('sidebar-open');
        });
        
        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('translate-x-full');
            sidebarOverlay.classList.add('hidden');
            document.body.classList.remove('sidebar-open');
        });

        sidebarOverlay.addEventListener('click', () => {
             closeSidebarBtn.click();
        });

        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', () => {
                 closeSidebarBtn.click();
            });
        });

        document.querySelectorAll('.sidebar-dropdown-toggle').forEach(button => {
            button.addEventListener('click', () => {
                const submenuToToggle = button.nextElementSibling;
                const chevronToToggle = button.querySelector('.chevron-icon');
                const isOpening = !submenuToToggle.classList.contains('open');
                const DURATION = 300; // Must match CSS transition duration

                const openSubmenu = document.querySelector('.sidebar-submenu.open');

                // Case 1: A different submenu is open. Close it first, then open the new one.
                if (isOpening && openSubmenu && openSubmenu !== submenuToToggle) {
                    // Close the currently open one
                    openSubmenu.style.maxHeight = null;
                    openSubmenu.classList.remove('open');
                    const otherButton = openSubmenu.previousElementSibling;
                    otherButton.classList.remove('active');
                    const otherChevron = otherButton.querySelector('.chevron-icon');
                    if (otherChevron) {
                        otherChevron.classList.remove('open');
                    }

                    // Wait for the closing animation to finish before opening the new one
                    setTimeout(() => {
                        submenuToToggle.classList.add('open');
                        button.classList.add('active');
                        if (chevronToToggle) chevronToToggle.classList.add('open');
                        submenuToToggle.style.maxHeight = submenuToToggle.scrollHeight + "px";
                    }, DURATION);
                } 
                // Case 2: No other submenu is open, or we are closing the current one.
                else {
                    if (isOpening) {
                        submenuToToggle.classList.add('open');
                        button.classList.add('active');
                        if (chevronToToggle) chevronToToggle.classList.add('open');
                        submenuToToggle.style.maxHeight = submenuToToggle.scrollHeight + "px";
                    } else {
                        submenuToToggle.style.maxHeight = null;
                        submenuToToggle.classList.remove('open');
                        button.classList.remove('active');
                        if (chevronToToggle) chevronToToggle.classList.remove('open');
                    }
                }
            });
        });

        window.addEventListener('scroll', () => {
            if (isSearchMode || isLoading || !currentView || !contentCache[currentView]) return;

            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                const viewCache = contentCache[currentView];
                if (!viewCache.canLoadMore) return;

                const nextPage = viewCache.page + 1;
                
                if (currentView === 'movies') {
                    fetchPopularContent('movie', nextPage);
                } else if (currentView === 'series') {
                    fetchPopularContent('tv', nextPage);
                } else if (currentView === 'home') {
                    if (viewCache.type === 'personalized') {
                        fetchPersonalizedRecommendations(nextPage);
                    } else {
                        fetchTrendingContent(nextPage);
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // initLoginStreak(); // MOVED DOWN
            loadLibraryFromStorage();
            loadWatchedFromStorage();
            loadAchievementsFromStorage();
            initTheme();
            initCardDensity();
            initFontSize();
            initAccessibilitySettings();
            updatePluginUI();
            currentLanguage = getBrowserLanguage();
            
            // Migration from old CINEBY setting key to new plugin key
            if (localStorage.getItem('findFlixCinebyEnabled') !== null) {
                const oldValue = localStorage.getItem('findFlixCinebyEnabled');
                localStorage.setItem('findFlixPlugin_cineby', oldValue);
                localStorage.removeItem('findFlixCinebyEnabled');
            }

            // Call initLoginStreak AFTER language is set to ensure correct translation keys
            initLoginStreak();

            document.addEventListener('click', (event) => {
                const dropdown = document.getElementById('more-options-dropdown-menu');
                if (!dropdown || !dropdown.classList.contains('show')) return;
                
                const container = dropdown.closest('.more-options-container');
                if (container && !container.contains(event.target)) {
                    // Close it with animation
                    dropdown.classList.add('animate-dropdown-up-out');
                    dropdown.classList.remove('animate-dropdown-up');
                    setTimeout(() => {
                        dropdown.classList.remove('show');
                        dropdown.classList.remove('animate-dropdown-up-out');
                    }, 200);
                }
            });

            await fetchAndStoreGenres();
            await populateContentLanguages(); // Fetch and populate languages on load
            await fetchNowPlayingMovies();
            
            const userPreferences = localStorage.getItem('findFlixUserPreferences');
            const onboardingSkipped = localStorage.getItem('findFlixOnboardingSkipped');
            if (!userPreferences && !onboardingSkipped) {
                showOnboardingView();
            } else {
                setupUI();
                handleRouting();
                initPWA(); // Initialize Progressive Web App features
            }

            const clearSearchBtn = document.getElementById('clear-search-btn');
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                // Manually trigger the input event to update the UI and clear the search
                searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                searchInput.focus();
            });

            // NEW: TV Channel Search Listener
            const tvChannelSearchInput = document.getElementById('tv-channel-search-input');
            if (tvChannelSearchInput) {
                tvChannelSearchInput.addEventListener('input', () => {
                    renderTvChannels(tvChannelSearchInput.value.trim().toLowerCase());
                });
            }

            // New Tools Dropdown Logic
            const toolsDropdownBtn = document.getElementById('tools-dropdown-btn');
            const toolsDropdownMenu = document.getElementById('tools-dropdown-menu');

            function closeToolsDropdown() {
                if (!toolsDropdownMenu || toolsDropdownMenu.classList.contains('hidden')) return;

                toolsDropdownMenu.classList.add('animate-dropdown-out');
                toolsDropdownMenu.classList.remove('animate-dropdown');
                toolsDropdownBtn.querySelector('svg:last-of-type').classList.remove('rotate-180');
                
                setTimeout(() => {
                    toolsDropdownMenu.classList.add('hidden');
                    toolsDropdownMenu.classList.remove('animate-dropdown-out');
                }, 200); // Must match animation duration
            }

            if (toolsDropdownBtn) {
                toolsDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (toolsDropdownMenu.classList.contains('hidden')) {
                        // Open
                        toolsDropdownMenu.classList.remove('hidden');
                        toolsDropdownMenu.classList.remove('animate-dropdown-out'); // Clean up old class
                        toolsDropdownMenu.classList.add('animate-dropdown');
                        toolsDropdownBtn.querySelector('svg:last-of-type').classList.add('rotate-180');
                    } else {
                        // Close
                        closeToolsDropdown();
                    }
                });
                
                toolsDropdownMenu.addEventListener('click', closeToolsDropdown);
            }
             // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (toolsDropdownBtn && toolsDropdownMenu && !toolsDropdownBtn.contains(e.target) && !toolsDropdownMenu.contains(e.target)) {
                    closeToolsDropdown();
                }
            });

            document.getElementById('back-btn').addEventListener('click', () => {
                window.history.back();
            });
            document.getElementById('surprise-again-btn').addEventListener('click', handleSurpriseAgainAnimation);
            document.getElementById('back-from-episodes-btn').addEventListener('click', () => window.history.back());
            document.getElementById('back-from-cast-btn').addEventListener('click', () => window.history.back());
            document.getElementById('back-from-person-btn').addEventListener('click', () => window.history.back());

            document.getElementById('roulette-start-btn').addEventListener('click', handleRouletteSpin);
            document.getElementById('show-roulette-btn').addEventListener('click', handleRouletteSpin);
            document.getElementById('close-roulette-btn').addEventListener('click', hideRouletteModal);
            document.getElementById('roulette-modal').addEventListener('click', (e) => {
                if (e.target.id === 'roulette-modal') {
                    hideRouletteModal();
                }
            });

            document.getElementById('trailer-modal').addEventListener('click', (e) => {
                if(e.target.id === 'trailer-modal') {
                    hideTrailerModal();
                }
            });
            document.getElementById('close-trailer-btn').addEventListener('click', hideTrailerModal);
            
            // Season Videos Modal Listeners
            const seasonVideosModal = document.getElementById('season-videos-modal');
            const closeSeasonVideosBtn = document.getElementById('close-season-videos-btn');
            
            if (closeSeasonVideosBtn) {
                closeSeasonVideosBtn.addEventListener('click', () => {
                    seasonVideosModal.classList.add('hidden');
                    seasonVideosModal.classList.remove('flex');
                    document.body.classList.remove('modal-open');
                });
            }
            if (seasonVideosModal) {
                seasonVideosModal.addEventListener('click', (e) => {
                    if (e.target.id === 'season-videos-modal') {
                        seasonVideosModal.classList.add('hidden');
                        seasonVideosModal.classList.remove('flex');
                        document.body.classList.remove('modal-open');
                    }
                });
            }

            document.getElementById('gemini-modal').addEventListener('click', (e) => {
                if(e.target.id === 'gemini-modal') {
                    hideGeminiModal();
                }
            });
            document.getElementById('close-gemini-btn').addEventListener('click', hideGeminiModal);

            document.getElementById('tv-settings-modal').addEventListener('click', (e) => {
                if (e.target.id === 'tv-settings-modal') {
                    hideTvSettingsModal();
                }
            });
            document.getElementById('close-tv-settings-btn').addEventListener('click', hideTvSettingsModal);

            document.getElementById('show-ai-recommender-btn').addEventListener('click', showAIRecommenderModal);
            document.getElementById('close-ai-recommender-btn').addEventListener('click', hideAIRecommenderModal);
            document.getElementById('get-ai-recommendation-btn').addEventListener('click', handleGetAIRecommendation);

            // REMOVED PREFERENCES EVENT LISTENERS

            document.getElementById('export-data-btn').addEventListener('click', exportUserData);
            const importBtn = document.getElementById('import-data-btn');
            const importFileInput = document.getElementById('import-file-input');
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', handleFileImport);

            document.getElementById('settings-about-btn').addEventListener('click', showAboutModal);

            // Cookie Consent Logic
            const cookieBanner = document.getElementById('cookie-consent-banner');
            const cookieBtn = document.getElementById('cookie-consent-btn');
            
            updateCookieBannerText();

            if (localStorage.getItem('findFlixCookieConsent') !== 'true') {
                // Show banner after a short delay
                setTimeout(() => {
                    cookieBanner.classList.remove('hidden');
                    setTimeout(() => {
                        cookieBanner.classList.remove('translate-y-full');
                    }, 50); // small delay for transition to work
                }, 1500); // Wait 1.5 seconds before showing
            }

            cookieBtn.addEventListener('click', () => {
                localStorage.setItem('findFlixCookieConsent', 'true');
                cookieBanner.classList.add('translate-y-full');
                cookieBanner.addEventListener('transitionend', () => {
                    cookieBanner.classList.add('hidden');
                }, { once: true });
            });

            // Easter Egg to unlock all achievements
            const unlockSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight'];
            let sequenceIndex = 0;

            document.addEventListener('keydown', (e) => {
                // Ignore key presses inside input fields to prevent accidental activation
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                if (e.key === unlockSequence[sequenceIndex]) {
                    sequenceIndex++;
                    if (sequenceIndex === unlockSequence.length) {
                        const t = translations[currentLanguage];
                        Object.keys(ACHIEVEMENTS).forEach(id => {
                            userAchievements.unlocked.add(id);
                        });
                        saveAchievementsToStorage();
                        
                        const toastMessages = {
                            'he': 'קוד סודי הופעל! כל ההישגים נפתחו!',
                            'en': 'Secret Code Activated! All achievements unlocked!',
                            'ru': 'Секретный код активирован! Все достижения разблокированы!',
                            'ar': 'تم تفعيل الرمز السري! تم فتح جميع الإنجازات!',
                            'de': 'Geheimcode aktiviert! Alle Erfolge freigeschaltet!',
                            'es': '¡Código secreto activado! ¡Todos los logros desbloqueados!',
                            'it': 'Codice segreto attivato! Tutti gli obiettivi sbloccati!',
                            'fr': 'Code secret activé ! Tous les succès déverrouillés !',
                            'pt': 'Código Secreto Ativado! Todas as conquistas desbloqueadas!',
                        };
                        showToast(toastMessages[currentLanguage] || toastMessages['en'], 'success');
                        
                        // If on achievements page, re-render to show the unlocked status
                        if (window.location.hash === '#achievements') {
                            renderAchievements();
                        }
                        
                        // Since new themes might be unlocked, re-initialize the theme selector
                        initTheme();

                        sequenceIndex = 0; // Reset for fun
                    }
                } else {
                    sequenceIndex = 0;
                }
            });

            // Back to Top button logic
            if (backToTopBtn) {
                window.addEventListener('scroll', () => {
                    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                        backToTopBtn.classList.add('show');
                    } else {
                        backToTopBtn.classList.remove('show');
                    }
                });

                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Initialize Flixy
            initFlixy();

            // NEW: Intersection Observer for scroll animations
            const scrollObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target); // Animate only once
                    }
                });
            }, {
                rootMargin: '0px 0px -50px 0px' // Trigger a bit before it's fully in view
            });

            // Function to apply observer to new elements
            window.observeElements = () => {
                const elements = document.querySelectorAll('.scroll-animate:not(.visible)');
                elements.forEach(el => {
                    scrollObserver.observe(el);
                });
            };
            
            // Initial observation
            observeElements();

            // NEW: Shorts player custom controls listener
            const shortsFeedContainer = document.getElementById('shorts-feed-container');
            let isDraggingProgress = false; // NEW: State for dragging
            let dragTarget = { player: null, shortItem: null, progressBar: null, duration: 0 }; // NEW

            if (shortsFeedContainer) {

                // --- NEW: Helper function for seeking ---
                function seekOnDrag(e) {
                    if (!isDraggingProgress || !dragTarget.player) return;

                    let { player, shortItem, progressBar, duration } = dragTarget; // Use let
                    
                    // NEW DURATION CHECK
                    if (!duration || duration <= 0) {
                        duration = player.getDuration();
                        if (!duration || duration <= 0) return; // Exit if duration is still not valid
                        dragTarget.duration = duration; // Update it in the target
                    }
                    
                    const rect = progressBar.getBoundingClientRect();
                    let clickX;
                    
                    // MODIFIED: Handle both mouse and touch
                    if (e.clientX !== undefined) {
                        clickX = e.clientX;
                    } else if (e.touches && e.touches.length > 0) {
                        clickX = e.touches[0].clientX;
                    } else if (e.changedTouches && e.changedTouches.length > 0) {
                        // For touchend
                        clickX = e.changedTouches[0].clientX;
                    } else {
                        return;
                    }

                    let clickPercent;
                    if (translations[currentLanguage].langDir === 'rtl') {
                        // In RTL, 0% is on the right edge (rect.right)
                        clickPercent = (rect.right - clickX) / rect.width;
                    } else {
                        // In LTR, 0% is on the left edge (rect.left)
                        clickPercent = (clickX - rect.left) / rect.width;
                    }

                    clickPercent = Math.max(0, Math.min(1, clickPercent)); 
                    const newTime = duration * clickPercent;
                    
                    // Seek but don't play yet (true allows seek ahead)
                    player.seekTo(newTime, true); 
                    
                    // Manually update UI
                    const progressFill = shortItem.querySelector('.short-progress-fill');
                    const currentTimeEl = shortItem.querySelector('.short-current-time');
                    if (progressFill) progressFill.style.width = (clickPercent * 100) + '%';
                    if (currentTimeEl) currentTimeEl.textContent = formatTime(newTime);
                }

                // --- NEW: Helper function to START dragging ---
                function startDrag(e) {
                    const progressBar = e.target.closest('.short-progress-container');
                    if (!progressBar) return;
                    
                    e.preventDefault(); // Prevent text selection or page scroll
                    isDraggingProgress = true;
                    
                    const shortItem = progressBar.closest('.short-item');
                    if (!shortItem) { isDraggingProgress = false; return; }
                    
                    const iframe = shortItem.querySelector('iframe');
                    if (!iframe || !shortsPlayers.has(iframe.id)) { isDraggingProgress = false; return; } // Good.
                    
                    const player = shortsPlayers.get(iframe.id);
                    const duration = player.getDuration() || 0; // Get duration, default to 0
                    
                    // NEW: Capture original playing state
                    const wasPlaying = shortItem.dataset.isPlaying === 'true';
                    
                    dragTarget = { player, shortItem, progressBar, duration, wasPlaying }; // Store it
                    
                    // Pause video while seeking
                    if (wasPlaying) { // MODIFIED: Use captured state
                        player.pauseVideo();
                    }
                    
                    // Immediately seek to click position
                    seekOnDrag(e);
                }

                // --- NEW: Helper function to END dragging ---
                function endDrag(e) {
                    if (!isDraggingProgress) return;
                    
                    // We might need to do one last seek on touchend/mouseup
                    seekOnDrag(e); 
                    
                    isDraggingProgress = false;
                    document.body.dataset.wasDragging = 'true'; // NEW: Set a flag on the body
                    
                    const { player, shortItem, duration, wasPlaying } = dragTarget; // MODIFIED: Get wasPlaying
                    
                    // Resume video if it was playing
                    if (player && shortItem && wasPlaying && duration > 0) { // MODIFIED: Check wasPlaying
                        player.playVideo();
                    }
                    
                    dragTarget = { player: null, shortItem: null, progressBar: null, duration: 0, wasPlaying: false }; // MODIFIED: Clear wasPlaying

                    // NEW: Clear the flag after the click event has had time to fire
                    setTimeout(() => {
                        document.body.dataset.wasDragging = 'false';
                    }, 100);
                }

                // --- NEW: Add Mousedown/Touchstart listener for seeking ---
                shortsFeedContainer.addEventListener('mousedown', startDrag);
                shortsFeedContainer.addEventListener('touchstart', startDrag, { passive: false }); // Need passive: false to preventDefault

                // --- NEW: Add Mousemove/Touchmove listener for dragging ---
                document.addEventListener('mousemove', (e) => {
                    if (!isDraggingProgress) return;
                    e.preventDefault();
                    seekOnDrag(e);
                });
                document.addEventListener('touchmove', (e) => {
                    if (!isDraggingProgress) return;
                    e.preventDefault(); // Prevent page scroll while dragging
                    seekOnDrag(e);
                }, { passive: false }); // Need passive: false to preventDefault

                // --- NEW: Add Mouseup/Touchend listener to stop dragging ---
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('touchend', endDrag);

                // --- MODIFIED: Click listener now ONLY handles mute/playpause ---
                shortsFeedContainer.addEventListener('click', (e) => {
                    // MODIFIED: Changed check to use the new wasDragging flag
                    if (isDraggingProgress || document.body.dataset.wasDragging === 'true') {
                        return;
                    }
                    
                    // Check for progress bar click (which is now handled by mousedown/up)
                    if (e.target.closest('.short-progress-container')) {
                        return; // This click is handled by the drag/seek logic
                    }

                    const button = e.target.closest('.short-mute-btn, .short-tap-overlay');
                    if (!button) {
                        return;
                    }

                    const shortItem = button.closest('.short-item');
                    if (!shortItem) return;

                    const iframe = shortItem.querySelector('iframe');
                    if (!iframe || !iframe.contentWindow) return;

                    // NEW: Get the YT.Player object
                    if (!shortsPlayers.has(iframe.id)) {
                        console.warn('Player not ready for iframe:', iframe.id);
                        return;
                    }
                    const player = shortsPlayers.get(iframe.id);

                    const action = button.dataset.action;
                    const iconEl = shortItem.querySelector('.short-play-pause-icon');

                    if (action === 'muteunmute') {
                        e.stopPropagation(); // Prevent tap-to-play from firing
                        const isMuted = player.isMuted(); // Check actual player state
                        if (isMuted) {
                            player.unMute();
                            shortItem.dataset.isMuted = 'false';
                            button.innerHTML = shortsUnmuteIcon;
                            isShortsFeedMuted = false; // <-- NEW: Update global state
                        } else {
                            player.mute();
                            shortItem.dataset.isMuted = 'true';
                            button.innerHTML = shortsMuteIcon;
                            isShortsFeedMuted = true; // <-- NEW: Update global state
                        }
                    } else if (action === 'playpause') {
                        const state = player.getPlayerState();
                        const isPlaying = (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING);

                        if (isPlaying) {
                            player.pauseVideo();
                            shortItem.dataset.isPlaying = 'false';
                            if(iconEl) {
                                iconEl.innerHTML = shortsPlayIcon;
                                iconEl.classList.remove('fade-out-icon'); // נקה אנימציה ישנה
                                iconEl.classList.add('show-icon'); // הצג אייקון
                                // NEW: Add fade out
                                setTimeout(() => iconEl.classList.add('fade-out-icon'), 150); // הוסף אנימציית יציאה
                                setTimeout(() => {
                                    iconEl.classList.remove('show-icon');
                                    iconEl.classList.remove('fade-out-icon');
                                }, 450); // 150ms + 300ms transition
                            }
                        } else {
                            player.playVideo();
                            shortItem.dataset.isPlaying = 'true';
                            if(iconEl) {
                                iconEl.innerHTML = shortsPauseIcon;
                                // Show and fade icon on play
                                iconEl.classList.remove('fade-out-icon'); // נקה אנימציה ישנה
                                iconEl.classList.add('show-icon');
                                setTimeout(() => iconEl.classList.add('fade-out-icon'), 150);
                                setTimeout(() => {
                                    iconEl.classList.remove('show-icon');
                                    iconEl.classList.remove('fade-out-icon');
                                }, 450); // 150ms + 300ms transition
                            }
                        }
                    } /* REMOVED: else if (action === 'settings') */
                    /* REMOVED: else if (action === 'set-quality') */
                    /* REMOVED: else if (action === 'set-speed') */
                });
            }

            // NEW: Shorts Prev/Next button listeners
        const shortsPrevBtn = document.getElementById('shorts-prev-btn');
        const shortsNextBtn = document.getElementById('shorts-next-btn');

        if (shortsFeedContainer && shortsPrevBtn && shortsNextBtn) {
                const scrollToShort = (direction) => {
                    const items = Array.from(shortsFeedContainer.querySelectorAll('.short-item'));
                    if (items.length === 0) return;

                    const currentScroll = shortsFeedContainer.scrollTop;
                    const itemHeight = items[0].clientHeight;
                    
                    // Find the index of the currently viewed item
                    // Add a small offset (10px) to prevent floating point issues
                    const currentIndex = Math.round((currentScroll + 10) / itemHeight);
                    
                    let targetIndex;
                    if (direction === 'next') {
                        targetIndex = Math.min(currentIndex + 1, items.length - 1);

                        // NEW: Check if we are at the end and need to load more
                        if (targetIndex === currentIndex && currentIndex === items.length - 1) {
                            if (!isLoading && contentCache.shorts.canLoadMore) {
                                const nextPage = contentCache.shorts.page + 1;
                                fetchShortsContent(nextPage);
                            }
                        }

                    } else { // prev
                        targetIndex = Math.max(currentIndex - 1, 0);
                    }

                    if (targetIndex !== currentIndex) {
                        shortsFeedContainer.scrollTo({
                            top: targetIndex * itemHeight,
                            behavior: 'smooth'
                        });
                    }
                };

                shortsNextBtn.addEventListener('click', () => scrollToShort('next'));
                shortsPrevBtn.addEventListener('click', () => scrollToShort('prev'));
            }
            // END NEW
        });

        // NEW: Cast API Initialization
        // Attached to window so the global callback in <head> can access it
        window.initializeCastApi = function() {
          // FIX: Check if cast is available to prevent ReferenceError
          if (!window.cast || !window.cast.framework) return;

          const castContext = window.cast.framework.CastContext.getInstance();
          castContext.setOptions({
            receiverApplicationId: window.chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
            autoJoinPolicy: window.chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
          });
        
          castContext.addEventListener(
            window.cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
            (event) => {
                const castButton = document.querySelector('google-cast-launcher');
                switch (event.sessionState) {
                    case window.cast.framework.SessionState.SESSION_STARTED:
                    case window.cast.framework.SessionState.SESSION_RESUMED:
                        if(castButton) castButton.classList.add('casting');
                        if (currentPlayingChannel) {
                            playChannel(currentPlayingChannel); // Re-run to trigger cast logic
                        }
                        break;
                    case window.cast.framework.SessionState.SESSION_ENDED:
                        if(castButton) castButton.classList.remove('casting');
                        if (currentPlayingChannel) {
                            playChannel(currentPlayingChannel); // Re-run to trigger local play logic
                        }
                        break;
                    default:
                        if(castButton) castButton.classList.remove('casting');
                        break;
                }
            }
          );
        
          // Reflect casting state on load
          const castState = castContext.getCastState();
          const castButton = document.querySelector('google-cast-launcher');
          if (castButton) {
              if (castState === window.cast.framework.CastState.CONNECTED) {
                  castButton.classList.add('casting');
              } else {
                  castButton.classList.remove('casting');
              }
          }
        };

        // Check if API became available before this script loaded
        if (window.castApiAvailable) {
            window.initializeCastApi();
        }
        
        /* REMOVED OLD LOGIC that caused race conditions
        window['__onGCastApiAvailable'] = function(isAvailable) {
          if (isAvailable) {
            initializeCastApi();
          }
        };
        */

        // NEW: Custom TV Player Controls Logic
        document.addEventListener('DOMContentLoaded', () => {
            const customVideoContainer = document.querySelector('#tv-view .group.relative.aspect-video');
            if (customVideoContainer) {
                const videoPlayer = document.getElementById('tv-player');
                const volumeBtn = document.getElementById('volume-btn');
                const volumeSlider = document.getElementById('volume-slider');
                const pipBtn = document.getElementById('pip-btn');
                const fullscreenBtn = document.getElementById('fullscreen-btn');
                const recordVideoBtn = document.getElementById('record-video-btn'); // NEW

                const volumeIcons = {
                    high: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`,
                    low: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>`,
                    muted: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l-5-5m0 5l5-5" /></svg>`
                };

                // "Cannot be stopped" logic
                videoPlayer.addEventListener('pause', () => {
                    setTimeout(() => {
                        if (videoPlayer.paused) {
                            videoPlayer.play().catch(e => {}); // Silently try to play
                        }
                    }, 100);
                });
                videoPlayer.addEventListener('ended', () => {
                     // Try to reload the source or replay
                     const currentSrc = videoPlayer.src;
                     if(currentSrc){
                         videoPlayer.load();
                         videoPlayer.play().catch(e => {});
                     }
                });

                // Volume logic
                function updateVolumeIcon() {
                    const volume = videoPlayer.volume;
                    const muted = videoPlayer.muted;
                    if (muted || volume === 0) {
                        volumeBtn.innerHTML = volumeIcons.muted;
                    } else if (volume < 0.5) {
                        volumeBtn.innerHTML = volumeIcons.low;
                    } else {
                        volumeBtn.innerHTML = volumeIcons.high;
                    }
                }

                volumeBtn.addEventListener('click', () => {
                    videoPlayer.muted = !videoPlayer.muted;
                });
                volumeSlider.addEventListener('input', e => {
                    videoPlayer.volume = parseFloat(e.target.value);
                    videoPlayer.muted = e.target.value === '0';
                });
                videoPlayer.addEventListener('volumechange', () => {
                    volumeSlider.value = videoPlayer.muted ? 0 : videoPlayer.volume;
                    updateVolumeIcon();
                });

                // PiP logic
                pipBtn.addEventListener('click', () => {
                    if (!document.pictureInPictureEnabled) {
                        alert("Picture-in-Picture is not supported by your browser.");
                        return;
                    }
                    if (document.pictureInPictureElement) {
                        document.exitPictureInPicture().catch(e => console.error("PiP Error:", e));
                    } else {
                        videoPlayer.requestPictureInPicture().catch(e => console.error("PiP Error:", e));
                    }
                });

                // NEW: Capture Frame logic
                const captureFrameBtn = document.getElementById('capture-frame-btn');
                if (captureFrameBtn) {
                    captureFrameBtn.addEventListener('click', async () => { // Make async
                        const videoPlayer = document.getElementById('tv-player');
                        const canvas = document.getElementById('frame-capture-canvas');
                        const t = translations[currentLanguage];

                        if (!videoPlayer || !canvas || videoPlayer.readyState < 3 || videoPlayer.videoWidth === 0) {
                            showToast(t.screenshotFailedGeneric, 'danger');
                            return;
                        }

                        const ctx = canvas.getContext('2d');
                        
                        try {
                            // 1. Draw the video frame
                            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                            
                            // 2. Add watermark
                            await logoLoadPromise; // Make sure logo is loaded
                            const logoSize = canvas.height * 0.12; // Watermark 12% of canvas height
                            const margin = canvas.width * 0.02;
                            ctx.globalAlpha = 0.7;
                            
                            // Draw logo
                            ctx.drawImage(logoImg, margin, canvas.height - logoSize - margin, logoSize, logoSize);
                            
                            // Prepare text
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                            ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
                            ctx.shadowBlur = 3;
                            ctx.shadowOffsetX = 1;
                            ctx.shadowOffsetY = 1;
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'bottom'; // Align text to the bottom edge

                            const textSiteName = 'Find-Flix';
                            const textUrl = 'findflixtv.edgeone.app';
                            const textX = margin + logoSize + (margin / 2);
                            const textYBottom = canvas.height - margin; // Align with bottom of canvas margin
                            
                            // Draw URL (smaller)
                            const fontSizeSmall = canvas.height * 0.025;
                            ctx.font = `normal ${fontSizeSmall}px Assistant`;
                            ctx.fillText(textUrl, textX, textYBottom);
                            
                            // Draw Site Name (larger, above URL)
                            const fontSizeLarge = canvas.height * 0.035;
                            ctx.font = `bold ${fontSizeLarge}px Assistant`;
                            ctx.textBaseline = 'bottom';
                            ctx.fillText(textSiteName, textX, textYBottom - fontSizeSmall - (margin / 4));

                            // Reset shadows and alpha
                            ctx.globalAlpha = 1.0;
                            ctx.shadowColor = 'transparent';
                            ctx.shadowBlur = 0;
                            ctx.shadowOffsetX = 0;
                            ctx.shadowOffsetY = 0;

                            // 3. Get data URL (this might fail)
                            const imageDataUrl = canvas.toDataURL('image/png');
                            
                            // 4. Create a link to download the image
                            const link = document.createElement('a');
                            link.href = imageDataUrl;
                            
                            let channelName = 'live_capture';
                            if (currentPlayingChannel && currentPlayingChannel.name) {
                                channelName = currentPlayingChannel.name.replace(/[^a-z0-9א-ת]/gi, '_').toLowerCase();
                            }
                            const timestamp = new Date().toISOString().replace(/[:.-]/g, '');
                            
                            link.download = `findflix_${channelName}_${timestamp}.png`;
                            
                            // Trigger download
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
            
                            showToast('התמונה נשמרה!', 'success');
                        } catch (error) {
                            console.error('Screenshot failed:', error);
                            // Check if it's the expected CORS error
                            if (error.name === 'SecurityError') {
                                showToast(t.screenshotFailedSecurity, 'danger');
                            } else {
                                showToast(t.screenshotFailedGeneric, 'danger');
                            }
                        }
                    });
                }

                // NEW: Record Video logic
                if (recordVideoBtn) {
                    recordVideoBtn.addEventListener('click', () => {
                        if (mediaRecorder && mediaRecorder.state === "recording") {
                            stopVideoRecording();
                        } else {
                            startVideoRecording();
                        }
                    });
                }

                // Fullscreen logic
                fullscreenBtn.addEventListener('click', () => {
                    if (!document.fullscreenElement) {
                        customVideoContainer.requestFullscreen().catch(err => alert(`Error entering fullscreen: ${err.message}`));
                    } else {
                        document.exitFullscreen();
                    }
                });

                // NEW: Screenshot logic
                /* This block is now removed as its logic was merged into capture-frame-btn
                const screenshotBtn = document.getElementById('screenshot-btn');
                if (screenshotBtn) {
                    screenshotBtn.addEventListener('click', () => {
                        const videoPlayer = document.getElementById('tv-player');
                        const canvas = document.getElementById('frame-capture-canvas');
                        const t = translations[currentLanguage];
                        
                        if (!videoPlayer || !canvas) return;

                        const ctx = canvas.getContext('2d');
                        
                        try {
                            // 1. Attempt to draw the video frame to the canvas
                            ctx.drawImage(videoPlayer, 0, 0, canvas.width, canvas.height);
                            
                            // 2. Attempt to get the data URL. This is what will fail.
                            const imageDataUrl = canvas.toDataURL('image/png');
                            
                            // 3. If it somehow succeeds, create a download link
                            const a = document.createElement('a');
                            a.href = imageDataUrl;
                            a.download = `findflix-screenshot-${Date.now()}.png`;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);

                        } catch (error) {
                            // 4. Catch the inevitable security error
                            console.error('Screenshot failed:', error);
                            // Check if it's the expected CORS error
                            if (error.name === 'SecurityError') {
                                showToast(t.screenshotFailedSecurity, 'danger');
                            } else {
                                showToast(t.screenshotFailedGeneric, 'danger');
                            }
                        }
                    });
                }
                */

                const aiInfoContainer = document.getElementById('tv-ai-info-container');
                const aiInfoOriginalParent = aiInfoContainer.parentElement;
                const aiInfoOriginalNextSibling = aiInfoContainer.nextElementSibling;

                document.addEventListener('fullscreenchange', () => {
                    const isOpen = document.getElementById('fullscreen-open-icon');
                    const isClose = document.getElementById('fullscreen-close-icon');
                    
                    if (document.fullscreenElement === customVideoContainer) {
                        isOpen.classList.add('hidden');
                        isClose.classList.remove('hidden');
                        if (aiInfoContainer) {
                            customVideoContainer.appendChild(aiInfoContainer); // Move it inside
                            aiInfoContainer.classList.add('fullscreen-overlay');
                        }
                    } else {
                        isOpen.classList.remove('hidden');
                        isClose.classList.add('hidden');
                        if (aiInfoContainer) {
                            // Move it back to its original position
                            aiInfoOriginalParent.insertBefore(aiInfoContainer, aiInfoOriginalNextSibling);
                            aiInfoContainer.classList.remove('fullscreen-overlay');
                        }
                    }
                });

                // AI Summary Toggle Logic
                const toggleAiSummaryBtn = document.getElementById('toggle-ai-summary-btn');
                if (toggleAiSummaryBtn) {
                    const aiSummaryVisibleIcon = document.getElementById('ai-summary-visible-icon');
                    const aiSummaryHiddenIcon = document.getElementById('ai-summary-hidden-icon');

                    const updateToggleButtonState = () => {
                        const isVisible = localStorage.getItem('findFlixAiSummaryVisible') !== 'false';
                        aiSummaryVisibleIcon.classList.toggle('hidden', !isVisible);
                        aiSummaryHiddenIcon.classList.toggle('hidden', isVisible);
                    };

                    toggleAiSummaryBtn.addEventListener('click', () => {
                        let isVisible = localStorage.getItem('findFlixAiSummaryVisible') !== 'false';
                        isVisible = !isVisible; // Toggle the state
                        localStorage.setItem('findFlixAiSummaryVisible', isVisible);
                        updateToggleButtonState();
                        
                        if (!isVisible) {
                            aiInfoContainer.classList.add('hidden');
                        } else {
                            // Only un-hide if there's already content to show. Otherwise, let the interval handle it.
                            if (aiInfoContainer.dataset.hasContent === 'true') {
                                 aiInfoContainer.classList.remove('hidden');
                            }
                        }
                    });

                    updateToggleButtonState(); // Initial state
                }

                // NEW: Tap/Click to show controls
                customVideoContainer.addEventListener('click', () => {
                    // This listener shows the controls. If a button was clicked, its own listener will handle its action.
                    // And this listener will ensure the controls stay visible for a bit longer.
                    clearTimeout(controlsTimeout);
                    customVideoContainer.classList.add('controls-visible');
                    controlsTimeout = setTimeout(() => {
                        customVideoContainer.classList.remove('controls-visible');
                    }, 3500); // Hide after 3.5 seconds of inactivity
                });

                // Initial state
                updateVolumeIcon();
            }
        });

        // Routing
        async function handleRouting() {
            const hash = window.location.hash;
            updateActiveSidebarLink(hash);
            const detailMatch = hash.match(/#details-(movie|tv)-(\d+)/);
            const episodesMatch = hash.match(/#episodes-(\d+)-(\d+)/);
            const castMatch = hash.match(/#cast-(movie|tv)-(\d+)/);
            const searchMatch = hash.match(/#search=(.*)/);
            const personMatch = hash.match(/#person-(\d+)/);

            if (hash !== '#tv') {
                stopTvPlayer();
            }

            let isListView = false;
            let listViewKey = '';

            if (detailMatch) {
                await showDetailsView(detailMatch[2], detailMatch[1]);
            } else if (episodesMatch) {
                const seriesId = episodesMatch[1];
                const seasonNumber = episodesMatch[2];
                // We need the series name. A bit tricky without storing state.
                // For now, let's fetch it again. This could be optimized.
                const details = await fetchDetails(seriesId, 'tv');
                if (details) {
                    await showEpisodesView(seriesId, seasonNumber, details.name);
                }
            } else if (castMatch) {
                scrollPositions['cast'] = window.scrollY;
                await showCastView(castMatch[2], castMatch[1]);
            } else if (personMatch) {
                await showPersonView(personMatch[1]);
            } else if (searchMatch) {
                const query = decodeURIComponent(searchMatch[1]);
                await showAndPerformSearch(query);
                isListView = true;
                listViewKey = 'search';
            } else if (hash === '#ai-results') {
                showAIResultsView();
                isListView = true;
                listViewKey = 'ai-results';
            } else if (hash === '#home' || hash === '') {
                if (currentView && currentView !== 'home') {
                    selectedGenreId = null;
                    const viewCache = contentCache.home;
                    viewCache.items = [];
                    viewCache.page = 1;
                    viewCache.allIds.clear();
                    viewCache.canLoadMore = true;
                }
                await showHomeView();
                isListView = true;
                listViewKey = 'home';
            } else if (hash === '#movies') {
                 if (currentView && currentView !== 'movies') {
                    selectedGenreId = null;
                    const viewCache = contentCache.movies;
                    viewCache.items = [];
                    viewCache.page = 1;
                    viewCache.allIds.clear();
                    viewCache.canLoadMore = true;
                }
                await showMoviesView();
                isListView = true;
                listViewKey = 'movies';
            } else if (hash === '#series') {
                if (currentView && currentView !== 'series') {
                    selectedGenreId = null;
                    const viewCache = contentCache.series;
                    viewCache.items = [];
                    viewCache.page = 1;
                    viewCache.allIds.clear();
                    viewCache.canLoadMore = true;
                }
                await showSeriesView();
                isListView = true;
                listViewKey = 'series';
            } else if (hash === '#cinemas') {
                currentView = 'cinemas';
                await showCinemasView();
                isListView = true;
                listViewKey = 'cinemas';
            } else if (hash === '#new-releases') {
                currentView = 'newReleases';
                await showNewReleasesView();
                isListView = true;
                listViewKey = 'newReleases';
            } else if (hash === '#library') {
                currentView = 'library';
                showLibraryView();
                isListView = true;
                listViewKey = 'library';
            } else if (hash === '#watched') {
                currentView = 'watched';
                showWatchedView();
                isListView = true;
                listViewKey = 'watched';
            } else if (hash === '#settings') {
                currentView = 'settings';
                showSettingsView();
            } else if (hash === '#achievements') {
                currentView = 'achievements';
                showAchievementsView();
                isListView = true;
                listViewKey = 'achievements';
            } else if (hash === '#plugins') {
                currentView = 'plugins';
                showPluginsView();
                isListView = true;
                listViewKey = 'plugins';
            } else if (hash === '#shorts') {
                // currentView = 'shorts'; // <--- REMOVED: This is now set inside showShortsView()
                showShortsView();
                isListView = true;
                listViewKey = 'shorts';
            } else if (hash === '#tv') {
                currentView = 'tv';
                showTvView();
            } else {
                await showHomeView();
                isListView = true;
                listViewKey = 'home';
            }
            
            // Centralized Scroll Restoration Logic
            if (isListView) {
                setTimeout(() => {
                    if (scrollPositions.hasOwnProperty(listViewKey)) {
                        window.scrollTo(0, scrollPositions[listViewKey]);
                    }
                }, 0); // Use 0 delay, just to push to end of event queue
            } else {
                // Not a list view (details, episodes, settings, report etc.), scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        function showTrailerModal(videoUrl) {
            // Extract Video ID from URL (Embed or Watch URL)
            let videoId = '';
            if (videoUrl.includes('embed/')) {
                videoId = videoUrl.split('embed/')[1].split('?')[0];
            } else if (videoUrl.includes('v=')) {
                videoId = videoUrl.split('v=')[1].split('&')[0];
            }

            if (!videoId) return;

            document.getElementById('trailer-modal').classList.remove('hidden');
            document.getElementById('trailer-modal').classList.add('flex');
            document.body.classList.add('modal-open');

            if (isYouTubeApiReady) {
                initTrailerPlayer(videoId);
            } else {
                // Fallback if API somehow not ready, wait a bit
                setTimeout(() => initTrailerPlayer(videoId), 1000);
            }
        }

        function hideTrailerModal() {
            // NEW: Exit fullscreen if active when closing the modal
            if (document.fullscreenElement) {
                document.exitFullscreen().catch(err => console.error("Error exiting fullscreen:", err));
            }
            
            // Close settings menu
            closeSettingsMenu();

            if (trailerPlayer) {
                trailerPlayer.stopVideo();
                // Optionally clear the player to save resources, or just pause/stop
                // trailerPlayer.destroy(); 
                // trailerPlayer = null; 
            }
            stopTrailerInterval();
            document.getElementById('trailer-modal').classList.add('hidden');
            document.getElementById('trailer-modal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        function showTvSettingsModal() {
            const t = translations[currentLanguage];
            const modal = document.getElementById('tv-settings-modal');
            document.getElementById('tv-settings-modal-title').textContent = t.tvSettingsModalTitle;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function hideTvSettingsModal() {
            const modal = document.getElementById('tv-settings-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        function hideGeminiModal() {
            const modal = document.getElementById('gemini-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
            const audioElement = document.getElementById('podcast-audio-element');
            if (audioElement && !audioElement.paused) {
                audioElement.pause();
                audioElement.src = ''; // Release resource
            }
        }

        function showAIRecommenderModal() {
            const t = translations[currentLanguage];
            if (!GEMINI_API_KEY) {
                showToast(t.apiKeyNeeded, 'danger', '#settings');
                return;
            }

            const modal = document.getElementById('ai-recommender-modal');
            document.getElementById('ai-recommender-modal-title').textContent = t.aiRecommenderTitle;
            document.getElementById('ai-recommender-modal-instructions').textContent = t.aiRecommenderInstructions;
            document.getElementById('ai-recommender-input').placeholder = t.aiRecommenderPlaceholder;
            document.getElementById('ai-recommender-submit-text').textContent = t.aiRecommenderSubmit;
            document.getElementById('ai-recommender-disclaimer').textContent = t.aiDisclaimer;
            document.getElementById('ai-recommender-input').value = ''; // Clear input
            document.getElementById('get-ai-recommendation-btn').disabled = false;
            document.getElementById('ai-recommender-spinner').classList.add('hidden');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function hideAIRecommenderModal() {
            const modal = document.getElementById('ai-recommender-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-open');
        }

        async function handleGetAIRecommendation() {
            const t = translations[currentLanguage];
            const submitBtn = document.getElementById('get-ai-recommendation-btn');
            const spinner = document.getElementById('ai-recommender-spinner');
            const btnText = document.getElementById('ai-recommender-submit-text');
            const userInput = document.getElementById('ai-recommender-input').value.trim();

            if (!userInput) return;

            // Show loading state
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            btnText.textContent = t.aiRecommenderSearching;

            try {
                // Step 1: Call Gemini to get multiple recommendations
                const systemPrompt = `You are a movie and TV series recommendation expert. The user will describe what they want to watch. Your task is to suggest 3 to 5 highly relevant movies or TV series. You MUST respond ONLY with a JSON array of objects, where each object contains the original English title and the media type ('movie' or 'tv'). Do not add any other text or explanation. The JSON format should be: [{"title": "The Original English Title", "type": "movie"}, ...]`;
                const userQuery = `Based on this description, recommend 3 to 5 movies or series: "${userInput}"`;

                const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Gemini API call failed with status: ${response.status}`);

                const result = await response.json();
                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text;

                if (!text) throw new Error('No text in Gemini response.');
                
                const recommendations = JSON.parse(text);
                if (!Array.isArray(recommendations) || recommendations.length === 0) {
                    throw new Error('Invalid JSON format from Gemini or no recommendations found.');
                }
                
                // Step 2: Search TMDB for each recommended title concurrently
                const searchPromises = recommendations.map(rec => 
                    fetchAPI('/search/multi', { query: rec.title })
                );
                const searchResults = await Promise.all(searchPromises);

                const finalItems = new Set(); // Use a Set to avoid duplicates
                searchResults.forEach((tmdbData, index) => {
                    if (tmdbData && tmdbData.results) {
                        const originalRec = recommendations[index];
                        // Find the best match, preferring the correct media type
                        let foundItem = tmdbData.results.find(item => 
                            (item.title === originalRec.title || item.name === originalRec.title) && 
                            item.media_type === originalRec.type && 
                            item.poster_path
                        );
                        // Fallback to the first reasonable result
                        if (!foundItem) {
                            foundItem = tmdbData.results.find(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
                        }
                        if (foundItem) {
                            finalItems.add(foundItem);
                        }
                    }
                });

                const uniqueFinalItems = Array.from(finalItems);

                if (uniqueFinalItems.length > 0) {
                    // Step 3: Display the results in the main grid
                    aiResultsCache = uniqueFinalItems;
                    hideAIRecommenderModal();
                    window.location.hash = '#ai-results';
                } else {
                    throw new Error(`Could not find any of the recommended titles on TMDB.`);
                }

                trackProgress('ai_consultant', 1);
                checkAchievements();

            } catch (error) {
                console.error('AI Recommendation Error:', error);
                showToast(t.aiRecommendationFailed, 'danger');
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                spinner.classList.add('hidden');
                btnText.textContent = t.aiRecommenderSubmit;
            }
        }
        
        function showToast(message, type = 'info', link = null) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                danger: 'bg-red-500'
            };
            
            toast.className = `p-4 rounded-lg text-white shadow-lg ${colors[type]} transform transition-all duration-300 ease-in-out translate-y-4 opacity-0`;
            
            if (link) {
                const linkElement = document.createElement('a');
                linkElement.href = link;
                linkElement.textContent = message;
                linkElement.className = 'font-bold cursor-pointer';
                linkElement.onclick = (e) => {
                    e.preventDefault();
                    window.location.hash = link;
                };
                toast.appendChild(linkElement);
            } else {
                toast.textContent = message;
            }

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        function startTypingAnimation() {
            clearTimeout(typingTimeout);
            const placeholders = translations[currentLanguage].searchPlaceholder;
            if (!placeholders || placeholders.length === 0) return;
            let textIndex = 0;
            let charIndex = 0;
            currentText = '';

            function type() {
                if (charIndex < placeholders[textIndex].length) {
                    currentText += placeholders[textIndex].charAt(charIndex);
                    searchInput.placeholder = currentText;
                    charIndex++;
                    typingTimeout = setTimeout(type, 100);
                } else {
                    typingTimeout = setTimeout(erase, 2000);
                }
            }

            function erase() {
                if (charIndex > 0) {
                    currentText = placeholders[textIndex].substring(0, charIndex - 1);
                    searchInput.placeholder = currentText;
                    charIndex--;
                    typingTimeout = setTimeout(erase, 50);
                } else {
                    textIndex = (textIndex + 1) % placeholders.length;
                    typingTimeout = setTimeout(type, 500);
                }
            }
            type();
        }

        // NEW HELPER FUNCTIONS for TV AI
        function stopAndResetAIInterval() {
            if (tvContentInterval) {
                clearInterval(tvContentInterval);
                tvContentInterval = null;
            }
            isAIIdentifying = false;
            const aiInfoContainer = document.getElementById('tv-ai-info-container');
            if (aiInfoContainer) aiInfoContainer.classList.add('hidden');
        }

        function startAIInterval() {
    stopAndResetAIInterval(); // Always reset before starting a new one

    const isAiEnabled = localStorage.getItem('findFlixAiTvEnabled') !== 'false';
    if (!GEMINI_API_KEY || !isAiEnabled) return;

    const t = translations[currentLanguage];
    const aiInfoContainer = document.getElementById('tv-ai-info-container');
    aiInfoContainer.dataset.hasContent = 'false';

    const isAiSummaryVisible = localStorage.getItem('findFlixAiSummaryVisible') !== 'false';
    if (!isAiSummaryVisible) {
        aiInfoContainer.classList.add('hidden');
    } else {
        aiInfoContainer.classList.remove('hidden');
        aiInfoContainer.innerHTML = `
            <div class="flex items-center justify-center gap-3 text-gray-300">
                <div class="loading-spinner"></div>
                <span>${t.identifyingContent}</span>
            </div>
        `;
    }

    let countdown = 5; // Initial 5s delay

    tvContentInterval = setInterval(async () => {
        if (window.location.hash !== '#tv') {
                    stopAndResetAIInterval();
                    return;
                }
                if (isAIIdentifying) return;
                
                countdown--;

                const timerContainer = document.getElementById('ai-timer-container');
                if (timerContainer) {
                     timerContainer.innerHTML = `
                        <div class="flex items-center" title="Next update in ${countdown}s">
                            <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            <span>${countdown}s</span>
                        </div>
                    `;
                }

                if (countdown <= 0) {
                    isAIIdentifying = true;
                    
                    if (timerContainer) {
                        timerContainer.innerHTML = `
                            <div class="flex items-center gap-2 text-gray-400">
                                <div class="loading-spinner h-4 w-4"></div>
                                <span>${t.identifyingContent}</span>
                            </div>`;
                    }
                    
                    await identifyTvContent();
                    
                    const customTimer = parseInt(localStorage.getItem('findFlixAiTvTimer') || '25', 10);
                    countdown = customTimer; 
                    isAIIdentifying = false;

                    // Immediately update timer display after scan
                    const newTimerContainer = document.getElementById('ai-timer-container');
                    if(newTimerContainer){
                         newTimerContainer.innerHTML = `
                            <div class="flex items-center" title="Next update in ${countdown}s">
                                <svg xmlns="http://www.w3.org/2000/svg" class="inline h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" />
                                </svg>
                                <span>${countdown}s</span>
                            </div>
                        `;
                    }
                }
            }, 1000);
        }

        async function getGeminiSummary(title, mediaType) {
            const t = translations[currentLanguage];
            const modal = document.getElementById('gemini-modal');
            const modalTitle = document.getElementById('gemini-modal-title');
            const loadingDiv = document.getElementById('gemini-loading');
            const responseDiv = document.getElementById('gemini-response');

            // Check for API Key before proceeding
            if (!GEMINI_API_KEY) {
                showToast(t.apiKeyNeeded, 'danger', '#settings');
                return;
            }
            
            trackProgress('ai_consultant', 1);
            checkAchievements();

            // Show modal and loading state
            modalTitle.textContent = t.aiSummaryTitle.replace('{title}', title);
            document.getElementById('gemini-loading-text').textContent = t.aiLoading;
            document.getElementById('gemini-disclaimer').textContent = t.aiDisclaimer;
            loadingDiv.classList.remove('hidden');
            responseDiv.classList.add('hidden');
            responseDiv.innerHTML = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');

            // Construct the prompt
            const mediaTypeString = mediaType === 'tv' ? 'series' : 'movie';
            const systemPrompt = `You are a movie and TV series expert. Your goal is to provide a short, insightful, and completely spoiler-free analysis. Respond in the language requested by the user.`;
            
            let targetLanguage = 'English';
            switch (currentLanguage) {
                case 'he': targetLanguage = 'Hebrew'; break;
                case 'ru': targetLanguage = 'Russian'; break;
                case 'ar': targetLanguage = 'Arabic'; break;
                case 'de': targetLanguage = 'German'; break;
                case 'es': targetLanguage = 'Spanish'; break;
                case 'it': targetLanguage = 'Italian'; break;
                case 'fr': targetLanguage = 'French'; break;
                case 'pt': targetLanguage = 'Portuguese'; break;
            }

            const userQuery = `Provide a short, insightful, and spoiler-free analysis of the ${mediaTypeString} "${title}". Focus on its themes, tone, what makes it unique, and what kind of audience would enjoy it. The response must be in ${targetLanguage}.`;

            const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                let text = candidate?.content?.parts?.[0]?.text;

                if (text) {
                    // Basic markdown to HTML conversion
                    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');     // Italic
                    text = text.replace(/\n/g, '<br>');                   // Newlines
                    responseDiv.innerHTML = `<p>${text}</p>`;
                } else {
                    throw new Error('No text found in API response.');
                }
            } catch (error) {
                console.error('AI Summary Error:', error);
                responseDiv.innerHTML = `<p class="text-red-400">${t.aiError}</p>`;
            } finally {
                loadingDiv.classList.add('hidden');
                responseDiv.classList.remove('hidden');
            }
        }

        async function getPodcastScript(title, mediaType, year, description) {
            const thisRequestId = ++currentPodcastRequestId; // Create a unique ID for this request

            const t = translations[currentLanguage];
            const modal = document.getElementById('gemini-modal');
            const modalTitle = document.getElementById('gemini-modal-title');
            const loadingDiv = document.getElementById('gemini-loading');
            const responseDiv = document.getElementById('gemini-response');
            const audioPlayerDiv = document.getElementById('gemini-audio-player');

            if (!GEMINI_API_KEY) {
                showToast(t.apiKeyNeeded, 'danger', '#settings');
                return;
            }

            trackProgress('ai_consultant', 1);
            checkAchievements();

            modalTitle.textContent = t.podcastTitle.replace('{title}', title);
            document.getElementById('gemini-loading-text').textContent = t.podcastLoading;
            document.getElementById('gemini-disclaimer').textContent = t.aiDisclaimer;
            
            loadingDiv.classList.remove('hidden');
            responseDiv.classList.add('hidden');
            audioPlayerDiv.classList.add('hidden'); // Hide audio player initially

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-open');

            const mediaTypeString = mediaType === 'tv' ? 'series' : 'movie';
            const systemPrompt = `You are a podcast script writer. Your task is to generate a short, engaging, and spoiler-free podcast segment about a movie or TV series. The segment should be around 300-350 words. Respond only with the script text. Do not include any stage directions, sound effect cues, or music cues (e.g., text in brackets like [intro music]). Do not add any introductory or concluding phrases like "Here's the script:".`;
            
            let targetLanguage = 'English';
            switch (currentLanguage) {
                case 'he': targetLanguage = 'Hebrew'; break;
                case 'ru': targetLanguage = 'Russian'; break;
                case 'ar': targetLanguage = 'Arabic'; break;
                case 'de': targetLanguage = 'German'; break;
                case 'es': targetLanguage = 'Spanish'; break;
                case 'it': targetLanguage = 'Italian'; break;
                case 'fr': targetLanguage = 'French'; break;
                case 'pt': targetLanguage = 'Portuguese'; break;
            }
            const now = new Date();
            const dateTimeString = now.toLocaleString(currentLanguage, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const userQuery = `The current date is ${dateTimeString}. Write a short podcast segment about the ${mediaTypeString} "${title}". Here is some information to help identify it correctly: Release Year: ${year}, Description: "${description}". The entire response must be in ${targetLanguage}.`;

            const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API call failed: ${response.status}`);

                const result = await response.json();
                const scriptText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!scriptText) throw new Error('No script text in response.');

                // Now call the TTS function
                await generateAndPlayAudio(scriptText, title, thisRequestId); // Pass the request ID

            } catch (error) {
                console.error('Podcast Script Error:', error);
                responseDiv.innerHTML = `<p class="text-red-400">${t.aiError}</p>`;
                responseDiv.classList.remove('hidden');
                loadingDiv.classList.add('hidden');
            }
        }

        async function generateAndPlayAudio(scriptText, mediaTitle, requestId) { // Receive request ID
            const t = translations[currentLanguage];
            const loadingDiv = document.getElementById('gemini-loading');
            const audioPlayerDiv = document.getElementById('gemini-audio-player');
            const audioElement = document.getElementById('podcast-audio-element');
            const playPauseBtn = document.getElementById('podcast-play-pause-btn');
            const seeker = document.getElementById('podcast-seeker');
            const currentTimeEl = document.getElementById('podcast-current-time');
            const durationEl = document.getElementById('podcast-duration');
            const downloadBtn = document.getElementById('podcast-download-btn');
            
            const playIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
            const pauseIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    contents: [{
                        parts: [{
                            // NEW: Clean the script text to remove non-dialogue parts like [intro music] before sending to TTS.
                            text: `Say in an engaging and upbeat podcast host voice: ${scriptText.replace(/\[.*?\]/g, '')}`
                        }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: "Puck" // Using an upbeat voice for a podcast style
                                }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };

                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);

                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                if (!audioData || !mimeType.startsWith("audio/")) throw new Error("Invalid audio data received.");

                if (requestId !== currentPodcastRequestId) { // Check if this is still the latest request
                    console.log('Stale podcast request ignored.');
                    return; // Abort if a newer request has been made
                }

                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;

                const pcmBuffer = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmBuffer);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);

                audioElement.src = audioUrl;
                
                // Setup download button
                downloadBtn.href = audioUrl;
                const safeFilename = mediaTitle.replace(/[^a-z0-9א-ת]/gi, '_').toLowerCase();
                downloadBtn.download = `findflix_podcast_${safeFilename}.mp3`;
                downloadBtn.title = t.downloadPodcast;
                
                const formatTime = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
                };
                
                audioElement.onloadedmetadata = () => {
                    loadingDiv.classList.add('hidden');
                    audioPlayerDiv.classList.remove('hidden');
                    playPauseBtn.innerHTML = pauseIcon;
                    seeker.max = audioElement.duration;
                    durationEl.textContent = formatTime(audioElement.duration);
                    audioElement.play();
                };

                playPauseBtn.onclick = () => {
                    if (audioElement.paused) {
                        audioElement.play();
                        playPauseBtn.innerHTML = pauseIcon;
                    } else {
                        audioElement.pause();
                        playPauseBtn.innerHTML = playIcon;
                    }
                };

                audioElement.ontimeupdate = () => {
                    seeker.value = audioElement.currentTime;
                    currentTimeEl.textContent = formatTime(audioElement.currentTime);
                };

                audioElement.onended = () => {
                    playPauseBtn.innerHTML = playIcon;
                    seeker.value = 0;
                    currentTimeEl.textContent = "0:00";
                }

                seeker.oninput = () => {
                    audioElement.currentTime = seeker.value;
                };

            } catch(error) {
                console.error("Audio generation failed:", error);
                document.getElementById('gemini-response').innerHTML = `<p class="text-red-400">${t.aiError}</p>`;
                document.getElementById('gemini-response').classList.remove('hidden');
                loadingDiv.classList.add('hidden');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const headerLength = 44;
            const buffer = new ArrayBuffer(headerLength + pcmData.length * 2);
            const view = new DataView(buffer);

            // RIFF chunk descriptor
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE');

            // fmt sub-chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // Subchunk1Size
            view.setUint16(20, 1, true); // AudioFormat (PCM)
            view.setUint16(22, 1, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, sampleRate * 2, true); // ByteRate
            view.setUint16(32, 2, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample

            // data sub-chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        function showWhatsNewModal() {
            const t = translations[currentLanguage];
            const latestUpdate = versionHistory[0];
            
            document.getElementById('update-modal-title').textContent = t.whatsNew;
            document.getElementById('update-modal-description').textContent = latestUpdate.description[currentLanguage];
            
            document.getElementById('update-modal').classList.remove('hidden');
            document.getElementById('update-modal').classList.add('flex');
            document.body.classList.add('modal-open');
        }

        function showAboutModal() {
            const t = translations[currentLanguage];
            document.getElementById('about-modal-title').textContent = t.aboutTitle;
            document.getElementById('about-modal-description').textContent = t.aboutDescription;
            document.getElementById('about-modal').classList.remove('hidden');
            document.getElementById('about-modal').classList.add('flex');
            document.body.classList.add('modal-open');
        }

        // Modals
        document.getElementById('close-update-btn').addEventListener('click', () => {
            document.getElementById('update-modal').classList.add('hidden');
            document.getElementById('update-modal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        });

        document.getElementById('close-about-btn').addEventListener('click', () => {
            document.getElementById('about-modal').classList.add('hidden');
            document.getElementById('about-modal').classList.remove('flex');
            document.body.classList.remove('modal-open');
        });

        // Reward Preview Modal
        document.getElementById('reward-preview-modal').addEventListener('click', (e) => {
            if(e.target.id === 'reward-preview-modal') {
                hideRewardPreviewModal();
            }
        });
        document.getElementById('close-reward-preview-btn').addEventListener('click', hideRewardPreviewModal);


        // Function to export user data
        function exportUserData() {
            const dataToExport = {};
            const keysToExport = [
                // Core Data
                'findFlixUserPreferences', 
                'findFlixLibrary', 
                'findFlixWatched',
                'findFlixAchievements',
                
                // Settings & Accessibility
                'findFlixLang', 
                'findFlixTmdbLang',
                'findFlixTheme', 
                'findFlixCardDensity',
                'findFlixFontSize', 
                'findFlixHighContrast',
                'findFlixReducedMotion', 
                'findFlixUnderlineLinks',
                'findFlixCustomFontName', 
                'findFlixCustomFontData', 
                
                // API & AI
                'findFlixGeminiApiKey',
                'findFlixAiTvEnabled',
                'findFlixAiTvTimer',
                'findFlixSportsScoreboardEnabled',
                'findFlixFlixyEnabled',
                'findFlixAiSummaryVisible',
                
                // Plugins
                'findFlixPlugin_cineby',
                'findFlixPlugin_tv',
                
                // User Stats & History
                'findFlixLoginStreak',
                'findFlixLastLoginDate',
                'findFlixHighestStreak',
                'findFlixHighestStreakDate',
                'findFlixChatHistory',
                
                // Misc
                'findFlixCookieConsent'
            ];

            keysToExport.forEach(key => {
                const data = localStorage.getItem(key);
                if (data !== null) {
                    dataToExport[key] = data;
                }
            });

            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `find-flix-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Function to handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (typeof importedData !== 'object' || importedData === null || !importedData.findFlixLang) {
                        throw new Error('Invalid data format');
                    }
                    
                    Object.keys(importedData).forEach(key => {
                        localStorage.setItem(key, importedData[key]);
                    });

                    showToast(translations[currentLanguage].importSuccess, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } catch (error) {
                    console.error('Import Error:', error);
                    showToast(translations[currentLanguage].importError, 'danger');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function initPWA() {
            const iconUrl = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAYFBMVEX/AAD/////OTn/Kiropqf/2dn/8PD/9PT/MjL/ERH/WVn/5ub/ICD/ycn/vr7/fn7/XV3/s7P/goL/h4f/oqL/c3P/U1P/zMzp6en/amr/rq7/j4//YWH/wcH/dXUA4uRdAAACnklEQVR4nO3d63aqMBhAYRCSAoKioIgoiP7/v3a4A4gIqgQdwj2fcx6dG2xCa2uWAAAAAAAAAAAAAAAAAAAAgMAs9l5rK1er1Qqx915bW7f2Xl/c7v22t3O5XIPo0/a+L05eHp9ffN/39/3j5w8+3+9/fTw/e/a3h+NRvR8Qjx/H4/Hw+v1u/N17bW3dC+Lp17fXl48fj8frb7eX28vt1/eb7cftj5sffz3+eH5e/73+/v3t7c3jYy+Yl48P29ub4/F4eX16vR7lY5m//eY3x+NRL2yvx8/bH+n59eb5x+NRfX6/G6d/915bW7e2vT4eP79ej1O+N4jH49fne5Ufrz/fj/Kv4y/+L/zUv7y/v395fX27ubx8/vT7eXp5u14N/6e33u1b8i+7e8+3n24/bj5sv3x5/vi++3fvrbe2a7tL/zL+U//G7u3vfu1vL7/e3F9f/958efw15cZ7r62tW/w15/f3t7c/33r7L5zvtbe1a/y97Xp7f/814fD2vS+599rauiX/L957bW3dkn8t915bW7fkv+vea2vr1u5/8QpfeOEVvvDCS6tY/t/l/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/whRde+CW1/xVfeOEVvvDCS6tY/zXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/yS2v/6/L/L+X+X8/8u5/9dyn+Z/jXf8IVX+MILL/zSyup/+/y/y/l/l/P/Luf/Xcp/mf413/CFF37hFV544ZUv1L/hC6/wDQIAAADApz8L7o7/v7G5xgAAAABJRU5ErkJggg==';
            
            // 1. Create and inject the manifest link
            const manifest = {
                name: 'Find-Flix',
                short_name: 'Find-Flix',
                start_url: '.',
                display: 'standalone',
                background_color: '#0d0d0d',
                theme_color: '#e50914',
                description: translations[currentLanguage] ? translations[currentLanguage].metaDescription : translations['he'].metaDescription,
                icons: [
                    {
                        src: iconUrl,
                        sizes: '192x192',
                        type: 'image/png',
                        purpose: 'any maskable'
                    },
                    {
                        src: iconUrl,
                        sizes: '512x512',
                        type: 'image/png',
                        purpose: 'any maskable'
                    }
                ]
            };
            const manifestString = JSON.stringify(manifest);
            const manifestBlob = new Blob([manifestString], {type: 'application/json'});
            const manifestUrl = URL.createObjectURL(manifestBlob);
            
            // Remove old manifest if it exists to support language changes
            const oldManifest = document.querySelector('link[rel="manifest"]');
            if(oldManifest) oldManifest.remove();

            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestUrl;
            document.head.appendChild(manifestLink);

            // 2. Service Worker registration is removed because it fails with blob URLs in this environment.
            // This fixes the "Failed to register a ServiceWorker" error. The app will lose offline capabilities
            // but the "Add to Home Screen" prompt should still work via the manifest file.

            // 3. Install prompt handling
            let deferredPrompt;
            const installButton = document.getElementById('install-app-link');

            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('beforeinstallprompt event fired.');
                e.preventDefault();
                deferredPrompt = e;
                installButton.classList.remove('hidden');
                console.log('Install button should be visible now.');

                installButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Install button clicked.');
                    installButton.classList.add('hidden');
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                });
            });
        }

        // Flixy AI Assistant Logic
        function initFlixy() {
            const flixyBtn = document.getElementById('sidebar-flixy-btn'); // MODIFIED: Target sidebar button
            const flixyWindow = document.getElementById('flixy-window');
            const closeFlixyBtn = document.getElementById('close-flixy-btn');
            const clearFlixyBtn = document.getElementById('clear-flixy-btn'); // NEW
            const flixyInput = document.getElementById('flixy-input');
            const flixySendBtn = document.getElementById('flixy-send-btn');
            const flixyMessages = document.getElementById('flixy-messages');

            if (!flixyBtn || !flixyWindow) return; // Check for flixyBtn instead of flixyFab

            // Translations for Flixy UI
            const flixyText = {
                'he': { 
                    placeholder: 'שאל אותי על סרטים, האתר או המלצות...', 
                    welcome: 'היי! אני Flixy 🤖, העוזר האישי שלך. איך אני יכול לעזור לך היום?' 
                },
                'en': { 
                    placeholder: 'Ask about movies, the site, or recommendations...', 
                    welcome: 'Hi! I\'m Flixy 🤖, your personal assistant. How can I help you today?' 
                }
            };

            // Initial Setup
            const t = flixyText[currentLanguage] || flixyText['en'];
            flixyInput.placeholder = t.placeholder;
            
            // Fixed direction for input and button based on language
            if (translations[currentLanguage].langDir === 'rtl') {
                flixyInput.classList.remove('pl-4', 'pr-12');
                flixyInput.classList.add('pr-4', 'pl-12');
                flixySendBtn.classList.remove('right-1.5');
                flixySendBtn.classList.add('left-1.5');
                flixySendBtn.querySelector('svg').classList.remove('rotate-90');
                flixySendBtn.querySelector('svg').classList.add('-rotate-90'); // Point left in RTL (Fixed rotation)
            } else {
                flixyInput.classList.remove('pr-4', 'pl-12');
                flixyInput.classList.add('pl-4', 'pr-12');
                flixySendBtn.classList.remove('left-1.5');
                flixySendBtn.classList.add('right-1.5');
                flixySendBtn.querySelector('svg').classList.remove('-rotate-90');
                flixySendBtn.querySelector('svg').classList.add('rotate-90'); // Point right in LTR
            }
            
            // NEW: Load Chat History
            let chatHistory = [];
            try {
                const savedHistory = localStorage.getItem('findFlixChatHistory');
                if (savedHistory) {
                    chatHistory = JSON.parse(savedHistory);
                }
            } catch (e) {
                console.error("Error loading chat history:", e);
            }

            if (chatHistory.length > 0) {
                chatHistory.forEach(msg => {
                    addFlixyMessage(msg.text, msg.sender, false); // false = don't save again
                });
            } else {
                // Add welcome message if empty
                addFlixyMessage(t.welcome, 'bot');
            }

            // Toggle Window
            flixyBtn.addEventListener('click', (e) => {
                // NEW: Check for API Key before opening
                if (!GEMINI_API_KEY) {
                    const t = translations[currentLanguage];
                    showToast(t.apiKeyNeeded, 'danger', '#settings');
                    return;
                }
                
                e.stopPropagation(); // Prevent immediate closing by document listener
                
                // NEW: Close sidebar on mobile when opening Flixy to avoid clutter
                const sidebar = document.getElementById('sidebar');
                const sidebarOverlay = document.getElementById('sidebar-overlay');
                if (document.body.classList.contains('sidebar-open')) {
                     sidebar.classList.add('translate-x-full');
                     sidebarOverlay.classList.add('hidden');
                     document.body.classList.remove('sidebar-open');
                }

                flixyWindow.classList.toggle('open');
                if (flixyWindow.classList.contains('open')) {
                    flixyInput.focus();
                }
            });

            closeFlixyBtn.addEventListener('click', () => {
                flixyWindow.classList.remove('open');
            });

            // NEW: Close Flixy when clicking outside
            document.addEventListener('click', (e) => {
                if (flixyWindow.classList.contains('open') && 
                    !flixyWindow.contains(e.target) && 
                    !flixyBtn.contains(e.target)) { // MODIFIED: Check new button
                    flixyWindow.classList.remove('open');
                }
            });

            // NEW: Clear Chat Button
            if (clearFlixyBtn) {
                clearFlixyBtn.addEventListener('click', () => {
                    flixyMessages.innerHTML = '';
                    chatHistory = []; // Clear array
                    localStorage.removeItem('findFlixChatHistory'); // Clear storage
                    addFlixyMessage(t.welcome, 'bot');
                });
            }

            // Send Message Logic
            const sendMessage = async () => {
                const text = flixyInput.value.trim();
                if (!text) return;

                // Add User Message
                addFlixyMessage(text, 'user');
                flixyInput.value = '';
                flixySendBtn.disabled = true;

                // Show Typing Indicator
                const typingId = addTypingIndicator();

                try {
                    const response = await callGeminiForFlixy(text);
                    removeTypingIndicator(typingId);
                    addFlixyMessage(response, 'bot');
                } catch (error) {
                    console.error('Flixy Error:', error);
                    removeTypingIndicator(typingId);
                    const errText = currentLanguage === 'he' ? 'אופס, נתקלתי בבעיה. נסה שוב מאוחר יותר.' : 'Oops, something went wrong. Try again later.';
                    addFlixyMessage(errText, 'bot');
                } finally {
                    flixySendBtn.disabled = false;
                    flixyInput.focus();
                }
            };

            flixySendBtn.addEventListener('click', sendMessage);
            flixyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            function addFlixyMessage(text, sender, save = true) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flixy-message ${sender} fade-in`;
                // Convert newlines to breaks and handle basic links if needed
                msgDiv.innerHTML = text.replace(/\n/g, '<br>');
                flixyMessages.appendChild(msgDiv);
                flixyMessages.scrollTop = flixyMessages.scrollHeight;

                if (save) {
                    chatHistory.push({ text, sender });
                    localStorage.setItem('findFlixChatHistory', JSON.stringify(chatHistory));
                }
            }

            function addTypingIndicator() {
                const id = 'typing-' + Date.now();
                const div = document.createElement('div');
                div.id = id;
                div.className = 'flixy-message bot flex gap-1 items-center h-8 w-16 justify-center';
                div.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                flixyMessages.appendChild(div);
                flixyMessages.scrollTop = flixyMessages.scrollHeight;
                return id;
            }

            function removeTypingIndicator(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            async function callGeminiForFlixy(userQuery) {
                if (!GEMINI_API_KEY) {
                    return currentLanguage === 'he' 
                        ? 'כדי שאוכל לענות, עליך להגדיר מפתח API של Gemini בהגדרות האתר. 🔑' 
                        : 'To answer, you need to set a Gemini API key in the settings. 🔑';
                }

                // Generate Current TV Schedule Context
                let tvScheduleContext = "TV Schedule data is currently unavailable.";
                try {
                    if (epgDataStore && Object.keys(epgDataStore).length > 0 && TV_CHANNELS['he']) {
                        const now = new Date();
                        const scheduleLines = [];
                        const extractFromChannels = (channels) => {
                            channels.forEach(ch => {
                                let epgId = ch.epgId;
                                if (!epgId && ch.streams && ch.streams.length > 0) {
                                    const streamWithEpg = ch.streams.find(s => s.epgId);
                                    if (streamWithEpg) epgId = streamWithEpg.epgId;
                                }
                                if (epgId && epgDataStore[epgId]) {
                                    const currentProg = epgDataStore[epgId].find(p => now >= p.StartDate && now < p.EndDate);
                                    if (currentProg) {
                                        const startTime = currentProg.StartDate.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
                                        scheduleLines.push(`- ${ch.name}: ${currentProg.Name} (${startTime})`);
                                    }
                                }
                            });
                        };
                        Object.values(TV_CHANNELS['he']).forEach(category => {
                            if (Array.isArray(category)) extractFromChannels(category);
                        });
                        if (scheduleLines.length > 0) tvScheduleContext = scheduleLines.join('\n');
                        else tvScheduleContext = "No active programs found in schedule.";
                    }
                } catch (e) {
                    console.error("Error building Flixy TV context:", e);
                }

                const langName = currentLanguage === 'he' ? 'Hebrew' : 'English';
                
                // System Prompt with explicit Tool instructions
                const systemPrompt = `You are Flixy, the smart AI assistant for "Find-Flix".
Find-Flix is a web app for discovering movies/TV, watching live Israeli TV, and tracking content.

**CRITICAL CAPABILITY - REAL TIME DATA:**
You have access to a tool called 'search_tmdb'.
You MUST use this tool whenever the user asks about:
1. Specific movies, series, or people (e.g., "Who acts in The Batman?", "Rating of Inception", "Gladiator 2").
2. Release dates, plots, or current popularity.
3. "Find me a movie about..." (Use the tool to verify real existence of such movies).

Do NOT guess or hallucinate information about media. SEARCH FIRST.
You also have the current Live TV schedule below.

CURRENT LIVE TV SCHEDULE (Real-time):
${tvScheduleContext}

Your Persona: Friendly, helpful, witty, loves movies.
Current User Language: ${langName}. Respond in ${langName}.
Keep responses concise and engaging.`;

                // Define the Tool
                const tools = [{
                    function_declarations: [{
                        name: "search_tmdb",
                        description: "Search TMDB for movies, TV shows, or people to get real-time details like rating, release date, cast, and plot.",
                        parameters: {
                            type: "OBJECT",
                            properties: {
                                query: {
                                    type: "STRING",
                                    description: "The specific movie, show, or person name to search for."
                                }
                            },
                            required: ["query"]
                        }
                    }]
                }];

                const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

                try {
                    // Step 1: Send user query to Model
                    // NOTE: Removed generationConfig to allow Function Calling to work properly
                    const payload1 = {
                        contents: [{ role: "user", parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        tools: tools
                    };

                    let response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload1)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error("Gemini API Error Body:", errorText);
                        throw new Error(`Gemini API Error: ${response.status}`);
                    }

                    let data = await response.json();
                    let part = data.candidates?.[0]?.content?.parts?.[0];

                    // Step 2: Check if Model wants to call the tool
                    if (part && part.functionCall) {
                        const fc = part.functionCall;
                        if (fc.name === 'search_tmdb') {
                            const query = fc.args.query;
                            
                            // --- REAL-TIME API CALL TO TMDB ---
                            const tmdbData = await fetchAPI('/search/multi', { query: query });
                            
                            // Process results to be concise for the AI
                            const topResults = (tmdbData.results || []).slice(0, 5).map(item => ({
                                title: item.title || item.name,
                                type: item.media_type,
                                date: item.release_date || item.first_air_date,
                                rating: item.vote_average,
                                overview: item.overview ? item.overview.substring(0, 200) + "..." : "No description",
                                id: item.id
                            }));

                            const functionResponse = {
                                functionResponse: {
                                    name: "search_tmdb",
                                    response: { name: "search_tmdb", content: { results: topResults } }
                                }
                            };

                            // Step 3: Send Tool Results back to Model
                            const payload2 = {
                                contents: [
                                    { role: "user", parts: [{ text: userQuery }] },
                                    { role: "model", parts: [part] }, // The function call request
                                    { role: "function", parts: [functionResponse] } // The function result - Correct Role is 'function'
                                ],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                tools: tools
                            };

                            response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload2)
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error("Gemini API Error (Round 2) Body:", errorText);
                                throw new Error(`Gemini API Error (Round 2): ${response.status}`);
                            }
                            data = await response.json();
                            part = data.candidates?.[0]?.content?.parts?.[0];
                        }
                    }

                    return part?.text || (currentLanguage === 'he' ? 'לא הצלחתי למצוא תשובה.' : 'I could not find an answer.');

                } catch (error) {
                    console.error("Flixy AI Error:", error);
                    return currentLanguage === 'he' 
                        ? 'אופס, נתקלתי בבעיה בחיבור ל-AI. 🤕' 
                        : 'Oops, encountered an AI connection error. 🤕';
                }
            }
        }

        // NEW: Video Recording Functions
        function startVideoRecording() {
            const video = document.getElementById('tv-player');
            const recordBtn = document.getElementById('record-video-btn');
            const t = translations[currentLanguage];

            if (!video || video.readyState < 3) {
                showToast(t.recordingFailedGeneric, 'danger');
                return;
            }

            try {
                const stream = video.captureStream();
                recordedChunks = [];
                // Try common codecs
                const options = { mimeType: 'video/webm; codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options.mimeType = 'video/webm; codecs=vp8';
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'video/webm';
                         if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                            showToast('No supported video format for recording.', 'danger');
                            return;
                         }
                    }
                }
                
                mediaRecorder = new MediaRecorder(stream, options);

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    
                    let channelName = 'live_recording';
                    if (currentPlayingChannel && currentPlayingChannel.name) {
                        channelName = currentPlayingChannel.name.replace(/[^a-z0-9א-ת]/gi, '_').toLowerCase();
                    }
                    const timestamp = new Date().toISOString().replace(/[:.-]/g, '');
                    
                    link.download = `findflix_${channelName}_${timestamp}.webm`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    showToast(t.recordingStopped, 'success');
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorder error:', event.error);
                    showToast(t.recordingFailedGeneric, 'danger');
                    stopVideoRecording(); // Clean up
                };

                mediaRecorder.start();
                
                // Update button state
                recordBtn.classList.add('recording');
                recordBtn.title = t.stopRecording;
                showToast(t.recordingStarted, 'info');

            } catch (error) {
                console.error('Recording error:', error);
                if (error.name === 'SecurityError') {
                    showToast(t.recordingFailedSecurity, 'danger');
                } else {
                    showToast(t.recordingFailedGeneric, 'danger');
                }
                mediaRecorder = null;
                recordedChunks = [];
            }
        }

        function stopVideoRecording() {
            const recordBtn = document.getElementById('record-video-btn');
            const t = translations[currentLanguage];

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
            }
            
            // Reset button state
            if (recordBtn) {
                recordBtn.classList.remove('recording');
                recordBtn.title = t.recordVideo;
            }

            mediaRecorder = null; // Clear the instance
        }

        // Theme & Font Size Management
        function applyTheme(theme) {
            // First, remove all theme-specific classes
            docElement.classList.remove('theme-light', 'theme-glass');

            if (theme === 'automatic') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (!prefersDark) {
                     docElement.classList.add('theme-light');
                }
            } else if (theme === 'light') {
                docElement.classList.add('theme-light');
            } else if (theme === 'glass') {
                docElement.classList.add('theme-glass');
            }
            // For 'dark', no class is added, which is correct as dark is the base theme.
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('findFlixTheme') || 'automatic';
            themeSelect.value = savedTheme;
            
            // Check for glass theme reward
            const glassOption = document.getElementById('theme-glass-option');
            if (userAchievements.unlocked.has('time_traveler') || userAchievements.unlocked.has('glass_theme')) {
                glassOption.classList.remove('hidden');
            } else {
                glassOption.classList.add('hidden');
            }

            applyTheme(savedTheme);

            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if ((localStorage.getItem('findFlixTheme') || 'automatic') === 'automatic') {
                    applyTheme('automatic'); // Use the centralized function
                }
            });

            themeSelect.addEventListener('change', (e) => {
                const newTheme = e.target.value;
                localStorage.setItem('findFlixTheme', newTheme);
                applyTheme(newTheme);
            });
        }

        function applyCardDensity(density) {
            const mainGrids = document.querySelectorAll('#content-grid, #cinemas-grid, #new-releases-grid, #library-grid, #watched-grid');
            const achievementsGrid = document.getElementById('achievements-grid');
            
            // Reset main grids
            mainGrids.forEach(grid => {
                grid.classList.remove('gap-2', 'sm:gap-4', 'gap-4', 'sm:gap-8', 'gap-6', 'sm:gap-12');
            });
            // Reset achievements grid
            if (achievementsGrid) {
                achievementsGrid.classList.remove('gap-3', 'gap-6', 'gap-8');
            }

            // Apply new classes
            if (density === 'compact') {
                mainGrids.forEach(grid => grid.classList.add('gap-2', 'sm:gap-4'));
                if (achievementsGrid) achievementsGrid.classList.add('gap-3');
            } else if (density === 'comfortable') {
                mainGrids.forEach(grid => grid.classList.add('gap-6', 'sm:gap-12'));
                if (achievementsGrid) achievementsGrid.classList.add('gap-8');
            } else { // default
                mainGrids.forEach(grid => grid.classList.add('gap-4', 'sm:gap-8'));
                if (achievementsGrid) achievementsGrid.classList.add('gap-6');
            }
        }

        function initCardDensity() {
            const densitySelect = document.getElementById('density-select');
            const savedDensity = localStorage.getItem('findFlixCardDensity') || 'default';
            densitySelect.value = savedDensity;
            applyCardDensity(savedDensity);

            densitySelect.addEventListener('change', (e) => {
                const newDensity = e.target.value;
                localStorage.setItem('findFlixCardDensity', newDensity);
                applyCardDensity(newDensity);
            });
        }
        
        function applyFontSize(size) {
            docElement.style.fontSize = `${size}px`;
        }

        function initFontSize() {
            const savedSize = localStorage.getItem('findFlixFontSize') || '16';
            fontSizeSlider.value = savedSize;
            applyFontSize(savedSize);

            fontSizeSlider.addEventListener('input', (e) => {
                const newSize = e.target.value;
                localStorage.setItem('findFlixFontSize', newSize);
                applyFontSize(newSize);
            });

            resetFontSizeBtn.addEventListener('click', () => {
                const defaultSize = '16';
                fontSizeSlider.value = defaultSize;
                localStorage.removeItem('findFlixFontSize');
                applyFontSize(defaultSize);
            });
        }

        function applyHighContrast(enabled) {
            docElement.classList.toggle('high-contrast', enabled);
        }

        function applyReducedMotion(enabled) {
            docElement.classList.toggle('reduced-motion', enabled);
        }

        function applyUnderlineLinks(enabled) {
            docElement.classList.toggle('underline-links', enabled);
        }

        function applyCustomFont(fontName, fontData) {
            // Remove previous custom font style if it exists
            const existingStyle = document.getElementById('custom-font-style');
            if (existingStyle) {
                existingStyle.remove();
            }

            if (fontName && fontData) {
                const style = document.createElement('style');
                style.id = 'custom-font-style';
                style.textContent = `
                    @font-face {
                        font-family: 'user-custom-font';
                        src: url(${fontData});
                    }
                `;
                document.head.appendChild(style);
                docElement.classList.add('custom-font');
                document.getElementById('custom-font-name').textContent = fontName;
            } else {
                // This case handles resetting the font
                docElement.classList.remove('custom-font');
                document.getElementById('custom-font-name').textContent = translations[currentLanguage].defaultFont;
            }
        }

        function initAccessibilitySettings() {
            const highContrastToggle = document.getElementById('high-contrast-toggle');
            const reducedMotionToggle = document.getElementById('reduced-motion-toggle');
            const underlineLinksToggle = document.getElementById('underline-links-toggle');
            const uploadFontBtn = document.getElementById('upload-font-btn');
            const resetFontBtn = document.getElementById('reset-font-btn');
            const fontFileInput = document.getElementById('font-file-input');
            const geminiApiKeyInput = document.getElementById('gemini-api-key-input');
            const saveGeminiApiKeyBtn = document.getElementById('save-gemini-api-key-btn');
            const aiTvIdentifierToggle = document.getElementById('ai-tv-identifier-toggle');
            const aiTvTimerSlider = document.getElementById('ai-tv-timer-slider');
            const aiTvTimerValue = document.getElementById('ai-tv-timer-value');
            const aiTvTimerSettingContainer = document.getElementById('ai-tv-timer-setting-container');
            const sportsScoreboardToggle = document.getElementById('sports-scoreboard-toggle');
            const flixyToggle = document.getElementById('flixy-toggle');

            // High Contrast
            const savedHighContrast = localStorage.getItem('findFlixHighContrast') === 'true';
            highContrastToggle.checked = savedHighContrast;
            applyHighContrast(savedHighContrast);

            highContrastToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                localStorage.setItem('findFlixHighContrast', isEnabled);
                applyHighContrast(isEnabled);
            });

            // Reduced Motion
            const savedReducedMotion = localStorage.getItem('findFlixReducedMotion') === 'true';
            reducedMotionToggle.checked = savedReducedMotion;
            applyReducedMotion(savedReducedMotion);
            
            reducedMotionToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                localStorage.setItem('findFlixReducedMotion', isEnabled);
                applyReducedMotion(isEnabled);
            });
            
            // Underline Links
            const savedUnderlineLinks = localStorage.getItem('findFlixUnderlineLinks') === 'true';
            underlineLinksToggle.checked = savedUnderlineLinks;
            applyUnderlineLinks(savedUnderlineLinks);
            
            underlineLinksToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                localStorage.setItem('findFlixUnderlineLinks', isEnabled);
                applyUnderlineLinks(isEnabled);
            });

            // Custom Font (Experimental)
            const savedFontName = localStorage.getItem('findFlixCustomFontName');
            const savedFontData = localStorage.getItem('findFlixCustomFontData');
            if (savedFontName && savedFontData) {
                applyCustomFont(savedFontName, savedFontData);
            }

            uploadFontBtn.addEventListener('click', () => fontFileInput.click());

            resetFontBtn.addEventListener('click', () => {
                localStorage.removeItem('findFlixCustomFontName');
                localStorage.removeItem('findFlixCustomFontData');
                applyCustomFont(null, null); // Reset the font
                showToast(translations[currentLanguage].fontResetSuccess, 'success');
            });

            fontFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const fontDataUrl = event.target.result;
                    const fontName = file.name;
                    localStorage.setItem('findFlixCustomFontName', fontName);
                    localStorage.setItem('findFlixCustomFontData', fontDataUrl);
                    applyCustomFont(fontName, fontDataUrl);
                    showToast(translations[currentLanguage].fontUploadSuccess.replace('{fontName}', fontName), 'success');
                };
                reader.onerror = () => {
                    showToast(translations[currentLanguage].fontUploadError, 'danger');
                };
                reader.readAsDataURL(file);
                e.target.value = ''; // Reset file input
            });

            // Gemini API Key
            geminiApiKeyInput.value = GEMINI_API_KEY;
            saveGeminiApiKeyBtn.addEventListener('click', () => {
                const newKey = geminiApiKeyInput.value.trim();
                localStorage.setItem('findFlixGeminiApiKey', newKey);
                GEMINI_API_KEY = newKey; // Update the global variable
                showToast(translations[currentLanguage].apiKeySaved, 'success');
            });

            // AI TV Identifier Settings
            const savedAiTvEnabled = localStorage.getItem('findFlixAiTvEnabled') !== 'false'; // Default to true
            aiTvIdentifierToggle.checked = savedAiTvEnabled;
            aiTvTimerSettingContainer.style.display = savedAiTvEnabled ? 'block' : 'none';

            aiTvIdentifierToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                localStorage.setItem('findFlixAiTvEnabled', isEnabled);
                aiTvTimerSettingContainer.style.display = isEnabled ? 'block' : 'none';
            });

            const savedAiTvTimer = localStorage.getItem('findFlixAiTvTimer') || '25';
            aiTvTimerSlider.value = savedAiTvTimer;
            aiTvTimerValue.textContent = `${savedAiTvTimer} ${translations[currentLanguage].secondsUnit}`;

            aiTvTimerSlider.addEventListener('input', (e) => {
                const newTimerValue = e.target.value;
                localStorage.setItem('findFlixAiTvTimer', newTimerValue);
                aiTvTimerValue.textContent = `${newTimerValue} ${translations[currentLanguage].secondsUnit}`;
            });

            // NEW: Sports Scoreboard Setting
            const savedSportsScoreboardEnabled = localStorage.getItem('findFlixSportsScoreboardEnabled') !== 'false'; // Default to true
            sportsScoreboardToggle.checked = savedSportsScoreboardEnabled;
            sportsScoreboardToggle.addEventListener('change', (e) => {
                localStorage.setItem('findFlixSportsScoreboardEnabled', e.target.checked);
            });

            // NEW: Flixy Toggle Setting
            const savedFlixyEnabled = localStorage.getItem('findFlixFlixyEnabled') !== 'false'; // Default to true
            flixyToggle.checked = savedFlixyEnabled;
            const flixyBtn = document.getElementById('sidebar-flixy-btn'); // MODIFIED
            const flixyWindow = document.getElementById('flixy-window');
            
            const updateFlixyVisibility = (enabled) => {
                if (enabled) {
                    if (flixyBtn) flixyBtn.classList.remove('hidden');
                } else {
                    if (flixyBtn) flixyBtn.classList.add('hidden');
                    if (flixyWindow) flixyWindow.classList.remove('open'); // Close if open
                }
            };
            
            // Initial check
            updateFlixyVisibility(savedFlixyEnabled);

            flixyToggle.addEventListener('change', (e) => {
                const isEnabled = e.target.checked;
                localStorage.setItem('findFlixFlixyEnabled', isEnabled);
                updateFlixyVisibility(isEnabled);
            });
        }

        function stopTvPlayer() {
    if (tvContentInterval) { // NEW
        clearInterval(tvContentInterval);
        tvContentInterval = null;
    }
    if (fullEpgInterval) { // NEW: Clear EPG interval
        clearInterval(fullEpgInterval);
        fullEpgInterval = null;
    }
    if (channelsRefreshInterval) { // NEW: Clear channels list interval
        clearInterval(channelsRefreshInterval);
        channelsRefreshInterval = null;
    }
    isAIIdentifying = false; // Also reset this flag
    currentPlayingChannel = null; // NEW
    stopVideoRecording(); // NEW: Stop recording if it's active
    const video = document.getElementById('tv-player');
    if (hls) {
        hls.destroy();
                hls = null;
            }
            if (video) {
                video.pause();
                video.src = '';
            }
            const overlay = document.getElementById('tv-player-overlay');
            const messageContainer = overlay.querySelector('.text-center'); // Get the container
            const t = translations[currentLanguage];
            if (overlay && messageContainer && t) { // Use messageContainer
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                // Restore default content
                messageContainer.innerHTML = `
                    <p id="tv-player-message" class="text-white text-lg font-semibold">${t.selectChannelPrompt}</p>
                `;
            }
        }

        // TV Channels Functions
        const TV_CHANNELS = {
            'he': {
                'news': [
                    { name: 'כאן 11', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c8/Kan11Logo.svg/512px-Kan11Logo.svg.png', streamUrl: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/master.m3u8', epgId:'ערוץ 11.il' },
                    { name: 'קשת 12', logo: 'https://i.imgur.com/fY3eakc.png', streamUrl: 'https://tv.embyil.tv:86/live/20/chunks.m3u8', epgId: 'ערוץ 12.il' },
                    { name: 'רשת 13', logo: 'https://i.imgur.com/eFM3bTq.png', streamUrl: 'https://d18b0e6mopany4.cloudfront.net/out/v1/1a7c55961dec4c72b51d79e5d9216cff/index.m3u8', epgId: 'ערוץ 13.il' },
                    { name: 'עכשיו 14', logo: 'https://i.imgur.com/Iq2Kb69.png', streamUrl: 'https://r.il.cdn-redge.media/livehls/oil/ch14/live/ch14/live.livx/playlist.m3u8', epgId: 'ערוץ 14.il' },
                    { name: 'ערוץ הכנסת', logo: 'https://i.imgur.com/QXB1jv8.png', streamUrl: 'https://kneset.gostreaming.tv/p2-kneset/_definst_/myStream/chunklist.m3u8', epgId: 'ערוץ הכנסת.il' },
                    { name: 'i24NEWS בעברית', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/LOGO_i24NEWS.png/512px-LOGO_i24NEWS.png', streamUrl: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8', epgId: 'i24 עברית.il' },
                ],
                'kids': [
                    { name: 'כאן חינוכית', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/KanHinuchit.svg/512px-KanHinuchit.svg.png', streamUrl: 'https://kan23.media.kan.org.il/hls/live/2024691-b/2024691/source1_4k/chunklist.m3u8', epgId: 'חינוכית.il' },
                    { name: 'ניקלודיאון', logo: 'https://www.citypng.com/public/uploads/preview/nick-nickelodeon-square-logo-icon-png-11663343702wclovnrete.png', streamUrl: 'https://tv.embyil.tv:86/live/720/chunks.m3u8' , epgId: 'ערוץ ניקלודיאון.il'  },
                    { name: 'ניק ג\'וניור', logo: 'https://yt3.googleusercontent.com/vS_TzruFvtEshcnWLWgs3DFQZplzRZd-Go8u-V-Eoh9rjJHG-IxY_4WcynYbBf2iV4Sg5Q3uOIo=s72-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/730/chunks.m3u8' },
                    { name: 'טין ניק', logo: 'https://yt3.googleusercontent.com/cS0-HfysJuxVn6Y3-RV5KxTViUGpo3rOaDFGiQ5hPKkAvhWQL5QjbP7ZREwQ4q0Ns-RK9dLOSw=s72-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/740/chunks.m3u8' , epgId: 'ערוץ טין ניק.il'   },
                    { name: 'לולי', logo: 'https://play.embyil.tv/emby/Items/2299483/Images/Primary?maxHeight=80&tag=728917473849ccdd5e264a405f2385e2&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/750/chunks.m3u8', epgId: 'Luli.hop.co.il' },
                    { name: 'ג\'וניור', logo: 'https://play.embyil.tv/emby/Items/2299484/Images/Primary?maxHeight=100&tag=d0070baaf26042390a24c55e9fb93421&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/760/chunks.m3u8', epgId: 'Junior.yes.co.il' },
                    { name: 'הופ', logo: 'https://play.embyil.tv/emby/Items/2299485/Images/Primary?maxHeight=100&tag=43d2c3c68530199ac80b53652e33d17c&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/770/chunks.m3u8', epgId: 'Hop.hop.co.il' },
                    { name: 'בייבי', logo: 'https://play.embyil.tv/emby/Items/2299486/Images/Primary?maxHeight=100&tag=2f09e9c5c85f91012958b530c8eeae50&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/780/chunks.m3u8', epgId: 'Baby.yes.co.il' },
                    { name: 'זום', logo: 'https://encrypted-tbn2.gstatic.com/favicon-tbn?q=tbn:ANd9GcQ6EIOj5sHDupXBoIsXBOHur0GmFzZsXuFLVRBSHqF08JGd8slAh7AXrsJTNs7oTz38pXkHDt4iYBZUSRX5lBEeybtPcda6CGwbAJC4EchZ7GR4KWs', streamUrl: 'https://tv.embyil.tv:86/live/790/chunks.m3u8', epgId: 'Zoom.yes.co.il' },
                    { name: 'זום טון', logo: 'https://static.wixstatic.com/media/632ff8_1a8ece33b21e4da7ba5197bde83ae196~mv2.png/v1/crop/x_156,y_0,w_1607,h_1080/fill/w_193,h_130,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logo_zoomtoon_channel.png', streamUrl: 'https://tv.embyil.tv:86/live/800/chunks.m3u8', epgId: 'ZoomToon.yes.co.il' },
                    { name: 'דיסני ג\'וניור', logo: 'https://yt3.googleusercontent.com/ycmH6u_8GXdVOSwL8K8D0QSLxzoJvd6yiRORWT0QYosXdtBBOkqQdXTR4DS6kDHd-U49Z3dcpHY=s72-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/700/chunks.m3u8' },
                    { name: 'ערוץ דיסני', logo: 'https://yt3.googleusercontent.com/OkYrjmhY3m9UfpUU_VafVcSBwB-lUJMtYUEUk4zkDSTE3_N2K-NEqKcqEmdxgUMuSvvVYacczF4=s72-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/710/chunks.m3u8' },
                ],
                'religion': [
                    { name: 'הידברות', logo: 'https://i.imgur.com/CTH4Hu2.png', streamUrl: 'https://cdn.cybercdn.live/HidabrootIL/Live97/playlist.m3u8' },
                    { name: 'ערוץ שלנו', logo: 'https://i.imgur.com/UVz2Ojq.png', streamUrl: 'https://1247634592.rsc.cdn77.org/1247634592/playlist.m3u8' },
                ],
                'sports': [
                     {
                         name: 'ספורט',
                         logo: 'https://play-lh.googleusercontent.com/J9ObrIg276ReJS2-WTBUEXAzSgyL7GPet2aFJeB6zSVtZR_bFE-weS1G4FM-6vtFqFrF',
                         epgId: 'Sport2.thesportchannel.co.il', // EPG ראשי, מצביע על ספורט 2
                         streams: [
                             { name: 'ספורט 1', url: 'https://tv.embyil.tv:86/live/80/chunks.m3u8', epgId: 'ספורט 1.il'},
                             { name: 'ספורט 2', url: 'https://tv.embyil.tv:86/live/90/chunks.m3u8', epgId: 'ספורט 2.il'},
                             { name: 'ספורט 3', url: 'https://tv.embyil.tv:86/live/100/chunks.m3u8', epgId: 'ספורט 3.il'},
                             { name: 'ספורט 4', url: 'https://tv.embyil.tv:86/live/110/chunks.m3u8', epgId: 'ספורט 4.il'},
                         ]
                     },
                     {
                         name: 'ערוץ ONE',
                         logo: 'https://th.bing.com/th/id/OSK.2zfnIVF3ktWkZGztYyKke_KoBsAEN7Ppp82hKx3-fmI?w=102&h=102&c=7&o=6&cb=12&pid=SANGAM',
                         streams: [
                             { name: 'ערוץ 1', url: 'https://tv.embyil.tv:86/live/160/chunks.m3u8', epgId: 'ONE 1.il' },
                             { name: 'ערוץ 2', url: 'https://tv.embyil.tv:86/live/160/chunks.m3u8', epgId: 'ONE 2.il' },
                         ]
                     },
                     { name: 'ספורט 5', logo: 'https://play.embyil.tv/emby/Items/2801240/Images/Primary?maxHeight=80&tag=9efaec884625f021ebdffaba82df03af&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/120/chunks.m3u8', epgId: 'SPORT5.il', customStyle: 'bg-black border-2 sport5-logo p-2' },
                     { name: 'ספורט 5 גולד', logo: 'https://play.embyil.tv/emby/Items/2801244/Images/Primary?maxHeight=80&tag=9bf2c96ffed263cbe987a1aeec18a029&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/150/chunks.m3u8', epgId: 'SPORT 5 GOLD.il', customStyle: 'bg-black border-2 sport5-logo p-2' },
                     { name: 'ספורט 5 לייב', logo: 'https://play.embyil.tv/emby/Items/2801241/Images/Primary?maxHeight=80&tag=21f5a54f95da5d5857cf51c815c04971&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/130/chunks.m3u8', epgId: 'Sport 5 Live.il', customStyle: 'bg-black border-2 sport5-logo p-2' },
                     { name: 'ספורט 5 פלוס', logo: 'https://play.embyil.tv/emby/Items/2801242/Images/Primary?maxHeight=80&tag=46f5ed4bd75acad2eb4efd03f59c7901&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/131/chunks.m3u8', epgId: 'SPORT 5 PLUS.il', customStyle: 'bg-black border-2 sport5-logo p-2' },
                     { name: 'ספורט 5 סטארס', logo: 'https://play.embyil.tv/emby/Items/2801243/Images/Primary?maxHeight=100&tag=67a6d144457844161364bae01db10d28&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/140/chunks.m3u8', epgId: 'Sport 5 Stars.il', customStyle: 'bg-black border-2 sport5-logo p-2' },
                     { 
                         name: 'יורוספורט', 
                         logo: 'https://assets.eurosport.io/web/img/og/eurosport.jpg', 
                         customStyle: 'bg-black p-1 object-cover',
                         streams: [
                             { name: 'ערוץ 1', url: 'https://tv.embyil.tv:86/live/180/chunks.m3u8', epgId: 'Eurosport.il' },
                             { name: 'ערוץ 2', url: 'https://tv.embyil.tv:86/live/190/chunks.m3u8', epgId: 'Eurosport2.eurosport.com' }
                         ]
                     }
                ],
                'general': [
                    { name: 'ערוץ 24', logo: 'https://play.embyil.tv/emby/Items/2801234/Images/Primary?maxHeight=80&tag=57fe5be87c977eaf1b6cf7bda2903729&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/51/chunks.m3u8', epgId: 'Music 24.il' },
                    { name: 'ערוץ הכוכב הבא', logo: 'https://cms.freetv.tv/uploads/stare_0ec07318c4.webp?updated_at=2023-06-13T07:04:55.116Z', streamUrl: 'https://tv.embyil.tv:86/live/540/chunks.m3u8', logoCustomClass: 'object-cover scale-125', epgId: 'ערוץ הכוכב הבא.il' },
                    { name: 'ערוץ חתונה ממבט ראשון', logo: 'https://th.bing.com/th/id/R.6ddac3cb5249d226445db2689075c75e?rik=oT%2bc1lm9s%2fheBg&pid=ImgRaw&r=0', streamUrl: 'https://tv.embyil.tv:86/live/530/chunks.m3u8' , epgId:'ערוץ חתונה ממבט ראשון.il'},
                    { name: 'ערוץ הקריוקי', logo: 'https://yt3.googleusercontent.com/4FS2OCChRrupoRQFdRn6TXZPYeoKzu7yiD9j8pwthtkkymc5ZvlK52Kk4zm09aZRcVGxJp8r=s120-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/520/chunks.m3u8', epgId:'ערוץ הקריוקי.il' }
                ],
                'drama': [
                    { 
                        name: 'ערוץ הדרמות הספרדיות', 
                        logo: 'https://play.embyil.tv/emby/Items/2299469/Images/Primary?maxHeight=80&tag=905f987b1a99da2529943a2e1ced75ec&quality=90', 
                        epgId: 'Spanish-Drama.yes.co.il', // EPG ראשי
                        customStyle: 'bg-black p-1',
                        streams: [
                             { name: 'ערוץ 1', url: 'https://tv.embyil.tv:86/live/620/chunks.m3u8', epgId: 'Spanish-Drama.yes.co.il' },
                             { name: 'ערוץ 2', url: 'https://tv.embyil.tv:86/live/610/chunks.m3u8', epgId: 'Spanish-Drama2.yes.co.il' }
                        ]
                    },
                    { 
                        name: 'ערוץ הדרמות ההודיות', 
                        logo: 'https://play.embyil.tv/emby/Items/2299471/Images/Primary?maxHeight=80&tag=93a3961d116a370910e2633225e47e51&quality=90', 
                        epgId: 'Indian-Drama.yes.co.il', // EPG ראשי
                        customStyle: 'bg-black p-1',
                        streams: [
                             { name: 'ערוץ 1', url: 'https://tv.embyil.tv:86/live/630/chunks.m3u8', epgId: 'Indian-Drama.yes.co.il' },
                             { name: 'ערוץ 2', url: 'https://tv.embyil.tv:86/live/640/chunks.m3u8' }
                        ]
                    },
                    { 
                        name: 'ערוץ הדרמות הטורקיות', 
                        logo: 'https://yt3.ggpht.com/ytc/AKedOLSocDxPxmXuShRVSeUebryDecBCdY8tXy5zEy-V-w=s900-c-k-c0x00ffffff-no-rj', 
                        customStyle: 'bg-black p-1',
                        streams: [
                             { name: 'ערוץ 1 (לא זמין)', url: '#' },
                              { name: 'ערוץ 2', url: 'https://tv.embyil.tv:86/live/590/chunks.m3u8' },
                              { name: 'ערוץ 3', url: 'https://tv.embyil.tv:86/live/600/chunks.m3u8' }
                         ]
                     },
                    { name: 'ערוץ בוליווד', logo: 'https://play.embyil.tv/emby/Items/2299473/Images/Primary?maxHeight=80&tag=46d3695404bc5583014d4d369ea8bba4&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/650/chunks.m3u8', epgId: 'Bollywood.yes.co.il', customStyle: 'bg-black p-1' },
                    { name: 'ויוה וינטג\'', logo: 'https://play.embyil.tv/emby/Items/2801295/Images/Primary?maxHeight=80&tag=43637c6b502992b2ebc64ad5796bdd2b&quality=90&quot;);"', streamUrl: 'https://tv.embyil.tv:86/live/670/chunks.m3u8', epgId: 'VivaVintage.yes.co.il', customStyle: 'bg-black p-1' },
                    { name: 'ויוה איסטנבול', logo: 'https://images.peer5.net/static/channels/small/75/logos/24.png?v=0', streamUrl: 'https://tv.embyil.tv:86/live/660/chunks.m3u8', customStyle: 'bg-white p-1' , epgId:'ויוה איסטנבול.il'},
                    { name: 'ויוה פרימיום', logo: 'https://play.embyil.tv/emby/Items/2801296/Images/Primary?maxHeight=80&tag=9ec57b25ee7d7fbd224f24bfb37b8182&quality=90&quot;);"', streamUrl: 'https://tv.embyil.tv:86/live/680/chunks.m3u8' , epgId: 'Viva.yes.co.il', customStyle: 'bg-black p-1' }
                ],
                'science': [
                    { name: 'נשיונל ג\'יאוגרפיק', logo: 'https://play.embyil.tv/emby/Items/2305581/Images/Primary?maxHeight=80&tag=789505b3a597a400eb77a0b20761b52f&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/693/chunks.m3u8', epgId: 'נשיונל גיאוגרפיק.il', customStyle: 'bg-black p-1' },
                    { name: 'ערוץ ההיסטוריה', logo: 'https://yt3.googleusercontent.com/ytc/AIdro_lFzOwepRQxfLBKjjK9T6n9RhRVfGMZcPaL792UehA09i0=s72-c-k-c0x00ffffff-no-rj', streamUrl: 'https://tv.embyil.tv:86/live/691/chunks.m3u8', customStyle: 'bg-black p-1' }
                ],
                'free_tv': [
                    { name: 'Free TV - סרטי משפחה', logo: 'https://play.embyil.tv/emby/Items/2801277/Images/Primary?maxHeight=80&tag=78d9d5f2d548cb05af55ca1d74d72563&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/480/chunks.m3u8', customStyle: 'bg-black p-1', epgid: 'FreeTV סרטים משפחה.il' },
                    { name: 'Free TV - דוקו', logo: 'https://play.embyil.tv/emby/Items/2801278/Images/Primary?maxHeight=80&tag=59e563828a262da0e5c4b48ed234c2a0&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/490/chunks.m3u8', customStyle: 'bg-black p-1' , epgod: 'FreeTV דוקו.il'},
                    { name: 'Free TV - קומדיה', logo: 'https://play.embyil.tv/emby/Items/2801269/Images/Primary?maxHeight=100&tag=4a7a21da1060d6251bd1f5afdb78dff7&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/400/chunks.m3u8', epgId: 'FreeTV סרטים קומדיה.il', customStyle: 'bg-black p-1' },
                    { name: 'Free TV - לייף סטייל', logo: 'https://cms.freetv.tv/uploads/lifestyle_139fcc1577.webp?updated_at=2023-05-30T10:29:39.421Z', streamUrl: 'https://tv.embyil.tv:86/live/500/chunks.m3u8', logoCustomClass: 'object-cover scale-125', epgid: 'FreeTV לייף סטייל.il'},
                    { name: 'Free TV - סרטי אימה', logo: 'https://play.embyil.tv/emby/Items/2801275/Images/Primary?maxHeight=80&tag=d3adad868b58192e1fb2d063082c53ec&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/460/chunks.m3u8', customStyle: 'bg-black p-1' , epgid: 'FreeTV סרטים אימה.il' },
                    { name: 'Free TV - סרטים ישראליים', logo: 'https://play.embyil.tv/emby/Items/2801270/Images/Primary?maxHeight=100&tag=7973a4e3ed0ab2038db0d4ecd5960c10&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/410/chunks.m3u8', customStyle: 'bg-black p-1' , epgid: 'FreeTV סרטים ישראלי.il'},
                    { name: 'Free TV - סרטי קומדיה', logo: 'https://play.embyil.tv/emby/Items/2801274/Images/Primary?maxHeight=100&tag=e59ca0a03a92afa856c697739b80d9b5&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/450/chunks.m3u8', customStyle: 'bg-black p-1' , epgid: 'FreeTV סרטים קומדיה.il'},
                    { name: 'Free TV - סרטי דרמה', logo: 'https://play.embyil.tv/emby/Items/2801273/Images/Primary?maxHeight=100&tag=0b6527a285d51c134776471bb17a6fac&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/440/chunks.m3u8', customStyle: 'bg-black p-1', epgid: 'FreeTV סרטים דרמה.il'},
                    { name: 'Free TV - סרטים רומנטיים', logo: 'https://play.embyil.tv/emby/Items/2801272/Images/Primary?maxHeight=80&tag=4ba6ade521efa0566c8cd5eee7e81604&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/430/chunks.m3u8', customStyle: 'bg-black p-1', epgid:'FreeTV סרטים רומנטי.il' }
                ],
                'hot': [
                    { name: 'HOT - ערוץ הקולנוע 1', logo: 'https://play.embyil.tv/emby/Items/2801251/Images/Primary?maxHeight=80&tag=aa1e09e41882f8f38a3a92be3dc12735&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/210/chunks.m3u8', epgId: 'הוט סינמה 1.il' },
                    { name: 'HOT - ערוץ הקולנוע 2', logo: 'https://play.embyil.tv/emby/Items/2801252/Images/Primary?maxHeight=80&tag=2954ec933c5c81c3a6f8905655e11cba&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/220/chunks.m3u8', epgId: 'הוט סינמה 2.il' },
                    { name: 'HOT - ערוץ הקולנוע 3', logo: 'https://play.embyil.tv/emby/Items/2801253/Images/Primary?maxHeight=80&tag=6a4f79b2440bbeab9f06fadcbc46b1df&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/230/chunks.m3u8', epgId: 'הוט סינמה 3.il' },
                    { name: 'HOT - ערוץ הקולנוע 4', logo: 'https://play.embyil.tv/emby/Items/2801254/Images/Primary?maxHeight=80&tag=8fc5366142add896a246ce6bea89a00a&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/240/chunks.m3u8', epgId: 'הוט סינמה 4.il' },
                    { name: 'HOT - דרמה', logo: 'https://upload.wikimedia.org/wikipedia/he/thumb/2/2f/HOT_HBO_Logo.svg/150px-HOT_HBO_Logo.svg.png', streamUrl: 'https://tv.embyil.tv:86/live/330/chunks.m3u8' },
                    { name: 'HOT - בידור', logo: 'https://play.embyil.tv/emby/Items/2801261/Images/Primary?maxHeight=80&tag=57e52a882b94df0f26222b2b2a88cadb&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/310/chunks.m3u8'},
                    { name: 'HOT Zone', logo: 'https://play.embyil.tv/emby/Items/2801260/Images/Primary?maxHeight=80&tag=5a199f6005c1e06e8c78f8c3728c109f&quality=90', streamUrl: 'https://tv.embyil.tv:86/live/290/chunks.m3u8', epgId: 'HOT-Zone.hot.net.il' }
                ]
            },
            'en': [
                { name: 'i24NEWS in English', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/LOGO_i24NEWS.png/512px-LOGO_i24NEWS.png', streamUrl: 'https://bcovlive-a.akamaihd.net/ecf224f43f3b43e69471a7b626481af0/eu-central-1/5377161796001/playlist.m3u8', epgid: 'i24 English.il' },
            ],
            'ru': [
                { name: '9 канал', logo: 'https://play.embyil.tv/emby/Items/2299414/Images/Primary?maxHeight=80&tag=affb748adc73dee115d60b068afa0887&quality=90', streamUrl: 'https://tv.embyil.tv/2/67e75601f5dd41ffe5fe5ca8/0/master.m3u8', epgId: 'Channel9.channel9.co.il' },
            ],
            'fr': [
                 { name: 'i24NEWS en Français', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/LOGO_i24NEWS.png/512px-LOGO_i24NEWS.png', streamUrl: 'https://bcovlive-a.akamaihd.net/41814196d97e433fb401c5e632d985e9/eu-central-1/5377161796001/playlist.m3u8' },
            ],
            'ar': [
                { name: 'i24NEWS بالعربية', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/79/LOGO_i24NEWS.png/512px-LOGO_i24NEWS.png', streamUrl: 'https://bcovlive-a.akamaihd.net/95116e8d79524d87bf3ac20ba04241e3/eu-central-1/5377161796001/playlist.m3u8' },
                { name: 'مكان 33', logo: 'https://i.imgur.com/RVtQTed.png', streamUrl: 'https://makan.media.kan.org.il/hls/live/2024680/2024680/master.m3u8' },
                { name: 'هلا TV', logo: 'https://i.imgur.com/028M4Ew.png', streamUrl: 'https://stream.panet.com/edge/halaTV/playlist.m3u8' },
            ]
        };

        // NEW XMLTV Date Parser
        function parseXMLTVDate(dateStr) {
            // Format: 20251110163000 +0200
            try {
                if (!dateStr || dateStr.length < 14) return null;
                
                const str = dateStr.substring(0, 14);
                const offset = dateStr.substring(15); // Skip the space at index 14
                
                // Correctly format the ISO string with a colon in the timezone offset
                const isoStr = `${str.substring(0, 4)}-${str.substring(4, 6)}-${str.substring(6, 8)}T${str.substring(8, 10)}:${str.substring(10, 12)}:${str.substring(12, 14)}${offset.substring(0, 3)}:${offset.substring(3)}`;
                
                return new Date(isoStr); // <-- FIX: Return Date object, not ISOString
            } catch (e) {
                console.error("Error parsing XMLTV date:", dateStr, e);
                return null;
            }
        }

        async function fetchEpgData() {
            const t = translations[currentLanguage];
            epgDataStore = {}; // Clear previous data
            
            // Reverting back to corsproxy.io as per user's working example
            const originalEpgUrl = 'https://raw.githubusercontent.com/globetvapp/epg/refs/heads/main/Israel/israel1.xml';
            const epgUrl = 'https://corsproxy.io/?' + encodeURIComponent(originalEpgUrl);

            try {
                console.log("[EPG] Fetching data from:", epgUrl);
                const response = await fetch(epgUrl);
                if (!response.ok) {
                    throw new Error(`EPG fetch failed with status: ${response.status}`);
                }
                const xmlText = await response.text();
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");

                // *** NEW ERROR CHECK ***
                const parserError = xmlDoc.getElementsByTagName("parsererror");
                if (parserError.length > 0) {
                    console.error("Error parsing EPG XML:", parserError[0].textContent);
                    throw new Error("Failed to parse EPG XML file.");
                }
                
                const programmes = xmlDoc.getElementsByTagName('programme');
                
                if (programmes.length === 0) {
                    console.warn("[EPG] XML parsed, but no <programme> tags were found. EPG will be empty.");
                }

                // REMOVE: The time-based filtering. We will load ALL programs.
                // const now = new Date(); // <-- REMOVED
                // const maxStartDate = new Date(Date.now() + 8 * 60 * 60 * 1000); // <-- REMOVED

                const tempEpgStore = {};

                // --- START OF FIX ---
                // Replaced the strict loop with the more robust loop from the user's example
                for (const programme of programmes) {
                    const channelId = programme.getAttribute('channel');
                    const startStr = programme.getAttribute('start');
                    const stopStr = programme.getAttribute('stop');
                    
                    // Use querySelector for safer parsing (like in the example)
                    const titleNode = programme.querySelector('title');
                    const descNode = programme.querySelector('desc');
                    
                    // Check for essentials
                    if (!channelId || !startStr || !stopStr) {
                        continue;
                    }

                    const startDateObj = parseXMLTVDate(startStr);
                    const endDateObj = parseXMLTVDate(stopStr);

                    if (!startDateObj || !endDateObj) {
                        continue; // Skip if dates are invalid
                    }

                    if (!tempEpgStore[channelId]) {
                        tempEpgStore[channelId] = [];
                    }

                    tempEpgStore[channelId].push({
                        ChannelId: channelId,
                        StartDate: startDateObj,
                        EndDate: endDateObj,
                        // Use the robust logic from the example
                        Name: titleNode ? titleNode.textContent : 'ללא כותרת', 
                        Description: descNode ? descNode.textContent : ''
                    });
                }
                // --- END OF FIX ---
                
                // Sort programs for each channel by start time
                Object.keys(tempEpgStore).forEach(channelId => {
                     tempEpgStore[channelId].sort((a, b) => new Date(a.StartDate) - new Date(b.StartDate));
                });
                
                epgDataStore = tempEpgStore;
                console.log(`[EPG] Successfully fetched and parsed. Found ${Object.keys(epgDataStore).length} channels.`);

            } catch (error) {
                console.error("Error fetching or parsing EPG data:", error);
                // Don't show a toast, just fail silently. The UI will show no EPG info.
            }
        }

        async function showTvView() {
            resetView();
            // tvView.classList.remove('hidden'); // לא להציג עדיין
            loadingMessage.classList.remove('hidden'); // הצג סמל טעינה ראשי
            isSearchMode = false;
            
            const t = translations[currentLanguage];
            document.getElementById('tv-title').textContent = t.tvChannelsTitle;
            // document.getElementById('tv-channels-down-notice').textContent = t.tvChannelsDownNotice; // הסרתי את השורה הזו
            document.getElementById('tv-experimental-notice').classList.add('hidden');
            document.getElementById('tv-channels-list-title').textContent = t.navTvChannels;
            document.getElementById('tv-player-message').textContent = t.selectChannelPrompt;
            
            const searchInput = document.getElementById('tv-channel-search-input');
            if (searchInput) searchInput.value = '';
            
            await fetchEpgData(); // טען נתוני לוח שידורים לפני הרינדור
            renderTvChannels();

            // NEW: Start auto-refresh interval for channels list (every 10 seconds)
            if (channelsRefreshInterval) clearInterval(channelsRefreshInterval);
            channelsRefreshInterval = setInterval(() => {
                const currentSearch = document.getElementById('tv-channel-search-input')?.value || '';
                renderTvChannels(currentSearch, true);
            }, 10000);

            // NEW: Hide EPG container on initial view load
            const epgContainer = document.getElementById('tv-epg-container');
            if (epgContainer) epgContainer.classList.add('hidden');

            // The AI button logic is moved to playChannel to prevent it from being overwritten.
            const aiInfoContainer = document.getElementById('tv-ai-info-container');
            aiInfoContainer.classList.add('hidden');

            loadingMessage.classList.add('hidden'); // הסתר סמל טעינה
            tvView.classList.remove('hidden'); // עכשיו הצג את העמוד
            tvView.classList.add('fade-in'); // הוסף אנימציית כניסה
            
            // NEW: Auto-resume last played channel
            if (currentPlayingChannel) {
                playChannel(currentPlayingChannel);
                // Re-highlight the active channel
                setTimeout(() => {
                     const list = document.getElementById('tv-channels-list');
                     if (list) {
                         const buttons = list.querySelectorAll('.channel-item');
                         buttons.forEach(btn => {
                             const btnTextEl = btn.querySelector('p.font-bold'); // Changed selector to match renderTvChannels
                             if (btnTextEl && btnTextEl.textContent === currentPlayingChannel.name) {
                                 btn.classList.add('active');
                             } else {
                                 btn.classList.remove('active');
                             }
                         });
                     }
                }, 200); // 200ms delay to ensure DOM is ready
            }
        }
        
        function renderTvChannels(searchTerm = '', isAutoUpdate = false) {
            const list = document.getElementById('tv-channels-list');
            
            // NEW: Save state before re-rendering
            let savedScrollTop = 0;
            let activeChannelName = null;
            if (isAutoUpdate && list) {
                savedScrollTop = list.scrollTop;
                const activeItem = list.querySelector('.channel-item.active');
                if (activeItem) {
                    const nameEl = activeItem.querySelector('p.font-bold');
                    if (nameEl) activeChannelName = nameEl.textContent;
                }
            }

            list.innerHTML = '';
            const channelsData = TV_CHANNELS[currentLanguage] || {};
            const t = translations[currentLanguage];

            // NEW: Clear all existing EPG cycling intervals
            tvEpgIntervals.forEach(clearInterval);
            tvEpgIntervals = [];

            const searchInput = document.getElementById('tv-channel-search-input');
            if (searchInput && !isAutoUpdate) { // Only set placeholder if not auto-updating to avoid flicker
                searchInput.placeholder = t.searchChannelsPlaceholder || 'Search channel...';
            }

            const channelNumberMap = {
                'כאן 11': '11', 'קשת 12': '12', 'רשת 13': '13', 'עכשיו 14': '14', 
                'כאן חינוכית': '23', 'ערוץ הכנסת': '99', 'הידברות': '97', 
                'קבלה לעם': '66', 'ערוץ שלנו': '•', 'רלוונט TV': '•', 
                'i24NEWS בערבית': '•', 'i24NEWS באנגלית': '•', 'i24NEWS בצרפתית': '•', 'ישראל פרס TV': '•',
                'i24NEWS בעברית': '15',
                'مكان 33': '33',
                'هلا TV': '30',
                'ספורט': '51 & 52 & 53 & 54',
                'ערוץ ONE': '49 & 50',
                'ONE אדג\'': '70',
                'ספורט 5': '55',
                'ספורט 5 לייב': '56',
                'ספורט 5 פלוס': '57',
                'ספורט 5 גולד': '58',
                'ספורט 5 סטארס': '59',
                'יורוספורט': '61',
                'ניקלודיאון': '84',
                'ניק ג\'וניור': '85',
                'טין ניק': '81',
                'לולי': '86',
                'ג\'וניור': '78',
                'הופ': '77',
                'בייבי': '79',
                'זום': '83',
                'זום טון': '82',
                'דיסני ג\'וניור': '80',
                'ערוץ דיסני': '87',
                'נשיונל ג\'יאוגרפיק': '41',
                'נשיונל ג\'יאוגרפיק ווילד': '43',
                'ערוץ ההיסטוריה': '44',
                'ערוץ הדרמות הספרדיות': '39 & 40',
                'ערוץ הדרמות ההודיות': '112 & 113',
                'ערוץ הדרמות הטורקיות': '17 & 21',
                'ערוץ בוליווד': '74',
                'ויוה וינטג\'': '37',
                'ויוה איסטנבול': '36',
                'ויוה טלונובלות': '35',
                'ערוץ 24': '24',
                'ערוץ הכוכב הבא': '•',
                'ערוץ חתונה ממבט ראשון': '•',
                'ערוץ הקריוקי': '•',
                '9 канал': '9',
                'Free TV - סרטי משפחה': '•',
                'Free TV - דוקו': '•',
                'Free TV - קומדיה': '•',
                'Free TV - לייף סטייל': '•',
                'Free TV - סרטי אימה': '•',
                'Free TV - סרטים ישראליים': '•',
                'Free TV - סרטי קומדיה': '•',
                'Free TV - סרטי דרמה': '•',
                'Free TV - סרטים רומנטיים': '•',
                'HOT - ערוץ הקולנוע 1': '•',
                'HOT - ערוץ הקולנוע 2': '•',
                'HOT - ערוץ הקולנוע 3': '•',
                'HOT - ערוץ הקולנוע 4': '•',
                'HOT - דרמה': '•',
                'HOT - בידור': '•',
                'HOT Zone': '•'
            };

            const createChannelButton = (channel) => {
                // NEW: Create a container div
                const container = document.createElement('div');
                container.className = 'channel-item-container w-full';

                // MODIFIED: This is the button, it should have the channel-item class for styling
                const btn = document.createElement('button');
                btn.className = 'channel-item w-full flex items-start gap-3 p-3 rounded-xl text-right hover:bg-white/5 transition-all border border-transparent hover:border-white/10 group relative overflow-hidden'; // Changed styling
                
                const channelNumber = channelNumberMap[channel.name] || '•';
                
                // NEW: Check for multiple streams and create tag
                const hasMultipleStreams = (channel.streams && channel.streams.length > 1) || channel.secondaryStreamUrl;
                let multiChannelTagHtml = '';
                if (hasMultipleStreams) {
                    multiChannelTagHtml = `<span class="multi-channel-tag text-[10px] px-2 py-0.5 bg-red-600/80 backdrop-blur-sm rounded text-white shadow-sm">${t.multiChannelTag}</span>`;
                }
                
                // Check for custom style or use default
                const containerClasses = channel.customStyle ? channel.customStyle : 'bg-gray-800';
                const logoClasses = channel.logoCustomClass ? channel.logoCustomClass : 'object-contain';

                let epgHtml = '';
                // let epgIdToUse = channel.epgId; // OLD LINE - REMOVED

                // NEW: EPG Cycling Logic
                // 1. Find all streams with valid EPGs
                const epgStreams = (channel.streams || [])
                    .filter(s => s.epgId && epgDataStore[s.epgId] && s.url !== '#')
                    .map(s => ({
                        epgId: s.epgId,
                        name: s.name 
                    }));

                // 2. Also consider the parent EPG ID if it exists (like for 'ערוץ הדרמות הספרדיות')
                if (channel.epgId && epgDataStore[channel.epgId] && !epgStreams.some(s => s.epgId === channel.epgId)) {
                    // Find the name of the primary stream
                    let primaryStreamName = channel.primaryStreamName;
                    if (!primaryStreamName) {
                        if (channel.streams && channel.streams.length > 0) {
                            primaryStreamName = channel.streams[0].name;
                        } else {
                            primaryStreamName = 'ערוץ 1'; // Fallback
                        }
                    }
                    epgStreams.unshift({ epgId: channel.epgId, name: primaryStreamName });
                }

                // 3. Determine the initial EPG to display
                let epgIdToUse;
                if (epgStreams.length > 0) {
                    epgIdToUse = epgStreams[0].epgId;
                } else if (channel.epgId && epgDataStore[channel.epgId]) {
                    epgIdToUse = channel.epgId; // Fallback for single EPG channel
                } else {
                    epgIdToUse = null; // No EPG found
                }
                
                // Unique ID for the EPG container
                const epgContainerId = `epg-cycle-${channel.name.replace(/[^a-z0-9א-ת]/gi, '_')}-${Math.random().toString(36).substring(2, 9)}`;

                // 4. Function to generate EPG HTML for a given EPG ID and stream name
                const getEpgHtml = (epgId, streamName = null) => {
                    let html = '';
                    const programs = epgDataStore[epgId];
                    
                    if (programs) {
                        const now = new Date();
                        const currentProgram = programs.find(p => {
                            const startDate = p.StartDate; // <-- FIX: Already a Date object
                            const endDate = p.EndDate;     // <-- FIX: Already a Date object
                            return now >= startDate && now < endDate;
                        });

                        if (currentProgram) {
                            // Calculate progress percentage
                            const start = currentProgram.StartDate.getTime();
                            const end = currentProgram.EndDate.getTime();
                            const current = now.getTime();
                            const percent = Math.min(100, Math.max(0, ((current - start) / (end - start)) * 100));
                            const endTimeStr = currentProgram.EndDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                            html = `
                                <div class="flex justify-between items-baseline w-full">
                                    <p class="text-sm text-red-400 font-bold truncate leading-tight" title="${currentProgram.Name}">${currentProgram.Name}</p>
                                    <span class="text-[10px] text-gray-500 font-mono ml-1 flex-shrink-0">${endTimeStr}</span>
                                </div>
                            `;
                            
                            if (currentProgram.Description) {
                                html += `<p class="text-[11px] text-gray-400 truncate opacity-80 leading-tight" title="${currentProgram.Description}">${currentProgram.Description}</p>`;
                            }
                            
                            // Progress Bar
                            html += `
                                <div class="w-full bg-gray-700/50 rounded-full h-1 mt-1.5 overflow-hidden">
                                    <div class="bg-gradient-to-r from-red-600 to-red-500 h-full rounded-full" style="width: ${percent}%"></div>
                                </div>
                            `;

                            // Add stream name if we are cycling
                            if (streamName) {
                                html += `<p class="text-[10px] text-gray-500 truncate mt-0.5" title="${streamName}">(${streamName})</p>`;
                            }
                        } else {
                            html = `<p class="text-xs text-gray-500 italic">אין מידע שידור זמין</p>`;
                            if (streamName) {
                                html += `<p class="text-xs text-gray-500 truncate" title="${streamName}">(${streamName})</p>`;
                            }
                        }
                    }
                    return html;
                };

                // 5. Generate initial EPG HTML
                if (epgIdToUse) {
                    const initialStreamName = epgStreams.length > 1 ? epgStreams[0].name : null;
                    epgHtml = getEpgHtml(epgIdToUse, initialStreamName);
                }

                // Add a small top margin if there is EPG content
                if (epgHtml || epgStreams.length > 0) {
                    // NO min-height, let content define height. This will reduce empty space but cause layout shift on cycling EPGs.
                    epgHtml = `<div class="mt-1 w-full" id="${epgContainerId}">${epgHtml}</div>`;
                } else {
                    // No EPG data at all (no epgIdToUse, or no epgStreams). Don't add a container.
                    epgHtml = '';
                }
                
                // 6. Set up interval if there are multiple EPGs to cycle
                if (epgStreams.length > 1) {
                    let currentEpgIndex = 0;
                    const newInterval = setInterval(() => {
                        const epgContainer = document.getElementById(epgContainerId);
                        if (!epgContainer) {
                            clearInterval(newInterval);
                            return;
                        }
                        
                        currentEpgIndex = (currentEpgIndex + 1) % epgStreams.length;
                        const currentEpgStream = epgStreams[currentEpgIndex];
                        epgContainer.innerHTML = getEpgHtml(currentEpgStream.epgId, currentEpgStream.name);

                    }, 4000); // Cycle every 4 seconds
                    
                    tvEpgIntervals.push(newInterval);
                }
                
                // --- END OF NEW EPG LOGIC ---

                // MODIFIED: Button HTML now contains epgHtml with better layout
                btn.innerHTML = `
                    <div class="w-14 h-14 flex-shrink-0 rounded-lg ${containerClasses} flex items-center justify-center overflow-hidden shadow-md group-hover:shadow-lg transition-shadow border border-white/5">
                        <img src="${channel.logo}" alt="${channel.name}" class="channel-logo-img w-full h-full ${logoClasses} transform group-hover:scale-110 transition-transform duration-300" onerror="this.onerror=null; this.parentElement.innerHTML = '<span class=\\'font-bold text-lg text-white\\'>${channelNumber}</span>';">
                    </div>
                    <div class="flex-grow min-w-0 flex flex-col justify-center h-full">
                        <div class="flex justify-between items-center w-full mb-0.5">
                            <p class="font-bold text-white text-base truncate group-hover:text-red-500 transition-colors">${channel.name}</p>
                            <div class="text-gray-500 font-mono text-xs bg-black/20 px-1.5 rounded">${channelNumber}</div>
                        </div>
                        ${multiChannelTagHtml ? `<div class="mb-1">${multiChannelTagHtml}</div>` : ''}
                        ${epgHtml}
                    </div>
                `;
                
                btn.addEventListener('click', () => {
                    playChannel(channel);
                     // Highlight active channel
                    document.querySelectorAll('#tv-channels-list .channel-item').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // MODIFIED: Scroll to the video player element, aligning to top
                    const player = document.getElementById('tv-player');
                    if (player) {
                        player.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
                
                // REMOVED: Old EPG container logic
                // const epgContainer = document.createElement('div');
                // ...
                // epgContainer.innerHTML = epgHtml;

                // MODIFIED: Only append the button to the container
                container.appendChild(btn);
                // REMOVED: Old EPG container append logic
                // if (epgHtml) { 
                //    container.appendChild(epgContainer);
                // }

                return container; // Return the new container
            };

            let channelsFound = false;

            if (Array.isArray(channelsData)) { // For languages without categories
                if (channelsData.length === 0) {
                    list.innerHTML = `<p class="text-gray-400">No channels available for this language.</p>`;
                    return;
                }
                channelsData.forEach(channel => {
                    if (channel.name.toLowerCase().includes(searchTerm)) {
                        list.appendChild(createChannelButton(channel));
                        channelsFound = true;
                    }
                });
            } else { // For Hebrew with categories
                if (Object.keys(channelsData).length === 0) {
                    list.innerHTML = `<p class="text-gray-400">No channels available for this language.</p>`;
                    return;
                }
                
                const categoryOrder = ['news', 'kids', 'sports', 'drama', 'science', 'religion', 'general', 'free_tv', 'hot']; // Define display order

                categoryOrder.forEach(categoryKey => {
                    if (channelsData[categoryKey] && channelsData[categoryKey].length > 0) {
                        const filteredChannels = channelsData[categoryKey].filter(channel => 
                            channel.name.toLowerCase().includes(searchTerm)
                        );

                        if (filteredChannels.length > 0) {
                            channelsFound = true;
                            const categoryName = t.tvCategories[categoryKey] || categoryKey;
                            const categoryHeader = document.createElement('h4');
                            categoryHeader.className = 'text-lg font-bold text-red-500 mt-4 first:mt-0 mb-2 px-2';
                            categoryHeader.textContent = categoryName;
                            list.appendChild(categoryHeader);

                            filteredChannels.forEach(channel => {
                                list.appendChild(createChannelButton(channel));
                            });
                        }
                    }
                });
            }

            if (!channelsFound) {
                list.innerHTML = `<p class="text-gray-400">${t.noResults}</p>`;
            }

            // NEW: Restore state after re-rendering
            if (isAutoUpdate && list) {
                list.scrollTop = savedScrollTop;
                if (activeChannelName) {
                    const items = list.querySelectorAll('.channel-item');
                    items.forEach(item => {
                        const nameEl = item.querySelector('p.font-bold');
                        if (nameEl && nameEl.textContent === activeChannelName) {
                            item.classList.add('active');
                        }
                    });
                }
            }
        }

        function playChannel(channel) {
            currentPlayingChannel = channel; // NEW: Set the current channel
            const video = document.getElementById('tv-player');
            const overlay = document.getElementById('tv-player-overlay');
            const messageContainer = overlay.querySelector('.text-center'); // Get the container
            const controlsContainer = document.getElementById('tv-player-controls');
            const streamControlsContainer = document.getElementById('tv-stream-controls'); // NEW container
            const t = translations[currentLanguage];
            
            // NEW: Get the EPG scroll container
            const epgScrollContainer = document.getElementById('epg-scroll-container'); // My new container
        
            stopAndResetAIInterval();
            
            // --- START MODIFICATION ---
            // Remove only dynamically added buttons (subtitle toggle, multi-stream)
            // const dynamicButtons = controlsContainer.querySelectorAll('.dynamic-channel-btn'); // OLD
            // dynamicButtons.forEach(btn => btn.remove()); // OLD
            
            // NEW: Clear the *new* stream controls container
            streamControlsContainer.innerHTML = '';
            streamControlsContainer.classList.add('hidden');
            // --- END MODIFICATION ---

            // NEW: Clear and hide the scroll button container
            epgScrollContainer.innerHTML = '';
            epgScrollContainer.classList.add('hidden');

            let isCurrentlyCasting = false;

            // NEW: Cast logic
            if (window.cast && cast.framework) {
                const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
                if (castSession) {
                    isCurrentlyCasting = true;
                    if (hls) hls.destroy();
                    video.pause();
                    video.src = ''; // Make sure to clear the source
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                    // NEW: Show themed loading overlay
                    messageContainer.innerHTML = `
                        <div class="mb-4 w-24 h-24 p-2 rounded-lg flex items-center justify-center">
                            <img src="${channel.logo}" alt="${channel.name}" class="channel-logo-img w-full h-full ${channel.logoCustomClass || 'object-contain'}" onerror="this.onerror=null; this.parentElement.innerHTML = '<span class=\\'font-bold text-3xl text-white\\'>?</span>';">
                        </div>
                        <div class="loading-spinner mx-auto mb-3"></div>
                        <p class="text-white text-lg font-semibold">${t.connectingTo || 'מתחבר ל...'}${channel.name}</p>
                    `;

                    // Logic to determine which stream URL to use
                    const channelStreamsForCast = (channel.streams && channel.streams.length > 0) 
                        ? channel.streams
                        : channel.secondaryStreamUrl
                            ? [
                                { name: channel.primaryStreamName || 'ערוץ 1', url: channel.streamUrl },
                                { name: channel.secondaryStreamName || 'ערוץ 2', url: channel.secondaryStreamUrl }
                              ]
                            : [];

                    let mediaUrl;
                    if (channel.subtitleStreamUrl && localStorage.getItem(`findFlix_subtitles_${channel.name}`) === 'true') {
                        mediaUrl = channel.subtitleStreamUrl;
                    } else if (channelStreamsForCast.length > 0) {
                        const activeStreamIndex = parseInt(localStorage.getItem(`findFlix_activeStream_${channel.name}`) || '0', 10);
                        mediaUrl = channelStreamsForCast[activeStreamIndex] ? channelStreamsForCast[activeStreamIndex].url : channelStreamsForCast[0].url;
                    } else {
                        mediaUrl = channel.streamUrl;
                    }

                    if (mediaUrl) {
                        const mediaInfo = new chrome.cast.media.MediaInfo(mediaUrl, 'application/x-mpegURL');
                        mediaInfo.streamType = chrome.cast.media.StreamType.LIVE; // Tell the receiver this is a live stream
                        mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                        mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
                        mediaInfo.metadata.title = channel.name;
                        mediaInfo.metadata.subtitle = "Find-Flix | Live TV"; // Add a subtitle
                        mediaInfo.metadata.images = [{ 'url': channel.logo }];
                        
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        
                        castSession.loadMedia(request).then(
                            () => {
                                console.log('Media loaded successfully on Cast device.');
                                message.innerHTML = `משדר את '${channel.name}' בטלוויזיה <br/> <span class="text-sm text-gray-400">ניתן לשלוט דרך אפליקציית Google Home</span>`;
                            },
                            (errorCode) => {
                                console.error('Error loading media on Cast device:', errorCode);
                                message.textContent = `שגיאה בטעינת השידור ל-Chromecast.`;
                            }
                        );
                    }
                    // return; // Stop local playback logic
                }
            }
            // END NEW Cast Logic

            if (hls) {
                hls.destroy();
            }

            const hasStream = channel && (channel.streamUrl || channel.subtitleStreamUrl || (channel.streams && channel.streams.length > 0));

            if (!hasStream) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                message.textContent = `${(channel ? channel.name : 'Unknown')} - ${t.channelNotAvailable}`;
                video.pause();
                video.src = '';
                return;
            }

            // MODIFIED: Show loading overlay *before* loading source
            if (!isCurrentlyCasting) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
                messageContainer.innerHTML = `
                    <div class="mb-4 w-24 h-24 p-2 rounded-lg flex items-center justify-center">
                        <img src="${channel.logo}" alt="${channel.name}" class="channel-logo-img w-full h-full ${channel.logoCustomClass || 'object-contain'}" onerror="this.onerror=null; this.parentElement.innerHTML = '<span class=\\'font-bold text-3xl text-white\\'>?</span>';">
                    </div>
                    <div class="loading-spinner mx-auto mb-3"></div>
                    <p class="text-white text-lg font-semibold">${t.connectingTo || 'מתחבר ל...'}${channel.name}</p>
                `;
            }

            function getErrorMessage(channelName, hlsData = null, videoError = null) {
                const t = translations[currentLanguage];
                let errorTitle = `שגיאה בטעינת השידור: ${channelName}`;
                let errorDetails = 'השידור אינו זמין כרגע או שנדרש רענון.';

                if (hlsData) {
                    if (hlsData.type === Hls.ErrorTypes.NETWORK_ERROR) {
                        errorDetails = 'אירעה שגיאה בניסיון להציג את השידור. ייתכן שזו בעיה אצלנו - אז כדאי לנסות שוב מאוחר יותר!';
                    } else if (hlsData.type === Hls.ErrorTypes.MEDIA_ERROR) {
                        errorDetails = 'אירעה שגיאה בפענוח השידור. ייתכן שהשידור נפל.';
                    }
                } else if (videoError) {
                    switch (videoError.code) {
                        case 2: // MEDIA_ERR_NETWORK
                            errorDetails = 'אירעה שגיאה בניסיון להציג את השידור. ייתכן שזו בעיה אצלנו - אז כדאי לנסות שוב מאוחר יותר!';
                            break;
                        case 3: // MEDIA_ERR_DECODE
                            errorDetails = 'אירעה שגיאה בפענוח השידור.';
                            break;
                        case 4: // MEDIA_ERR_SRC_NOT_SUPPORTED
                            errorDetails = 'פורמט השידור אינו נתמך על ידי הדפדפן שלך.';
                            break;
                    }
                }
                
                return `
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 mx-auto text-yellow-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <p class="text-white text-lg font-semibold mb-2">${errorTitle}</p>
                    <p class="text-gray-300 text-sm">${errorDetails}</p>
                `;
            }

            function loadSource(sourceUrl) {
                // Also hide video error overlay when switching streams
                const overlay = document.getElementById('tv-player-overlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');

                if (hls) {
                    hls.destroy();
                }
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(sourceUrl);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        overlay.classList.add('hidden'); // NEW: Hide overlay on success
                        overlay.classList.remove('flex'); // NEW
                        video.play();
                        startAIInterval(); // Start AI scanning on successful load
                    });
                    hls.on(Hls.Events.ERROR, function(event, data) {
                        if (data.fatal) {
                            console.error('HLS fatal error:', data);
                            overlay.classList.remove('hidden');
                            overlay.classList.add('flex');
                            // Updated error message to include channel name and icon
                            messageContainer.innerHTML = getErrorMessage(channel.name, data, null);
                            stopAndResetAIInterval(); // Stop AI scanning on error
                        }
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = sourceUrl;
                    video.addEventListener('loadedmetadata', function() {
                        overlay.classList.add('hidden'); // NEW: Hide overlay on success
                        overlay.classList.remove('flex'); // NEW
                        video.play();
                        startAIInterval();
                    });
                    // Add error handler for native HLS player
                    video.addEventListener('error', function(e) {
                        console.error('Native video player error:', e);
                        overlay.classList.remove('hidden');
                        overlay.classList.add('flex');
                        messageContainer.innerHTML = getErrorMessage(channel.name, null, video.error);
                        stopAndResetAIInterval();
                    });
                } else {
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                    message.textContent = 'HLS is not supported on your browser.';
                }
            }

            // Normalize multi-stream channels into a single 'streams' array
            const channelStreams = (channel.streams && channel.streams.length > 0) 
                ? channel.streams
                : channel.secondaryStreamUrl
                    ? [
                        { name: channel.primaryStreamName || 'ערוץ 1', url: channel.streamUrl },
                        { name: channel.secondaryStreamName || 'ערוץ 2', url: channel.secondaryStreamUrl }
                      ]
                    : [];
            
            // Check for subtitle stream and create the toggle button
            if (channel.subtitleStreamUrl) {
                const subtitleStorageKey = `findFlix_subtitles_${channel.name}`;
                let subtitlesInitiallyOn = localStorage.getItem(subtitleStorageKey) === 'true';

                // Initial load based on saved state
                if (!isCurrentlyCasting) {
                    if (subtitlesInitiallyOn) {
                        loadSource(channel.subtitleStreamUrl);
                    } else {
                        loadSource(channel.streamUrl);
                    }
                }

                controlsContainer.classList.remove('hidden');
                const toggleBtn = document.createElement('button');
                // --- START MODIFICATION ---
                toggleBtn.className = 'dynamic-channel-btn px-4 py-2 bg-gray-600 text-white font-bold rounded-full flex items-center gap-2 transition-colors hover:bg-gray-700'; // Added dynamic-channel-btn
                // --- END MODIFICATION ---
                toggleBtn.dataset.subtitlesOn = subtitlesInitiallyOn.toString();
                
                const updateButtonText = () => {
                    const subtitlesOn = toggleBtn.dataset.subtitlesOn === 'true';
                    const text = subtitlesOn ? t.subtitleToggleOn : t.subtitleToggleOff;
                    toggleBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 3a1 1 0 00-1-1H3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V3zM4.5 9.5a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zm0 2a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm0-4a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm8.5 6a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zm0 2a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5zm0-4a.5.5 0 01.5-.5h5a.5.5 0 010 1h-5a.5.5 0 01-.5-.5z" clip-rule="evenodd" />
                        </svg>
                        <span>${text}</span>
                    `;
                    toggleBtn.classList.toggle('bg-green-600', subtitlesOn);
                    toggleBtn.classList.toggle('hover:bg-green-700', subtitlesOn);
                    toggleBtn.classList.toggle('bg-gray-600', !subtitlesOn);
                    toggleBtn.classList.toggle('hover:bg-gray-700', !subtitlesOn);
                };
                
                toggleBtn.addEventListener('click', () => {
                    const subtitlesOn = toggleBtn.dataset.subtitlesOn === 'true';
                    const newState = !subtitlesOn;
                    toggleBtn.dataset.subtitlesOn = newState.toString();
                    localStorage.setItem(subtitleStorageKey, newState);
                    updateButtonText();

                    const newUrl = newState ? channel.subtitleStreamUrl : channel.streamUrl;

                    // Check for active cast session
                    const castSession = window.cast && cast.framework ? cast.framework.CastContext.getInstance().getCurrentSession() : null;

                    // If casting this channel, reload media on cast device
                    if (castSession) {
                        const mediaInfo = new chrome.cast.media.MediaInfo(newUrl, 'application/x-mpegURL');
                        mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
                        mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                        mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
                        mediaInfo.metadata.title = channel.name;
                        mediaInfo.metadata.images = [{ 'url': channel.logo }];
                        
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        
                        castSession.loadMedia(request).then(
                            () => console.log('Reloaded media on Cast device with new subtitle setting.'),
                            (errorCode) => console.error('Error reloading media on Cast device:', errorCode)
                        );
                    } else {
                        // Not casting, just update local player
                        loadSource(newUrl);
                    }
                });
                
                updateButtonText(); // Initial text
                // controlsContainer.appendChild(toggleBtn); // OLD
                streamControlsContainer.appendChild(toggleBtn); // NEW
                streamControlsContainer.classList.remove('hidden'); // NEW
            } else if (channelStreams.length > 1) {
                // Multi-stream channel
                // controlsContainer.classList.remove('hidden'); // OLD
                // controlsContainer.classList.add('flex', 'justify-center', 'gap-2'); // OLD
                streamControlsContainer.classList.remove('hidden'); // NEW
                streamControlsContainer.classList.add('flex', 'justify-center', 'gap-2'); // NEW

                const updateActiveButton = (activeIndex) => {
                    localStorage.setItem(`findFlix_activeStream_${channel.name}`, activeIndex);
                    // const buttons = controlsContainer.querySelectorAll('button'); // OLD
                    const buttons = streamControlsContainer.querySelectorAll('button'); // NEW
                    buttons.forEach((button, index) => {
                        if (index === activeIndex) {
                            button.classList.add('bg-red-600', 'hover:bg-red-700');
                            button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                        } else {
                            button.classList.remove('bg-red-600', 'hover:bg-red-700');
                            button.classList.add('bg-gray-600', 'hover:bg-gray-700');
                        }
                    });
                };

                channelStreams.forEach((stream, index) => {
                    const streamBtn = document.createElement('button');
                    // --- START MODIFICATION ---
                    streamBtn.className = 'dynamic-channel-btn px-4 py-2 text-white font-bold rounded-full flex items-center gap-2 transition-colors'; // Added dynamic-channel-btn
                    // --- END MODIFICATION ---
                    streamBtn.innerHTML = `<span>${stream.name}</span>`;
                    
                    if (stream.url === '#') {
                        streamBtn.disabled = true;
                        streamBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        streamBtn.addEventListener('click', () => {
                            updateActiveButton(index);
                            const newUrl = stream.url;

                            // NEW: Re-render the EPG for the selected stream
                            renderFullEpg(channel); // channel object is in scope

                            // Check for active cast session
                            const castSession = window.cast && cast.framework ? cast.framework.CastContext.getInstance().getCurrentSession() : null;

                            if (castSession) {
                                // Reload media on cast device
                                const mediaInfo = new chrome.cast.media.MediaInfo(newUrl, 'application/x-mpegURL');
                                mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
                                mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                                mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
                                mediaInfo.metadata.title = channel.name;
                                mediaInfo.metadata.images = [{ 'url': channel.logo }];
                                
                                const request = new chrome.cast.media.LoadRequest(mediaInfo);
                                
                                castSession.loadMedia(request).then(
                                    () => console.log('Reloaded media on Cast device with new stream.'),
                                    (errorCode) => console.error('Error reloading media on Cast device:', errorCode)
                                );
                            } else {
                                // Not casting, just update local player
                                loadSource(newUrl);
                            }
                        });
                    }
                    
                    // controlsContainer.appendChild(streamBtn); // OLD
                    streamControlsContainer.appendChild(streamBtn); // NEW
                });

                let activeStreamIndex = parseInt(localStorage.getItem(`findFlix_activeStream_${channel.name}`), 10);
                
                // If the stored index is invalid (NaN or points to a disabled stream), find the first valid one.
                if (isNaN(activeStreamIndex) || (channelStreams[activeStreamIndex] && channelStreams[activeStreamIndex].url === '#')) {
                    const firstValidIndex = channelStreams.findIndex(stream => stream.url !== '#');
                    activeStreamIndex = firstValidIndex !== -1 ? firstValidIndex : 0; // Fallback to 0 if none are valid
                }

                if (!isCurrentlyCasting) {
                    const activeStream = channelStreams[activeStreamIndex];
                    if (activeStream && activeStream.url !== '#') {
                        loadSource(activeStream.url);
                    } else {
                        // Handle case where no valid stream is found at all
                        overlay.classList.remove('hidden');
                        overlay.classList.add('flex');
                        message.textContent = t.channelNotAvailable;
                        stopAndResetAIInterval();
                        return; // Exit if no playable stream
                    }
                }
                updateActiveButton(activeStreamIndex);
            } else {
                // For channels with no subtitle or secondary stream option
                if (!isCurrentlyCasting) {
                    loadSource(channel.streamUrl);
                }
            }

            // NEW: Render the full EPG for the selected channel
            renderFullEpg(channel);

            // NEW: Check if EPG is visible and add scroll button
            const epgContainer = document.getElementById('tv-epg-container');
            /* REMOVED THIS BLOCK
            if (epgContainer && !epgContainer.classList.contains('hidden')) {
                const scrollBtn = document.createElement('button');
                scrollBtn.className = 'px-4 py-2 bg-blue-600 text-white font-bold rounded-full flex items-center gap-2 transition-colors hover:bg-blue-700';
                scrollBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                    </svg>
                    <span>${t.epgTitle || 'לוח שידורים'}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
                    </svg>
                `;
                scrollBtn.onclick = () => {
                    epgContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                };
                epgScrollContainer.appendChild(scrollBtn);
                epgScrollContainer.classList.remove('hidden');
            }
            */ // END OF REMOVED BLOCK
        }

        async function identifyTvContent() {
    const t = translations[currentLanguage];
    const aiInfoContainer = document.getElementById('tv-ai-info-container');
    const video = document.getElementById('tv-player');
    const canvas = document.getElementById('frame-capture-canvas');

    // Safety check if elements are not on the page
    if (!aiInfoContainer || !video || !canvas) return;

    const isAiSummaryVisible = localStorage.getItem('findFlixAiSummaryVisible') !== 'false';

    const ctx = canvas.getContext('2d');

    if (video.paused || video.readyState < 3 || video.videoWidth === 0) {
                // Video not playing or ready, just wait for the next interval.
                return;
            }

            try {
                // Draw current frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageDataUrl = canvas.toDataURL('image/jpeg', 0.5); // Use JPEG with quality 0.5 to reduce size
                const base64Data = imageDataUrl.split(',')[1];

                // Prepare API call
                const targetLanguageName = { he: 'Hebrew', en: 'English', ru: 'Russian', ar: 'Arabic', de: 'German', es: 'Spanish', it: 'Italian', fr: 'French', pt: 'Portuguese' }[currentLanguage] || 'English';
                
                // NEW: Add current date and time for better context
                const now = new Date();
                const dateTimeString = now.toLocaleString(currentLanguage, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                const timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                const systemPrompt = `You are an expert at identifying media content from a single video frame. Your task is to identify the content in the image with high accuracy. The current date and time is ${dateTimeString} (${timeZone}) in Israel. Use this context for identifying live events like news or sports.

Respond ONLY with a JSON object. Do not include any text before or after the JSON. The response language for all text fields must be ${targetLanguageName}.

IMPORTANT FIRST RULE: You must check for specific broadcast error screens first. These screens often contain animated illustrations and text in Russian or German.
- Look for Russian text like "Возможные причины:" (Possible reasons) or "Доступ ограничен!" (Access denied), often with a large red 'X'.
- Look for German text like "Stellen Sie sicher, dass Ihr Abonnement aktiv ist" (Make sure your subscription is active) or "Überprüfen Sie, ob Sie das Geräte-Limit überschritten haben" (Check if you have exceeded the device limit).
If you identify ANY of these specific error screens or very similar troubleshooting/error messages, you MUST respond ONLY with the following JSON object and nothing else:
{
  "type": "error",
  "message": "נראה שיש בעיה עם השידור הזה כרגע."
}

If the image is NOT an error screen, then follow the rules below for identifying media.

1.  If you identify a sports match (like soccer, basketball, etc.) AND a scoreboard with team names and scores is CLEARLY VISIBLE, respond with this JSON structure. If any detail is not visible, use null for that value. Do not guess.
    {
      "type": "sports",
      "title": "Team 1 vs Team 2",
      "description": "Brief event description, e.g., 'Israeli Premier League'",
      "sport": "e.g., soccer",
      "team1": { "name": "Team 1 Name", "score": 1 },
      "team2": { "name": "Team 2 Name", "score": 0 },
      "gameTime": "e.g., 45+2'"
    }

2.  If you identify a regular TV show, movie, or news program, respond with this JSON structure. Be as specific as possible with the title.
    {
      "type": "media",
      "title": "The specific show or movie title",
      "description": "A one-sentence description."
    }

3.  If you are not highly confident, if the image is too generic, or if it is an advertisement or a channel logo screen, you MUST respond with this JSON structure. It is better to be correct and say you don't know than to be wrong.
    {
      "type": "unidentified",
      "title": "${t.contentNotIdentified}",
      "description": ""
    }`;
                const userQuery = `Identify the content in this image.`;
                const apiUrl = `${GEMINI_BASE_URL}${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: userQuery },
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                        ]
                    }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                     // Silently fail and wait for next interval
                    console.error(`API call failed with status: ${response.status}`);
                    return;
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                const jsonText = candidate?.content?.parts?.[0]?.text;

        if (!jsonText) {
            // Silently fail and wait for next interval
            console.error('No valid response from AI.');
            aiInfoContainer.dataset.hasContent = 'false';
            return;
        }

        aiInfoContainer.dataset.hasContent = 'true';
        if (!isAiSummaryVisible) {
            aiInfoContainer.classList.add('hidden');
            return; // Don't bother updating the DOM if it's hidden
        }

        const identifiedContent = JSON.parse(jsonText);
        const videoOverlay = document.getElementById('tv-player-overlay');
        const videoMessage = document.getElementById('tv-player-message');

                // Handle different content types from AI
                const sportsScoreboardEnabled = localStorage.getItem('findFlixSportsScoreboardEnabled') !== 'false'; // Default to true
                if (identifiedContent && identifiedContent.type === 'error') {
                    // Handle the specific broadcast error
                    if (videoOverlay && videoMessage) {
                        videoMessage.textContent = identifiedContent.message;
                        videoOverlay.classList.remove('hidden');
                        videoOverlay.classList.add('flex');
                    }
                    aiInfoContainer.innerHTML = `
                        <div class="flex justify-center items-center gap-3 text-amber-400 p-4 bg-amber-900/50 rounded-lg border border-amber-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            </svg>
                            <span class="font-bold">${identifiedContent.message}</span>
                        </div>
                    `;
                } else {
                    if (videoOverlay && !videoOverlay.classList.contains('hidden')) {
                        videoOverlay.classList.add('hidden');
                        videoOverlay.classList.remove('flex');
                    }

                    if (identifiedContent && identifiedContent.type === 'sports' && sportsScoreboardEnabled && identifiedContent.team1 && identifiedContent.team2) {
                        const team1Name = identifiedContent.team1.name;
                        const team2Name = identifiedContent.team2.name;
                        const team1Score = identifiedContent.team1.score;
                        const team2Score = identifiedContent.team2.score;
                        const gameTime = identifiedContent.gameTime;
                        const sportDescription = identifiedContent.description;
                        
                        // Get sport emoji
                        const sportType = identifiedContent.sport ? identifiedContent.sport.toLowerCase().replace(' ', '_') : 'default';
                        const sportEmoji = sportEmojis[sportType] || '🏆'; // Default to a trophy

                        const currentScoreboardHTML = aiInfoContainer.querySelector('.scoreboard-container');
                        // Only update if content is different to avoid flicker
                        if (!currentScoreboardHTML || currentScoreboardHTML.dataset.gameTime !== gameTime || currentScoreboardHTML.dataset.score !== `${team1Score}-${team2Score}`) {
                            const scoreboardHTML = `
                                <div class="flex justify-between items-start">
                                    <div class="flex-grow">
                                        <div class="scoreboard-container bg-gray-900/50 p-4 rounded-lg border border-gray-700" data-game-time="${gameTime}" data-score="${team1Score}-${team2Score}">
                                            <p class="text-center text-sm text-gray-400 mb-3">${sportDescription || ''}</p>
                                            <div class="flex items-center justify-around" dir="ltr">
                                                <div class="flex flex-col items-center gap-2 text-center w-2/5">
                                                    <div class="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center text-3xl shadow-inner">${sportEmoji}</div>
                                                    <span class="font-bold text-lg text-white truncate w-full">${team1Name}</span>
                                                </div>
                                                <div class="flex flex-col items-center gap-1 text-center">
                                                    <div class="flex items-center gap-4">
                                                        <span class="text-5xl font-bold text-white tabular-nums">${team1Score !== null ? team1Score : '-'}</span>
                                                        <span class="text-2xl font-bold text-gray-500">-</span>
                                                        <span class="text-5xl font-bold text-white tabular-nums">${team2Score !== null ? team2Score : '-'}</span>
                                                    </div>
                                                    <span class="text-lg font-semibold text-red-500 mt-1">${gameTime || ''}</span>
                                                </div>
                                                <div class="flex flex-col items-center gap-2 text-center w-2/5">
                                                    <div class="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center text-3xl shadow-inner">${sportEmoji}</div>
                                                    <span class="font-bold text-lg text-white truncate w-full">${team2Name}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-2 text-center">${t.aiDisclaimer}</p>
                                    </div>
                                    <div id="ai-timer-container" class="text-sm text-gray-400 flex-shrink-0 ml-4"></div>
                                </div>
                            `;
                            aiInfoContainer.innerHTML = scoreboardHTML;
                        }

                    } else if (identifiedContent && identifiedContent.title && identifiedContent.title !== t.contentNotIdentified) {
                        // Only update if the content has actually changed to prevent flashing the same info
                        const currentTitleEl = aiInfoContainer.querySelector('h4');
                        const currentTitleText = currentTitleEl ? currentTitleEl.textContent.trim() : '';

                        if (currentTitleText !== identifiedContent.title.trim()) {
                             aiInfoContainer.innerHTML = `
                                <div class="flex justify-between items-start bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                                    <div class="flex-grow">
                                        <h4 class="text-xl font-bold text-purple-400 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24"><path fill="currentColor" d="M12,0 C11,5 5,11 0,12 C5,13 11,19 12,24 C13,19 19,13 24,12 C19,11 13,5 12,0Z"/></svg>
                                            ${identifiedContent.title}
                                        </h4>
                                        <p class="text-gray-300 mt-2">${identifiedContent.description}</p>
                                        <p class="text-xs text-gray-500 mt-3">${t.aiDisclaimer}</p>
                                    </div>
                                    <div id="ai-timer-container" class="text-sm text-gray-400 flex-shrink-0 ml-4"></div>
                                </div>
                            `;
                        }
                    } else {
                        // If content is not identified, update to show that, but only if it's not already showing that
                        const currentTitleEl = aiInfoContainer.querySelector('h4'); // Check for the h4 tag
                        if (!currentTitleEl || !currentTitleEl.textContent.includes(t.contentNotIdentified)) {
                            aiInfoContainer.innerHTML = `
                                <div class="flex justify-between items-start bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                                    <div class_name="flex-grow">
                                        <h4 class="text-xl font-bold text-gray-500 flex items-center gap-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                            ${t.contentNotIdentified}
                                        </h4>
                                        <p class="text-gray-300 mt-2">${t.aiIdentifyingWillRetry || 'הבינה ממשיכה לנסות לזהות ברקע...'}</p>
                                        <p class="text-xs text-gray-500 mt-3">${t.aiDisclaimer}</p>
                                    </div>
                                    <div id="ai-timer-container" class="text-sm text-gray-400 flex-shrink-0 ml-4"></div>
                                </div>
                            `;
                        }
                    }
                }
                trackProgress('ai_consultant', 1);
                checkAchievements();
        
            } catch (error) {
                // Silently fail on error
                console.error('Error identifying TV content:', error);
                aiInfoContainer.dataset.hasContent = 'false';
            }
        }
        
        // NEW: Function to render the full EPG for a selected channel
        async function renderFullEpg(channel, isAutoUpdate = false) { // <-- MODIFIED: Added isAutoUpdate
            const epgContainer = document.getElementById('tv-epg-container');
            const epgList = document.getElementById('tv-epg-list');
            const epgTitle = document.getElementById('tv-epg-title');
            const epgDisclaimer = document.getElementById('epg-disclaimer'); // NEW: Get disclaimer element
            const epgScrollContainer = document.getElementById('epg-scroll-container'); // NEW: Get scroll container
            const t = translations[currentLanguage];
        
            if (!epgContainer || !epgList || !epgTitle || !epgDisclaimer || !epgScrollContainer) return; // NEW: Added scroll container check
        
            // NEW: Handle Auto Update Interval
            if (!isAutoUpdate) {
                if (fullEpgInterval) clearInterval(fullEpgInterval);
                fullEpgInterval = setInterval(() => renderFullEpg(channel, true), 10000);
            }

            // NEW: Save scroll position if updating
            let savedScrollTop = 0;
            if (isAutoUpdate) {
                savedScrollTop = epgList.scrollTop;
            }

            epgDisclaimer.textContent = t.epgDisclaimer; // NEW: Set disclaimer text
        
            // Clear and hide by default
            epgList.innerHTML = '';
            epgTitle.textContent = '';
            epgContainer.classList.add('hidden');
            epgDisclaimer.classList.add('hidden'); // NEW: Hide disclaimer by default
            epgScrollContainer.innerHTML = ''; // NEW: Clear scroll button container
            epgScrollContainer.classList.add('hidden'); // NEW: Hide scroll button container
        
            // --- Removed sports check, as fetching is now disabled for all ---
        
            let epgIdToUse = channel.epgId;
            let epgChannelName = channel.name;
        
            const channelStreams = (channel.streams && channel.streams.length > 0) 
                ? channel.streams
                : channel.secondaryStreamUrl
                    ? [
                        { name: channel.primaryStreamName || 'ערוץ 1', url: channel.streamUrl, epgId: channel.epgId },
                        { name: channel.secondaryStreamName || 'ערוץ 2', url: channel.secondaryStreamUrl, epgId: null }
                      ]
                    : [];
        
            if (channelStreams.length > 0) {
                let activeStreamIndex = parseInt(localStorage.getItem(`findFlix_activeStream_${channel.name}`), 10);
                
                if (isNaN(activeStreamIndex) || (channelStreams[activeStreamIndex] && channelStreams[activeStreamIndex].url === '#')) {
                    const firstValidIndex = channelStreams.findIndex(stream => stream.url !== '#');
                    activeStreamIndex = firstValidIndex !== -1 ? firstValidIndex : 0;
                }
                const activeStream = channelStreams[activeStreamIndex];
                
                if (activeStream && activeStream.epgId) {
                    epgIdToUse = activeStream.epgId;
                    epgChannelName = `${channel.name} - ${activeStream.name}`;
                } else if (channel.epgId) {
                    epgIdToUse = channel.epgId;
                    epgChannelName = `${channel.name} - ${activeStream.name}`;
                } else {
                    epgIdToUse = null;
                }
            }
            
            if (channel && epgIdToUse && epgDataStore[epgIdToUse]) {
                const programs = epgDataStore[epgIdToUse];
                if (programs.length > 0) {
                    epgTitle.textContent = `${t.epgTitle}: ${epgChannelName}`;
                    
                    const now = new Date();
                    const todayKey = now.toDateString();
                    const tomorrow = new Date(now);
                    tomorrow.setDate(now.getDate() + 1);
                    const tomorrowKey = tomorrow.toDateString();
        
                    let currentProgramFound = false;
                    const programsByDay = {};
                    programs.forEach(program => {
                        const startDate = program.StartDate;
                        const endDate = program.EndDate;
                        if (endDate > now) {
                            const dateKey = startDate.toDateString();
                            if (!programsByDay[dateKey]) programsByDay[dateKey] = [];
                            programsByDay[dateKey].push(program);
                        }
                    });
        
                    let programsRendered = 0;
                    const dateKeys = Object.keys(programsByDay).sort((a, b) => new Date(a) - new Date(b));
        
                    // --- NEW: Parallel fetch logic to prevent race conditions on render ---
                    // 1. Create a flat list of all programs to render, and their fetch promises
                    const allProgramsWithPromises = [];
                    dateKeys.forEach(dateKey => {
                        programsByDay[dateKey].forEach(program => {
                            // --- REMOVED fetchPromise logic ---
                            allProgramsWithPromises.push({ program, dateKey });
                        });
                    });

                    // 2. Await all promises
                    // --- REMOVED tmdbResults logic ---

                    // 3. Map results back to programs
                    const allProgramsWithData = allProgramsWithPromises.map((p, index) => ({
                        ...p,
                        tmdbInfo: null // --- SET tmdbInfo to null ---
                    }));
                    // --- END NEW LOGIC ---

                    // --- NEW FIX: Preload the first EPG image to help mobile browsers ---
                    // --- REMOVED image preload logic ---
                    // --- END NEW FIX ---

                    let currentDayKey = null; // To track when to add a header

                    // 4. Render everything synchronously with all data ready
                    for (const item of allProgramsWithData) {
                        const { program, dateKey, tmdbInfo } = item; // tmdbInfo will always be null

                        // Add day header if it's a new day
                        if (dateKey !== currentDayKey) {
                            currentDayKey = dateKey;
                            let dayHeaderText;
                            if (dateKey === todayKey) dayHeaderText = t.epgToday;
                            else if (dateKey === tomorrowKey) dayHeaderText = t.epgTomorrow;
                            else dayHeaderText = new Date(dateKey).toLocaleDateString(currentLanguage, { weekday: 'long', day: 'numeric', month: 'long' });

                            const header = document.createElement('h5');
                            header.className = 'epg-day-header text-lg font-bold text-red-500 mt-4 mb-2 sticky top-0 bg-gray-900/80 backdrop-blur-sm py-2 px-4 z-10 border-b-2 border-red-700 rounded-t-lg';
                            header.textContent = dayHeaderText;
                            epgList.appendChild(header);
                        }

                        // --- Build the LI ---
                        const startDate = program.StartDate;
                        const endDate = program.EndDate;
                        
                        const li = document.createElement('li');
                        const epgItemId = 'epg-item-' + program.Name.replace(/[^a-z0-9א-ת]/gi, '') + startDate.getTime();
                        li.id = epgItemId; 

                        const startTime = startDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });
                        const endTime = endDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });

                        let isCurrent = false;
                        if (!currentProgramFound && now >= startDate && now < endDate) {
                            isCurrent = true;
                            currentProgramFound = true;
                        }
                        
                        // Apply TMDB info *before* setting innerHTML/appending
                        // --- REMOVED background image logic ---
                        // if (tmdbInfo) { ... } 
                        li.className = `epg-item ${isCurrent ? 'current' : ''}`; // --- REMOVED tmdbInfo check ---

                        let descriptionHtml = '';
                        let hasDescription = false;
                        if (program.Description) {
                            descriptionHtml = `<p class="text-sm text-gray-400 mt-1 truncate" title="${program.Description}" data-original-title="${program.Description}">${program.Description}</p>`;
                            hasDescription = true;
                        }

                        li.innerHTML = `
                            <div class="flex justify-between items-start gap-2">
                                <div class="flex-grow min-w-0">
                                    <span class="font-bold text-white">${program.Name}</span>
                                    ${descriptionHtml}
                                </div>
                                <span class="text-sm text-gray-400 flex-shrink-0 text-right">${startTime} - ${endTime}</span>
                            </div>
                            <!-- Button placeholder -->
                            <div class="epg-button-container mt-2"></div> 
                        `;

                        // Add button *after* setting innerHTML
                        // --- REMOVED button logic ---
                        // if (tmdbInfo) { ... }

                        if (hasDescription) {
                            li.style.cursor = 'pointer';
                            li.addEventListener('click', (e) => {
                                // FIX: Check for 'A' tag to prevent click-through
                                if (e.target.tagName === 'A' || e.target.closest('A')) return;

                                const descEl = li.querySelector('p');
                                if (descEl) {
                                    const isTruncated = descEl.classList.contains('truncate');
                                    if (isTruncated) {
                                        descEl.classList.remove('truncate');
                                        descEl.classList.add('whitespace-normal');
                                    } else {
                                        descEl.classList.add('truncate');
                                        descEl.classList.remove('whitespace-normal');
                                    }
                                }
                            });
                        }

                        epgList.appendChild(li);
                        programsRendered++;
                    } // --- END of new loop ---
    
                    /* --- REMOVED OLD LOOP ---
                    dateKeys.forEach(dateKey => {
                        const dayPrograms = programsByDay[dateKey];
                        let dayHeaderText;
                        if (dateKey === todayKey) dayHeaderText = t.epgToday;
                        else if (dateKey === tomorrowKey) dayHeaderText = t.epgTomorrow;
                        else dayHeaderText = new Date(dateKey).toLocaleDateString(currentLanguage, { weekday: 'long', day: 'numeric', month: 'long' });
        
                        const header = document.createElement('h5');
                        header.className = 'epg-day-header text-lg font-bold text-red-500 mt-4 mb-2 sticky top-0 bg-gray-900/80 backdrop-blur-sm py-2 px-4 z-10 border-b-2 border-red-700 rounded-t-lg';
                        header.textContent = dayHeaderText;
                        epgList.appendChild(header);
        
                        dayPrograms.forEach(program => {
                            const startDate = program.StartDate;
                            const endDate = program.EndDate;
                            
                            const li = document.createElement('li');
                            const epgItemId = 'epg-item-' + program.Name.replace(/[^a-z0-9א-ת]/gi, '') + startDate.getTime();
                            li.id = epgItemId;
        
                            const startTime = startDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });
                            const endTime = endDate.toLocaleTimeString(currentLanguage, { hour: '2-digit', minute: '2-digit' });
        
                            let isCurrent = false;
                            if (!currentProgramFound && now >= startDate && now < endDate) {
                                isCurrent = true;
                                currentProgramFound = true;
                            }
                            li.className = `epg-item ${isCurrent ? 'current' : ''}`;
                            
                            let descriptionHtml = '';
                            let hasDescription = false;
                            if (program.Description) {
                                // FIX: Corrected typo from 'class-' to 'class'
                                descriptionHtml = `<p class="text-sm text-gray-400 mt-1 truncate" title="${program.Description}" data-original-title="${program.Description}">${program.Description}</p>`;
                                hasDescription = true;
                            }
        
                            // FIX: Added epg-button-container
                            li.innerHTML = `
                                <div class="flex justify-between items-start gap-2">
                                    <div class="flex-grow min-w-0">
                                        <span class="font-bold text-white">${program.Name}</span>
                                        ${descriptionHtml}
                                    </div>
                                    <span class="text-sm text-gray-400 flex-shrink-0 text-right">${startTime} - ${endTime}</span>
                                </div>
                                <!-- Button placeholder -->
                                <div class="epg-button-container mt-2"></div> 
                            `;
        
                            if (hasDescription) {
                                li.style.cursor = 'pointer';
                                li.addEventListener('click', (e) => {
                                    // FIX: Check for 'A' tag to prevent click-through
                                    if (e.target.tagName === 'A' || e.target.closest('A')) return;
        
                                    const descEl = li.querySelector('p');
                                    if (descEl) {
                                        const isTruncated = descEl.classList.contains('truncate');
                                        if (isTruncated) {
                                            descEl.classList.remove('truncate');
                                            descEl.classList.add('whitespace-normal');
                                        } else {
                                            descEl.classList.add('truncate');
                                            descEl.classList.remove('whitespace-normal');
                                        }
                                    }
                                });
                            }
        
                            epgList.appendChild(li);
                            programsRendered++;
        
                            // --- START FIXES for Request 1 & 2 ---
                            // Only run this if it's NOT a sports channel AND not one of the excluded channels
                            if (!isSports && channel.name !== 'עכשיו 14' && channel.name !== 'ערוץ הכנסת' && channel.name !== 'i24NEWS בעברית') { 
                                (async () => {
                                    const tmdbInfo = await fetchTmdbImageForEpg(program.Name, channel.name); // <-- Pass channel.name
                                    if (tmdbInfo) {
                                        const itemEl = document.getElementById(epgItemId);
                                        if (itemEl) {
                                            // MODIFICATION: Use a more mobile-friendly backdrop size (w780 instead of w1280)
                                            const mobileBackdropUrl = `https://image.tmdb.org/t/p/w780${tmdbInfo.backdrop_path}`;
                                            itemEl.style.backgroundImage = `url(${mobileBackdropUrl})`;
                                            itemEl.classList.add('epg-item-with-image');
                                            
                                            // FIX for Request 2: Add the button immediately
                                            const buttonContainer = itemEl.querySelector('.epg-button-container');
                                            if (buttonContainer) {
                                                const detailsBtn = document.createElement('a');
                                                detailsBtn.href = `#details-${tmdbInfo.media_type}-${tmdbInfo.id}`;
                                                detailsBtn.className = 'epg-view-content-btn inline-flex items-center gap-1.5 px-3 py-1 bg-red-600 text-white text-xs font-bold rounded-full transition-colors hover:bg-red-700';
                                                detailsBtn.innerHTML = `
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                                    </svg>
                                                    ${t.moreDetails || 'פרטים נוספים'}
                                                `;
                                                buttonContainer.appendChild(detailsBtn);
                                            }
                                        }
                                    }
                                })();
                            }
                            // --- END FIXES ---
                        });
                    });
                    */ // --- END OF REMOVED OLD LOOP ---
        
                    if (programsRendered > 0) {
                        epgContainer.classList.remove('hidden');
                        epgDisclaimer.classList.remove('hidden'); // NEW: Show disclaimer with EPG

                        // NEW: Add the scroll button here
                        const scrollBtn = document.createElement('button');
                        scrollBtn.className = 'px-4 py-2 bg-blue-600 text-white font-bold rounded-full flex items-center gap-2 transition-colors hover:bg-blue-700';
                        scrollBtn.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
                            </svg>
                            <span>${t.epgTitle || 'לוח שידורים'}</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
                            </svg>
                        `;
                        scrollBtn.onclick = () => {
                            epgContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        };
                        epgScrollContainer.appendChild(scrollBtn);
                        epgScrollContainer.classList.remove('hidden');
                        // END NEW

                        if (isAutoUpdate) {
                            // Restore scroll position
                            epgList.scrollTop = savedScrollTop;
                        } else {
                            setTimeout(() => {
                                const currentItem = epgList.querySelector('.current');
                                if (currentItem) {
                                    let header = currentItem.previousElementSibling;
                                    while(header && header.tagName !== 'H5') header = header.previousElementSibling;
                                    
                                    // REMOVED: The following lines that caused scrolling to the EPG
                                    // if (header) header.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                    // else currentItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); 
                                }
                            }, 200);
                        }
                    }
                }
            }
        }
        
        </script>
        </body>
        </html>

